<!DOCTYPE html>
<html lang="zh-CN"><head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <meta name="description" content=" - https://www.snoopyops.top/posts/%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86/es%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/">
    <meta name="author" content="snoopy - https://www.snoopyops.top/">
    
    <meta name="msvalidate.01" content="B46311949B856F2A7015F366FB3CE878" />
    <title></title>
    <link rel="icon" type="image/png" href="/favicon.ico">
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/lxgw-wenkai-webfont/1.7.0/style.min.css" />
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/lxgw-wenkai-screen-webfont/1.7.0/style.min.css" />
    
    <link rel="stylesheet" href="https://www.snoopyops.top/style.min.6bbccf0916939df698171c34d30f896276712c30bd56be0d7fd8023e1b00c3d9.css">
    
    <script type="text/javascript" src="/main.js" defer></script>
    
    
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?080713f769977324f1fbafc95c5fa4c6";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
</head>
<body class="active-animate cool">
        <div class="cool-before" style="background: url('/imgs/bg/foxgirl.jpg') center center/cover no-repeat fixed;"></div>
        <div id="readmore-container">
            <div id="header" class=""><div class="container-header">
    
    
    <div class="right">
        
        <h1 class="title"></h1>
    
        
            
            <div id="toc">📜</div>
        
    </div>
</div>
</div>
            <div id="content">










<div class="container-main container-page ">

    <div class="desc">
        
        <span>
            
            <svg t="1656736000388" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7409" width="12" height="12"><path d="M524.885333 338.986667L200.362667 663.466667c-17.28 15.274667-27.989333 36.693333-29.696 56.234666v133.76l130.730666 0.085334c22.784-1.621333 43.989333-12.245333 61.013334-31.701334l322.688-322.645333-160.213334-160.213333z m60.373334-60.330667l160.170666 160.213333 102.144-102.144a19.712 19.712 0 0 0 0-27.861333L715.093333 176.426667a19.456 19.456 0 0 0-27.605333 0L585.258667 278.613333zM701.312 85.333333c27.946667 0 54.741333 11.136 74.282667 30.848l132.309333 132.309334a105.045333 105.045333 0 0 1 0 148.565333L424.874667 879.957333c-29.824 34.346667-72.106667 55.466667-120.448 58.794667H85.333333v-42.666667l0.128-179.84c3.626667-44.970667 24.576-86.826667 56.448-114.944l485.12-485.034666A104.789333 104.789333 0 0 1 701.269333 85.333333z" p-id="7410" fill="#adb5bd"></path></svg>
            0001-01-01&nbsp;&nbsp;&nbsp;
            <svg t="1656737270708" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="23838" width="11" height="11"><path d="M824.264 95.36c0-23.859 25.043-44.16 48.902-44.16s49.714 20.301 49.714 44.16v190.08c0 23.859-19.054 52.868-42.913 52.868h-190.08c-23.859 0-46.696-25.96-46.696-49.819s22.55-46.249 46.409-46.249h82.025C702.344 175.534 610.22 155.853 512 155.853c-206.775 0-360.398 149.372-360.398 356.147 0 206.775 153.623 358.23 360.398 358.23 206.775 0 357.467-151.455 357.467-358.23 0-23.859 23.634-50.706 53.413-50.706 29.78 0 49.92 26.847 49.92 50.706 0 254.493-206.307 460.8-460.8 460.8-254.493 0-460.8-206.307-460.8-460.8C51.2 257.507 257.507 51.2 512 51.2c122.4 0 226.684 33.296 312.264 117.369 0.358 0.351 0.358-24.052 0-73.209z" p-id="23839" fill="#adb5bd"></path></svg>
            0001-01-01&nbsp;&nbsp;&nbsp;
        </span>
        <span>
            
            <svg t="1656737548689" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="33866" width="12" height="12"><path d="M832.038608 64.662657H192.030028C121.255125 64.662657 63.940169 121.98845 63.940169 192.694717v446.793671C63.940169 710.205493 121.255125 767.643272 192.030028 767.643272h133.353183a63.940169 63.940169 0 0 1 55.219742 31.576328l76.099638 129.83828c12.358154 21.093031 33.790754 31.626903 55.216129 31.626903s42.832688-10.544709 55.198067-31.619678l76.222461-129.870792a63.940169 63.940169 0 0 1 55.212517-31.551041h133.54103c70.576219 0 127.732228-57.289669 127.732227-127.800865V192.391272C959.825022 121.85479 902.643727 64.662657 832.038608 64.662657zM895.884854 639.842407A63.85347 63.85347 0 0 1 832.092795 703.703103h-133.54103a127.753903 127.753903 0 0 0-110.349172 63.09847l-76.222461 129.856342a0.274545 0.274545 0 0 1 0-0.050574h-0.032512s-0.021675 0.061411-0.032512 0.061412l-76.1466-129.85273A127.804477 127.804477 0 0 0 325.383211 703.703103H192.030028A64.207489 64.207489 0 0 1 127.880338 639.488388V192.694717A64.102729 64.102729 0 0 1 192.030028 128.602826h640.00858A63.799284 63.799284 0 0 1 895.884854 192.391272v447.451135z" fill="#adb5bd" p-id="33867"></path><path d="M608.154093 288.092004A31.970084 31.970084 0 0 0 576.184009 320.062089v160.078006l-134.650049-179.278119A31.970084 31.970084 0 0 0 384.002258 320.062089v255.760676a31.970084 31.970084 0 0 0 63.940169 0v-159.958796l134.650048 179.274507a31.970084 31.970084 0 0 0 57.531703-19.200113V320.062089a31.970084 31.970084 0 0 0-31.970085-31.970085z" fill="#adb5bd" p-id="33868"></path></svg>
            2639 字</span>&nbsp;
        <span>
            
            <svg t="1656737462334" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="32892" width="12" height="12"><path d="M512 74.666667C270.933333 74.666667 74.666667 270.933333 74.666667 512S270.933333 949.333333 512 949.333333 949.333333 753.066667 949.333333 512 753.066667 74.666667 512 74.666667z m0 810.666666c-204.8 0-373.333333-168.533333-373.333333-373.333333S307.2 138.666667 512 138.666667 885.333333 307.2 885.333333 512 716.8 885.333333 512 885.333333z" p-id="32893" fill="#adb5bd"></path><path d="M695.466667 567.466667l-151.466667-70.4V277.333333c0-17.066667-14.933333-32-32-32s-32 14.933333-32 32v238.933334c0 12.8 6.4 23.466667 19.2 29.866666l170.666667 81.066667c4.266667 2.133333 8.533333 2.133333 12.8 2.133333 12.8 0 23.466667-6.4 29.866666-19.2 6.4-14.933333 0-34.133333-17.066666-42.666666z" p-id="32894" fill="#adb5bd"></path></svg>
            6 分钟</span>
            <div class="container-ctgtag">
	<div class="taxonomy">
		<div class="tag">
			
			
		</div>
	</div>
</div>
        
    </div>
    
    <div class="toc">
        <div class="container-page-operation">
	<div class="page-operation">
		<div><a href="/"><img src="/imgs/icons/home-2.svg" alt=""></a></div>
		<div><a href="/nav"><img src="/imgs/icons/iov-navigate-1.svg" alt=""></a></div>
		<div><a href="/tags"><img src="/imgs/icons/treetags.svg" alt=""></a></div>
		<div id="light-dark"><a><img src="/imgs/icons/moon2.svg" alt=""></a></div>
		<div><a href="#"><img src="/imgs/icons/up2.svg" alt=""></a></div>
	</div>
</div>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#elasticsearch">ElasticSearch</a>
      <ul>
        <li><a href="#服务器调优">服务器调优</a></li>
        <li><a href="#es集群部署">ES集群部署</a></li>
        <li><a href="#x-pack插件">x-pack插件</a></li>
        <li><a href="#集成ldap">集成LDAP</a></li>
        <li><a href="#最终配置">最终配置</a></li>
      </ul>
    </li>
    <li><a href="#cerebro">cerebro</a></li>
    <li><a href="#kibana">kibana</a>
      <ul>
        <li><a href="#kibana部署">kibana部署</a></li>
        <li><a href="#权限配置">权限配置</a></li>
      </ul>
    </li>
    <li><a href="#es优化">ES优化</a>
      <ul>
        <li><a href="#分片与副本数量">分片与副本数量</a></li>
        <li><a href="#索引保存时长">索引保存时长</a></li>
        <li><a href="#快照及恢复">快照及恢复</a></li>
      </ul>
    </li>
    <li><a href="#新增一个节点">新增一个节点</a></li>
  </ul>
</nav>
    </div>

    <div class='content  '>
        <h2 id="elasticsearch">ElasticSearch</h2>
<p>本次采用3台服务器做部署ES集群。配置为8C16G</p>
<h3 id="服务器调优">服务器调优</h3>
<p>配置es可以创建的最大线程数量</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vim /etc/security/limits.conf
</span></span><span style="display:flex;"><span>添加
</span></span><span style="display:flex;"><span>root soft nofile <span style="color:#099">65535</span>
</span></span><span style="display:flex;"><span>root hard nofile <span style="color:#099">65535</span>
</span></span><span style="display:flex;"><span>* soft nofile <span style="color:#099">65535</span>
</span></span><span style="display:flex;"><span>* hard nofile <span style="color:#099">65535</span>
</span></span><span style="display:flex;"><span>* hard noproc <span style="color:#099">65535</span>
</span></span><span style="display:flex;"><span>* soft noproc <span style="color:#099">65535</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>修改最大虚拟内存</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vim /etc/sysctl.conf
</span></span><span style="display:flex;"><span>添加
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># es configure</span>
</span></span><span style="display:flex;"><span>vm.max_map_count<span style="color:#000;font-weight:bold">=</span><span style="color:#099">655360</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>使参数生效
</span></span><span style="display:flex;"><span>sysctl -p
</span></span></code></pre></td></tr></table>
</div>
</div><p>增加锁内存的权限</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vim /etc/security/limits.conf
</span></span><span style="display:flex;"><span>添加
</span></span><span style="display:flex;"><span>ops - memlock unlimited
</span></span></code></pre></td></tr></table>
</div>
</div><p>Centos7 中systemd 不支持，需要额外配置(此步骤操作完，需要重启服务器)</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vim /etc/systemd/system.conf
</span></span><span style="display:flex;"><span>修改
</span></span><span style="display:flex;"><span><span style="color:#008080">DefaultLimitNOFILE</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">65536</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">DefaultLimitNPROC</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">32000</span> 
</span></span><span style="display:flex;"><span><span style="color:#008080">DefaultLimitMEMLOCK</span><span style="color:#000;font-weight:bold">=</span>infinity
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="es集群部署">ES集群部署</h3>
<p>下载二进制文件并解压</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.12.0-linux-x86_64.tar.gz
</span></span><span style="display:flex;"><span>tar xf elasticsearch-7.12.0-linux-x86_64.tar.gz -C /opt/
</span></span><span style="display:flex;"><span>ln -s /opt/elasticsearch-7.12.0 /opt/elasticsearch
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ll /opt
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#099">1</span> root root   <span style="color:#099">25</span> Apr  <span style="color:#099">4</span> 03:24 elasticsearch -&gt; /opt/elasticsearch-7.12.0
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#099">9</span> root root <span style="color:#099">4096</span> Mar <span style="color:#099">18</span>  <span style="color:#099">2021</span> elasticsearch-7.12.0
</span></span></code></pre></td></tr></table>
</div>
</div><p>使用安装包自带的jdk，防止使用本机安装的jdk版本不兼容导致无法启动</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vim /opt/elasticsearch/bin/elasticsearch-env
</span></span><span style="display:flex;"><span>添加
</span></span><span style="display:flex;"><span><span style="color:#008080">JAVA_HOME</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;/opt/elasticsearch/jdk&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://images.snoopyops.top/image-20230404103240139.png" alt="image-20230404103240139"></p>
<p>修改es启动的jvm，一般为内存的一半，且xmx和xms要一样。不要超过32G，推荐最大配置为31G.</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>grep <span style="color:#d14">&#34;Xm&#34;</span> /opt/elasticsearch/config/jvm.options
</span></span><span style="display:flex;"><span>-Xms8g
</span></span><span style="display:flex;"><span>-Xmx8g
</span></span></code></pre></td></tr></table>
</div>
</div><p>es主要配置</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cp /opt/elasticsearch/config/elasticsearch.yml /opt/elasticsearch/config/elasticsearch.yml<span style="color:#d14">`</span>date +%F<span style="color:#d14">`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@hwei-ng-public-elastic-prod-1 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /opt/elasticsearch/config/elasticsearch.yml</span>
</span></span><span style="display:flex;"><span>cluster.name: ng-elk-es
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 每个节点需要有单独的name</span>
</span></span><span style="display:flex;"><span>node.name: node-1
</span></span><span style="display:flex;"><span>path.data: /work/elasticsearch/data
</span></span><span style="display:flex;"><span>path.logs: /work/elasticsearch/logs
</span></span><span style="display:flex;"><span>bootstrap.memory_lock: <span style="color:#0086b3">true</span>
</span></span><span style="display:flex;"><span>network.host: 0.0.0.0
</span></span><span style="display:flex;"><span>discovery.seed_hosts: <span style="color:#000;font-weight:bold">[</span><span style="color:#d14">&#34;10.66.3.123&#34;</span>, <span style="color:#d14">&#34;10.66.0.182&#34;</span>, <span style="color:#d14">&#34;10.66.2.19&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>cluster.initial_master_nodes: <span style="color:#000;font-weight:bold">[</span><span style="color:#d14">&#34;node-1&#34;</span>, <span style="color:#d14">&#34;node-2&#34;</span>, <span style="color:#d14">&#34;node-3&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建配置文件中的目录</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir -p /work/elasticsearch/
</span></span></code></pre></td></tr></table>
</div>
</div><p>修改文件夹权限</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>chown -R ops. /opt/elasticsearch*
</span></span><span style="display:flex;"><span>chown -R ops. /work/elasticsearch
</span></span></code></pre></td></tr></table>
</div>
</div><p>配置systems</p>
<pre tabindex="0"><code>vim /usr/lib/systemd/system/elasticsearch.service
[Unit]
Description=Elasticsearch
Documentation=https://www.elastic.co
Wants=network-online.target
After=network-online.target

[Service]
Type=simple
#Type=notify
RuntimeDirectory=elasticsearch
PrivateTmp=true
Environment=ES_HOME=/opt/elasticsearch
Environment=ES_PATH_CONF=/opt/elasticsearch/config/
Environment=PID_DIR=/var/run/elasticsearch
Environment=ES_SD_NOTIFY=true

WorkingDirectory=/opt/elasticsearch

User=ops
Group=ops

ExecStart=/opt/elasticsearch/bin/elasticsearch -p ${PID_DIR}/elasticsearch.pid

# StandardOutput is configured to redirect to journalctl since
# some error messages may be logged in standard output before
# elasticsearch logging system is initialized. Elasticsearch
# stores its logs in /var/log/elasticsearch and does not use
# journalctl by default. If you also want to enable journalctl
# logging, you can simply remove the &#34;quiet&#34; option from ExecStart.
StandardOutput=journal
StandardError=inherit

# Specifies the maximum file descriptor number that can be opened by this process
LimitNOFILE=65535

# Specifies the maximum number of processes
LimitNPROC=4096

# Specifies the maximum size of virtual memory
LimitAS=infinity

# Specifies the maximum file size
LimitFSIZE=infinity

# Disable timeout logic and wait until process is stopped
TimeoutStopSec=0

# SIGTERM signal is used to stop the Java process
KillSignal=SIGTERM

# Send the signal only to the JVM rather than its control group
KillMode=process

# Java process is never killed
SendSIGKILL=no

# When a JVM receives a SIGTERM signal it exits with code 143
SuccessExitStatus=143

# Allow a slow startup before the systemd notifier module kicks in to extend the timeout
TimeoutStartSec=75

#LimitMEMLOCK=infinity

[Install]
WantedBy=multi-user.target
</code></pre><p>启动服务</p>
<pre tabindex="0"><code>systemctl daemon-reload
systemctl enable elasticsearch
systemctl start elasticsearch
systemctl status elasticsearch
</code></pre><h3 id="x-pack插件">x-pack插件</h3>
<p>进入其中一台es安装机器，进入es安装目录，查看es所属用户，并执行su命令切换至es所属用户.</p>
<p>在es安装目录执行<code>./bin/elasticsearch-certutil ca</code>命令，生成CA证书</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>su - ops
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>ops@hwei-ng-public-elastic-prod-1 elasticsearch<span style="color:#000;font-weight:bold">]</span>$ bin/elasticsearch-certutil ca
</span></span><span style="display:flex;"><span>warning: usage of JAVA_HOME is deprecated, use ES_JAVA_HOME
</span></span><span style="display:flex;"><span>This tool assists you in the generation of X.509 certificates and certificate
</span></span><span style="display:flex;"><span>signing requests <span style="color:#000;font-weight:bold">for</span> use with SSL/TLS in the Elastic stack.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The <span style="color:#d14">&#39;ca&#39;</span> mode generates a new <span style="color:#d14">&#39;certificate authority&#39;</span>
</span></span><span style="display:flex;"><span>This will create a new X.509 certificate and private key that can be used
</span></span><span style="display:flex;"><span>to sign certificate when running in <span style="color:#d14">&#39;cert&#39;</span> mode.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Use the <span style="color:#d14">&#39;ca-dn&#39;</span> option <span style="color:#000;font-weight:bold">if</span> you wish to configure the <span style="color:#d14">&#39;distinguished name&#39;</span>
</span></span><span style="display:flex;"><span>of the certificate authority
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>By default the <span style="color:#d14">&#39;ca&#39;</span> mode produces a single PKCS#12 output file which holds:
</span></span><span style="display:flex;"><span>    * The CA certificate
</span></span><span style="display:flex;"><span>    * The CA<span style="color:#a61717;background-color:#e3d2d2">&#39;</span>s private key
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>If you elect to generate PEM format certificates <span style="color:#000;font-weight:bold">(</span>the -pem option<span style="color:#000;font-weight:bold">)</span>, <span style="color:#000;font-weight:bold">then</span> the output will
</span></span><span style="display:flex;"><span>be a zip file containing individual files <span style="color:#000;font-weight:bold">for</span> the CA certificate and private key
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Please enter the desired output file <span style="color:#000;font-weight:bold">[</span>elastic-stack-ca.p12<span style="color:#000;font-weight:bold">]</span>: 回车
</span></span><span style="display:flex;"><span>Enter password <span style="color:#000;font-weight:bold">for</span> elastic-stack-ca.p12 : 输入密码
</span></span></code></pre></td></tr></table>
</div>
</div><p>查询<code>elastic-stack-ca.p12</code>文件目录</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>ops@hwei-ng-public-elastic-prod-1 elasticsearch<span style="color:#000;font-weight:bold">]</span>$ realpath elastic-stack-ca.p12
</span></span><span style="display:flex;"><span>/opt/elasticsearch-7.12.0/elastic-stack-ca.p12
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建 <code>elastic-certificates.p12</code> 文件</p>
<pre tabindex="0"><code>[ops@hwei-ng-public-elastic-prod-1 elasticsearch]$ bin/elasticsearch-certutil cert --ca /opt/elasticsearch-7.12.0/elastic-stack-ca.p12
Enter password for CA (/opt/elasticsearch-7.12.0/elastic-stack-ca.p12) : 刚刚的密码
Please enter the desired output file [elastic-certificates.p12]: config/certs/elastic-certificates.p12
Directory /opt/elasticsearch-7.12.0/config/certs does not exist. Do you want to create it? [Y/n]y
Enter password for elastic-certificates.p12 : 回车
</code></pre><p>其他es服务器都创建certs
并将/opt/elasticsearch/config/certs/elastic-certificates.p12 拷贝过去
每台es服务器都编辑elasticsearch.yml，添加如下</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 开启xpack</span>
</span></span><span style="display:flex;"><span>xpack.security.enabled: <span style="color:#0086b3">true</span>
</span></span><span style="display:flex;"><span>xpack.security.transport.ssl.enabled: <span style="color:#0086b3">true</span>
</span></span><span style="display:flex;"><span>xpack.security.transport.ssl.verification_mode: certificate
</span></span><span style="display:flex;"><span>xpack.security.transport.ssl.keystore.path: certs/elastic-certificates.p12
</span></span><span style="display:flex;"><span>xpack.security.transport.ssl.truststore.path: certs/elastic-certificates.p12
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后重启每台es服务，相当于重启集群</p>
<p>找到第一台服务器，创建各种密码</p>
<pre tabindex="0"><code>[root@hwei-ng-public-elastic-prod-1 elasticsearch]# bin/elasticsearch-setup-passwords auto
warning: usage of JAVA_HOME is deprecated, use ES_JAVA_HOME
Initiating the setup of passwords for reserved users elastic,apm_system,kibana,kibana_system,logstash_system,beats_system,remote_monitoring_user.
The passwords will be randomly generated and printed to the console.
Please confirm that you would like to continue [y/N]y


Changed password for user apm_system
PASSWORD apm_system = vbIaWavxxx

Changed password for user kibana_system
PASSWORD kibana_system = nbwqfKxxx

Changed password for user kibana
PASSWORD kibana = nbwqfKXxxx

Changed password for user logstash_system
PASSWORD logstash_system = oBQqLfrxxx

Changed password for user beats_system
PASSWORD beats_system = US9ox5LGxxx

Changed password for user remote_monitoring_user
PASSWORD remote_monitoring_user = etFKmaUNxxx

Changed password for user elastic
PASSWORD elastic = 0pZnqTsYfGULIxxx
</code></pre><h3 id="集成ldap">集成LDAP</h3>
<p>修改es配置文件，添加如下内容</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ldap</span>
</span></span><span style="display:flex;"><span>xpack.security.authc.realms.ldap.ldap1.order: <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>xpack.security.authc.realms.ldap.ldap1.url: <span style="color:#d14">&#34;ldap://master-ldap.xxx.com:389&#34;</span>
</span></span><span style="display:flex;"><span>xpack.security.authc.realms.ldap.ldap1.bind_dn: <span style="color:#d14">&#34;cn=admin, dc=xxx, dc=com&#34;</span>
</span></span><span style="display:flex;"><span>xpack.security.authc.realms.ldap.ldap1.bind_password: <span style="color:#d14">&#34;abxxx12#</span>$<span style="color:#d14">&#34;</span>
</span></span><span style="display:flex;"><span>xpack.security.authc.realms.ldap.ldap1.user_search.base_dn: <span style="color:#d14">&#34;dc=xxx, dc=com&#34;</span>
</span></span><span style="display:flex;"><span>xpack.security.authc.realms.ldap.ldap1.user_search.filter: <span style="color:#d14">&#34;(cn={0})&#34;</span>
</span></span><span style="display:flex;"><span>xpack.security.authc.realms.ldap.ldap1.group_search.base_dn: <span style="color:#d14">&#34;cn=Users, dc=xxx, dc=com&#34;</span>
</span></span><span style="display:flex;"><span>xpack.security.authc.realms.ldap.ldap1.files.role_mapping: <span style="color:#d14">&#34;/opt/elasticsearch/config/role_mapping.yml&#34;</span>
</span></span><span style="display:flex;"><span>xpack.security.authc.realms.ldap.ldap1.unmapped_groups_as_roles: <span style="color:#0086b3">false</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>编辑role_mapping文件</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@hwei-ng-public-elastic-prod-1 config<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat role_mapping.yml</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Role mapping configuration file which has elasticsearch roles as keys</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># that map to one or more user or group distinguished names</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#roleA:   this is an elasticsearch role</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#  - groupA-DN  this is a group distinguished name</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#  - groupB-DN</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#  - user1-DN   this is the full user distinguished name</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#power_user:</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#  - &#34;cn=zhe.peng,dc=opayride,dc=com&#34;</span>
</span></span><span style="display:flex;"><span>user:
</span></span><span style="display:flex;"><span>  - <span style="color:#d14">&#34;cn=Users,dc=opayride,dc=com&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#  - &#34;cn=admins,dc=example,dc=com&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#  - &#34;cn=John Doe,cn=other users,dc=example,dc=com&#34;</span>
</span></span><span style="display:flex;"><span>superuser:
</span></span><span style="display:flex;"><span>  - <span style="color:#d14">&#34;cn=wuennan,cn=Users,dc=opayride,dc=com&#34;</span>
</span></span><span style="display:flex;"><span>kibana_admin:
</span></span><span style="display:flex;"><span>  - <span style="color:#d14">&#34;cn=Users,dc=opayride,dc=com&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>检查配置文件权限</p>
<pre tabindex="0"><code>[root@hwei-ng-public-elastic-prod-1 elasticsearch]# chown ops. /opt/elasticsearch/config/role_mapping.yml
[root@hwei-ng-public-elastic-prod-1 elasticsearch]# chmod 640 /opt/elasticsearch/config/role_mapping.yml
</code></pre><p><code>ldap</code>需要破解，替换<code>jar</code>包。</p>
<pre tabindex="0"><code>/opt/elasticsearch/modules/x-pack-core
mv x-pack-core-7.12.0.jar x-pack-core-7.12.0.jar`date +%F`
wget https://tools.wuennan.cn/software/x-pack-core-7.12.0.jar
chown ops. x-pack-core-7.12.0.jar
</code></pre><p>重启es集群即可。</p>
<h3 id="最终配置">最终配置</h3>
<pre tabindex="0"><code>[root@hwei-ng-public-elastic-prod-1 ~]# cat /opt/elasticsearch/config/elasticsearch.yml
cluster.name: ng-elk-es
node.name: node-1
path.data: /work/elasticsearch/data
path.logs: /work/elasticsearch/logs
bootstrap.memory_lock: true
network.host: 0.0.0.0
discovery.seed_hosts: [&#34;10.66.3.123&#34;, &#34;10.66.0.182&#34;, &#34;10.66.2.19&#34;]
cluster.initial_master_nodes: [&#34;node-1&#34;, &#34;node-2&#34;, &#34;node-3&#34;]
# 开启xpack
xpack.security.enabled: true
xpack.security.transport.ssl.enabled: true
xpack.security.transport.ssl.verification_mode: certificate
xpack.security.transport.ssl.keystore.path: certs/elastic-certificates.p12
xpack.security.transport.ssl.truststore.path: certs/elastic-certificates.p12
# ldap
xpack.security.authc.realms.ldap.ldap1.order: 0
xpack.security.authc.realms.ldap.ldap1.url: &#34;ldap://master-ldap.xxx.com:389&#34;
xpack.security.authc.realms.ldap.ldap1.bind_dn: &#34;cn=admin, dc=xxx, dc=com&#34;
xpack.security.authc.realms.ldap.ldap1.bind_password: &#34;abcxxx&#34;
xpack.security.authc.realms.ldap.ldap1.user_search.base_dn: &#34;dc=xxx, dc=com&#34;
xpack.security.authc.realms.ldap.ldap1.user_search.filter: &#34;(cn={0})&#34;
xpack.security.authc.realms.ldap.ldap1.group_search.base_dn: &#34;cn=Users, dc=xxx, dc=com&#34;
xpack.security.authc.realms.ldap.ldap1.files.role_mapping: &#34;/opt/elasticsearch/config/role_mapping.yml&#34;
xpack.security.authc.realms.ldap.ldap1.unmapped_groups_as_roles: false


[root@hwei-ng-public-elastic-prod-1 ~]# cat /opt/elasticsearch/config/role_mapping.yml
# Role mapping configuration file which has elasticsearch roles as keys
# that map to one or more user or group distinguished names

#roleA:   this is an elasticsearch role
#  - groupA-DN  this is a group distinguished name
#  - groupB-DN
#  - user1-DN   this is the full user distinguished name

#power_user:
#  - &#34;cn=zhe.peng,dc=opayride,dc=com&#34;
user:
  - &#34;cn=Users,dc=opayride,dc=com&#34;
#  - &#34;cn=admins,dc=example,dc=com&#34;
#  - &#34;cn=John Doe,cn=other users,dc=example,dc=com&#34;
superuser:
  - &#34;cn=wuennan,cn=Users,dc=opayride,dc=com&#34;
kibana_admin:
  - &#34;cn=Users,dc=opayride,dc=com&#34;
</code></pre><h2 id="cerebro">cerebro</h2>
<p>配置文需提前准备</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run --name cerebro -it -d -p 9000:9000 -v /work/docker/cerebro/conf/:/opt/cerebro/conf lmenezes/cerebro -Dplay.ws.ssl.loose.acceptAnyCertificate<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>配置文件中需要配置基础认证和es的信息。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@hwei-ng-public-kibana-prod-1 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># grep -Ev &#39;^[ ]*#|^#|^$&#39; /work/docker/cerebro/conf/application.conf</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">secret</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;ki:s:[[@=Ag?QI`W2jMwkY:eqvrJ]JqoJyi2axj3ZvOv^/KavOT4ViJSv?6YY4[N&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">basePath</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;/&#34;</span>
</span></span><span style="display:flex;"><span>pidfile.path<span style="color:#000;font-weight:bold">=</span>/dev/null
</span></span><span style="display:flex;"><span>rest.history.size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">50</span> // defaults to <span style="color:#099">50</span> <span style="color:#000;font-weight:bold">if</span> not specified
</span></span><span style="display:flex;"><span>data.path <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;./cerebro.db&#34;</span>
</span></span><span style="display:flex;"><span>play <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  server.http.port <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">${</span>?CEREBRO_PORT<span style="color:#d14">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">es</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#008080">gzip</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">true</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">auth</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  type: <span style="color:#d14">${</span>?AUTH_TYPE<span style="color:#d14">}</span>
</span></span><span style="display:flex;"><span>  settings <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#008080">url</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">${</span>?LDAP_URL<span style="color:#d14">}</span>
</span></span><span style="display:flex;"><span>    base-dn <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">${</span>?LDAP_BASE_DN<span style="color:#d14">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#008080">method</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">${</span>?LDAP_METHOD<span style="color:#d14">}</span>
</span></span><span style="display:flex;"><span>    user-template <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">${</span>?LDAP_USER_TEMPLATE<span style="color:#d14">}</span>
</span></span><span style="display:flex;"><span>    // User identifier that can perform searches
</span></span><span style="display:flex;"><span>    bind-dn <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">${</span>?LDAP_BIND_DN<span style="color:#d14">}</span>
</span></span><span style="display:flex;"><span>    bind-pw <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">${</span>?LDAP_BIND_PWD<span style="color:#d14">}</span>
</span></span><span style="display:flex;"><span>    group-search <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      // If left <span style="color:#0086b3">unset</span> parent<span style="color:#d14">&#39;s base-dn will be used
</span></span></span><span style="display:flex;"><span><span style="color:#d14">      base-dn = ${?LDAP_GROUP_BASE_DN}
</span></span></span><span style="display:flex;"><span><span style="color:#d14">      // Attribute that represent the user, for example uid or mail
</span></span></span><span style="display:flex;"><span><span style="color:#d14">      user-attr = ${?LDAP_USER_ATTR}
</span></span></span><span style="display:flex;"><span><span style="color:#d14">      // Define a separate template for user-attr
</span></span></span><span style="display:flex;"><span><span style="color:#d14">      // If left unset parent&#39;</span>s user-template will be used
</span></span><span style="display:flex;"><span>      user-attr-template <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">${</span>?LDAP_USER_ATTR_TEMPLATE<span style="color:#d14">}</span>
</span></span><span style="display:flex;"><span>      // Filter that tests membership of the group. If this property is empty <span style="color:#000;font-weight:bold">then</span> there is no group membership check
</span></span><span style="display:flex;"><span>      // AD <span style="color:#008080">example</span> <span style="color:#000;font-weight:bold">=</span>&gt; <span style="color:#008080">memberOf</span><span style="color:#000;font-weight:bold">=</span><span style="color:#008080">CN</span><span style="color:#000;font-weight:bold">=</span>mygroup,ou<span style="color:#000;font-weight:bold">=</span>ouofthegroup,DC<span style="color:#000;font-weight:bold">=</span>domain,DC<span style="color:#000;font-weight:bold">=</span>com
</span></span><span style="display:flex;"><span>      // OpenLDAP <span style="color:#008080">example</span> <span style="color:#000;font-weight:bold">=</span>&gt; <span style="color:#008080">CN</span><span style="color:#000;font-weight:bold">=</span>mygroup
</span></span><span style="display:flex;"><span>      <span style="color:#008080">group</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">${</span>?LDAP_GROUP<span style="color:#d14">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    // 需要配置基础认证
</span></span><span style="display:flex;"><span>    <span style="color:#008080">username</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;admin&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#008080">password</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;c0Bpxxx&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">hosts</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#008080">host</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;https://10.66.xx.xxx:9200&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#008080">name</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;ng-elk-es&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#008080">auth</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#008080">username</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;elastic&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#008080">password</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;0pxxxxxxxx&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>配置域名后，可通过浏览器访问</p>
<p><img src="https://images.snoopyops.top/image-20230404150719439.png" alt="image-20230404150719439"></p>
<h2 id="kibana">kibana</h2>
<h3 id="kibana部署">kibana部署</h3>
<p>下载并部署</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://artifacts.elastic.co/downloads/kibana/kibana-7.12.0-linux-x86_64.tar.gz
</span></span><span style="display:flex;"><span>tar xf kibana-7.12.0-linux-x86_64.tar.gz -C /opt/
</span></span><span style="display:flex;"><span>ln -s /opt/kibana-7.12.0-linux-x86_64 /opt/kibana
</span></span></code></pre></td></tr></table>
</div>
</div><p>编辑配置文件</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@hwei-ng-public-kibana-prod-1 config<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mv kibana.yml kibana.yml`date +%F`</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@hwei-ng-public-kibana-prod-1 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /opt/kibana/config/kibana.yml</span>
</span></span><span style="display:flex;"><span>server.host: <span style="color:#d14">&#34;0.0.0.0&#34;</span>
</span></span><span style="display:flex;"><span>elasticsearch.hosts: <span style="color:#000;font-weight:bold">[</span><span style="color:#d14">&#34;https://10.66.x.xxx:9200&#34;</span>,<span style="color:#d14">&#34;https://10.66.x.xxx:9200&#34;</span>,<span style="color:#d14">&#34;https://10.66.x.xxx:9200&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>elasticsearch.ssl.verificationMode: none
</span></span><span style="display:flex;"><span>logging.verbose: <span style="color:#0086b3">false</span>
</span></span><span style="display:flex;"><span>logging.dest: <span style="color:#d14">&#34;/work/logs/kibana/kibana.log&#34;</span>
</span></span><span style="display:flex;"><span>elasticsearch.shardTimeout: <span style="color:#099">2147483647</span>
</span></span><span style="display:flex;"><span>elasticsearch.requestTimeout: <span style="color:#099">2147483647</span>
</span></span><span style="display:flex;"><span>elasticsearch.username: <span style="color:#d14">&#34;kibana_system&#34;</span>
</span></span><span style="display:flex;"><span>elasticsearch.password: <span style="color:#d14">&#34;nbwqfxxxxxx&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建配置文件中所需要的目录</p>
<pre tabindex="0"><code>[root@hwei-ng-public-kibana-prod-1 ~]# chown -R ops. /opt/kibana*
</code></pre><p>配置systemd</p>
<pre tabindex="0"><code>[root@hwei-ng-public-kibana-prod-1 ~]# cat /etc/systemd/system/kibana.service
[Unit]
Description=Kibana
After=network.target

[Service]
Type=simple
User=ops
Group=ops
ExecStart=/opt/kibana/bin/kibana
Type=simple
PIDFile=/var/run/kibana.pid
Restart=always

[Install]
WantedBy=default.target
</code></pre><h3 id="权限配置">权限配置</h3>
<p>为普通用户创建 <code>role</code></p>
<p><img src="https://images.snoopyops.top/image-20230410175628332.png" alt="image-20230410175628332"></p>
<p>为普通用户绑定角色</p>
<p><img src="https://images.snoopyops.top/image-20230410175901416.png" alt="image-20230410175901416"></p>
<p>为管理员绑定角色</p>
<p><img src="https://images.snoopyops.top/image-20230411162017682.png" alt="image-20230411162017682"></p>
<h2 id="es优化">ES优化</h2>
<h3 id="分片与副本数量">分片与副本数量</h3>
<p>针对日志类，推荐1个分片和1个副本。</p>
<p>基于日期的索引需求, 并且对索引数据的搜索场景非常少. 也许这些索引量将达到成百上千, 但每个索引的数据量只有1GB甚至更小. 对于这种类似场景, 我建议你只需要为索引分配1个分片.</p>
<p>大部分的Logstash用户并不会频繁的进行搜索, 甚至每分钟都不会有一次查询. 所以这种场景, 推荐更为经济使用的设置. 在这种场景下, 搜索性能并不是第一要素, 所以并不需要很多副本. 维护单个副本用于数据冗余已经足够. 不过数据被不断载入到内存的比例相应也会变高.</p>
<h3 id="索引保存时长">索引保存时长</h3>
<p>保存90天的索引数据</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># cat /opt/script/es_index_delete.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#!/bin/bash</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#es_index_delete.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">LAST_DATA</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">`</span>date -d <span style="color:#d14">&#34;-90 days&#34;</span> <span style="color:#d14">&#34;+%Y.%m.%d&#34;</span><span style="color:#d14">`</span> <span style="color:#998;font-style:italic">#删除90天前索引数据  &#34;+%Y.%m.%d&#34; &#34;+%Y-%m-%d&#34; 注意时间标识区别. -</span>
</span></span><span style="display:flex;"><span>curl -u elastic:0pxxxxxxxx -XDELETE http://10.66.3.123:9200/*-<span style="color:#d14">${</span><span style="color:#008080">LAST_DATA</span><span style="color:#d14">}</span>
</span></span><span style="display:flex;"><span><span style="color:#0086b3">exit</span> <span style="color:#099">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="快照及恢复">快照及恢复</h3>
<p>http://47.104.6.100/w/%E8%BF%90%E7%BB%B4%E6%96%87%E6%A1%A3/%E8%BF%90%E7%BB%B4%E4%B8%9A%E5%8A%A1/efk/efk%E6%AD%A3%E5%BC%8F%E6%90%AD%E5%BB%BA/es%E9%9B%86%E7%BE%A4%E7%9A%84%E6%90%AD%E5%BB%BA/snapshot%E4%BB%93%E5%BA%93/</p>
<h2 id="新增一个节点">新增一个节点</h2>
<p>根据ES安装步骤安装es，最终配置为</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@hwei-ng-public-elastic-prod-4 config<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat elasticsearch.yml</span>
</span></span><span style="display:flex;"><span>cluster.name: ng-elk-es
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 节点名称</span>
</span></span><span style="display:flex;"><span>node.name: node-4
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 非master节点</span>
</span></span><span style="display:flex;"><span>node.master: <span style="color:#0086b3">false</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 新增的为data节点</span>
</span></span><span style="display:flex;"><span>node.data: <span style="color:#0086b3">true</span>
</span></span><span style="display:flex;"><span>path.data: /work/elasticsearch/data
</span></span><span style="display:flex;"><span>path.logs: /work/elasticsearch/logs
</span></span><span style="display:flex;"><span>bootstrap.memory_lock: <span style="color:#0086b3">true</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 节点IP</span>
</span></span><span style="display:flex;"><span>network.host: 10.66.1.85
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 添加此节点</span>
</span></span><span style="display:flex;"><span>discovery.seed_hosts: <span style="color:#000;font-weight:bold">[</span><span style="color:#d14">&#34;10.66.3.123&#34;</span>, <span style="color:#d14">&#34;10.66.0.182&#34;</span>, <span style="color:#d14">&#34;10.66.2.19&#34;</span>,<span style="color:#d14">&#34;10.66.1.85&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>cluster.initial_master_nodes: <span style="color:#000;font-weight:bold">[</span><span style="color:#d14">&#34;node-1&#34;</span>, <span style="color:#d14">&#34;node-2&#34;</span>, <span style="color:#d14">&#34;node-3&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 开启xpack</span>
</span></span><span style="display:flex;"><span>xpack.security.enabled: <span style="color:#0086b3">true</span>
</span></span><span style="display:flex;"><span>xpack.security.transport.ssl.enabled: <span style="color:#0086b3">true</span>
</span></span><span style="display:flex;"><span>xpack.security.transport.ssl.verification_mode: certificate
</span></span><span style="display:flex;"><span>xpack.security.transport.ssl.keystore.path: certs/elastic-certificates.p12
</span></span><span style="display:flex;"><span>xpack.security.transport.ssl.truststore.path: certs/elastic-certificates.p12
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#xpack.security.http.ssl.enabled: true</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#xpack.security.http.ssl.keystore.path: certs/elastic-certificates.p12</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#xpack.security.http.ssl.truststore.path: certs/elastic-certificates.p12</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#xpack.security.http.ssl.client_authentication: none</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#xpack.security.http.ssl.verification_mode: none</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ldap</span>
</span></span><span style="display:flex;"><span>xpack.security.authc.realms.ldap.ldap1.order: <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>xpack.security.authc.realms.ldap.ldap1.url: <span style="color:#d14">&#34;ldap://master-ldap.opayride.com:389&#34;</span>
</span></span><span style="display:flex;"><span>xpack.security.authc.realms.ldap.ldap1.bind_dn: <span style="color:#d14">&#34;cn=admin, dc=opayride, dc=com&#34;</span>
</span></span><span style="display:flex;"><span>xpack.security.authc.realms.ldap.ldap1.bind_password: <span style="color:#d14">&#34;abcD@12#</span>$<span style="color:#d14">&#34;</span>
</span></span><span style="display:flex;"><span>xpack.security.authc.realms.ldap.ldap1.user_search.base_dn: <span style="color:#d14">&#34;dc=opayride, dc=com&#34;</span>
</span></span><span style="display:flex;"><span>xpack.security.authc.realms.ldap.ldap1.user_search.filter: <span style="color:#d14">&#34;(cn={0})&#34;</span>
</span></span><span style="display:flex;"><span>xpack.security.authc.realms.ldap.ldap1.group_search.base_dn: <span style="color:#d14">&#34;cn=Users, dc=opayride, dc=com&#34;</span>
</span></span><span style="display:flex;"><span>xpack.security.authc.realms.ldap.ldap1.files.role_mapping: <span style="color:#d14">&#34;/opt/elasticsearch/config/role_mapping.yml&#34;</span>
</span></span><span style="display:flex;"><span>xpack.security.authc.realms.ldap.ldap1.unmapped_groups_as_roles: <span style="color:#0086b3">false</span>
</span></span><span style="display:flex;"><span>http.max_content_length: 500mb
</span></span></code></pre></td></tr></table>
</div>
</div><p>其他节点的<code>discovery.seed_hosts</code>也要新增新的节点。</p>
<p>如下图 node-4为新增的data节点。</p>
<p><img src="https://images.snoopyops.top/image-20230925230411021.png" alt="image-20230925230411021"></p>

    </div>
    
    

    
</div>

            </div>
            <div id="footer"><div class="container-footer">
    
    

    <div class="beian">
        
        <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=">
            

        </a>

        <a href="" target="_blank">
            
            <span class="some">icp...<span>
            
        </a>
    </div>

    <div class="info">
        <a href="https://github.com/loveminimal/hugo-theme-virgo">Copyright</a> ©  - <span id="info-date"></span>
    </div>

</div></div>
        </div>
        <div class="cool-after" style="background-color: rgba(255, 255, 255, 0.81);"></div>
    </body>
</html>
<link href="https://qiniu.techgrow.cn/readmore/dist/readmore.css" type="text/css" rel="stylesheet">
<script src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script>
<script>
    var regex = /(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i
    var isMobile = navigator.userAgent.match(regex);
    if (!isMobile) {
        try {
            var plugin = new ReadmorePlugin();
            plugin.init({
                id: "readmore-container",
                blogId: "25525-2853989927488-092",
                name: "史努比会点运维",
                keyword: "验证码",
                qrcode: "https://images.snoopyops.top/wechat/wechat_snoopyops.jpg",
                type: "hugo",
                height: "auto",
                expires: "7",
                interval: "60",
                random: "1"
            })
        } catch (e) {
            console.warn("readmore plugin occurred error: " + e.name + " | " + e.message);
        }
    }
</script>
