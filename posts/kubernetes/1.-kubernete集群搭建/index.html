<!DOCTYPE html>
<html lang="zh-CN"><head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <meta name="description" content="1. Kubernetes集群搭建 - https://www.snoopyops.top/posts/kubernetes/1.-kubernete%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/">
    <meta name="author" content="snoopy - https://www.snoopyops.top/">
    
    <meta name="msvalidate.01" content="B46311949B856F2A7015F366FB3CE878" />
    <title>1. Kubernetes集群搭建</title>
    <link rel="icon" type="image/png" href="/favicon.ico">
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/lxgw-wenkai-webfont/1.7.0/style.min.css" />
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/lxgw-wenkai-screen-webfont/1.7.0/style.min.css" />
    
    <link rel="stylesheet" href="https://www.snoopyops.top/style.min.6bbccf0916939df698171c34d30f896276712c30bd56be0d7fd8023e1b00c3d9.css">
    
    <script type="text/javascript" src="/main.js" defer></script>
    
    
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?080713f769977324f1fbafc95c5fa4c6";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
</head>
<body class="active-animate cool">
        <div class="cool-before" style="background: url('/imgs/bg/foxgirl.jpg') center center/cover no-repeat fixed;"></div>
        <div id="readmore-container">
            <div id="header" class=""><div class="container-header">
    
    
    <div class="right">
        
        <h1 class="title">1. Kubernetes集群搭建</h1>
    
        
            
            <div id="toc">📜</div>
        
    </div>
</div>
</div>
            <div id="content">










<div class="container-main container-page ">

    <div class="desc">
        
        <span>
            
            <svg t="1656736000388" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7409" width="12" height="12"><path d="M524.885333 338.986667L200.362667 663.466667c-17.28 15.274667-27.989333 36.693333-29.696 56.234666v133.76l130.730666 0.085334c22.784-1.621333 43.989333-12.245333 61.013334-31.701334l322.688-322.645333-160.213334-160.213333z m60.373334-60.330667l160.170666 160.213333 102.144-102.144a19.712 19.712 0 0 0 0-27.861333L715.093333 176.426667a19.456 19.456 0 0 0-27.605333 0L585.258667 278.613333zM701.312 85.333333c27.946667 0 54.741333 11.136 74.282667 30.848l132.309333 132.309334a105.045333 105.045333 0 0 1 0 148.565333L424.874667 879.957333c-29.824 34.346667-72.106667 55.466667-120.448 58.794667H85.333333v-42.666667l0.128-179.84c3.626667-44.970667 24.576-86.826667 56.448-114.944l485.12-485.034666A104.789333 104.789333 0 0 1 701.269333 85.333333z" p-id="7410" fill="#adb5bd"></path></svg>
            2023-05-11&nbsp;&nbsp;&nbsp;
            <svg t="1656737270708" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="23838" width="11" height="11"><path d="M824.264 95.36c0-23.859 25.043-44.16 48.902-44.16s49.714 20.301 49.714 44.16v190.08c0 23.859-19.054 52.868-42.913 52.868h-190.08c-23.859 0-46.696-25.96-46.696-49.819s22.55-46.249 46.409-46.249h82.025C702.344 175.534 610.22 155.853 512 155.853c-206.775 0-360.398 149.372-360.398 356.147 0 206.775 153.623 358.23 360.398 358.23 206.775 0 357.467-151.455 357.467-358.23 0-23.859 23.634-50.706 53.413-50.706 29.78 0 49.92 26.847 49.92 50.706 0 254.493-206.307 460.8-460.8 460.8-254.493 0-460.8-206.307-460.8-460.8C51.2 257.507 257.507 51.2 512 51.2c122.4 0 226.684 33.296 312.264 117.369 0.358 0.351 0.358-24.052 0-73.209z" p-id="23839" fill="#adb5bd"></path></svg>
            2023-12-06&nbsp;&nbsp;&nbsp;
        </span>
        <span>
            
            <svg t="1656737548689" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="33866" width="12" height="12"><path d="M832.038608 64.662657H192.030028C121.255125 64.662657 63.940169 121.98845 63.940169 192.694717v446.793671C63.940169 710.205493 121.255125 767.643272 192.030028 767.643272h133.353183a63.940169 63.940169 0 0 1 55.219742 31.576328l76.099638 129.83828c12.358154 21.093031 33.790754 31.626903 55.216129 31.626903s42.832688-10.544709 55.198067-31.619678l76.222461-129.870792a63.940169 63.940169 0 0 1 55.212517-31.551041h133.54103c70.576219 0 127.732228-57.289669 127.732227-127.800865V192.391272C959.825022 121.85479 902.643727 64.662657 832.038608 64.662657zM895.884854 639.842407A63.85347 63.85347 0 0 1 832.092795 703.703103h-133.54103a127.753903 127.753903 0 0 0-110.349172 63.09847l-76.222461 129.856342a0.274545 0.274545 0 0 1 0-0.050574h-0.032512s-0.021675 0.061411-0.032512 0.061412l-76.1466-129.85273A127.804477 127.804477 0 0 0 325.383211 703.703103H192.030028A64.207489 64.207489 0 0 1 127.880338 639.488388V192.694717A64.102729 64.102729 0 0 1 192.030028 128.602826h640.00858A63.799284 63.799284 0 0 1 895.884854 192.391272v447.451135z" fill="#adb5bd" p-id="33867"></path><path d="M608.154093 288.092004A31.970084 31.970084 0 0 0 576.184009 320.062089v160.078006l-134.650049-179.278119A31.970084 31.970084 0 0 0 384.002258 320.062089v255.760676a31.970084 31.970084 0 0 0 63.940169 0v-159.958796l134.650048 179.274507a31.970084 31.970084 0 0 0 57.531703-19.200113V320.062089a31.970084 31.970084 0 0 0-31.970085-31.970085z" fill="#adb5bd" p-id="33868"></path></svg>
            17637 字</span>&nbsp;
        <span>
            
            <svg t="1656737462334" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="32892" width="12" height="12"><path d="M512 74.666667C270.933333 74.666667 74.666667 270.933333 74.666667 512S270.933333 949.333333 512 949.333333 949.333333 753.066667 949.333333 512 753.066667 74.666667 512 74.666667z m0 810.666666c-204.8 0-373.333333-168.533333-373.333333-373.333333S307.2 138.666667 512 138.666667 885.333333 307.2 885.333333 512 716.8 885.333333 512 885.333333z" p-id="32893" fill="#adb5bd"></path><path d="M695.466667 567.466667l-151.466667-70.4V277.333333c0-17.066667-14.933333-32-32-32s-32 14.933333-32 32v238.933334c0 12.8 6.4 23.466667 19.2 29.866666l170.666667 81.066667c4.266667 2.133333 8.533333 2.133333 12.8 2.133333 12.8 0 23.466667-6.4 29.866666-19.2 6.4-14.933333 0-34.133333-17.066666-42.666666z" p-id="32894" fill="#adb5bd"></path></svg>
            36 分钟</span>
            <div class="container-ctgtag">
	<div class="taxonomy">
		<div class="tag">
			
			
		</div>
	</div>
</div>
        
    </div>
    
    <div class="toc">
        <div class="container-page-operation">
	<div class="page-operation">
		<div><a href="/"><img src="/imgs/icons/home-2.svg" alt=""></a></div>
		<div><a href="/nav"><img src="/imgs/icons/iov-navigate-1.svg" alt=""></a></div>
		<div><a href="/tags"><img src="/imgs/icons/treetags.svg" alt=""></a></div>
		<div id="light-dark"><a><img src="/imgs/icons/moon2.svg" alt=""></a></div>
		<div><a href="#"><img src="/imgs/icons/up2.svg" alt=""></a></div>
	</div>
</div>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#一环境准备">一、环境准备</a>
      <ul>
        <li><a href="#1-k8s核心组件">1. K8S核心组件</a></li>
        <li><a href="#2-k8s中的三种网络">2. K8S中的三种网络</a></li>
        <li><a href="#3-ip规划及实验拓扑">3. IP规划及实验拓扑</a></li>
      </ul>
    </li>
    <li><a href="#二基础服务准备">二、基础服务准备</a>
      <ul>
        <li><a href="#1-dns服务初始化">1. DNS服务初始化</a></li>
        <li><a href="#2-准备签发证书环境">2. 准备签发证书环境</a></li>
        <li><a href="#3-部署docker环境">3. 部署Docker环境</a></li>
        <li><a href="#4-部署harbor仓库">4. 部署Harbor仓库</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#1-部署etcd集群">1. 部署etcd集群</a></li>
        <li><a href="#2-部署api-server">2. 部署api-server</a></li>
        <li><a href="#3-四层负载均衡">3. 四层负载均衡</a></li>
        <li><a href="#4-安装kube-controller-manager">4. 安装kube-controller-manager</a></li>
        <li><a href="#5-安装kube-scheduler">5. 安装kube-scheduler</a></li>
        <li><a href="#6-部署kubelet">6. 部署Kubelet</a></li>
        <li><a href="#7-部署kube-proxy">7. 部署kube-proxy</a></li>
        <li><a href="#8-集群验证">8. 集群验证</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#1-陈述式资源管理">1. 陈述式资源管理</a></li>
        <li><a href="#2-声明式资源管理">2. 声明式资源管理</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#1-ingress部署">1. Ingress部署</a></li>
        <li><a href="#2-验证">2. 验证</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#1-dashboard部署">1 Dashboard部署</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#1-环境准备">1. 环境准备</a></li>
        <li><a href="#2-集群升级">2. 集群升级</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>

    <div class='content  '>
        <h1 id="kubernete集群搭建">Kubernete集群搭建</h1>
<h2 id="一环境准备">一、环境准备</h2>
<h3 id="1-k8s核心组件">1. K8S核心组件</h3>
<p>K8S的逻辑架构图如下：</p>
<p><img src="https://images.wuennan.cn/image-20200818224330086.png" alt="image-20200818224330086"></p>
<p><strong>etcd</strong>：保存了整个集群的状态，就是一个数据库。</p>
<h4 id="11-主控master节点">1.1 主控（master）节点</h4>
<p><strong>apiserver</strong></p>
<ul>
<li>提供 了集群的REST API接口（包括鉴权、数据校验及集群状态变更）</li>
<li>负责其他模块质检的数据交互，承担通信枢纽功能。</li>
<li>是资源配额控制的入口。</li>
<li>提供完备的集群安全机制。</li>
</ul>
<p><strong>controller-manager</strong></p>
<ul>
<li>由一系列控制器组成，通过 <code>apiserver</code> 监控整个整个集群的状态，并确保集群处于预期的工作状态</li>
<li>Node Controller</li>
<li>Deployment Controller</li>
<li>Service  Controller</li>
<li>Volume Controller</li>
<li>&hellip;</li>
</ul>
<p><strong>scheduler</strong></p>
<ul>
<li>接收调度 pod 到合适的运算节点上。</li>
<li>预算策略（predict）</li>
<li>优选策略（priorities）</li>
</ul>
<h4 id="12-运算node节点">1.2 运算（node）节点</h4>
<p><strong>kube-kubelet</strong></p>
<ul>
<li>定时从某个地方获取节点上 <code>pod</code> 的期望状态（运行什么容器、运行的副本数量、网络或者存储如何配置等等），并调用对应的容器平台接口达到这个状态。</li>
<li>定时汇报当前节点的状态给 <code>apiserver</code> ，以供调度的时候 使用</li>
<li>镜像和容器的清理工作，保证节点上镜像不会占满磁盘空间，退出的容器不会占用太多的资源</li>
</ul>
<p><strong>kube-proxy</strong></p>
<ul>
<li>K8S在每个节点上运行网络代理，service资源的载体(server是kube-proxy通过创建iptables或者lvs的规则实现的)。</li>
<li>建立 <code>pod</code> 网络和集群网络的的关系（ClusterIP -&gt; podIP）</li>
<li>常见的三种流量调度模式
<ul>
<li>Userspace（废弃）</li>
<li>Iptables（濒临废弃）</li>
<li>Ipvs（推荐）</li>
</ul>
</li>
<li>负责建立和删除包括更新调度规则、通知 <code>apiserver</code> 自己更新，或从 <code>apiserver</code> 那里获取其他 <code>kube-proxy</code>  的调度规则变化来更新自己的。</li>
</ul>
<h3 id="2-k8s中的三种网络">2. K8S中的三种网络</h3>
<p>K8S中默认有如下三种网络</p>
<ul>
<li>
<p>Node 网络</p>
</li>
<li>
<p>Service 网络</p>
</li>
<li>
<p>Pod 网络</p>
</li>
</ul>
<p><img src="https://images.wuennan.cn/image-20200818082131316.png" alt="image-20200818082131316"></p>
<h3 id="3-ip规划及实验拓扑">3. IP规划及实验拓扑</h3>
<p>推荐 <code>2C4G</code> 及以上配置</p>
<table>
<thead>
<tr>
<th>IP</th>
<th>主机名</th>
<th>角色</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.199.11</td>
<td>192-168-199-11</td>
<td>代理节点1</td>
</tr>
<tr>
<td>192.168.199.12</td>
<td>192-168-199-12</td>
<td>代理节点2</td>
</tr>
<tr>
<td>192.168.199.13</td>
<td>192-168-199-13</td>
<td>运算节点1</td>
</tr>
<tr>
<td>192.168.199.14</td>
<td>192-168-199-14</td>
<td>运算节点2</td>
</tr>
<tr>
<td>192.168.199.15</td>
<td>192-168-199-15</td>
<td>运维节点</td>
</tr>
</tbody>
</table>
<p>实验拓扑图</p>
<p><img src="https://images.wuennan.cn/image-20200821075109370.png" alt="image-20200821075109370"></p>
<h2 id="二基础服务准备">二、基础服务准备</h2>
<h3 id="1-dns服务初始化">1. DNS服务初始化</h3>
<p>通过 <code>Bind9</code> 提供域名解析服务，<code>Ingress</code> 可根据域名的访问实现七层调度。</p>
<h4 id="11-安装bind9">1.1 安装Bind9</h4>
<p>主要在 <code>192.168.199.11</code> 上操作，安装时请注意主机名</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># yum install bind -y</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># rpm -qa bind</span>
</span></span><span style="display:flex;"><span>bind-9.11.4-16.P2.el7_8.6.x86_64
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="12-配置bind9">1.2 配置Bind9</h4>
<p>修改主配置文件</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># vim /etc/named.conf</span>
</span></span><span style="display:flex;"><span>listen-on port <span style="color:#099">53</span> <span style="color:#000;font-weight:bold">{</span> 192.168.199.11; <span style="color:#000;font-weight:bold">}</span>;
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ipv6可删除，allow-query指定哪些主机可以使用此服务查询域名</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># allow-query指定可以使用此DNS的主机</span>
</span></span><span style="display:flex;"><span>allow-query     <span style="color:#000;font-weight:bold">{</span> any; <span style="color:#000;font-weight:bold">}</span>;
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># forwarders指向上层DNS，需要单独添加，我在此次填写的网关</span>
</span></span><span style="display:flex;"><span>forwarders      <span style="color:#000;font-weight:bold">{</span> 192.168.199.1; <span style="color:#000;font-weight:bold">}</span>;
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 递归查询</span>
</span></span><span style="display:flex;"><span>recursion yes;
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># DNS安全扩展，对域名进行签名认证，保证域名的完整性和正确性，不会被修改，为节省资源可关闭</span>
</span></span><span style="display:flex;"><span>dnssec-enable no;
</span></span><span style="display:flex;"><span>dnssec-validation no;
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>DNS默认有递归查询和迭代查询两种方式</p>
<p>递归查询：只要发出递归查询，服务器必须回答目标IP与域名的映射关系。</p>
<p>迭代查询：服务器收到一次迭代查询，回复一次结果，这个结果可能是目标IP与域名的映射关系，也可能是其他DNS服务器的地址。</p>
<p><img src="https://images.wuennan.cn/image-20200818233400890.png" alt="image-20200818233400890"></p>
</blockquote>
<p>检查配置文件，正常情况无输出</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># named-checkconf</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>配置主机域和业务域</strong>
修改域配置文件，在 <code>/etc/named.rfc1912.zones</code> 最下方添加如下内容</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>zone <span style="color:#d14">&#34;host.com&#34;</span> IN <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0086b3">type</span>  master;
</span></span><span style="display:flex;"><span>        file  <span style="color:#d14">&#34;host.com.zone&#34;</span>;
</span></span><span style="display:flex;"><span>        allow-update <span style="color:#000;font-weight:bold">{</span> 192.168.199.11; <span style="color:#000;font-weight:bold">}</span>;
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>zone <span style="color:#d14">&#34;od.com&#34;</span> IN <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0086b3">type</span>  master;
</span></span><span style="display:flex;"><span>        file  <span style="color:#d14">&#34;od.com.zone&#34;</span>;
</span></span><span style="display:flex;"><span>        allow-update <span style="color:#000;font-weight:bold">{</span> 192.168.199.11; <span style="color:#000;font-weight:bold">}</span>;
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>配置主机域数据文件</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /var/named/host.com.zone</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">$ORIGIN</span> host.com.
</span></span><span style="display:flex;"><span><span style="color:#008080">$TTL</span> <span style="color:#099">600</span>        ; <span style="color:#099">10</span> minutes
</span></span><span style="display:flex;"><span>@       IN SOA  dns.host.com. dnsadmin.host.com. <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">2020052701</span> ; serial
</span></span><span style="display:flex;"><span>                                <span style="color:#099">10800</span>      ; refresh <span style="color:#000;font-weight:bold">(</span><span style="color:#099">3</span> hours<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">900</span>        ; retry <span style="color:#000;font-weight:bold">(</span><span style="color:#099">15</span> minutes<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">604800</span>     ; expire <span style="color:#000;font-weight:bold">(</span><span style="color:#099">1</span> week<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">86400</span>      ; minimum <span style="color:#000;font-weight:bold">(</span><span style="color:#099">1</span> day<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                        NS   dns.host.com.
</span></span><span style="display:flex;"><span><span style="color:#008080">$TTL</span> <span style="color:#099">60</span> ; <span style="color:#099">1</span> minute
</span></span><span style="display:flex;"><span>dns                     A    192.168.199.11
</span></span><span style="display:flex;"><span>192-168-199-11          A    192.168.199.11
</span></span><span style="display:flex;"><span>192-168-199-12          A    192.168.199.12
</span></span><span style="display:flex;"><span>192-168-199-13          A    192.168.199.13
</span></span><span style="display:flex;"><span>192-168-199-14          A    192.168.199.14
</span></span><span style="display:flex;"><span>192-168-199-15          A    192.168.199.15
</span></span></code></pre></td></tr></table>
</div>
</div><p>配置业务域数据文件</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /var/named/od.com.zone</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">$ORIGIN</span> od.com.
</span></span><span style="display:flex;"><span><span style="color:#008080">$TTL</span> <span style="color:#099">600</span>        ; <span style="color:#099">10</span> minutes
</span></span><span style="display:flex;"><span>@               IN SOA  dns.od.com. dnsadmin.od.com. <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">2020052701</span> ; serial
</span></span><span style="display:flex;"><span>                                <span style="color:#099">10800</span>      ; refresh <span style="color:#000;font-weight:bold">(</span><span style="color:#099">3</span> hours<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">900</span>        ; retry <span style="color:#000;font-weight:bold">(</span><span style="color:#099">15</span> minutes<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">604800</span>     ; expire <span style="color:#000;font-weight:bold">(</span><span style="color:#099">1</span> week<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">86400</span>      ; minimum <span style="color:#000;font-weight:bold">(</span><span style="color:#099">1</span> day<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                NS   dns.od.com.
</span></span><span style="display:flex;"><span><span style="color:#008080">$TTL</span> <span style="color:#099">60</span> ; <span style="color:#099">1</span> minute
</span></span><span style="display:flex;"><span>dns                A    192.168.199.11
</span></span></code></pre></td></tr></table>
</div>
</div><p>检查配置文件</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># named-checkconf</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>启动服务</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># systemctl start named</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># systemctl enable named</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="13-验证">1.3 验证</h4>
<p>验证服务是否正常启动</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># netstat -lnutp | grep 53</span>
</span></span><span style="display:flex;"><span>tcp        <span style="color:#099">0</span>      <span style="color:#099">0</span> 127.0.0.1:953           0.0.0.0:*               LISTEN      1804/named
</span></span><span style="display:flex;"><span>tcp        <span style="color:#099">0</span>      <span style="color:#099">0</span> 192.168.199.11:53       0.0.0.0:*               LISTEN      1804/named
</span></span><span style="display:flex;"><span>tcp6       <span style="color:#099">0</span>      <span style="color:#099">0</span> ::1:953                 :::*                    LISTEN      1804/named
</span></span><span style="display:flex;"><span>udp        <span style="color:#099">0</span>      <span style="color:#099">0</span> 192.168.199.11:53       0.0.0.0:*                           1804/named
</span></span></code></pre></td></tr></table>
</div>
</div><p>测试通过 <code>192.168.199.11</code> 是否能够解析 <code>192-168-199-14.host.com</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># dig -t A 192-168-199-14.host.com @192.168.199.11 +short</span>
</span></span><span style="display:flex;"><span>192.168.199.14
</span></span></code></pre></td></tr></table>
</div>
</div><p>修改所有主机的<strong>网卡配置文件</strong>，指定<code>DNS1=192.168.199.11</code> ，并重启网卡
修改 <code>/etc/resolv.conf</code> 文件，再第一行添加 <code>search host.com </code> 使其支持短域名。业务域不推荐使用短域名。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/resolv.conf</span>
</span></span><span style="display:flex;"><span>search host.com
</span></span><span style="display:flex;"><span>nameserver 192.168.199.11
</span></span><span style="display:flex;"><span>nameserver 223.5.5.5
</span></span></code></pre></td></tr></table>
</div>
</div><p>测试</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ping 192-168-199-12</span>
</span></span><span style="display:flex;"><span>PING 192-168-199-12.host.com <span style="color:#000;font-weight:bold">(</span>192.168.199.12<span style="color:#000;font-weight:bold">)</span> 56<span style="color:#000;font-weight:bold">(</span>84<span style="color:#000;font-weight:bold">)</span> bytes of data.
</span></span><span style="display:flex;"><span><span style="color:#099">64</span> bytes from 192.168.199.12 <span style="color:#000;font-weight:bold">(</span>192.168.199.12<span style="color:#000;font-weight:bold">)</span>: <span style="color:#008080">icmp_seq</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">1</span> <span style="color:#008080">ttl</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">64</span> <span style="color:#008080">time</span><span style="color:#000;font-weight:bold">=</span>0.370 ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ping baidu.com</span>
</span></span><span style="display:flex;"><span>PING baidu.com <span style="color:#000;font-weight:bold">(</span>220.181.38.148<span style="color:#000;font-weight:bold">)</span> 56<span style="color:#000;font-weight:bold">(</span>84<span style="color:#000;font-weight:bold">)</span> bytes of data.
</span></span><span style="display:flex;"><span><span style="color:#099">64</span> bytes from 220.181.38.148 <span style="color:#000;font-weight:bold">(</span>220.181.38.148<span style="color:#000;font-weight:bold">)</span>: <span style="color:#008080">icmp_seq</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">1</span> <span style="color:#008080">ttl</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">49</span> <span style="color:#008080">time</span><span style="color:#000;font-weight:bold">=</span>12.3 ms
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="2-准备签发证书环境">2. 准备签发证书环境</h3>
<h4 id="21-准备所需软件">2.1 准备所需软件</h4>
<p>K8S 中所有通信需要依赖证书，常用的签发证书工具有 <code>openssl</code> 和 <code>cfssl</code></p>
<p>主要在 <code>192.168,199.15</code> 上操作，下载所需软件包，修改权限后并验证</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 下载所需软件包</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -O /usr/bin/cfssl</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -O /usr/bin/cfssl-json</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 -O /usr/bin/cfssl-certinfo</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#修改权限</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># chmod +x /usr/bin/cfssl*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#验证</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># which cfssl</span>
</span></span><span style="display:flex;"><span>/usr/bin/cfssl
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># which cfssl-json</span>
</span></span><span style="display:flex;"><span>/usr/bin/cfssl-json
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># which cfssl-certinfo</span>
</span></span><span style="display:flex;"><span>/usr/bin/cfssl-certinfo
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="22-签发证书">2.2 签发证书</h4>
<p>需要创建根证书</p>
<p>创建生成 <code>CA</code> 证书签名请求（<code>csr</code>）的 <code>JSON</code> 配置文件</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># vim /opt/certs/ca-csr.json</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;CN&#34;</span>: <span style="color:#d14">&#34;OldboyEdu&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;hosts&#34;</span>: <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">]</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;key&#34;</span>: <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;algo&#34;</span>: <span style="color:#d14">&#34;rsa&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;size&#34;</span>: <span style="color:#099">2048</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;names&#34;</span>: <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;C&#34;</span>: <span style="color:#d14">&#34;CN&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;ST&#34;</span>: <span style="color:#d14">&#34;beijing&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;L&#34;</span>: <span style="color:#d14">&#34;beijing&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;O&#34;</span>: <span style="color:#d14">&#34;od&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;OU&#34;</span>: <span style="color:#d14">&#34;ops&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">]</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;ca&#34;</span>: <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;expiry&#34;</span>: <span style="color:#d14">&#34;175200h&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>CN：一般写的是域名，非常重要，浏览器使用该字段验证网站是否合法
C：国家
ST：州，省
L：地区，城市
O：组织名称，公司名称
OU：组织单位名称，公司部门
expiry：证书过期时间，kubeadmin自签证书默认有效期为1年</p>
</blockquote>
<p>生成 <code>CA</code> 证书和私钥</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /opt/certs/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cfssl gencert -initca ca-csr.json | cfssl-json -bare ca</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># cfssl gencert -initca ca-csr.json 可生成密钥文件，通过管道的方式将生成的证书传输到文件中</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 主要使用的是ca.pem 和 ca-key.pem</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ll</span>
</span></span><span style="display:flex;"><span>total <span style="color:#099">16</span>
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root  <span style="color:#099">993</span> May <span style="color:#099">27</span> 23:06 ca.csr
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root  <span style="color:#099">328</span> May <span style="color:#099">27</span> 22:59 ca-csr.json
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 根证书的私钥</span>
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#099">1</span> root root <span style="color:#099">1679</span> May <span style="color:#099">27</span> 23:06 ca-key.pem
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 根证书</span>
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root <span style="color:#099">1346</span> May <span style="color:#099">27</span> 23:06 ca.pem
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>可通过 <code>cfssl-certinfo -cert ca.pem</code> 命令查看签发证书的详细信息</p>
</blockquote>
<h3 id="3-部署docker环境">3. 部署Docker环境</h3>
<p>K8S需要依赖于 <code>Docker</code> 的环境，主要在 <code>192.168.199.13</code>  、 <code>192.168.199.14</code> 、 <code>192.168.199.15</code> 三台主机上安装 <code>Docker</code> 环境</p>
<h4 id="31-安装并配置docker">3.1 安装并配置docker</h4>
<p>安装 <code>docker</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-14 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>若主机使用的是阿里云操作系统，<code>Docker</code> 安装方式如下：</p>
<pre tabindex="0"><code>wget -O /etc/yum.repos.d/docker-ce.repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
yum install yum-plugin-releasever-adapter --disablerepo=* --enablerepo=plus
yum install docker-ce
</code></pre><p>若是国外主机，<code>Docker</code> 安装方式如下：</p>
<pre tabindex="0"><code>curl -s https://get.docker.com | sudo sh
</code></pre><p>在已安装 <code>docker</code> 的主机上配置 <code>docker</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mkdir -p /data/docker</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mkdir /etc/docker</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/docker/daemon.json</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#d14">&#34;graph&#34;</span>: <span style="color:#d14">&#34;/data/docker&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#d14">&#34;storage-driver&#34;</span>: <span style="color:#d14">&#34;overlay2&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#d14">&#34;insecure-registries&#34;</span>: <span style="color:#000;font-weight:bold">[</span><span style="color:#d14">&#34;registry.access.redhat.com&#34;</span>,<span style="color:#d14">&#34;quay.io&#34;</span>,<span style="color:#d14">&#34;harbor.od.com&#34;</span><span style="color:#000;font-weight:bold">]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#d14">&#34;registry-mirrors&#34;</span>: <span style="color:#000;font-weight:bold">[</span><span style="color:#d14">&#34;https://q2gr04ke.mirror.aliyuncs.com&#34;</span><span style="color:#000;font-weight:bold">]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#d14">&#34;bip&#34;</span>: <span style="color:#d14">&#34;172.7.13.1/24&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#d14">&#34;exec-opts&#34;</span>: <span style="color:#000;font-weight:bold">[</span><span style="color:#d14">&#34;native.cgroupdriver=systemd&#34;</span><span style="color:#000;font-weight:bold">]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#d14">&#34;live-restore&#34;</span>: <span style="color:#0086b3">true</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>bip最好与主机相对应，当启动容器时，可以很方便判断出容器所在的主句。
192.168.199.13 &mdash;&ndash; 172.7.13.1/24
192.168.199.14 &mdash;&ndash; 172.7.14.1/24
192.168.199.15 &mdash;&ndash; 172.7.15.1/24</p>
</blockquote>
<h4 id="32-验证">3.2 验证</h4>
<p>启动并验证容器</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># systemctl start docker</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># systemctl enable docker</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker info</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker ps -a</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="4-部署harbor仓库">4. 部署Harbor仓库</h3>
<p><code>Harbor</code> 为目前主流的镜像仓库，主要在 <code>192.168.199.15</code> 上操作</p>
<h4 id="41-安装harbor">4.1 安装Harbor</h4>
<p>下载并解压 <code>harbor</code> 离线安装包</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># tar xf harbor-offline-installer-v1.8.3.tgz -C /opt/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 opt<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mv harbor/ harbor-v1.8.3</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 opt<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ln -s /opt/harbor-v1.8.3/ /opt/harbor</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>harbor的离线安装包可从github上下载
强烈建议使用1.7.6及其以上的版本，1.7.5及其以下版本有越权的bug，普通用户可能会获取到管理员的权限</p>
</blockquote>
<p>修改配置文件 <code>/opt/harbor/harbor.yml</code> ，主要修改以下内容</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 opt<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># vim /opt/harbor/harbor.yml</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 一定要配置，否则 install 的时候会报错 </span>
</span></span><span style="display:flex;"><span>hostname: harbor.od.com
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># harbor的登录密码</span>
</span></span><span style="display:flex;"><span>harbor_admin_password: Harbor12345
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 通过Nginx的80端口反向代理Harbor的180端口</span>
</span></span><span style="display:flex;"><span>  port: <span style="color:#099">180</span>
</span></span><span style="display:flex;"><span>data_volume: /data/harbor
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 日志的位置</span>
</span></span><span style="display:flex;"><span>  location: /data/harbor/logs
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 使用反向代理需要配置此行，否和可能会导致node节点无法pull镜像</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 注意，走的是http协议</span>
</span></span><span style="display:flex;"><span>  external_url: http://harbor.od.com:80
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建配置文件中所需的目录并安装 <code>docker-compose</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 opt<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mkdir -p /data/harbor/logs</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 opt<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># yum install docker-compose -y</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>通过脚本安装 <code>harbor</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 opt<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /opt/harbor</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 harbor<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ./install.sh</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看启动的容器状态</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 harbor<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker-compose ps</span>
</span></span><span style="display:flex;"><span>      Name                     Command               State             Ports
</span></span><span style="display:flex;"><span>--------------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>harbor-core         /harbor/start.sh                 Up
</span></span><span style="display:flex;"><span>harbor-db           /entrypoint.sh postgres          Up      5432/tcp
</span></span><span style="display:flex;"><span>harbor-jobservice   /harbor/start.sh                 Up
</span></span><span style="display:flex;"><span>harbor-log          /bin/sh -c /usr/local/bin/ ...   Up      127.0.0.1:1514-&gt;10514/tcp
</span></span><span style="display:flex;"><span>harbor-portal       nginx -g daemon off;             Up      80/tcp
</span></span><span style="display:flex;"><span>nginx               nginx -g daemon off;             Up      0.0.0.0:180-&gt;80/tcp
</span></span><span style="display:flex;"><span>redis               docker-entrypoint.sh redis ...   Up      6379/tcp
</span></span><span style="display:flex;"><span>registry            /entrypoint.sh /etc/regist ...   Up      5000/tcp
</span></span><span style="display:flex;"><span>registryctl         /harbor/start.sh                 Up
</span></span></code></pre></td></tr></table>
</div>
</div><p>若需要修改配置文件，需要执行以下步骤</p>
<pre tabindex="0"><code>[root@192-168-199-15 harbor]# cd /opt/harbor
[root@192-168-199-15 harbor]# docker-compose down 
# 更新配置文件
[root@192-168-199-15 harbor]# ./prepare 
[root@192-168-199-15 harbor]# docker-compose up -d
</code></pre><h4 id="42-反向代理及域名解析">4.2 反向代理及域名解析</h4>
<p>安装并配置 <code>Nginx</code> ，使用 <code>Nginx</code> 反向代理 <code>harbor</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 harbor<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># yum install nginx -y</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 harbor<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/nginx/conf.d/harbor.od.com.conf</span>
</span></span><span style="display:flex;"><span>server <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    listen       80;
</span></span><span style="display:flex;"><span>    server_name  harbor.od.com;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    client_max_body_size 1000m;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    location / <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        proxy_pass http://127.0.0.1:180;
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>验证无报错后，启动 <code>Nginx</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 harbor<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># nginx -t</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 harbor<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># systemctl start nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 harbor<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># systemctl enable nginx</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 <code>192.168.199.11</code> 上配置 <code>bind</code> 使主机可以正常解析 <code>harbor.od.com</code> ，主要修改如下</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /var/named/od.com.zone</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">$ORIGIN</span> od.com.
</span></span><span style="display:flex;"><span><span style="color:#008080">$TTL</span> <span style="color:#099">600</span>        ; <span style="color:#099">10</span> minutes
</span></span><span style="display:flex;"><span>@               IN SOA  dns.od.com. dnsadmin.od.com. <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>								<span style="color:#998;font-style:italic"># 前滚一个序号</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">2020052702</span> ; serial
</span></span><span style="display:flex;"><span>                                <span style="color:#099">10800</span>      ; refresh <span style="color:#000;font-weight:bold">(</span><span style="color:#099">3</span> hours<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">900</span>        ; retry <span style="color:#000;font-weight:bold">(</span><span style="color:#099">15</span> minutes<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">604800</span>     ; expire <span style="color:#000;font-weight:bold">(</span><span style="color:#099">1</span> week<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">86400</span>      ; minimum <span style="color:#000;font-weight:bold">(</span><span style="color:#099">1</span> day<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                NS   dns.od.com.
</span></span><span style="display:flex;"><span><span style="color:#008080">$TTL</span> <span style="color:#099">60</span> ; <span style="color:#099">1</span> minute
</span></span><span style="display:flex;"><span>dns                A    192.168.199.11
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 添加 A 记录</span>
</span></span><span style="display:flex;"><span>harbor             A    192.168.199.15
</span></span></code></pre></td></tr></table>
</div>
</div><p>验证是否可以解析 <code>harbor.od.com</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># dig -t A harbor.od.com +short</span>
</span></span><span style="display:flex;"><span>192.168.199.15
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="43-web页面配置">4.3 WEB页面配置</h4>
<p>登录 <code>harbor</code> 默认用户名为 <code>admin</code> 密码为 <code>Harbor</code> ，新建名称为 <code>public</code> 的公开项目</p>
<p><img src="https://images.wuennan.cn/20200528003144683-1594546377446.png" alt="20200528003144683"></p>
<p>在 <code>192.168.199.15</code> 上，从官方 <code>pull</code> 一个镜像下来，并上传到私有仓库</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker pull nginx:1.7.9</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker tag 84581e99d807 harbor.od.com/public/nginx:v1.7.9</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 登录到私有仓库，否则无法上传成功</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker login harbor.od.com</span>
</span></span><span style="display:flex;"><span>……
</span></span><span style="display:flex;"><span>Login Succeeded
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 上传镜像到私有仓库</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker push harbor.od.com/public/nginx:v1.7.9</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>私有仓库已存在刚刚上传的镜像</p>
<p><img src="https://images.wuennan.cn/20200528004751926-1594546395609.png" alt="20200528004751926"></p>
<h1 id="二kubernetes部署">二、Kubernetes部署</h1>
<h3 id="1-部署etcd集群">1. 部署etcd集群</h3>
<p><code>etcd</code> 集群需要安装在奇数个服务器上。这里主要部署在 <code>192.168.199.12</code> 、 <code>192.168.199.13</code> 和 <code>192.168.199.14</code> 三个主机上。</p>
<h4 id="11-为etcd签发证书">1.1 为etcd签发证书</h4>
<p><code>etcd</code> 集群中各个节点之间相互通信使用的证书。由于一个 <code>etcd</code> 节点既为其他节点提供服务，又需要作为客户端访问其他节点，因此该证书同时用作服务器证书和客户端证书。</p>
<p><code>etcd</code> 集群向外提供服务使用的证书。该证书是服务器证书。</p>
<p><code>etcd</code> 之间的通信需要证书，签发证书操作主要在运维主机 <code>192.168.199.15</code> 上进行
创建基于根证书的 <code>config</code> 配置文件</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /opt/certs/ca-config.json</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;signing&#34;</span>: <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;default&#34;</span>: <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;expiry&#34;</span>: <span style="color:#d14">&#34;175200h&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;profiles&#34;</span>: <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;server&#34;</span>: <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;expiry&#34;</span>: <span style="color:#d14">&#34;175200h&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;usages&#34;</span>: <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#d14">&#34;signing&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#d14">&#34;key encipherment&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#d14">&#34;server auth&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;client&#34;</span>: <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;expiry&#34;</span>: <span style="color:#d14">&#34;175200h&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;usages&#34;</span>: <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#d14">&#34;signing&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#d14">&#34;key encipherment&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#d14">&#34;client auth&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;peer&#34;</span>: <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;expiry&#34;</span>: <span style="color:#d14">&#34;175200h&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;usages&#34;</span>: <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#d14">&#34;signing&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#d14">&#34;key encipherment&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#d14">&#34;server auth&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#d14">&#34;client auth&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建生成自签证书签名请求（scr）的 JSON 配置文件</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /opt/certs/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /opt/certs/etcd-peer-csr.json</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;CN&#34;</span>: <span style="color:#d14">&#34;k8s-etcd&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;hosts&#34;</span>: <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;192.168.199.11&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;192.168.199.12&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;192.168.199.13&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;192.168.199.14&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">]</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;key&#34;</span>: <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;algo&#34;</span>: <span style="color:#d14">&#34;rsa&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;size&#34;</span>: <span style="color:#099">2048</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;names&#34;</span>: <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;C&#34;</span>: <span style="color:#d14">&#34;CN&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;ST&#34;</span>: <span style="color:#d14">&#34;beijing&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;L&#34;</span>: <span style="color:#d14">&#34;beijing&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;O&#34;</span>: <span style="color:#d14">&#34;od&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;OU&#34;</span>: <span style="color:#d14">&#34;ops&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>hosts中表示要部署etcd服务的设备。192.168.199.11作为备用，当一个节点坏了之后，可以在192.168.199.11上部署一个etcd节点。不支持配置网段。
生产环境中应多配置一些hosts</p>
</blockquote>
<p>生成 etcd 证书和私钥</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=peer etcd-peer-csr.json |cfssl-json -bare etcd-peer</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="12-安装etcd">1.2 安装etcd</h4>
<p>以下部分，需要在 <code>192.168.199.12</code> 、<code>192.168.199.13</code> 、<code>192.168.199.14</code>  三个主机主机上操作，操作相同</p>
<p>创建 <code>etcd</code> 用户</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># useradd -s /sbin/nologin -M etcd</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># id etcd</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">uid</span><span style="color:#000;font-weight:bold">=</span>1000<span style="color:#000;font-weight:bold">(</span>etcd<span style="color:#000;font-weight:bold">)</span> <span style="color:#008080">gid</span><span style="color:#000;font-weight:bold">=</span>1000<span style="color:#000;font-weight:bold">(</span>etcd<span style="color:#000;font-weight:bold">)</span> <span style="color:#008080">groups</span><span style="color:#000;font-weight:bold">=</span>1000<span style="color:#000;font-weight:bold">(</span>etcd<span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>从 <code>github</code> 上下载 <code>etcd</code>
<a href="https://github.com/etcd-io/etcd/tags">etcd下载地址</a></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># tar xf etcd-v3.1.20-linux-amd64.tar.gz -C /opt/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /opt/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 opt<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mv etcd-v3.1.20-linux-amd64/ etcd-v3.1.20</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 opt<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ln -s /opt/etcd-v3.1.20/ /opt/etcd</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建目录，拷贝证书、私钥</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 opt<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mkdir -p /opt/etcd/certs /data/etcd /data/logs/etcd-server</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 opt<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /opt/etcd/certs/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp 192-168-199-15:/opt/certs/ca.pem ./</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp 192-168-199-15:/opt/certs/etcd-peer.pem ./</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp 192-168-199-15:/opt/certs/etcd-peer-key.pem ./</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建 <code>etcd</code> 的启动文件，需要注意 <code>--name</code> 部分和 <code>--initial-cluster</code> 部分</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /opt/etcd/etcd-server-startup.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#!/bin/sh</span>
</span></span><span style="display:flex;"><span>./etcd --name etcd-server-199-12 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       --data-dir /data/etcd/etcd-server <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       --listen-peer-urls https://192.168.199.12:2380 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       --listen-client-urls https://192.168.199.12:2379,http://127.0.0.1:2379 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       --quota-backend-bytes <span style="color:#099">8000000000</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       --initial-advertise-peer-urls https://192.168.199.12:2380 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       --advertise-client-urls https://192.168.199.12:2379,http://127.0.0.1:2379 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       --initial-cluster  etcd-server-199-12<span style="color:#000;font-weight:bold">=</span>https://192.168.199.12:2380,etcd-server-199-13<span style="color:#000;font-weight:bold">=</span>https://192.168.199.13:2380,etcd-server-199-14<span style="color:#000;font-weight:bold">=</span>https://192.168.199.14:2380 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       <span style="color:#998;font-style:italic"># 根证书</span>
</span></span><span style="display:flex;"><span>       --ca-file ./certs/ca.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       <span style="color:#998;font-style:italic"># 对外提供服务的服务器证书</span>
</span></span><span style="display:flex;"><span>       --cert-file ./certs/etcd-peer.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       <span style="color:#998;font-style:italic"># 服务器证书对应的私钥</span>
</span></span><span style="display:flex;"><span>       --key-file ./certs/etcd-peer-key.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       --client-cert-auth  <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>        <span style="color:#998;font-style:italic"># 用于验证访问 etcd 服务器的客户端证书的 CA 根证书</span>
</span></span><span style="display:flex;"><span>       --trusted-ca-file ./certs/ca.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       --peer-ca-file ./certs/ca.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       <span style="color:#998;font-style:italic"># peer 证书，用于 etcd 节点之间的相互访问</span>
</span></span><span style="display:flex;"><span>       --peer-cert-file ./certs/etcd-peer.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       <span style="color:#998;font-style:italic"># peer 证书对应的私钥</span>
</span></span><span style="display:flex;"><span>       --peer-key-file ./certs/etcd-peer-key.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       --peer-client-cert-auth <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       <span style="color:#998;font-style:italic"># 用于验证 peer 证书的 CA 根证书</span>
</span></span><span style="display:flex;"><span>       --peer-trusted-ca-file ./certs/ca.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       --log-output stdout
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>三台主机的配置文件中，&ndash;name参数和所涉及到的ip地址不同。需要注意</p>
</blockquote>
<p>对上述涉及到的目录授权，使 <code>etcd</code> 用户对其具有权限</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># chmod a+x /opt/etcd/etcd-server-startup.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># chown -R etcd.etcd /opt/etcd-v3.1.20/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># chown -R etcd.etcd /data/etcd/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># chown -R etcd.etcd /data/logs/etcd-server/</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>安装 <code>supervisor</code> ，通过 <code>supervisor</code> 管理 <code>etcd</code> 进程</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># yum install supervisor -y</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># systemctl start supervisord</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># systemctl enable supervisord</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>编写 <code>supervisord</code> 相关文件，使其可以管理 <code>etcd</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/supervisord.d/etcd-server.ini</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>program:etcd-server-199-12<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">command</span><span style="color:#000;font-weight:bold">=</span>/opt/etcd/etcd-server-startup.sh                        ; the program <span style="color:#000;font-weight:bold">(</span>relative uses PATH, can take args<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">numprocs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">1</span>                                                      ; number of processes copies to start <span style="color:#000;font-weight:bold">(</span>def 1<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">directory</span><span style="color:#000;font-weight:bold">=</span>/opt/etcd                                             ; directory to cwd to before <span style="color:#0086b3">exec</span> <span style="color:#000;font-weight:bold">(</span>def no cwd<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">autostart</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                                  ; start at supervisord start <span style="color:#000;font-weight:bold">(</span>default: <span style="color:#0086b3">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">autorestart</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                                ; retstart at unexpected quit <span style="color:#000;font-weight:bold">(</span>default: <span style="color:#0086b3">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">startsecs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">30</span>                                                    ; number of secs prog must stay running <span style="color:#000;font-weight:bold">(</span>def. 1<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">startretries</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">3</span>                                                  ; max <span style="color:#998;font-style:italic"># of serial start failures (default 3)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">exitcodes</span><span style="color:#000;font-weight:bold">=</span>0,2                                                   ; <span style="color:#d14">&#39;expected&#39;</span> <span style="color:#0086b3">exit</span> codes <span style="color:#000;font-weight:bold">for</span> process <span style="color:#000;font-weight:bold">(</span>default 0,2<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stopsignal</span><span style="color:#000;font-weight:bold">=</span>QUIT                                                 ; signal used to <span style="color:#0086b3">kill</span> process <span style="color:#000;font-weight:bold">(</span>default TERM<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stopwaitsecs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">10</span>                                                 ; max num secs to <span style="color:#0086b3">wait</span> b4 SIGKILL <span style="color:#000;font-weight:bold">(</span>default 10<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">user</span><span style="color:#000;font-weight:bold">=</span>etcd                                                       ; setuid to this UNIX account to run the program
</span></span><span style="display:flex;"><span><span style="color:#008080">redirect_stderr</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                            ; redirect proc stderr to stdout <span style="color:#000;font-weight:bold">(</span>default <span style="color:#0086b3">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile</span><span style="color:#000;font-weight:bold">=</span>/data/logs/etcd-server/etcd.stdout.log           ; stdout log path, NONE <span style="color:#000;font-weight:bold">for</span> none; default AUTO
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile_maxbytes</span><span style="color:#000;font-weight:bold">=</span>64MB                                    ; max <span style="color:#998;font-style:italic"># logfile bytes b4 rotation (default 50MB)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile_backups</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">4</span>                                        ; <span style="color:#998;font-style:italic"># of stdout logfile backups (default 10)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_capture_maxbytes</span><span style="color:#000;font-weight:bold">=</span>1MB                                     ; number of bytes in <span style="color:#d14">&#39;capturemode&#39;</span> <span style="color:#000;font-weight:bold">(</span>default 0<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_events_enabled</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">false</span>                                     ; emit events on stdout writes <span style="color:#000;font-weight:bold">(</span>default <span style="color:#0086b3">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>program:etcd-server-199-12 应与脚本中的名称相对应，三个主机的配置文件此部分也不同</p>
</blockquote>
<p>通过 <code>supervisord</code> 启动 <code>etcd</code> 的进程，并查看其状态</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># supervisorctl update</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># supervisorctl status</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 开始状态为 STARTING ，等待约30秒后，状态会变为RUNNING</span>
</span></span><span style="display:flex;"><span>etcd-server-199-12               RUNNING   pid 12546, uptime 0:02:40
</span></span></code></pre></td></tr></table>
</div>
</div><p>验证 <code>etcd</code> 的端口是否正常启动</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># netstat -lntp | grep etcd</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#2379 和 2380 端口都要起来</span>
</span></span><span style="display:flex;"><span>tcp        <span style="color:#099">0</span>      <span style="color:#099">0</span> 192.168.199.12:2379     0.0.0.0:*               LISTEN      12547/./etcd
</span></span><span style="display:flex;"><span>tcp        <span style="color:#099">0</span>      <span style="color:#099">0</span> 127.0.0.1:2379          0.0.0.0:*               LISTEN      12547/./etcd
</span></span><span style="display:flex;"><span>tcp        <span style="color:#099">0</span>      <span style="color:#099">0</span> 192.168.199.12:2380     0.0.0.0:*               LISTEN      12547/./etcd
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="13-验证-1">1.3 验证</h4>
<p><strong>集群健康状态检查</strong></p>
<p>等三台服务都安装完 <code>etcd</code> 后，需要检查集群的状态，可采用以下两种方法进行检查
方法一：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-14 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ./etcdctl cluster-health</span>
</span></span><span style="display:flex;"><span>member 35d340010a02200a is healthy: got healthy result from http://127.0.0.1:2379
</span></span><span style="display:flex;"><span>member 4a554f90b80c73ac is healthy: got healthy result from http://127.0.0.1:2379
</span></span><span style="display:flex;"><span>member c899bc1f18888852 is healthy: got healthy result from http://127.0.0.1:2379
</span></span><span style="display:flex;"><span>cluster is healthy
</span></span></code></pre></td></tr></table>
</div>
</div><p>方法二：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-14 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ./etcdctl member list</span>
</span></span><span style="display:flex;"><span>35d340010a02200a: <span style="color:#008080">name</span><span style="color:#000;font-weight:bold">=</span>etcd-server-199-14 <span style="color:#008080">peerURLs</span><span style="color:#000;font-weight:bold">=</span>https://192.168.199.14:2380 <span style="color:#008080">clientURLs</span><span style="color:#000;font-weight:bold">=</span>http://127.0.0.1:2379,https://192.168.199.14:2379 <span style="color:#008080">isLeader</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">false</span>
</span></span><span style="display:flex;"><span>4a554f90b80c73ac: <span style="color:#008080">name</span><span style="color:#000;font-weight:bold">=</span>etcd-server-199-13 <span style="color:#008080">peerURLs</span><span style="color:#000;font-weight:bold">=</span>https://192.168.199.13:2380 <span style="color:#008080">clientURLs</span><span style="color:#000;font-weight:bold">=</span>http://127.0.0.1:2379,https://192.168.199.13:2379 <span style="color:#008080">isLeader</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">false</span>
</span></span><span style="display:flex;"><span>c899bc1f18888852: <span style="color:#008080">name</span><span style="color:#000;font-weight:bold">=</span>etcd-server-199-12 <span style="color:#008080">peerURLs</span><span style="color:#000;font-weight:bold">=</span>https://192.168.199.12:2380 <span style="color:#008080">clientURLs</span><span style="color:#000;font-weight:bold">=</span>http://127.0.0.1:2379,https://192.168.199.12:2379 <span style="color:#008080">isLeader</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="2-部署api-server">2. 部署api-server</h3>
<h4 id="21-准备安装包">2.1 准备安装包</h4>
<p>主要在 <code>192.168.199.13</code> 和 <code>192.168.199.14</code> 上进行操作
<code>K8S</code> 安装包可在 <code>github</code> 上下载</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># tar xf kubernetes-server-linux-amd64-v1.15.2.tar.gz -C /opt/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /opt/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 opt<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mv kubernetes/ kubernetes-v1.15.2</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 opt<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ln -s /opt/kubernetes-v1.15.2/ /opt/kubernetes</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>删除不必要的文件</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 opt<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd kubernetes</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># go语言写的源码包</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 kubernetes<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># rm -rf kubernetes-src.tar.gz</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 kubernetes<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd server/bin/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># tar包为镜像文件，使用kubeadm方式部署会使用到</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 bin<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># rm -rf *.tar</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 bin<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># rm -rf *_tag</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 此时 /opt/kubernetes/server/bin 目录下只剩下一堆可执行文件</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 bin<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ll</span>
</span></span><span style="display:flex;"><span>total <span style="color:#099">884636</span>
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#099">1</span> root root  <span style="color:#099">43534816</span> Aug  <span style="color:#099">5</span>  <span style="color:#099">2019</span> apiextensions-apiserver
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#099">1</span> root root <span style="color:#099">100548640</span> Aug  <span style="color:#099">5</span>  <span style="color:#099">2019</span> cloud-controller-manager
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#099">1</span> root root <span style="color:#099">200648416</span> Aug  <span style="color:#099">5</span>  <span style="color:#099">2019</span> hyperkube
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#099">1</span> root root  <span style="color:#099">40182208</span> Aug  <span style="color:#099">5</span>  <span style="color:#099">2019</span> kubeadm
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#099">1</span> root root <span style="color:#099">164501920</span> Aug  <span style="color:#099">5</span>  <span style="color:#099">2019</span> kube-apiserver
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#099">1</span> root root <span style="color:#099">116397088</span> Aug  <span style="color:#099">5</span>  <span style="color:#099">2019</span> kube-controller-manager
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#099">1</span> root root  <span style="color:#099">42985504</span> Aug  <span style="color:#099">5</span>  <span style="color:#099">2019</span> kubectl
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#099">1</span> root root <span style="color:#099">119616640</span> Aug  <span style="color:#099">5</span>  <span style="color:#099">2019</span> kubelet
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#099">1</span> root root  <span style="color:#099">36987488</span> Aug  <span style="color:#099">5</span>  <span style="color:#099">2019</span> kube-proxy
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#099">1</span> root root  <span style="color:#099">38786144</span> Aug  <span style="color:#099">5</span>  <span style="color:#099">2019</span> kube-scheduler
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#099">1</span> root root   <span style="color:#099">1648224</span> Aug  <span style="color:#099">5</span>  <span style="color:#099">2019</span> mounter
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>192.168.199.14上的操作与上述相同</strong></p>
<h4 id="22-签发证书-1">2.2 签发证书</h4>
<ul>
<li>kube-apiserver 对外提供服务的服务器证书及私钥。</li>
<li>kube-apiserver 访问 etcd 所需的客户端证书及私钥。</li>
<li>kube-apiserver 访问 kubelet 所需的客户端证书及私钥。</li>
<li>验证访问其服务的客户端的 CA。</li>
<li>验证 etcd 服务器证书的 CA 根证书。</li>
<li>验证 service account token 的公钥。</li>
</ul>
<p><strong>签发 client 证书</strong></p>
<p>为 <code>kube-apiserver</code> 签发证书，此证书在 <code>apiserver</code> 和 <code>etcd</code> 通信时会使用到。<code>etcd</code> 为服务端，<code>apiserver</code> 为客户端。因此需要在 <code>192.168.199.15</code> 上制作 <code>client</code> 证书给 <code>apiserver</code> 使用。</p>
<p>创建生成证书签名请求（csr）的 <code>JSON</code> 的配置文件</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /opt/certs/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /opt/certs/client-csr.json</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;CN&#34;</span>: <span style="color:#d14">&#34;k8s-node&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;hosts&#34;</span>: <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">]</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;key&#34;</span>: <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;algo&#34;</span>: <span style="color:#d14">&#34;rsa&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;size&#34;</span>: <span style="color:#099">2048</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;names&#34;</span>: <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;C&#34;</span>: <span style="color:#d14">&#34;CN&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;ST&#34;</span>: <span style="color:#d14">&#34;beijing&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;L&#34;</span>: <span style="color:#d14">&#34;beijing&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;O&#34;</span>: <span style="color:#d14">&#34;od&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;OU&#34;</span>: <span style="color:#d14">&#34;ops&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>签发证书</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client client-csr.json |cfssl-json -bare client</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ll client*</span>
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root  <span style="color:#099">993</span> May <span style="color:#099">30</span> 09:40 client.csr
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root  <span style="color:#099">280</span> May <span style="color:#099">30</span> 09:38 client-csr.json
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#099">1</span> root root <span style="color:#099">1675</span> May <span style="color:#099">30</span> 09:40 client-key.pem
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root <span style="color:#099">1363</span> May <span style="color:#099">30</span> 09:40 client.pem
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>签发kube-apiserver证书</strong></p>
<p><code>kub-apiserver</code> 对外提供服务时，需要一个证书。同样在 <code>192.168.199.15</code> 上签发证书</p>
<p>创建生成证书签名请求（csr）的 <code>JSON</code> 配置文件</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /opt/certs/apiserver-csr.json</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;CN&#34;</span>: <span style="color:#d14">&#34;k8s-apiserver&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;hosts&#34;</span>: <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;127.0.0.1&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;192.168.0.1&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;kubernetes.default&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;kubernetes.default.svc&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;kubernetes.default.svc.cluster&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;kubernetes.default.svc.cluster.local&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;192.168.199.10&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;192.168.199.13&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;192.168.199.14&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;192.168.199.16&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">]</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;key&#34;</span>: <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;algo&#34;</span>: <span style="color:#d14">&#34;rsa&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;size&#34;</span>: <span style="color:#099">2048</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;names&#34;</span>: <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;C&#34;</span>: <span style="color:#d14">&#34;CN&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;ST&#34;</span>: <span style="color:#d14">&#34;beijing&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;L&#34;</span>: <span style="color:#d14">&#34;beijing&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;O&#34;</span>: <span style="color:#d14">&#34;od&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;OU&#34;</span>: <span style="color:#d14">&#34;ops&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>在hosts中把可能会安装 apiserver 的 IP 全都列出来，同样不支持网段</p>
<p>kube-ipvs0 网卡的ip会变为192.168.0.1 ，因此要加上此ip</p>
</blockquote>
<p>签发证书</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server apiserver-csr.json |cfssl-json -bare apiserver</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="23-安装apiserver">2.3 安装apiserver</h4>
<p>主要在 <code>192.168.199.13</code> 和 <code>192.168.199.14</code> 上进行操作
<strong>在 <code>192.168.199.13</code> 上安装apiserver</strong>
拷贝证书到 <code>192.168.199.13</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 bin<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># pwd</span>
</span></span><span style="display:flex;"><span>/opt/kubernetes/server/bin
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 bin<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mkdir cert</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 bin<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd cert/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp root@192.168.199.15:/opt/certs/apiserver.pem ./</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp root@192.168.199.15:/opt/certs/apiserver-key.pem ./</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp root@192.168.199.15:/opt/certs/ca.pem ./</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp root@192.168.199.15:/opt/certs/ca-key.pem ./</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp root@192.168.199.15:/opt/certs/client.pem ./</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp root@192.168.199.15:/opt/certs/client-key.pem ./</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 验证所需6套证书</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ll</span>
</span></span><span style="display:flex;"><span>total <span style="color:#099">24</span>
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#099">1</span> root root <span style="color:#099">1679</span> May <span style="color:#099">31</span> 16:18 apiserver-key.pem
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root <span style="color:#099">1598</span> May <span style="color:#099">31</span> 16:17 apiserver.pem
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#099">1</span> root root <span style="color:#099">1679</span> May <span style="color:#099">31</span> 16:18 ca-key.pem
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root <span style="color:#099">1346</span> May <span style="color:#099">31</span> 16:18 ca.pem
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#099">1</span> root root <span style="color:#099">1675</span> May <span style="color:#099">31</span> 16:19 client-key.pem
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root <span style="color:#099">1363</span> May <span style="color:#099">31</span> 16:19 client.pem
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建配置文件目录</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 bin<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mkdir /opt/kubernetes/server/bin/conf</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 bin<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /opt/kubernetes/server/bin/conf</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建 <code>apiserver</code> 日志审计规则，再下面的启动脚本中会用到</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat audit.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: audit.k8s.io/v1beta1 <span style="color:#998;font-style:italic"># This is required.</span>
</span></span><span style="display:flex;"><span>kind: Policy
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Don&#39;t generate audit events for all requests in RequestReceived stage.</span>
</span></span><span style="display:flex;"><span>omitStages:
</span></span><span style="display:flex;"><span>  - <span style="color:#d14">&#34;RequestReceived&#34;</span>
</span></span><span style="display:flex;"><span>rules:
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Log pod changes at RequestResponse level</span>
</span></span><span style="display:flex;"><span>  - level: RequestResponse
</span></span><span style="display:flex;"><span>    resources:
</span></span><span style="display:flex;"><span>    - group: <span style="color:#d14">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#998;font-style:italic"># Resource &#34;pods&#34; doesn&#39;t match requests to any subresource of pods,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#998;font-style:italic"># which is consistent with the RBAC policy.</span>
</span></span><span style="display:flex;"><span>      resources: <span style="color:#000;font-weight:bold">[</span><span style="color:#d14">&#34;pods&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Log &#34;pods/log&#34;, &#34;pods/status&#34; at Metadata level</span>
</span></span><span style="display:flex;"><span>  - level: Metadata
</span></span><span style="display:flex;"><span>    resources:
</span></span><span style="display:flex;"><span>    - group: <span style="color:#d14">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>      resources: <span style="color:#000;font-weight:bold">[</span><span style="color:#d14">&#34;pods/log&#34;</span>, <span style="color:#d14">&#34;pods/status&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Don&#39;t log requests to a configmap called &#34;controller-leader&#34;</span>
</span></span><span style="display:flex;"><span>  - level: None
</span></span><span style="display:flex;"><span>    resources:
</span></span><span style="display:flex;"><span>    - group: <span style="color:#d14">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>      resources: <span style="color:#000;font-weight:bold">[</span><span style="color:#d14">&#34;configmaps&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>      resourceNames: <span style="color:#000;font-weight:bold">[</span><span style="color:#d14">&#34;controller-leader&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Don&#39;t log watch requests by the &#34;system:kube-proxy&#34; on endpoints or services</span>
</span></span><span style="display:flex;"><span>  - level: None
</span></span><span style="display:flex;"><span>    users: <span style="color:#000;font-weight:bold">[</span><span style="color:#d14">&#34;system:kube-proxy&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>    verbs: <span style="color:#000;font-weight:bold">[</span><span style="color:#d14">&#34;watch&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>    resources:
</span></span><span style="display:flex;"><span>    - group: <span style="color:#d14">&#34;&#34;</span> <span style="color:#998;font-style:italic"># core API group</span>
</span></span><span style="display:flex;"><span>      resources: <span style="color:#000;font-weight:bold">[</span><span style="color:#d14">&#34;endpoints&#34;</span>, <span style="color:#d14">&#34;services&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Don&#39;t log authenticated requests to certain non-resource URL paths.</span>
</span></span><span style="display:flex;"><span>  - level: None
</span></span><span style="display:flex;"><span>    userGroups: <span style="color:#000;font-weight:bold">[</span><span style="color:#d14">&#34;system:authenticated&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>    nonResourceURLs:
</span></span><span style="display:flex;"><span>    - <span style="color:#d14">&#34;/api*&#34;</span> <span style="color:#998;font-style:italic"># Wildcard matching.</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#d14">&#34;/version&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Log the request body of configmap changes in kube-system.</span>
</span></span><span style="display:flex;"><span>  - level: Request
</span></span><span style="display:flex;"><span>    resources:
</span></span><span style="display:flex;"><span>    - group: <span style="color:#d14">&#34;&#34;</span> <span style="color:#998;font-style:italic"># core API group</span>
</span></span><span style="display:flex;"><span>      resources: <span style="color:#000;font-weight:bold">[</span><span style="color:#d14">&#34;configmaps&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># This rule only applies to resources in the &#34;kube-system&#34; namespace.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># The empty string &#34;&#34; can be used to select non-namespaced resources.</span>
</span></span><span style="display:flex;"><span>    namespaces: <span style="color:#000;font-weight:bold">[</span><span style="color:#d14">&#34;kube-system&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Log configmap and secret changes in all other namespaces at the Metadata level.</span>
</span></span><span style="display:flex;"><span>  - level: Metadata
</span></span><span style="display:flex;"><span>    resources:
</span></span><span style="display:flex;"><span>    - group: <span style="color:#d14">&#34;&#34;</span> <span style="color:#998;font-style:italic"># core API group</span>
</span></span><span style="display:flex;"><span>      resources: <span style="color:#000;font-weight:bold">[</span><span style="color:#d14">&#34;secrets&#34;</span>, <span style="color:#d14">&#34;configmaps&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Log all other resources in core and extensions at the Request level.</span>
</span></span><span style="display:flex;"><span>  - level: Request
</span></span><span style="display:flex;"><span>    resources:
</span></span><span style="display:flex;"><span>    - group: <span style="color:#d14">&#34;&#34;</span> <span style="color:#998;font-style:italic"># core API group</span>
</span></span><span style="display:flex;"><span>    - group: <span style="color:#d14">&#34;extensions&#34;</span> <span style="color:#998;font-style:italic"># Version of group should NOT be included.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># A catch-all rule to log all other requests at the Metadata level.</span>
</span></span><span style="display:flex;"><span>  - level: Metadata
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># Long-running requests like watches that fall under this rule will not</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># generate an audit event in RequestReceived.</span>
</span></span><span style="display:flex;"><span>    omitStages:
</span></span><span style="display:flex;"><span>      - <span style="color:#d14">&#34;RequestReceived&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>没有需要改动的地方</p>
</blockquote>
<p>创建 <code>apiserver</code> 启动脚本</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 bin<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /opt/kubernetes/server/bin/kube-apiserver.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#!/bin/bash</span>
</span></span><span style="display:flex;"><span>./kube-apiserver <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --apiserver-count <span style="color:#099">2</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --audit-log-path /data/logs/kubernetes/kube-apiserver/audit-log <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --audit-policy-file ./conf/audit.yaml <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --authorization-mode RBAC <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  <span style="color:#998;font-style:italic"># 用于验证访问 kube-apiserver 的客户端的证书的 CA 根证书</span>
</span></span><span style="display:flex;"><span>  --client-ca-file ./cert/ca.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --requestheader-client-ca-file ./cert/ca.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --enable-admission-plugins NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  <span style="color:#998;font-style:italic"># 用于验证 etcd 服务器证书的 CA 根证书</span>
</span></span><span style="display:flex;"><span>  --etcd-cafile ./cert/ca.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  <span style="color:#998;font-style:italic"># 用于访问 etcd 的客户端证书</span>
</span></span><span style="display:flex;"><span>  --etcd-certfile ./cert/client.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  <span style="color:#998;font-style:italic"># 用于访问 etcd 的客户端证书的私钥</span>
</span></span><span style="display:flex;"><span>  --etcd-keyfile ./cert/client-key.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --etcd-servers https://192.168.199.12:2379,https://192.168.199.13:2379,https://192.168.199.14:2379 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  <span style="color:#998;font-style:italic"># 用于验证 service account token 的公钥</span>
</span></span><span style="display:flex;"><span>  --service-account-key-file ./cert/ca-key.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --service-cluster-ip-range 192.168.0.0/16 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --service-node-port-range 3000-29999 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --target-ram-mb<span style="color:#000;font-weight:bold">=</span><span style="color:#099">1024</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  <span style="color:#998;font-style:italic"># 用于访问 kubelet 的客户端证书</span>
</span></span><span style="display:flex;"><span>  --kubelet-client-certificate ./cert/client.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  <span style="color:#998;font-style:italic"># 用于访问 kubelet 的客户端证书的私钥</span>
</span></span><span style="display:flex;"><span>  --kubelet-client-key ./cert/client-key.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --log-dir  /data/logs/kubernetes/kube-apiserver <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  <span style="color:#998;font-style:italic"># 用于对外提供服务的服务器证书</span>
</span></span><span style="display:flex;"><span>  --tls-cert-file ./cert/apiserver.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  <span style="color:#998;font-style:italic"># 服务器证书对应的私钥</span>
</span></span><span style="display:flex;"><span>  --tls-private-key-file ./cert/apiserver-key.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --v <span style="color:#099">2</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>需要注意脚本中涉及到的文件路径及 IP 地址</p>
</blockquote>
<p>对脚本进行授权</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 bin<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># chmod +x kube-apiserver.sh</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建 <code>supervisord</code> 配置文件</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 bin<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/supervisord.d/kube-apiserver.ini</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>program:kube-apiserver-199-13<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">command</span><span style="color:#000;font-weight:bold">=</span>/opt/kubernetes/server/bin/kube-apiserver.sh            ; the program <span style="color:#000;font-weight:bold">(</span>relative uses PATH, can take args<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">numprocs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">1</span>                                                      ; number of processes copies to start <span style="color:#000;font-weight:bold">(</span>def 1<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">directory</span><span style="color:#000;font-weight:bold">=</span>/opt/kubernetes/server/bin                            ; directory to cwd to before <span style="color:#0086b3">exec</span> <span style="color:#000;font-weight:bold">(</span>def no cwd<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">autostart</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                                  ; start at supervisord start <span style="color:#000;font-weight:bold">(</span>default: <span style="color:#0086b3">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">autorestart</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                                ; retstart at unexpected quit <span style="color:#000;font-weight:bold">(</span>default: <span style="color:#0086b3">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">startsecs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">30</span>                                                    ; number of secs prog must stay running <span style="color:#000;font-weight:bold">(</span>def. 1<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">startretries</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">3</span>                                                  ; max <span style="color:#998;font-style:italic"># of serial start failures (default 3)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">exitcodes</span><span style="color:#000;font-weight:bold">=</span>0,2                                                   ; <span style="color:#d14">&#39;expected&#39;</span> <span style="color:#0086b3">exit</span> codes <span style="color:#000;font-weight:bold">for</span> process <span style="color:#000;font-weight:bold">(</span>default 0,2<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stopsignal</span><span style="color:#000;font-weight:bold">=</span>QUIT                                                 ; signal used to <span style="color:#0086b3">kill</span> process <span style="color:#000;font-weight:bold">(</span>default TERM<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stopwaitsecs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">10</span>                                                 ; max num secs to <span style="color:#0086b3">wait</span> b4 SIGKILL <span style="color:#000;font-weight:bold">(</span>default 10<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">user</span><span style="color:#000;font-weight:bold">=</span>root                                                       ; setuid to this UNIX account to run the program
</span></span><span style="display:flex;"><span><span style="color:#008080">redirect_stderr</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                            ; redirect proc stderr to stdout <span style="color:#000;font-weight:bold">(</span>default <span style="color:#0086b3">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile</span><span style="color:#000;font-weight:bold">=</span>/data/logs/kubernetes/kube-apiserver/apiserver.stdout.log        ; stderr log path, NONE <span style="color:#000;font-weight:bold">for</span> none; default AUTO
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile_maxbytes</span><span style="color:#000;font-weight:bold">=</span>64MB                                    ; max <span style="color:#998;font-style:italic"># logfile bytes b4 rotation (default 50MB)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile_backups</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">4</span>                                        ; <span style="color:#998;font-style:italic"># of stdout logfile backups (default 10)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_capture_maxbytes</span><span style="color:#000;font-weight:bold">=</span>1MB                                     ; number of bytes in <span style="color:#d14">&#39;capturemode&#39;</span> <span style="color:#000;font-weight:bold">(</span>default 0<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_events_enabled</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">false</span>                                     ; emit events on stdout writes <span style="color:#000;font-weight:bold">(</span>default <span style="color:#0086b3">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>注意不同的主机在 [ ] 中的名称不一样</p>
</blockquote>
<p>创建上述文件中所涉及到的目录</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 bin<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mkdir -p /data/logs/kubernetes/kube-apiserver</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>让 <code>supervisord</code> 管理服务</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 bin<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># supervisorctl update</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># supervisorctl status</span>
</span></span><span style="display:flex;"><span>etcd-server-199-13               RUNNING   pid 846, uptime <span style="color:#099">1</span> day, 7:35:30
</span></span><span style="display:flex;"><span>kube-apiserver-199-13            RUNNING   pid 3514, uptime 0:10:13
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># netstat -lnpt | grep kube-api</span>
</span></span><span style="display:flex;"><span>tcp        <span style="color:#099">0</span>      <span style="color:#099">0</span> 127.0.0.1:8080          0.0.0.0:*               LISTEN      3515/./kube-apiserv
</span></span><span style="display:flex;"><span>tcp6       <span style="color:#099">0</span>      <span style="color:#099">0</span> :::6443                 :::*                    LISTEN      3515/./kube-apiserv
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>192.168.199.14 的操作与上述相同</strong></p>
<h3 id="3-四层负载均衡">3. 四层负载均衡</h3>
<p>同时在 <code>192.168.199.11</code> 和 <code>192.168.199.12</code> 上部署 <code>nginx</code> 实现对后端的 <code>apiserver</code> 负载均衡，在 <code>192.168.199.11</code> 和 <code>192.168.199.12</code> 上需要通过 <code>keepalive</code> 实现高可用。</p>
<h4 id="31-安装并配置nginx">3.1 安装并配置Nginx</h4>
<p>安装并配置 <code>nginx</code> ，两个主机操作相同，均执行以下步骤</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># yum install nginx -y</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 在 /etc/nginx/nginx.conf 文件的最后添加反向代理设置</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># tail -n 12 /etc/nginx/nginx.conf</span>
</span></span><span style="display:flex;"><span>stream <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    upstream kube-apiserver <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        server 192.168.199.13:6443     <span style="color:#008080">max_fails</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">3</span> <span style="color:#008080">fail_timeout</span><span style="color:#000;font-weight:bold">=</span>30s;
</span></span><span style="display:flex;"><span>        server 192.168.199.14:6443     <span style="color:#008080">max_fails</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">3</span> <span style="color:#008080">fail_timeout</span><span style="color:#000;font-weight:bold">=</span>30s;
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    server <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        listen 7443;
</span></span><span style="display:flex;"><span>        proxy_connect_timeout 2s;
</span></span><span style="display:flex;"><span>        proxy_timeout 900s;
</span></span><span style="display:flex;"><span>        proxy_pass kube-apiserver;
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>检查并启动 <code>nginx</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># nginx -t</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># systemctl start nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># systemctl enable nginx</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="32-安装keepalived">3.2 安装keepalived</h4>
<p>主要在 <code>192.168.199.11</code> 和 <code>192.168.199.12</code> 上进行操作，两边配置相似。 <code>192.168.199.11</code> 为主节点， <code>192.168.199.12</code> 为从节点。</p>
<p>安装并配置 <code>keepalived</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># yum install keepalived -y</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在两个服务器上都需要添加监控端口的脚本</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/keepalived/check_port.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#!/bin/bash</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#keepalived 监控端口脚本</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#使用方法：</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#在keepalived的配置文件中</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#vrrp_script check_port {#创建一个vrrp_script脚本,检查配置</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#    script &#34;/etc/keepalived/check_port.sh 6379&#34; #配置监听的端口</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#    interval 2 #检查脚本的频率,单位（秒）</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#}</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">CHK_PORT</span><span style="color:#000;font-weight:bold">=</span><span style="color:#008080">$1</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">[</span> -n <span style="color:#d14">&#34;</span><span style="color:#008080">$CHK_PORT</span><span style="color:#d14">&#34;</span> <span style="color:#000;font-weight:bold">]</span>;<span style="color:#000;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>        <span style="color:#008080">PORT_PROCESS</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">`</span>ss -lnt|grep <span style="color:#008080">$CHK_PORT</span>|wc -l<span style="color:#d14">`</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">[</span> <span style="color:#008080">$PORT_PROCESS</span> -eq <span style="color:#099">0</span> <span style="color:#000;font-weight:bold">]</span>;<span style="color:#000;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0086b3">echo</span> <span style="color:#d14">&#34;Port </span><span style="color:#008080">$CHK_PORT</span><span style="color:#d14"> Is Not Used,End.&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0086b3">exit</span> <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0086b3">echo</span> <span style="color:#d14">&#34;Check Port Cant Be Empty!&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">fi</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>对上述脚本进行授权</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># chmod +x /etc/keepalived/check_port.sh</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>配置 <code>keepalived</code>
<strong>主节点</strong>清空原来的配置，添加如下配置，<code>192.168.199.10</code> 为 <code>VIP</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/keepalived/keepalived.conf</span>
</span></span><span style="display:flex;"><span>! Configuration File <span style="color:#000;font-weight:bold">for</span> keepalived
</span></span><span style="display:flex;"><span>global_defs <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   router_id 192.168.199.11
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vrrp_script chk_nginx <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    script <span style="color:#d14">&#34;/etc/keepalived/check_port.sh 7443&#34;</span>
</span></span><span style="display:flex;"><span>    interval <span style="color:#099">2</span>
</span></span><span style="display:flex;"><span>    weight -20
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vrrp_instance VI_1 <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    state MASTER
</span></span><span style="display:flex;"><span>    interface eth0
</span></span><span style="display:flex;"><span>    virtual_router_id <span style="color:#099">251</span>
</span></span><span style="display:flex;"><span>    priority <span style="color:#099">100</span>
</span></span><span style="display:flex;"><span>    advert_int <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>    mcast_src_ip 192.168.199.11
</span></span><span style="display:flex;"><span>    nopreempt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    authentication <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        auth_type PASS
</span></span><span style="display:flex;"><span>        auth_pass <span style="color:#099">11111111</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    track_script <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>         chk_nginx
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    virtual_ipaddress <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        192.168.199.10
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>从节点</strong>清空原来的配置，添加如下配置，<code>192.168.199.10</code> 为 <code>VIP</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/keepalived/keepalived.conf</span>
</span></span><span style="display:flex;"><span>! Configuration File <span style="color:#000;font-weight:bold">for</span> keepalived
</span></span><span style="display:flex;"><span>global_defs <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        router_id 192.168.199.12
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>vrrp_script chk_nginx <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        script <span style="color:#d14">&#34;/etc/keepalived/check_port.sh 7443&#34;</span>
</span></span><span style="display:flex;"><span>        interval <span style="color:#099">2</span>
</span></span><span style="display:flex;"><span>        weight -20
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>vrrp_instance VI_1 <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        state BACKUP
</span></span><span style="display:flex;"><span>        interface eth0
</span></span><span style="display:flex;"><span>        virtual_router_id <span style="color:#099">251</span>
</span></span><span style="display:flex;"><span>        mcast_src_ip 192.168.199.12
</span></span><span style="display:flex;"><span>        priority <span style="color:#099">90</span>
</span></span><span style="display:flex;"><span>        advert_int <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>        authentication <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                auth_type PASS
</span></span><span style="display:flex;"><span>                auth_pass <span style="color:#099">11111111</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        track_script <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                chk_nginx
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        virtual_ipaddress <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                192.168.199.10
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>启动 <code>keepalived</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># systemctl start keepalived.service</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># systemctl enable keepalived.service</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>验证
<code>VIP</code> 在 <code>192.168.199.11</code> 的节点上，当此节点的 <code>Nginx</code> 停止，<code>7443</code> 端口不存活，<code>VIP</code> 会漂移到 <code>192.168.199.12</code> 节点上</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ip ad | grep 192.168.199.10</span>
</span></span><span style="display:flex;"><span>    inet 192.168.199.10/32 scope global eth0
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="4-安装kube-controller-manager">4. 安装kube-controller-manager</h3>
<p>需要在 <code>192.168.199.13</code> 和 <code>192.168.199.14</code> 上进行操作，两边操作相同。
创建启动脚本</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /opt/kubernetes/server/bin/kube-controller-manager.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#!/bin/sh</span>
</span></span><span style="display:flex;"><span>./kube-controller-manager <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --cluster-cidr 172.7.0.0/16 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --leader-elect <span style="color:#0086b3">true</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --log-dir /data/logs/kubernetes/kube-controller-manager <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --master http://127.0.0.1:8080 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --service-account-private-key-file ./cert/ca-key.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --service-cluster-ip-range 192.168.0.0/16 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --root-ca-file ./cert/ca.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --v <span style="color:#099">2</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>找master节点时，使用的是 <code>127.0.0.1</code> 并且是 http 协议，因此不需要使用证书。若组件再不同的机器上，则需要证书。</p>
</blockquote>
<p>对启动脚本进行授权并创建相应的目录</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># chmod +x /opt/kubernetes/server/bin/kube-controller-manager.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mkdir -p /data/logs/kubernetes/kube-controller-manager</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>配置 <code>supervisord</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/supervisord.d/kube-conntroller-manager.ini</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>program:kube-controller-manager-199-13<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">command</span><span style="color:#000;font-weight:bold">=</span>/opt/kubernetes/server/bin/kube-controller-manager.sh                     ; the program <span style="color:#000;font-weight:bold">(</span>relative uses PATH, can take args<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">numprocs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">1</span>                                                                        ; number of processes copies to start <span style="color:#000;font-weight:bold">(</span>def 1<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">directory</span><span style="color:#000;font-weight:bold">=</span>/opt/kubernetes/server/bin                                              ; directory to cwd to before <span style="color:#0086b3">exec</span> <span style="color:#000;font-weight:bold">(</span>def no cwd<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">autostart</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                                                    ; start at supervisord start <span style="color:#000;font-weight:bold">(</span>default: <span style="color:#0086b3">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">autorestart</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                                                  ; retstart at unexpected quit <span style="color:#000;font-weight:bold">(</span>default: <span style="color:#0086b3">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">startsecs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">30</span>                                                                      ; number of secs prog must stay running <span style="color:#000;font-weight:bold">(</span>def. 1<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">startretries</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">3</span>                                                                    ; max <span style="color:#998;font-style:italic"># of serial start failures (default 3)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">exitcodes</span><span style="color:#000;font-weight:bold">=</span>0,2                                                                     ; <span style="color:#d14">&#39;expected&#39;</span> <span style="color:#0086b3">exit</span> codes <span style="color:#000;font-weight:bold">for</span> process <span style="color:#000;font-weight:bold">(</span>default 0,2<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stopsignal</span><span style="color:#000;font-weight:bold">=</span>QUIT                                                                   ; signal used to <span style="color:#0086b3">kill</span> process <span style="color:#000;font-weight:bold">(</span>default TERM<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stopwaitsecs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">10</span>                                                                   ; max num secs to <span style="color:#0086b3">wait</span> b4 SIGKILL <span style="color:#000;font-weight:bold">(</span>default 10<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">user</span><span style="color:#000;font-weight:bold">=</span>root                                                                         ; setuid to this UNIX account to run the program
</span></span><span style="display:flex;"><span><span style="color:#008080">redirect_stderr</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                                              ; redirect proc stderr to stdout <span style="color:#000;font-weight:bold">(</span>default <span style="color:#0086b3">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile</span><span style="color:#000;font-weight:bold">=</span>/data/logs/kubernetes/kube-controller-manager/controller.stdout.log  ; stderr log path, NONE <span style="color:#000;font-weight:bold">for</span> none; default AUTO
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile_maxbytes</span><span style="color:#000;font-weight:bold">=</span>64MB                                                      ; max <span style="color:#998;font-style:italic"># logfile bytes b4 rotation (default 50MB)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile_backups</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">4</span>                                                          ; <span style="color:#998;font-style:italic"># of stdout logfile backups (default 10)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_capture_maxbytes</span><span style="color:#000;font-weight:bold">=</span>1MB                                                       ; number of bytes in <span style="color:#d14">&#39;capturemode&#39;</span> <span style="color:#000;font-weight:bold">(</span>default 0<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_events_enabled</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">false</span>                                                       ; emit events on stdout writes <span style="color:#000;font-weight:bold">(</span>default <span style="color:#0086b3">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>注意不通的主机  [ ] 中的名称不一样</p>
</blockquote>
<p>查看 <code>supervisorctl</code> 的状态</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># supervisorctl update</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># supervisorctl status</span>
</span></span><span style="display:flex;"><span>etcd-server-199-13               RUNNING   pid 846, uptime <span style="color:#099">1</span> day, 13:51:56
</span></span><span style="display:flex;"><span>kube-apiserver-199-13            RUNNING   pid 3514, uptime 6:26:39
</span></span><span style="display:flex;"><span>kube-controller-manager-199-13   RUNNING   pid 4258, uptime 0:03:45
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="5-安装kube-scheduler">5. 安装kube-scheduler</h3>
<h4 id="51-部署kube-scheduler">5.1 部署kube-scheduler</h4>
<p>需要在 <code>192.168.199.13</code> 和 <code>192.168.199.14</code> 上进行操作，两边操作相同。
编辑 <code>kube-scheduler</code> 的启动文件</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /opt/kubernetes/server/bin/kube-scheduler.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#!/bin/sh</span>
</span></span><span style="display:flex;"><span>./kube-scheduler <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --leader-elect  <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --log-dir /data/logs/kubernetes/kube-scheduler <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --master http://127.0.0.1:8080 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --v <span style="color:#099">2</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>找master节点时，使用的是 <code>127.0.0.1</code> 并且是 http 协议，因此不需要使用证书。若组件再不同的机器上，则需要证书。</p>
</blockquote>
<p>对脚本授权并创建相应的目录</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># chmod +x /opt/kubernetes/server/bin/kube-scheduler.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mkdir -p /data/logs/kubernetes/kube-scheduler</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>配置 <code>supervisord</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/supervisord.d/kube-scheduler.ini</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>program:kube-scheduler-199-13<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">command</span><span style="color:#000;font-weight:bold">=</span>/opt/kubernetes/server/bin/kube-scheduler.sh                     ; the program <span style="color:#000;font-weight:bold">(</span>relative uses PATH, can take args<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">numprocs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">1</span>                                                               ; number of processes copies to start <span style="color:#000;font-weight:bold">(</span>def 1<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">directory</span><span style="color:#000;font-weight:bold">=</span>/opt/kubernetes/server/bin                                     ; directory to cwd to before <span style="color:#0086b3">exec</span> <span style="color:#000;font-weight:bold">(</span>def no cwd<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">autostart</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                                           ; start at supervisord start <span style="color:#000;font-weight:bold">(</span>default: <span style="color:#0086b3">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">autorestart</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                                         ; retstart at unexpected quit <span style="color:#000;font-weight:bold">(</span>default: <span style="color:#0086b3">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">startsecs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">30</span>                                                             ; number of secs prog must stay running <span style="color:#000;font-weight:bold">(</span>def. 1<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">startretries</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">3</span>                                                           ; max <span style="color:#998;font-style:italic"># of serial start failures (default 3)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">exitcodes</span><span style="color:#000;font-weight:bold">=</span>0,2                                                            ; <span style="color:#d14">&#39;expected&#39;</span> <span style="color:#0086b3">exit</span> codes <span style="color:#000;font-weight:bold">for</span> process <span style="color:#000;font-weight:bold">(</span>default 0,2<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stopsignal</span><span style="color:#000;font-weight:bold">=</span>QUIT                                                          ; signal used to <span style="color:#0086b3">kill</span> process <span style="color:#000;font-weight:bold">(</span>default TERM<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stopwaitsecs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">10</span>                                                          ; max num secs to <span style="color:#0086b3">wait</span> b4 SIGKILL <span style="color:#000;font-weight:bold">(</span>default 10<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">user</span><span style="color:#000;font-weight:bold">=</span>root                                                                ; setuid to this UNIX account to run the program
</span></span><span style="display:flex;"><span><span style="color:#008080">redirect_stderr</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                                     ; redirect proc stderr to stdout <span style="color:#000;font-weight:bold">(</span>default <span style="color:#0086b3">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile</span><span style="color:#000;font-weight:bold">=</span>/data/logs/kubernetes/kube-scheduler/scheduler.stdout.log ; stderr log path, NONE <span style="color:#000;font-weight:bold">for</span> none; default AUTO
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile_maxbytes</span><span style="color:#000;font-weight:bold">=</span>64MB                                             ; max <span style="color:#998;font-style:italic"># logfile bytes b4 rotation (default 50MB)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile_backups</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">4</span>                                                 ; <span style="color:#998;font-style:italic"># of stdout logfile backups (default 10)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_capture_maxbytes</span><span style="color:#000;font-weight:bold">=</span>1MB                                              ; number of bytes in <span style="color:#d14">&#39;capturemode&#39;</span> <span style="color:#000;font-weight:bold">(</span>default 0<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_events_enabled</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">false</span>                                              ; emit events on stdout writes <span style="color:#000;font-weight:bold">(</span>default <span style="color:#0086b3">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>注意不通的主机  [ ] 中的名称不一样</p>
</blockquote>
<p>查看 <code>supervisorctl</code> 的状态</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># supervisorctl update</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># supervisorctl status</span>
</span></span><span style="display:flex;"><span>etcd-server-199-13               RUNNING   pid 4497, uptime 0:01:13
</span></span><span style="display:flex;"><span>kube-apiserver-199-13            RUNNING   pid 4500, uptime 0:01:13
</span></span><span style="display:flex;"><span>kube-controller-manager-199-13   RUNNING   pid 4499, uptime 0:01:13
</span></span><span style="display:flex;"><span>kube-scheduler-199-13            RUNNING   pid 4498, uptime 0:01:13
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="52-集群状态检查">5.2 集群状态检查</h4>
<p>创建软连接，使用户可以直接使用 <code>kubectl</code> 命令</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ln -s /opt/kubernetes/server/bin/kubectl /usr/bin/kubectl</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># which kubectl</span>
</span></span><span style="display:flex;"><span>/usr/bin/kubectl
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看集群状态</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get cs</span>
</span></span><span style="display:flex;"><span>NAME                 STATUS    MESSAGE              ERROR
</span></span><span style="display:flex;"><span>scheduler            Healthy   ok
</span></span><span style="display:flex;"><span>controller-manager   Healthy   ok
</span></span><span style="display:flex;"><span>etcd-1               Healthy   <span style="color:#000;font-weight:bold">{</span><span style="color:#d14">&#34;health&#34;</span>: <span style="color:#d14">&#34;true&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>etcd-2               Healthy   <span style="color:#000;font-weight:bold">{</span><span style="color:#d14">&#34;health&#34;</span>: <span style="color:#d14">&#34;true&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>etcd-0               Healthy   <span style="color:#000;font-weight:bold">{</span><span style="color:#d14">&#34;health&#34;</span>: <span style="color:#d14">&#34;true&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="6-部署kubelet">6. 部署Kubelet</h3>
<h4 id="61-签发证书">6.1 签发证书</h4>
<p>主要在 <code>192.168.199.15</code> 上进行操作
创建生成证书签名请求（csr）的 <code>JSON</code> 配置文件</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /opt/certs/kubelet-csr.json</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;CN&#34;</span>: <span style="color:#d14">&#34;k8s-kubelet&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;hosts&#34;</span>: <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;127.0.0.1&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;192.168.199.10&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;192.168.199.13&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;192.168.199.14&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;192.168.199.16&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;192.168.199.17&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;192.168.199.18&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;192.168.199.19&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;192.168.199.20&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;192.168.199.21&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">]</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;key&#34;</span>: <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;algo&#34;</span>: <span style="color:#d14">&#34;rsa&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;size&#34;</span>: <span style="color:#099">2048</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;names&#34;</span>: <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;C&#34;</span>: <span style="color:#d14">&#34;CN&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;ST&#34;</span>: <span style="color:#d14">&#34;beijing&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;L&#34;</span>: <span style="color:#d14">&#34;beijing&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;O&#34;</span>: <span style="color:#d14">&#34;od&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;OU&#34;</span>: <span style="color:#d14">&#34;ops&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>hosts中表示可能会安装kubelet的主机，不支持网段</p>
</blockquote>
<p>生成证书</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server kubelet-csr.json | cfssl-json -bare kubelet</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ll kubelet*</span>
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root <span style="color:#099">1115</span> Jun  <span style="color:#099">2</span> 00:10 kubelet.csr
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root  <span style="color:#099">497</span> Jun  <span style="color:#099">2</span> 00:04 kubelet-csr.json
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#099">1</span> root root <span style="color:#099">1675</span> Jun  <span style="color:#099">2</span> 00:10 kubelet-key.pem
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root <span style="color:#099">1468</span> Jun  <span style="color:#099">2</span> 00:10 kubelet.pem
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="62-部署kubelet">6.2 部署kubelet</h4>
<p>在 <code>192.168.199.13</code> 上拷贝证书</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /opt/kubernetes/server/bin/cert/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp 192.168.199.15:/opt/certs/kubelet.pem ./</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp 192.168.199.15:/opt/certs/kubelet-key.pem ./</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>通过以下命令生成 <code>kubelet.kubeconfig</code> ，由于使用的是相对路径，请在 <strong>config目录</strong> 下执行以下命令。</p>
<p><strong>若证书过期，重新生成证书后，需要重新生成 kubelet.kubeconfig</strong></p>
<p><strong>set-cluster</strong>: 指定一个普通的用户，与 <code>192.168.199.10</code> 进行通信，此步骤相当于把 <code>ca.pem</code> 的证书加入到 <code>kubelet.kubeconfig</code> 文件中，通过 <code>echo &quot;xxx&quot; | base64 -d</code> 可看到原来的密钥。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl config set-cluster myk8s \</span>
</span></span><span style="display:flex;"><span>   --certificate-authority<span style="color:#000;font-weight:bold">=</span>/opt/kubernetes/server/bin/cert/ca.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>   --embed-certs<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>   --server<span style="color:#000;font-weight:bold">=</span>https://192.168.199.10:7443 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>   --kubeconfig<span style="color:#000;font-weight:bold">=</span>kubelet.kubeconfig
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>注意IP，这里写的是 api-server 的VIP，不写自己主机的 api-server 接口的原因是防止因自己主机的api-server宕机影响业务。</p>
</blockquote>
<p><strong>set-credentials</strong></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl config set-credentials k8s-node \</span>
</span></span><span style="display:flex;"><span>   --client-certificate<span style="color:#000;font-weight:bold">=</span>/opt/kubernetes/server/bin/cert/client.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>   --client-key<span style="color:#000;font-weight:bold">=</span>/opt/kubernetes/server/bin/cert/client-key.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>   --embed-certs<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>   --kubeconfig<span style="color:#000;font-weight:bold">=</span>kubelet.kubeconfig
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>set-context</strong></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl config set-context myk8s-context \</span>
</span></span><span style="display:flex;"><span>   --cluster<span style="color:#000;font-weight:bold">=</span>myk8s <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>   --user<span style="color:#000;font-weight:bold">=</span>k8s-node <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>   --kubeconfig<span style="color:#000;font-weight:bold">=</span>kubelet.kubeconfig
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>use-context</strong></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl config use-context myk8s-context --kubeconfig=kubelet.kubeconfig</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>若有 <code>kubelet.kubeconfig</code> 文件，可先通过 <code>echo &quot;xxx&quot; | base64 -d &gt; 123.pem</code> 获取密钥文件，再通过 <code>cfssl-certinfo -cert 123.pem</code> 解析出证书生成文件。</p>
</blockquote>
<h4 id="63-创建角色绑定">6.3 创建角色绑定</h4>
<p>让 <code>k8s-node</code> 这个用户具有 <code>system：node</code> 的角色</p>
<p>以下步骤会将数据落入到 etcd 中，因此其他节点不需要执行以下步骤</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /opt/kubernetes/server/bin/conf/k8s-node.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: rbac.authorization.k8s.io/v1
</span></span><span style="display:flex;"><span>kind: ClusterRoleBinding
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: k8s-node
</span></span><span style="display:flex;"><span>roleRef:
</span></span><span style="display:flex;"><span>  apiGroup: rbac.authorization.k8s.io
</span></span><span style="display:flex;"><span>  kind: ClusterRole
</span></span><span style="display:flex;"><span>  name: system:node
</span></span><span style="display:flex;"><span>subjects:
</span></span><span style="display:flex;"><span>- apiGroup: rbac.authorization.k8s.io
</span></span><span style="display:flex;"><span>  kind: User
</span></span><span style="display:flex;"><span>  name: k8s-node
</span></span></code></pre></td></tr></table>
</div>
</div><p>生效配置</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl create -f k8s-node.yaml</span>
</span></span><span style="display:flex;"><span>clusterrolebinding.rbac.authorization.k8s.io/k8s-node created
</span></span></code></pre></td></tr></table>
</div>
</div><p>验证</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get clusterrolebinding k8s-node -o yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: rbac.authorization.k8s.io/v1
</span></span><span style="display:flex;"><span>kind: ClusterRoleBinding
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  creationTimestamp: <span style="color:#d14">&#34;2020-06-01T16:36:57Z&#34;</span>
</span></span><span style="display:flex;"><span>  name: k8s-node
</span></span><span style="display:flex;"><span>  resourceVersion: <span style="color:#d14">&#34;28654&#34;</span>
</span></span><span style="display:flex;"><span>  selfLink: /apis/rbac.authorization.k8s.io/v1/clusterrolebindings/k8s-node
</span></span><span style="display:flex;"><span>  uid: 8eb86a21-e85c-4289-bbe3-fe2671b6465c
</span></span><span style="display:flex;"><span>roleRef:
</span></span><span style="display:flex;"><span>  apiGroup: rbac.authorization.k8s.io
</span></span><span style="display:flex;"><span>  kind: ClusterRole
</span></span><span style="display:flex;"><span>  name: system:node
</span></span><span style="display:flex;"><span>subjects:
</span></span><span style="display:flex;"><span>- apiGroup: rbac.authorization.k8s.io
</span></span><span style="display:flex;"><span>  kind: User
</span></span><span style="display:flex;"><span>  name: k8s-node
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="64-其他节点">6.4 其他节点</h4>
<p><strong>192.168.199.14</strong>上
拷贝证书</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-14 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /opt/kubernetes/server/bin/cert/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-14 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp 192.168.199.15:/opt/certs/kubelet.pem ./</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-14 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp 192.168.199.15:/opt/certs/kubelet-key.pem ./</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>拷贝配置文件</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-14 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /opt/kubernetes/server/bin/conf/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-14 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp root@192.168.199.13:/opt/kubernetes/server/bin/conf/kubelet.kubeconfig ./</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="65-准备paush基础镜像">6.5 准备paush基础镜像</h4>
<p><code>kubelet</code> 启动的时候需要一个基础镜像</p>
<p>在 <code>192.168.199.15</code> 上，准备 <code>paush</code> 基础镜像，并上传至私有仓库</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker pull kubernetes/pause</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker images | grep pause</span>
</span></span><span style="display:flex;"><span>kubernetes/pause                latest                     f9d5de079539        <span style="color:#099">5</span> years ago         240kB
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker tag f9d5de079539 harbor.od.com/public/pause:latest</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker push harbor.od.com/public/pause:latest</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 <code>192.168.199.13</code> 上，创建 <code>kubelet</code> 启动脚本</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /opt/kubernetes/server/bin/kubelet.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#!/bin/sh</span>
</span></span><span style="display:flex;"><span>./kubelet <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  <span style="color:#998;font-style:italic"># 禁止匿名用户使用kubectl</span>
</span></span><span style="display:flex;"><span>  --anonymous-auth<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">false</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  <span style="color:#998;font-style:italic"># 与docker配置文件/etc/docker/daemon.json中保持一致</span>
</span></span><span style="display:flex;"><span>  --cgroup-driver systemd <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  <span style="color:#998;font-style:italic"># coredns会使用此IP</span>
</span></span><span style="display:flex;"><span>  --cluster-dns 192.168.0.2 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --cluster-domain cluster.local <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --runtime-cgroups<span style="color:#000;font-weight:bold">=</span>/systemd/system.slice <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --kubelet-cgroups<span style="color:#000;font-weight:bold">=</span>/systemd/system.slice <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  <span style="color:#998;font-style:italic"># 不关闭swap也可以启动kubelet</span>
</span></span><span style="display:flex;"><span>  --fail-swap-on<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;false&#34;</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --client-ca-file ./cert/ca.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --tls-cert-file ./cert/kubelet.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --tls-private-key-file ./cert/kubelet-key.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  <span style="color:#998;font-style:italic"># 主机名</span>
</span></span><span style="display:flex;"><span>  --hostname-override 192-168-199-13.host.com <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --image-gc-high-threshold <span style="color:#099">20</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --image-gc-low-threshold <span style="color:#099">10</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --kubeconfig ./conf/kubelet.kubeconfig <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --log-dir /data/logs/kubernetes/kube-kubelet <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  <span style="color:#998;font-style:italic"># pause的位置</span>
</span></span><span style="display:flex;"><span>  --pod-infra-container-image harbor.od.com/public/pause:latest <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --root-dir /data/kubelet
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>注意hostname-override 中的主机名及镜像仓库的地址</p>
</blockquote>
<p>对脚本授权并创建相应的目录</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mkdir -p /data/logs/kubernetes/kube-kubelet /data/kubelet</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># chmod a+x /opt/kubernetes/server/bin/kubelet.sh</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>配置 <code>supervisord</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/supervisord.d/kube-kubelet.ini</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>program:kube-kubelet-199-13<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">command</span><span style="color:#000;font-weight:bold">=</span>/opt/kubernetes/server/bin/kubelet.sh     ; the program <span style="color:#000;font-weight:bold">(</span>relative uses PATH, can take args<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">numprocs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">1</span>                                        ; number of processes copies to start <span style="color:#000;font-weight:bold">(</span>def 1<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">directory</span><span style="color:#000;font-weight:bold">=</span>/opt/kubernetes/server/bin              ; directory to cwd to before <span style="color:#0086b3">exec</span> <span style="color:#000;font-weight:bold">(</span>def no cwd<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">autostart</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                    ; start at supervisord start <span style="color:#000;font-weight:bold">(</span>default: <span style="color:#0086b3">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">autorestart</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                  ; retstart at unexpected quit <span style="color:#000;font-weight:bold">(</span>default: <span style="color:#0086b3">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">startsecs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">30</span>                                      ; number of secs prog must stay running <span style="color:#000;font-weight:bold">(</span>def. 1<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">startretries</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">3</span>                                    ; max <span style="color:#998;font-style:italic"># of serial start failures (default 3)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">exitcodes</span><span style="color:#000;font-weight:bold">=</span>0,2                                     ; <span style="color:#d14">&#39;expected&#39;</span> <span style="color:#0086b3">exit</span> codes <span style="color:#000;font-weight:bold">for</span> process <span style="color:#000;font-weight:bold">(</span>default 0,2<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stopsignal</span><span style="color:#000;font-weight:bold">=</span>QUIT                                   ; signal used to <span style="color:#0086b3">kill</span> process <span style="color:#000;font-weight:bold">(</span>default TERM<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stopwaitsecs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">10</span>                                   ; max num secs to <span style="color:#0086b3">wait</span> b4 SIGKILL <span style="color:#000;font-weight:bold">(</span>default 10<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">user</span><span style="color:#000;font-weight:bold">=</span>root                                         ; setuid to this UNIX account to run the program
</span></span><span style="display:flex;"><span><span style="color:#008080">redirect_stderr</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                              ; redirect proc stderr to stdout <span style="color:#000;font-weight:bold">(</span>default <span style="color:#0086b3">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile</span><span style="color:#000;font-weight:bold">=</span>/data/logs/kubernetes/kube-kubelet/kubelet.stdout.log   ; stderr log path, NONE <span style="color:#000;font-weight:bold">for</span> none; default AUTO
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile_maxbytes</span><span style="color:#000;font-weight:bold">=</span>64MB                      ; max <span style="color:#998;font-style:italic"># logfile bytes b4 rotation (default 50MB)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile_backups</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">4</span>                          ; <span style="color:#998;font-style:italic"># of stdout logfile backups (default 10)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_capture_maxbytes</span><span style="color:#000;font-weight:bold">=</span>1MB                       ; number of bytes in <span style="color:#d14">&#39;capturemode&#39;</span> <span style="color:#000;font-weight:bold">(</span>default 0<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_events_enabled</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">false</span>                       ; emit events on stdout writes <span style="color:#000;font-weight:bold">(</span>default <span style="color:#0086b3">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>检查 <code>supervisorctl</code> 的状态</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># supervisorctl update</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># supervisorctl status</span>
</span></span><span style="display:flex;"><span>etcd-server-199-13               RUNNING   pid 4497, uptime <span style="color:#099">1</span> day, 1:40:00
</span></span><span style="display:flex;"><span>kube-apiserver-199-13            RUNNING   pid 4500, uptime <span style="color:#099">1</span> day, 1:40:00
</span></span><span style="display:flex;"><span>kube-controller-manager-199-13   RUNNING   pid 4817, uptime 4:12:46
</span></span><span style="display:flex;"><span>kube-kubelet-199-13              RUNNING   pid 5487, uptime 0:00:41
</span></span><span style="display:flex;"><span>kube-scheduler-199-13            RUNNING   pid 5144, uptime 1:22:14
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="67-验证集群">6.7 验证集群</h4>
<p>查看集群状况</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get nodes</span>
</span></span><span style="display:flex;"><span>NAME                      STATUS   ROLES    AGE   VERSION
</span></span><span style="display:flex;"><span>192-168-199-13.host.com   Ready    &lt;none&gt;   94s   v1.15.2
</span></span><span style="display:flex;"><span>192-168-199-14.host.com   Ready    &lt;none&gt;   92s   v1.15.2
</span></span></code></pre></td></tr></table>
</div>
</div><p>上述 <code>ROLES</code> 标签为空，添加 <code>ROLES</code> 标签，非必须的操作</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl label node 192-168-199-13.host.com node-role.kubernetes.io/master=</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl label node 192-168-199-13.host.com node-role.kubernetes.io/node=</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl label node 192-168-199-14.host.com node-role.kubernetes.io/master=</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl label node 192-168-199-14.host.com node-role.kubernetes.io/node=</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 再次查看集群状态，ROLES中有角色</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get nodes</span>
</span></span><span style="display:flex;"><span>NAME                      STATUS   ROLES         AGE     VERSION
</span></span><span style="display:flex;"><span>192-168-199-13.host.com   Ready    master,node   6m35s   v1.15.2
</span></span><span style="display:flex;"><span>192-168-199-14.host.com   Ready    master,node   6m33s   v1.15.2
</span></span></code></pre></td></tr></table>
</div>
</div><p>默认 <code>kubectl</code> 无法通过 <code>Tab</code> 键补全参数，可通过以下命令设置自动补全功能</p>
<pre tabindex="0"><code>[root@192-168-199-13 ~]# source &lt;(kubectl completion bash)
</code></pre><h3 id="7-部署kube-proxy">7. 部署kube-proxy</h3>
<p><code>kube-proxy</code> 主要用于连接集群网络和 <code>pod</code> 网络</p>
<h4 id="71-签发证书">7.1 签发证书</h4>
<p>在 <code>192.168.199.15</code> 中签发证书</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /opt/certs/kube-proxy-csr.json</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;CN&#34;</span>: <span style="color:#d14">&#34;system:kube-proxy&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;key&#34;</span>: <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;algo&#34;</span>: <span style="color:#d14">&#34;rsa&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;size&#34;</span>: <span style="color:#099">2048</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;names&#34;</span>: <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;C&#34;</span>: <span style="color:#d14">&#34;CN&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;ST&#34;</span>: <span style="color:#d14">&#34;beijing&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;L&#34;</span>: <span style="color:#d14">&#34;beijing&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;O&#34;</span>: <span style="color:#d14">&#34;od&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;OU&#34;</span>: <span style="color:#d14">&#34;ops&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client kube-proxy-csr.json |cfssl-json -bare kube-proxy-client</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 <code>192.168.199.13</code> 上拷贝证书</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /opt/kubernetes/server/bin/cert</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp root@192.168.199.15:/opt/certs/kube-proxy-client.pem ./</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp root@192.168.199.15:/opt/certs/kube-proxy-client-key.pem ./</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>set-cluster</strong></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /opt/kubernetes/server/bin/conf/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl config set-cluster myk8s \</span>
</span></span><span style="display:flex;"><span>   --certificate-authority<span style="color:#000;font-weight:bold">=</span>/opt/kubernetes/server/bin/cert/ca.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>   --embed-certs<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>   --server<span style="color:#000;font-weight:bold">=</span>https://192.168.199.10:7443 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>   --kubeconfig<span style="color:#000;font-weight:bold">=</span>kube-proxy.kubeconfig
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>set-credentials</strong></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl config set-credentials kube-proxy \</span>
</span></span><span style="display:flex;"><span>   --client-certificate<span style="color:#000;font-weight:bold">=</span>/opt/kubernetes/server/bin/cert/kube-proxy-client.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>   --client-key<span style="color:#000;font-weight:bold">=</span>/opt/kubernetes/server/bin/cert/kube-proxy-client-key.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>   --embed-certs<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>   --kubeconfig<span style="color:#000;font-weight:bold">=</span>kube-proxy.kubeconfig
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>set-contex</strong></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl config set-context myk8s-context \</span>
</span></span><span style="display:flex;"><span>   --cluster<span style="color:#000;font-weight:bold">=</span>myk8s <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>   --user<span style="color:#000;font-weight:bold">=</span>kube-proxy <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>   --kubeconfig<span style="color:#000;font-weight:bold">=</span>kube-proxy.kubeconfig
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>use-context</strong></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl config use-context myk8s-context --kubeconfig=kube-proxy.kubeconfig</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 <code>192.168.199.14</code> 拷贝  <code>192.168.199.13</code>  上生成的 <code>kube-proxy.kubeconfig</code> 即可</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-14 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /opt/kubernetes/server/bin/conf/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-14 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp root@192.168.199.13:/opt/kubernetes/server/bin/conf/kube-proxy.kubeconfig ./</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="72-加载lvs模块">7.2 加载lvs模块</h4>
<p><code>192.168.199.13</code> 和 <code>192.168.199.14</code>
启动内核中的 <code>lvs</code> 模块</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat ip_vs.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#!/bin/bash</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">ipvs_mods_dir</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;/usr/lib/modules/</span><span style="color:#000;font-weight:bold">$(</span>uname -r<span style="color:#000;font-weight:bold">)</span><span style="color:#d14">/kernel/net/netfilter/ipvs&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">for</span> i in <span style="color:#000;font-weight:bold">$(</span>ls <span style="color:#008080">$ipvs_mods_dir</span>|grep -o <span style="color:#d14">&#34;^[^.]*&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span>  /sbin/modinfo -F filename <span style="color:#008080">$i</span> &amp;&gt;/dev/null
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">[</span> <span style="color:#008080">$?</span> -eq <span style="color:#099">0</span> <span style="color:#000;font-weight:bold">]</span>;<span style="color:#000;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>    /sbin/modprobe <span style="color:#008080">$i</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">done</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>对脚本进行授权，并执行脚本</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># chmod a+x ip_vs.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># sh ip_vs.sh</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>验证模块是否被加载</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># lsmod | grep ip_vs</span>
</span></span><span style="display:flex;"><span>ip_vs_wrr              <span style="color:#099">12697</span>  <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>ip_vs_wlc              <span style="color:#099">12519</span>  <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>ip_vs_sh               <span style="color:#099">12688</span>  <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>ip_vs_sed              <span style="color:#099">12519</span>  <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>ip_vs_rr               <span style="color:#099">12600</span>  <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>ip_vs_pe_sip           <span style="color:#099">12740</span>  <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>nf_conntrack_sip       <span style="color:#099">33780</span>  <span style="color:#099">1</span> ip_vs_pe_sip
</span></span><span style="display:flex;"><span>ip_vs_nq               <span style="color:#099">12516</span>  <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>ip_vs_lc               <span style="color:#099">12516</span>  <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>ip_vs_lblcr            <span style="color:#099">12922</span>  <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>ip_vs_lblc             <span style="color:#099">12819</span>  <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>ip_vs_ftp              <span style="color:#099">13079</span>  <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>ip_vs_dh               <span style="color:#099">12688</span>  <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>ip_vs                 <span style="color:#099">145497</span>  <span style="color:#099">24</span> ip_vs_dh,ip_vs_lc,ip_vs_nq,ip_vs_rr,ip_vs_sh,ip_vs_ftp,ip_vs_sed,ip_vs_wlc,ip_vs_wrr,ip_vs_pe_sip,ip_vs_lblcr,ip_vs_lblc
</span></span><span style="display:flex;"><span>nf_nat                 <span style="color:#099">26583</span>  <span style="color:#099">3</span> ip_vs_ftp,nf_nat_ipv4,nf_nat_masquerade_ipv4
</span></span><span style="display:flex;"><span>nf_conntrack          <span style="color:#099">139264</span>  <span style="color:#099">8</span> ip_vs,nf_nat,nf_nat_ipv4,xt_conntrack,nf_nat_masquerade_ipv4,nf_conntrack_netlink,nf_conntrack_sip,nf_conntrack_ipv4
</span></span><span style="display:flex;"><span>libcrc32c              <span style="color:#099">12644</span>  <span style="color:#099">3</span> ip_vs,nf_nat,nf_conntrack
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="73-启动服务">7.3 启动服务</h4>
<p>创建启动脚本</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /opt/kubernetes/server/bin/kube-proxy.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#!/bin/sh</span>
</span></span><span style="display:flex;"><span>./kube-proxy <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --cluster-cidr 172.7.0.0/16 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --hostname-override 192-168-199-13.host.com <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --proxy-mode<span style="color:#000;font-weight:bold">=</span>ipvs <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --ipvs-scheduler<span style="color:#000;font-weight:bold">=</span>nq <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --kubeconfig ./conf/kube-proxy.kubeconfig
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>注意主机名，cluster-cidr 指 pod 集群IP</p>
</blockquote>
<p>根据上述脚本创建目录并对脚本进行授权</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># chmod a+x /opt/kubernetes/server/bin/kube-proxy.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mkdir -p /data/logs/kubernetes/kube-proxy</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>配置 <code>supervisord</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/supervisord.d/kube-proxy.ini</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>program:kube-proxy-199-13<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">command</span><span style="color:#000;font-weight:bold">=</span>/opt/kubernetes/server/bin/kube-proxy.sh                     ; the program <span style="color:#000;font-weight:bold">(</span>relative uses PATH, can take args<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">numprocs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">1</span>                                                           ; number of processes copies to start <span style="color:#000;font-weight:bold">(</span>def 1<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">directory</span><span style="color:#000;font-weight:bold">=</span>/opt/kubernetes/server/bin                                 ; directory to cwd to before <span style="color:#0086b3">exec</span> <span style="color:#000;font-weight:bold">(</span>def no cwd<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">autostart</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                                       ; start at supervisord start <span style="color:#000;font-weight:bold">(</span>default: <span style="color:#0086b3">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">autorestart</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                                     ; retstart at unexpected quit <span style="color:#000;font-weight:bold">(</span>default: <span style="color:#0086b3">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">startsecs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">30</span>                                                         ; number of secs prog must stay running <span style="color:#000;font-weight:bold">(</span>def. 1<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">startretries</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">3</span>                                                       ; max <span style="color:#998;font-style:italic"># of serial start failures (default 3)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">exitcodes</span><span style="color:#000;font-weight:bold">=</span>0,2                                                        ; <span style="color:#d14">&#39;expected&#39;</span> <span style="color:#0086b3">exit</span> codes <span style="color:#000;font-weight:bold">for</span> process <span style="color:#000;font-weight:bold">(</span>default 0,2<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stopsignal</span><span style="color:#000;font-weight:bold">=</span>QUIT                                                      ; signal used to <span style="color:#0086b3">kill</span> process <span style="color:#000;font-weight:bold">(</span>default TERM<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stopwaitsecs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">10</span>                                                      ; max num secs to <span style="color:#0086b3">wait</span> b4 SIGKILL <span style="color:#000;font-weight:bold">(</span>default 10<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">user</span><span style="color:#000;font-weight:bold">=</span>root                                                            ; setuid to this UNIX account to run the program
</span></span><span style="display:flex;"><span><span style="color:#008080">redirect_stderr</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                                 ; redirect proc stderr to stdout <span style="color:#000;font-weight:bold">(</span>default <span style="color:#0086b3">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile</span><span style="color:#000;font-weight:bold">=</span>/data/logs/kubernetes/kube-proxy/proxy.stdout.log     ; stderr log path, NONE <span style="color:#000;font-weight:bold">for</span> none; default AUTO
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile_maxbytes</span><span style="color:#000;font-weight:bold">=</span>64MB                                         ; max <span style="color:#998;font-style:italic"># logfile bytes b4 rotation (default 50MB)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile_backups</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">4</span>                                             ; <span style="color:#998;font-style:italic"># of stdout logfile backups (default 10)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_capture_maxbytes</span><span style="color:#000;font-weight:bold">=</span>1MB                                          ; number of bytes in <span style="color:#d14">&#39;capturemode&#39;</span> <span style="color:#000;font-weight:bold">(</span>default 0<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_events_enabled</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">false</span>                                          ; emit events on stdout writes <span style="color:#000;font-weight:bold">(</span>default <span style="color:#0086b3">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>更新 <code>supervisord</code> 并查看状态</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># supervisorctl update</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># supervisorctl status</span>
</span></span><span style="display:flex;"><span>etcd-server-199-13               RUNNING   pid 688, uptime 0:47:58
</span></span><span style="display:flex;"><span>kube-apiserver-199-13            RUNNING   pid 695, uptime 0:47:58
</span></span><span style="display:flex;"><span>kube-controller-manager-199-13   RUNNING   pid 693, uptime 0:47:58
</span></span><span style="display:flex;"><span>kube-kubelet-199-13              RUNNING   pid 691, uptime 0:47:58
</span></span><span style="display:flex;"><span>kube-proxy-199-13                RUNNING   pid 10633, uptime 0:00:59
</span></span><span style="display:flex;"><span>kube-scheduler-199-13            RUNNING   pid 689, uptime 0:47:58
</span></span></code></pre></td></tr></table>
</div>
</div><p>安装 <code>ipvsadm</code> 工具，查看 <code>ipvs</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># yum install ipvsadm -y</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ipvsadm -Ln</span>
</span></span><span style="display:flex;"><span>IP Virtual Server version 1.2.1 <span style="color:#000;font-weight:bold">(</span><span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span>4096<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>Prot LocalAddress:Port Scheduler Flags
</span></span><span style="display:flex;"><span>  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
</span></span><span style="display:flex;"><span>TCP  192.168.0.1:443 nq
</span></span><span style="display:flex;"><span>  -&gt; 192.168.199.13:6443          Masq    <span style="color:#099">1</span>      <span style="color:#099">0</span>          <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>  -&gt; 192.168.199.14:6443          Masq    <span style="color:#099">1</span>      <span style="color:#099">0</span>          <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get svc</span>
</span></span><span style="display:flex;"><span>NAME         TYPE        CLUSTER-IP    EXTERNAL-IP   PORT<span style="color:#000;font-weight:bold">(</span>S<span style="color:#000;font-weight:bold">)</span>   AGE
</span></span><span style="display:flex;"><span>kubernetes   ClusterIP   192.168.0.1   &lt;none&gt;        443/TCP   2d7h
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="8-集群验证">8. 集群验证</h3>
<p>创建一个名称为 <code>my-nginx</code> 的 <code>pod</code> ，配置文件如下</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /root/nginx-ds.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: extensions/v1beta1
</span></span><span style="display:flex;"><span>kind: DaemonSet
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: nginx-ds
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  template:
</span></span><span style="display:flex;"><span>    metadata:
</span></span><span style="display:flex;"><span>      labels:
</span></span><span style="display:flex;"><span>        app: nginx-ds
</span></span><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>      - name: my-nginx
</span></span><span style="display:flex;"><span>        image: harbor.od.com/public/nginx:v1.7.9
</span></span><span style="display:flex;"><span>        ports:
</span></span><span style="display:flex;"><span>        - containerPort: <span style="color:#099">80</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>根据 <code>yaml</code> 文件启动 <code>pod</code> ，并查看其状态</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl create -f nginx-ds.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get pods -o wide</span>
</span></span><span style="display:flex;"><span>NAME             READY   STATUS    RESTARTS   AGE   IP           NODE                      NOMINATED NODE   READINESS GATES
</span></span><span style="display:flex;"><span>nginx-ds-6z2cl   1/1     Running   <span style="color:#099">0</span>          27s   172.7.14.2   192-168-199-14.host.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>nginx-ds-ln87w   1/1     Running   <span style="color:#099">0</span>          27s   172.7.13.2   192-168-199-13.host.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic">#  curl 172.7.13.2</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看集群状态</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get cs</span>
</span></span><span style="display:flex;"><span>NAME                 STATUS    MESSAGE              ERROR
</span></span><span style="display:flex;"><span>scheduler            Healthy   ok
</span></span><span style="display:flex;"><span>controller-manager   Healthy   ok
</span></span><span style="display:flex;"><span>etcd-1               Healthy   <span style="color:#000;font-weight:bold">{</span><span style="color:#d14">&#34;health&#34;</span>: <span style="color:#d14">&#34;true&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>etcd-2               Healthy   <span style="color:#000;font-weight:bold">{</span><span style="color:#d14">&#34;health&#34;</span>: <span style="color:#d14">&#34;true&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>etcd-0               Healthy   <span style="color:#000;font-weight:bold">{</span><span style="color:#d14">&#34;health&#34;</span>: <span style="color:#d14">&#34;true&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get node</span>
</span></span><span style="display:flex;"><span>NAME                      STATUS   ROLES         AGE   VERSION
</span></span><span style="display:flex;"><span>192-168-199-13.host.com   Ready    master,node   23h   v1.15.2
</span></span><span style="display:flex;"><span>192-168-199-14.host.com   Ready    master,node   23h   v1.15.2
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get pods</span>
</span></span><span style="display:flex;"><span>NAME             READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>nginx-ds-6z2cl   1/1     Running   <span style="color:#099">0</span>          3m1s
</span></span><span style="display:flex;"><span>nginx-ds-ln87w   1/1     Running   <span style="color:#099">0</span>          3m1s
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="三常用命令">三、常用命令</h1>
<h3 id="1-陈述式资源管理">1. 陈述式资源管理</h3>
<h4 id="11-命名空间">1.1 命名空间</h4>
<p>查看命名空间</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get namespace</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 可以简写为</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get ns</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>查询 <code>default</code> 空间下所有的资源</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get all [ -n default ]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建一个名称为 <code>app</code> 的命名空间</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl create ns app</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>删除名称为 <code>app</code> 的命名空间</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl delete ns app</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="12-deployment">1.2 deployment</h4>
<p>创建一个 <code>deployment</code> 资源</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># deployment 可以简写为 deploy</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl create deployment nginx-dp --image=harbor.od.com/public/nginx:v1.7.9 -n kube-public</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看 <code>deployment</code> 资源</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 简单查看</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get deploy -n kube-public</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 扩展查看</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get deploy -n kube-public -o wide</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 详细查看</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl describe deployment nginx-dp -n kube-public</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="13-pods">1.3 pods</h4>
<p>查看 <code>pod</code> 资源</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get pod [ -o wide ]</span>
</span></span><span style="display:flex;"><span>NAME             READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>nginx-ds-6z2cl   1/1     Running   <span style="color:#099">1</span>          23h
</span></span><span style="display:flex;"><span>nginx-ds-ln87w   1/1     Running   <span style="color:#099">1</span>          23h
</span></span></code></pre></td></tr></table>
</div>
</div><p>进入 <code>pod</code> 资源内部</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl exec -it nginx-ds-6z2cl /bin/bash</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="14-services">1.4 services</h4>
<p>暴露服务端口</p>
<pre tabindex="0"><code>[root@192-168-199-13 ~]# kubectl expose deployment nginx-dp --port=80 -n kube-public
</code></pre><p>更改服务副本数</p>
<pre tabindex="0"><code>[root@192-168-199-13 ~]# kubectl scale deployment nginx-dp --replicas=2 -n kube-public
</code></pre><h3 id="2-声明式资源管理">2. 声明式资源管理</h3>
<h4 id="21-pods">2.1 pods</h4>
<p>查看 <code>kube-public</code> 命名空间内的 <code>pod</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get pods -n kube-public</span>
</span></span><span style="display:flex;"><span>NAME                        READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>nginx-dp-5dfc689474-2mlsq   1/1     Running   <span style="color:#099">1</span>          11d
</span></span></code></pre></td></tr></table>
</div>
</div><p>获取资源配置清单</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get pods nginx-dp-5dfc689474-2mlsq -o yaml -n kube-public</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看<code>pods</code>的资源配置清单写法</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl explain pods</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看 <code>pods</code> 中 <code>metadate</code> 的用法</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl explain pods.metadata</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>资源配置清单示例：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat nginx-ds-svc.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Service
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    app: nginx-ds
</span></span><span style="display:flex;"><span>  name: nginx-ds
</span></span><span style="display:flex;"><span>  namespace: default
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  ports:
</span></span><span style="display:flex;"><span>  - port: <span style="color:#099">80</span>
</span></span><span style="display:flex;"><span>    protocol: TCP
</span></span><span style="display:flex;"><span>    targetPort: <span style="color:#099">80</span>
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    app: nginx-ds
</span></span><span style="display:flex;"><span>  sessionAffinity: None
</span></span><span style="display:flex;"><span>  type: ClusterIP
</span></span></code></pre></td></tr></table>
</div>
</div><p>根据资源配置清单创建 <code>pod</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl create -f nginx-ds-svc.yaml</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="22-services">2.2 services</h4>
<p>获取 <code>service</code> 信息</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get svc</span>
</span></span><span style="display:flex;"><span>NAME         TYPE        CLUSTER-IP        EXTERNAL-IP   PORT<span style="color:#000;font-weight:bold">(</span>S<span style="color:#000;font-weight:bold">)</span>   AGE
</span></span><span style="display:flex;"><span>kubernetes   ClusterIP   192.168.0.1       &lt;none&gt;        443/TCP   14d
</span></span><span style="display:flex;"><span>nginx-ds     ClusterIP   192.168.164.154   &lt;none&gt;        80/TCP    9s
</span></span></code></pre></td></tr></table>
</div>
</div><p>将 <code>nginx-ds</code> 的配置信息以 <code>yaml</code> 的方式输出</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get svc nginx-ds -o yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Service
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  creationTimestamp: <span style="color:#d14">&#34;2020-06-14T22:42:42Z&#34;</span>
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    app: nginx-ds
</span></span><span style="display:flex;"><span>  name: nginx-ds
</span></span><span style="display:flex;"><span>  namespace: default
</span></span><span style="display:flex;"><span>  resourceVersion: <span style="color:#d14">&#34;238777&#34;</span>
</span></span><span style="display:flex;"><span>  selfLink: /api/v1/namespaces/default/services/nginx-ds
</span></span><span style="display:flex;"><span>  uid: 0128d415-acc5-43df-a235-87e75a72d86e
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  clusterIP: 192.168.164.154
</span></span><span style="display:flex;"><span>  ports:
</span></span><span style="display:flex;"><span>  - port: <span style="color:#099">80</span>
</span></span><span style="display:flex;"><span>    protocol: TCP
</span></span><span style="display:flex;"><span>    targetPort: <span style="color:#099">80</span>
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    app: nginx-ds
</span></span><span style="display:flex;"><span>  sessionAffinity: None
</span></span><span style="display:flex;"><span>  type: ClusterIP
</span></span><span style="display:flex;"><span>status:
</span></span><span style="display:flex;"><span>  loadBalancer: <span style="color:#000;font-weight:bold">{}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可通过 <code>explain</code> 查看资源配置清单的写法</p>
<pre tabindex="0"><code>[root@k8s-node1 ~]# kubectl explain ds
</code></pre><h1 id="四flannel网络">四、Flannel网络</h1>
<p><strong>CIN网络插件</strong>最主要的功能是实现POD资源可以<strong>跨宿主机</strong>进行通信</p>
<h4 id="1-安装并配置flannel">1. 安装并配置Flannel</h4>
<p>需要在所有 <code>node</code> 节点安装 <code>Flannel</code> ，使 <code>pod</code> 可以跨界点间通信
目前集群 <code>pod</code> 之间不能互相通信，从<code>pod 172.7.13.2</code> 中无法 <code>ping</code> 通 <code>172.7.14.3</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get pod -o wide</span>
</span></span><span style="display:flex;"><span>NAME             READY   STATUS    RESTARTS   AGE   IP           NODE                      NOMINATED NODE   READINESS GATES
</span></span><span style="display:flex;"><span>nginx-ds-6z2cl   1/1     Running   <span style="color:#099">2</span>          12d   172.7.14.3   192-168-199-14.host.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>nginx-ds-ln87w   1/1     Running   <span style="color:#099">2</span>          12d   172.7.13.2   192-168-199-13.host.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl exec -it nginx-ds-ln87w /bin/bash</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@nginx-ds-ln87w:/# ping 172.7.14.3
</span></span><span style="display:flex;"><span>PING 172.7.14.3 <span style="color:#000;font-weight:bold">(</span>172.7.14.3<span style="color:#000;font-weight:bold">)</span>: <span style="color:#099">48</span> data bytes
</span></span></code></pre></td></tr></table>
</div>
</div><p>从 <code>172.7.14.3</code> 中也无法 <code>ping</code> 通 <code>172.7.13.2</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-14 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get pod -o wide</span>
</span></span><span style="display:flex;"><span>NAME             READY   STATUS    RESTARTS   AGE   IP           NODE                      NOMINATED NODE   READINESS GATES
</span></span><span style="display:flex;"><span>nginx-ds-6z2cl   1/1     Running   <span style="color:#099">2</span>          12d   172.7.14.3   192-168-199-14.host.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>nginx-ds-ln87w   1/1     Running   <span style="color:#099">2</span>          12d   172.7.13.2   192-168-199-13.host.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-14 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl exec -it nginx-ds-6z2cl /bin/bash</span>
</span></span><span style="display:flex;"><span>root@nginx-ds-6z2cl:/# ping 172.7.13.2
</span></span><span style="display:flex;"><span>PING 172.7.13.2 <span style="color:#000;font-weight:bold">(</span>172.7.13.2<span style="color:#000;font-weight:bold">)</span>: <span style="color:#099">48</span> data bytes
</span></span></code></pre></td></tr></table>
</div>
</div><p>从 <a href="https://github.com/coreos/flannel/releases">flannel官网</a>下载软件</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># wget https://github.com/coreos/flannel/releases/download/v0.11.0/flannel-v0.11.0-linux-amd64.tar.gz</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>解压软件包，并创建软连接</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mkdir /opt/flannel-v0.11.0</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># tar xf flannel-v0.11.0-linux-amd64.tar.gz -C /opt/flannel-v0.11.0</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ln -s /opt/flannel-v0.11.0/ /opt/flannel</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>拷贝证书，使 <code>flannel</code> 可以连接 <code>etcd</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /opt/flannel</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 flannel<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mkdir cert</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 flannel<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd cert/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp root@192.168.199.15:/opt/certs/ca.pem ./</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp root@192.168.199.15:/opt/certs/client.pem ./</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp root@192.168.199.15:/opt/certs/client-key.pem ./</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ll</span>
</span></span><span style="display:flex;"><span>total <span style="color:#099">12</span>
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root <span style="color:#099">1346</span> Jun <span style="color:#099">15</span> 19:49 ca.pem
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#099">1</span> root root <span style="color:#099">1675</span> Jun <span style="color:#099">15</span> 19:50 client-key.pem
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root <span style="color:#099">1363</span> Jun <span style="color:#099">15</span> 19:50 client.pem
</span></span></code></pre></td></tr></table>
</div>
</div><p>定义网络相关变量，启动 <code>falnnel</code> 时会引用此文件</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 flannel<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat subnet.env</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 整个 pod 集群使用的网段</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">FLANNEL_NETWORK</span><span style="color:#000;font-weight:bold">=</span>172.7.0.0/16
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 本机 pod 使用的网段</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">FLANNEL_SUBNET</span><span style="color:#000;font-weight:bold">=</span>172.7.13.1/24
</span></span><span style="display:flex;"><span><span style="color:#008080">FLANNEL_MTU</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">1500</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">FLANNEL_IPMASQ</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">false</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建 <code>flanneld</code> 的启动脚本</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 flannel<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat flanneld.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#!/bin/sh</span>
</span></span><span style="display:flex;"><span>./flanneld <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  <span style="color:#998;font-style:italic"># 自己本身的 node ip</span>
</span></span><span style="display:flex;"><span>  --public-ip<span style="color:#000;font-weight:bold">=</span>192.168.199.13 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  <span style="color:#998;font-style:italic"># etcd集群的地址</span>
</span></span><span style="display:flex;"><span>  --etcd-endpoints<span style="color:#000;font-weight:bold">=</span>https://192.168.199.12:2379,https://192.168.199.13:2379,https://192.168.199.14:2379 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --etcd-keyfile<span style="color:#000;font-weight:bold">=</span>./cert/client-key.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --etcd-certfile<span style="color:#000;font-weight:bold">=</span>./cert/client.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --etcd-cafile<span style="color:#000;font-weight:bold">=</span>./cert/ca.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  <span style="color:#998;font-style:italic"># 网卡名称</span>
</span></span><span style="display:flex;"><span>  --iface<span style="color:#000;font-weight:bold">=</span>eth0 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --subnet-file<span style="color:#000;font-weight:bold">=</span>./subnet.env <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --healthz-port<span style="color:#000;font-weight:bold">=</span><span style="color:#099">2401</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>对脚本进行授权</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 flannel<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># chmod a+x flanneld.sh</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 <code>etcd</code> 集群中<strong>任意一台主机</strong>上配置 <code>flannel</code> 使用 <code>host-gw</code> 的网络模型，此模型中所有的 <code>Node</code> 节点应处于同一个二层网络，拥有同一个物理网关。可以通过 <code>./etcdctl member list</code> 命令查看集群状态</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /opt/etcd</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 配置为 host-gw 模式</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ./etcdctl set /coreos.com/network/config &#39;{&#34;Network&#34;: &#34;172.7.0.0/16&#34;, &#34;Backend&#34;: {&#34;Type&#34;: &#34;host-gw&#34;}}&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 验证配置</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ./etcdctl get /coreos.com/network/config</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span><span style="color:#d14">&#34;Network&#34;</span>: <span style="color:#d14">&#34;172.7.0.0/16&#34;</span>, <span style="color:#d14">&#34;Backend&#34;</span>: <span style="color:#000;font-weight:bold">{</span><span style="color:#d14">&#34;Type&#34;</span>: <span style="color:#d14">&#34;host-gw&#34;</span><span style="color:#000;font-weight:bold">}}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>除此之外还有 Vxlan 网络模型 和 直接路由模型</p>
</blockquote>
<p>配置 <code>supervisord</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/supervisord.d/flannel.ini</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>program:flanneld-199-13<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">command</span><span style="color:#000;font-weight:bold">=</span>/opt/flannel/flanneld.sh                             ; the program <span style="color:#000;font-weight:bold">(</span>relative uses PATH, can take args<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">numprocs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">1</span>                                                   ; number of processes copies to start <span style="color:#000;font-weight:bold">(</span>def 1<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">directory</span><span style="color:#000;font-weight:bold">=</span>/opt/flannel                                       ; directory to cwd to before <span style="color:#0086b3">exec</span> <span style="color:#000;font-weight:bold">(</span>def no cwd<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">autostart</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                               ; start at supervisord start <span style="color:#000;font-weight:bold">(</span>default: <span style="color:#0086b3">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">autorestart</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                             ; retstart at unexpected quit <span style="color:#000;font-weight:bold">(</span>default: <span style="color:#0086b3">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">startsecs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">30</span>                                                 ; number of secs prog must stay running <span style="color:#000;font-weight:bold">(</span>def. 1<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">startretries</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">3</span>                                               ; max <span style="color:#998;font-style:italic"># of serial start failures (default 3)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">exitcodes</span><span style="color:#000;font-weight:bold">=</span>0,2                                                ; <span style="color:#d14">&#39;expected&#39;</span> <span style="color:#0086b3">exit</span> codes <span style="color:#000;font-weight:bold">for</span> process <span style="color:#000;font-weight:bold">(</span>default 0,2<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stopsignal</span><span style="color:#000;font-weight:bold">=</span>QUIT                                              ; signal used to <span style="color:#0086b3">kill</span> process <span style="color:#000;font-weight:bold">(</span>default TERM<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stopwaitsecs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">10</span>                                              ; max num secs to <span style="color:#0086b3">wait</span> b4 SIGKILL <span style="color:#000;font-weight:bold">(</span>default 10<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">user</span><span style="color:#000;font-weight:bold">=</span>root                                                    ; setuid to this UNIX account to run the program
</span></span><span style="display:flex;"><span><span style="color:#008080">redirect_stderr</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                         ; redirect proc stderr to stdout <span style="color:#000;font-weight:bold">(</span>default <span style="color:#0086b3">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile</span><span style="color:#000;font-weight:bold">=</span>/data/logs/flanneld/flanneld.stdout.log       ; stderr log path, NONE <span style="color:#000;font-weight:bold">for</span> none; default AUTO
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile_maxbytes</span><span style="color:#000;font-weight:bold">=</span>64MB                                 ; max <span style="color:#998;font-style:italic"># logfile bytes b4 rotation (default 50MB)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile_backups</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">4</span>                                     ; <span style="color:#998;font-style:italic"># of stdout logfile backups (default 10)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_capture_maxbytes</span><span style="color:#000;font-weight:bold">=</span>1MB                                  ; number of bytes in <span style="color:#d14">&#39;capturemode&#39;</span> <span style="color:#000;font-weight:bold">(</span>default 0<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_events_enabled</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">false</span>                                  ; emit events on stdout writes <span style="color:#000;font-weight:bold">(</span>default <span style="color:#0086b3">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">killasgroup</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stopasgroup</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>注意 [ ] 中的名字</p>
</blockquote>
<p>创建上述启动脚本中用到的目录</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mkdir /data/logs/flanneld/</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看 <code>supervisord</code> 的状态</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># supervisorctl update</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># supervisorctl status</span>
</span></span><span style="display:flex;"><span>etcd-server-199-13               RUNNING   pid 721, uptime 16:23:15
</span></span><span style="display:flex;"><span>flanneld-199-13                  RUNNING   pid 57257, uptime 0:00:46
</span></span><span style="display:flex;"><span>kube-apiserver-199-13            RUNNING   pid 717, uptime 16:23:15
</span></span><span style="display:flex;"><span>kube-controller-manager-199-13   RUNNING   pid 722, uptime 16:23:15
</span></span><span style="display:flex;"><span>kube-kubelet-199-13              RUNNING   pid 714, uptime 16:23:15
</span></span><span style="display:flex;"><span>kube-proxy-199-13                RUNNING   pid 713, uptime 16:23:15
</span></span><span style="display:flex;"><span>kube-scheduler-199-13            RUNNING   pid 716, uptime 16:23:15
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>192.168.199.14 节点配置内容，同上</strong></p>
<h4 id="2-验证flannel">2. 验证Flannel</h4>
<h5 id="21-验证网络状态">2.1 验证网络状态</h5>
<p>配置完成后，两个节点之间的 <code>pod</code> 可以进行正常的通信</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@nginx-ds-ln87w:/# ping 172.7.14.3
</span></span><span style="display:flex;"><span>PING 172.7.14.3 <span style="color:#000;font-weight:bold">(</span>172.7.14.3<span style="color:#000;font-weight:bold">)</span>: <span style="color:#099">48</span> data bytes
</span></span><span style="display:flex;"><span><span style="color:#099">56</span> bytes from 172.7.14.3: <span style="color:#008080">icmp_seq</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">498</span> <span style="color:#008080">ttl</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">62</span> <span style="color:#008080">time</span><span style="color:#000;font-weight:bold">=</span>0.561 ms
</span></span><span style="display:flex;"><span><span style="color:#099">56</span> bytes from 172.7.14.3: <span style="color:#008080">icmp_seq</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">499</span> <span style="color:#008080">ttl</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">62</span> <span style="color:#008080">time</span><span style="color:#000;font-weight:bold">=</span>0.428 ms
</span></span><span style="display:flex;"><span><span style="color:#099">56</span> bytes from 172.7.14.3: <span style="color:#008080">icmp_seq</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">500</span> <span style="color:#008080">ttl</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">62</span> <span style="color:#008080">time</span><span style="color:#000;font-weight:bold">=</span>0.499 ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@nginx-ds-6z2cl:/# ping 172.7.13.2
</span></span><span style="display:flex;"><span>PING 172.7.13.2 <span style="color:#000;font-weight:bold">(</span>172.7.13.2<span style="color:#000;font-weight:bold">)</span>: <span style="color:#099">48</span> data bytes
</span></span><span style="display:flex;"><span><span style="color:#099">56</span> bytes from 172.7.13.2: <span style="color:#008080">icmp_seq</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">470</span> <span style="color:#008080">ttl</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">62</span> <span style="color:#008080">time</span><span style="color:#000;font-weight:bold">=</span>0.498 ms
</span></span><span style="display:flex;"><span><span style="color:#099">56</span> bytes from 172.7.13.2: <span style="color:#008080">icmp_seq</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">471</span> <span style="color:#008080">ttl</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">62</span> <span style="color:#008080">time</span><span style="color:#000;font-weight:bold">=</span>0.503 ms
</span></span><span style="display:flex;"><span><span style="color:#099">56</span> bytes from 172.7.13.2: <span style="color:#008080">icmp_seq</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">472</span> <span style="color:#008080">ttl</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">62</span> <span style="color:#008080">time</span><span style="color:#000;font-weight:bold">=</span>0.566 ms
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="22-flannel原理">2.2 Flannel原理</h5>
<p>flannel 的 host-gw 模式，相当于再每台主机上添加了静态路由</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># route -n</span>
</span></span><span style="display:flex;"><span>....
</span></span><span style="display:flex;"><span>172.7.14.0      192.168.199.14  255.255.255.0   UG    <span style="color:#099">0</span>      <span style="color:#099">0</span>        <span style="color:#099">0</span> eth0
</span></span><span style="display:flex;"><span>....
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="3-优化-iptables-规则">3. 优化 iptables 规则</h4>
<p>查看 <code>iptables</code> 的现有规则</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># iptables-save | grep -i postrouting</span>
</span></span><span style="display:flex;"><span>:POSTROUTING ACCEPT <span style="color:#000;font-weight:bold">[</span>53:3216<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>:KUBE-POSTROUTING - <span style="color:#000;font-weight:bold">[</span>0:0<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>-A POSTROUTING -m comment --comment <span style="color:#d14">&#34;kubernetes postrouting rules&#34;</span> -j KUBE-POSTROUTING
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 来源地址是 172.7.13.0/24 且 不是docker0 网卡出网的，做SNAT</span>
</span></span><span style="display:flex;"><span>-A POSTROUTING -s 172.7.13.0/24 ! -o docker0 -j MASQUERADE
</span></span><span style="display:flex;"><span>-A KUBE-POSTROUTING -m comment --comment <span style="color:#d14">&#34;kubernetes service traffic requiring SNAT&#34;</span> -m mark --mark 0x4000/0x4000 -j MASQUERADE
</span></span><span style="display:flex;"><span>-A KUBE-POSTROUTING -m comment --comment <span style="color:#d14">&#34;Kubernetes endpoints dst ip:port, source ip for solving hairpin purpose&#34;</span> -m <span style="color:#0086b3">set</span> --match-set KUBE-LOOP-BACK dst,dst,src -j MASQUERADE
</span></span></code></pre></td></tr></table>
</div>
</div><p>现在的规则是通过 <code>docker0</code> 出网的，不做SNAT。需要加上出网地址是 <code>172.7.0.0/16</code> 网段也不做SNAT
安装并启动 <code>iptables</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># yum install iptables-services -y</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># systemctl start iptables</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># systemctl enable iptables</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>修改 <code>iptables</code> 规则</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 删除现有规则</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># iptables -t nat -D POSTROUTING -s 172.7.13.0/24 ! -o docker0 -j MASQUERADE</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 优化规则</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># iptables -t nat -I POSTROUTING -s 172.7.13.0/24 ! -d 172.7.0.0/16 ! -o docker0 -j MASQUERADE</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 保存</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># service iptables save</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>若出现pod节点不互通情况，请执行以下操作</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># iptables-save | grep -i reject</span>
</span></span><span style="display:flex;"><span>-A INPUT -j REJECT --reject-with icmp-host-prohibited
</span></span><span style="display:flex;"><span>-A FORWARD -j REJECT --reject-with icmp-host-prohibited
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># iptables -t filter -D INPUT -j REJECT --reject-with icmp-host-prohibited</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># iptables -t filter -D FORWARD -j REJECT --reject-with icmp-host-prohibited</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>其他 node 节点也需要操作以上内容</strong></p>
<h1 id="五coredns">五、Coredns</h1>
<h4 id="1-coredns部署">1. Coredns部署</h4>
<h5 id="11-准备工作">1.1 准备工作</h5>
<p>Coredns 主要负责自动关联 <strong>Service资源名称</strong> 和 <strong>集群网络IP</strong>，从而达到服务被集群自动发现的目的。
如下有 <code>service</code> 资源，Coredns 会将 <code>nginx-ds</code> 与 <code>192.168.31.51</code> 建立关联</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-14 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get svc</span>
</span></span><span style="display:flex;"><span>NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span style="color:#000;font-weight:bold">(</span>S<span style="color:#000;font-weight:bold">)</span>   AGE
</span></span><span style="display:flex;"><span>kubernetes   ClusterIP   192.168.0.1     &lt;none&gt;        443/TCP   25h
</span></span><span style="display:flex;"><span>nginx-ds     ClusterIP   192.168.31.51   &lt;none&gt;        80/TCP    121m
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们需要在运维主机上创建资源配置清单，通过 <code>nginx</code> 的目录浏览功能实现共享，使不通的 <code>node</code> 节点直接访问 <code>url</code> 就可以获取资源配置清单
在 <code>192.168.199.11</code> 上添加A记录</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /var/named/od.com.zone</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">$ORIGIN</span> od.com.
</span></span><span style="display:flex;"><span><span style="color:#008080">$TTL</span> <span style="color:#099">600</span>        ; <span style="color:#099">10</span> minutes
</span></span><span style="display:flex;"><span>@               IN SOA  dns.od.com. dnsadmin.od.com. <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>								<span style="color:#998;font-style:italic"># 前滚序号</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">2020052703</span> ; serial
</span></span><span style="display:flex;"><span>                                <span style="color:#099">10800</span>      ; refresh <span style="color:#000;font-weight:bold">(</span><span style="color:#099">3</span> hours<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">900</span>        ; retry <span style="color:#000;font-weight:bold">(</span><span style="color:#099">15</span> minutes<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">604800</span>     ; expire <span style="color:#000;font-weight:bold">(</span><span style="color:#099">1</span> week<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">86400</span>      ; minimum <span style="color:#000;font-weight:bold">(</span><span style="color:#099">1</span> day<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                NS   dns.od.com.
</span></span><span style="display:flex;"><span><span style="color:#008080">$TTL</span> <span style="color:#099">60</span> ; <span style="color:#099">1</span> minute
</span></span><span style="display:flex;"><span>dns                A    192.168.199.11
</span></span><span style="display:flex;"><span>harbor             A    192.168.199.15
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 添加如下域名解析</span>
</span></span><span style="display:flex;"><span>k8s-yaml           A    192.168.199.15
</span></span></code></pre></td></tr></table>
</div>
</div><p>验证解析是否生效</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># systemctl restart named</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># dig -t A k8s-yaml.od.com @192.168.199.11 +short</span>
</span></span><span style="display:flex;"><span>192.168.199.15
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 <code>192.168.199.15</code> 上配置 <code>nginx</code> ，实现目录浏览功能</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/nginx/conf.d/k8s-yaml.od.com.conf</span>
</span></span><span style="display:flex;"><span>server <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    listen       80;
</span></span><span style="display:flex;"><span>    server_name  k8s-yaml.od.com;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    location / <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        autoindex on;
</span></span><span style="display:flex;"><span>        default_type text/plain;
</span></span><span style="display:flex;"><span>        root /data/k8s-yaml;
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># nginx -t</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># nginx -s reload</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建对应的目录用于存放 <code>coredns</code> 相关的资源配置清单，在浏览器中可以直接访问到此目录</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mkdir /data/k8s-yaml/coredns -p</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /data/k8s-yaml/coredns/</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="12-部署coredns">1.2 部署Coredns</h5>
<p>下载镜像，打标签后推送到私有仓库 <code>Harbor</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker pull coredns/coredns:1.6.1</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker tag c0f6e815079e harbor.od.com/public/coredns:v1.6.1</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker push harbor.od.com/public/coredns:v1.6.1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>编写资源配置清单
<code>rbac</code> 资源配置清单，主要配置权限相关内容</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 coredns<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat rbac.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: ServiceAccount
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: coredns
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>      kubernetes.io/cluster-service: <span style="color:#d14">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>      addonmanager.kubernetes.io/mode: Reconcile
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion: rbac.authorization.k8s.io/v1
</span></span><span style="display:flex;"><span>kind: ClusterRole
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    kubernetes.io/bootstrapping: rbac-defaults
</span></span><span style="display:flex;"><span>    addonmanager.kubernetes.io/mode: Reconcile
</span></span><span style="display:flex;"><span>  name: system:coredns
</span></span><span style="display:flex;"><span>rules:
</span></span><span style="display:flex;"><span>- apiGroups:
</span></span><span style="display:flex;"><span>  - <span style="color:#d14">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  resources:
</span></span><span style="display:flex;"><span>  - endpoints
</span></span><span style="display:flex;"><span>  - services
</span></span><span style="display:flex;"><span>  - pods
</span></span><span style="display:flex;"><span>  - namespaces
</span></span><span style="display:flex;"><span>  verbs:
</span></span><span style="display:flex;"><span>  - list
</span></span><span style="display:flex;"><span>  - watch
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion: rbac.authorization.k8s.io/v1
</span></span><span style="display:flex;"><span>kind: ClusterRoleBinding
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  annotations:
</span></span><span style="display:flex;"><span>    rbac.authorization.kubernetes.io/autoupdate: <span style="color:#d14">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    kubernetes.io/bootstrapping: rbac-defaults
</span></span><span style="display:flex;"><span>    addonmanager.kubernetes.io/mode: EnsureExists
</span></span><span style="display:flex;"><span>  name: system:coredns
</span></span><span style="display:flex;"><span>roleRef:
</span></span><span style="display:flex;"><span>  apiGroup: rbac.authorization.k8s.io
</span></span><span style="display:flex;"><span>  kind: ClusterRole
</span></span><span style="display:flex;"><span>  name: system:coredns
</span></span><span style="display:flex;"><span>subjects:
</span></span><span style="display:flex;"><span>- kind: ServiceAccount
</span></span><span style="display:flex;"><span>  name: coredns
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>ConfigMap</code> 资源配置清单，主要配置 <code>coredns</code> 相关内容，其中 <code>forward</code> 指向上层的 <code>DNS</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 coredns<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat cm.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: ConfigMap
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: coredns
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span><span style="display:flex;"><span>data:
</span></span><span style="display:flex;"><span>  Corefile: |
</span></span><span style="display:flex;"><span>    .:53 <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        errors
</span></span><span style="display:flex;"><span>        log
</span></span><span style="display:flex;"><span>        health
</span></span><span style="display:flex;"><span>        ready
</span></span><span style="display:flex;"><span>        kubernetes cluster.local 192.168.0.0/16
</span></span><span style="display:flex;"><span>        forward . 192.168.199.11
</span></span><span style="display:flex;"><span>        cache <span style="color:#099">30</span>
</span></span><span style="display:flex;"><span>        loop
</span></span><span style="display:flex;"><span>        reload
</span></span><span style="display:flex;"><span>        loadbalance
</span></span><span style="display:flex;"><span>       <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>Deployment</code> 资源配置清单，为 <code>pod</code> 资源控制器，主要配置 <code>pod</code> 相关内容</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 coredns<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat dp.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: apps/v1
</span></span><span style="display:flex;"><span>kind: Deployment
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: coredns
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    k8s-app: coredns
</span></span><span style="display:flex;"><span>    kubernetes.io/name: <span style="color:#d14">&#34;CoreDNS&#34;</span>
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  replicas: <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    matchLabels:
</span></span><span style="display:flex;"><span>      k8s-app: coredns
</span></span><span style="display:flex;"><span>  template:
</span></span><span style="display:flex;"><span>    metadata:
</span></span><span style="display:flex;"><span>      labels:
</span></span><span style="display:flex;"><span>        k8s-app: coredns
</span></span><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      priorityClassName: system-cluster-critical
</span></span><span style="display:flex;"><span>      serviceAccountName: coredns
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>      - name: coredns
</span></span><span style="display:flex;"><span>        image: harbor.od.com/public/coredns:v1.6.1
</span></span><span style="display:flex;"><span>        args:
</span></span><span style="display:flex;"><span>        - -conf
</span></span><span style="display:flex;"><span>        - /etc/coredns/Corefile
</span></span><span style="display:flex;"><span>        volumeMounts:
</span></span><span style="display:flex;"><span>        - name: config-volume
</span></span><span style="display:flex;"><span>          mountPath: /etc/coredns
</span></span><span style="display:flex;"><span>        ports:
</span></span><span style="display:flex;"><span>        - containerPort: <span style="color:#099">53</span>
</span></span><span style="display:flex;"><span>          name: dns
</span></span><span style="display:flex;"><span>          protocol: UDP
</span></span><span style="display:flex;"><span>        - containerPort: <span style="color:#099">53</span>
</span></span><span style="display:flex;"><span>          name: dns-tcp
</span></span><span style="display:flex;"><span>          protocol: TCP
</span></span><span style="display:flex;"><span>        - containerPort: <span style="color:#099">9153</span>
</span></span><span style="display:flex;"><span>          name: metrics
</span></span><span style="display:flex;"><span>          protocol: TCP
</span></span><span style="display:flex;"><span>        livenessProbe:
</span></span><span style="display:flex;"><span>          httpGet:
</span></span><span style="display:flex;"><span>            path: /health
</span></span><span style="display:flex;"><span>            port: <span style="color:#099">8080</span>
</span></span><span style="display:flex;"><span>            scheme: HTTP
</span></span><span style="display:flex;"><span>          initialDelaySeconds: <span style="color:#099">60</span>
</span></span><span style="display:flex;"><span>          timeoutSeconds: <span style="color:#099">5</span>
</span></span><span style="display:flex;"><span>          successThreshold: <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>          failureThreshold: <span style="color:#099">5</span>
</span></span><span style="display:flex;"><span>      dnsPolicy: Default
</span></span><span style="display:flex;"><span>      volumes:
</span></span><span style="display:flex;"><span>        - name: config-volume
</span></span><span style="display:flex;"><span>          configMap:
</span></span><span style="display:flex;"><span>            name: coredns
</span></span><span style="display:flex;"><span>            items:
</span></span><span style="display:flex;"><span>            - key: Corefile
</span></span><span style="display:flex;"><span>              path: Corefile
</span></span></code></pre></td></tr></table>
</div>
</div><p>通过 <code>Service</code> 资源配置清单暴露 <code>coredns</code> 的 <code>53</code> 端口</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 coredns<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat svc.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Service
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: coredns
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    k8s-app: coredns
</span></span><span style="display:flex;"><span>    kubernetes.io/cluster-service: <span style="color:#d14">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>    kubernetes.io/name: <span style="color:#d14">&#34;CoreDNS&#34;</span>
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    k8s-app: coredns
</span></span><span style="display:flex;"><span>  clusterIP: 192.168.0.2
</span></span><span style="display:flex;"><span>  ports:
</span></span><span style="display:flex;"><span>  - name: dns
</span></span><span style="display:flex;"><span>    port: <span style="color:#099">53</span>
</span></span><span style="display:flex;"><span>    protocol: UDP
</span></span><span style="display:flex;"><span>  - name: dns-tcp
</span></span><span style="display:flex;"><span>    port: <span style="color:#099">53</span>
</span></span><span style="display:flex;"><span>  - name: metrics
</span></span><span style="display:flex;"><span>    port: <span style="color:#099">9153</span>
</span></span><span style="display:flex;"><span>    protocol: TCP
</span></span></code></pre></td></tr></table>
</div>
</div><p>访问对应的 <code>URL</code> 可以看到刚创建的内容</p>
<p><img src="https://images.wuennan.cn/20200616231737876.png" alt="20200616231737876"></p>
<p>根据资源配置清单创建资源</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl apply -f http://k8s-yaml.od.com/coredns/rbac.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl apply -f http://k8s-yaml.od.com/coredns/cm.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl apply -f http://k8s-yaml.od.com/coredns/dp.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl apply -f http://k8s-yaml.od.com/coredns/svc.yaml</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>验证资源创建情况</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get all -n kube-system</span>
</span></span><span style="display:flex;"><span>NAME                           READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod/coredns-6b6c4f9648-44xjn   1/1     Running   <span style="color:#099">0</span>          3m49s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># coredns的cluster ip为192.168.0.2</span>
</span></span><span style="display:flex;"><span>NAME              TYPE        CLUSTER-IP    EXTERNAL-IP   PORT<span style="color:#000;font-weight:bold">(</span>S<span style="color:#000;font-weight:bold">)</span>                  AGE
</span></span><span style="display:flex;"><span>service/coredns   ClusterIP   192.168.0.2   &lt;none&gt;        53/UDP,53/TCP,9153/TCP   3m36s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>deployment.apps/coredns   1/1     <span style="color:#099">1</span>            <span style="color:#099">1</span>           3m49s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                                 DESIRED   CURRENT   READY   AGE
</span></span><span style="display:flex;"><span>replicaset.apps/coredns-6b6c4f9648   <span style="color:#099">1</span>         <span style="color:#099">1</span>         <span style="color:#099">1</span>       3m49s
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2-验证coredns解析">2. 验证coredns解析</h4>
<p>验证 <code>coredns</code> 是否能够解析 <code>www.baidu.com</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># dig -t A www.baidu.com @192.168.0.2 +short</span>
</span></span><span style="display:flex;"><span>www.a.shifen.com.
</span></span><span style="display:flex;"><span>61.135.169.121
</span></span><span style="display:flex;"><span>61.135.169.125
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>coredns</code> 主要用于解析 <code>service</code> 资源和 <code>cluster ip</code>，可通过一下方式验证</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 通过陈述式命令创建一个pod</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl create deployment nginx-dp --image=harbor.od.com/public/nginx:v1.7.9 -n kube-public</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看创建的pod</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get pods -n kube-public -o wide</span>
</span></span><span style="display:flex;"><span>NAME                        READY   STATUS    RESTARTS   AGE   IP           NODE                      NOMINATED NODE   READINESS GATES
</span></span><span style="display:flex;"><span>nginx-dp-5dfc689474-jml9v   1/1     Running   <span style="color:#099">0</span>          34s   172.7.14.3   192-168-199-14.host.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 通过陈述式命令创建一个svc资源</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl expose deployment nginx-dp --port 80 -n kube-public</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 验证svc资源是否创建成功</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get svc -n kube-public</span>
</span></span><span style="display:flex;"><span>NAME       TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span style="color:#000;font-weight:bold">(</span>S<span style="color:#000;font-weight:bold">)</span>   AGE
</span></span><span style="display:flex;"><span>nginx-dp   ClusterIP   192.168.41.222   &lt;none&gt;        80/TCP    24s
</span></span></code></pre></td></tr></table>
</div>
</div><p>通过 <code>coredns</code> 可以将 <code>svc</code> 资源解析成 <code>cluster ip</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># dig -t A nginx-dp.kube-public.svc.cluster.local. @192.168.0.2 +short</span>
</span></span><span style="display:flex;"><span>192.168.41.222
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>注意： 需要使用FQDN即全限定域名</p>
</blockquote>
<p>更多 <code>coredns</code> 相关内容，可参考<a href="http://ccnuo.com/2019/08/25/CoreDNS%EF%BC%9AKubernetes%E5%86%85%E9%83%A8%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90%E5%8E%9F%E7%90%86%E3%80%81%E5%BC%8A%E7%AB%AF%E5%8F%8A%E4%BC%98%E5%8C%96%E6%96%B9%E5%BC%8F/">CoreDNS：Kubernetes内部域名解析原理、弊端及优化方式</a></p>
<h1 id="六ingress">六、Ingress</h1>
<h3 id="1-ingress部署">1. Ingress部署</h3>
<h4 id="11-ingress简介">1.1 Ingress简介</h4>
<p>Ingress 功能是将集群外部的流量请求转发至集群内部，从而使实现服务暴露</p>
<h4 id="12-traefik部署">1.2 Traefik部署</h4>
<p>可以在 <a href="https://github.com/containous/traefik">github</a> 上下载traefik。
获取<code>traefik</code> 的镜像文件，打标签后上传至 <code>Harbor</code> 私有仓库</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker pull traefik:v1.7.2-alpine</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker images | grep traefik</span>
</span></span><span style="display:flex;"><span>traefik                         v1.7.2-alpine              add5fac61ae5        <span style="color:#099">20</span> months ago       72.4MB
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker tag add5fac61ae5 harbor.od.com/public/traefik:v1.7.2</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker push harbor.od.com/public/traefik:v1.7.2</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>准备资源配置清单</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 traefik<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># pwd</span>
</span></span><span style="display:flex;"><span>/data/k8s-yaml/traefik
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建 <code>rbac.yaml</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 traefik<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat rbac.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: ServiceAccount
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: traefik-ingress-controller
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion: rbac.authorization.k8s.io/v1beta1
</span></span><span style="display:flex;"><span>kind: ClusterRole
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: traefik-ingress-controller
</span></span><span style="display:flex;"><span>rules:
</span></span><span style="display:flex;"><span>  - apiGroups:
</span></span><span style="display:flex;"><span>      - <span style="color:#d14">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    resources:
</span></span><span style="display:flex;"><span>      - services
</span></span><span style="display:flex;"><span>      - endpoints
</span></span><span style="display:flex;"><span>      - secrets
</span></span><span style="display:flex;"><span>    verbs:
</span></span><span style="display:flex;"><span>      - get
</span></span><span style="display:flex;"><span>      - list
</span></span><span style="display:flex;"><span>      - watch
</span></span><span style="display:flex;"><span>  - apiGroups:
</span></span><span style="display:flex;"><span>      - extensions
</span></span><span style="display:flex;"><span>    resources:
</span></span><span style="display:flex;"><span>      - ingresses
</span></span><span style="display:flex;"><span>    verbs:
</span></span><span style="display:flex;"><span>      - get
</span></span><span style="display:flex;"><span>      - list
</span></span><span style="display:flex;"><span>      - watch
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>kind: ClusterRoleBinding
</span></span><span style="display:flex;"><span>apiVersion: rbac.authorization.k8s.io/v1beta1
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: traefik-ingress-controller
</span></span><span style="display:flex;"><span>roleRef:
</span></span><span style="display:flex;"><span>  apiGroup: rbac.authorization.k8s.io
</span></span><span style="display:flex;"><span>  kind: ClusterRole
</span></span><span style="display:flex;"><span>  name: traefik-ingress-controller
</span></span><span style="display:flex;"><span>subjects:
</span></span><span style="display:flex;"><span>- kind: ServiceAccount
</span></span><span style="display:flex;"><span>  name: traefik-ingress-controller
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建 <code>DaemonSet</code> 类型资源，控制一个宿主机上跑一个副本</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 traefik<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat ds.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: extensions/v1beta1
</span></span><span style="display:flex;"><span>kind: DaemonSet
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: traefik-ingress
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    k8s-app: traefik-ingress
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  template:
</span></span><span style="display:flex;"><span>    metadata:
</span></span><span style="display:flex;"><span>      labels:
</span></span><span style="display:flex;"><span>        k8s-app: traefik-ingress
</span></span><span style="display:flex;"><span>        name: traefik-ingress
</span></span><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      serviceAccountName: traefik-ingress-controller
</span></span><span style="display:flex;"><span>      terminationGracePeriodSeconds: <span style="color:#099">60</span>
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>      - image: harbor.od.com/public/traefik:v1.7.2
</span></span><span style="display:flex;"><span>        name: traefik-ingress
</span></span><span style="display:flex;"><span>        ports:
</span></span><span style="display:flex;"><span>        - name: controller
</span></span><span style="display:flex;"><span>          containerPort: <span style="color:#099">80</span>
</span></span><span style="display:flex;"><span>          hostPort: <span style="color:#099">81</span>
</span></span><span style="display:flex;"><span>        - name: admin-web
</span></span><span style="display:flex;"><span>          containerPort: <span style="color:#099">8080</span>
</span></span><span style="display:flex;"><span>        securityContext:
</span></span><span style="display:flex;"><span>          capabilities:
</span></span><span style="display:flex;"><span>            drop:
</span></span><span style="display:flex;"><span>            - ALL
</span></span><span style="display:flex;"><span>            add:
</span></span><span style="display:flex;"><span>            - NET_BIND_SERVICE
</span></span><span style="display:flex;"><span>        args: 
</span></span><span style="display:flex;"><span>        - --api
</span></span><span style="display:flex;"><span>        - --kubernetes
</span></span><span style="display:flex;"><span>        - --logLevel<span style="color:#000;font-weight:bold">=</span>INFO
</span></span><span style="display:flex;"><span>        - --insecureskipverify<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>
</span></span><span style="display:flex;"><span>        - --kubernetes.endpoint<span style="color:#000;font-weight:bold">=</span>https://192.168.199.10:7443
</span></span><span style="display:flex;"><span>        - --accesslog
</span></span><span style="display:flex;"><span>        - --accesslog.filepath<span style="color:#000;font-weight:bold">=</span>/var/log/traefik_access.log
</span></span><span style="display:flex;"><span>        - --traefiklog
</span></span><span style="display:flex;"><span>        - --traefiklog.filepath<span style="color:#000;font-weight:bold">=</span>/var/log/traefik.log
</span></span><span style="display:flex;"><span>        - --metrics.prometheus
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>注意：需要修改资源清单中所涉及到的IP地址</p>
</blockquote>
<p>创建 <code>Service</code> 类型资源</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 traefik<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat svc.yaml</span>
</span></span><span style="display:flex;"><span>kind: Service
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: traefik-ingress-service
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    k8s-app: traefik-ingress
</span></span><span style="display:flex;"><span>  ports:
</span></span><span style="display:flex;"><span>    - protocol: TCP
</span></span><span style="display:flex;"><span>      port: <span style="color:#099">80</span>
</span></span><span style="display:flex;"><span>      name: controller
</span></span><span style="display:flex;"><span>    - protocol: TCP
</span></span><span style="display:flex;"><span>      port: <span style="color:#099">8080</span>
</span></span><span style="display:flex;"><span>      name: admin-web
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>Ingress</code> 资源是一组基于域名和 <code>URL</code> 路径，把用户的请求转发至指定 <code>Service</code> 资源的规则</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 traefik<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat ingress.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: extensions/v1beta1
</span></span><span style="display:flex;"><span>kind: Ingress
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: traefik-web-ui
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span><span style="display:flex;"><span>  annotations:
</span></span><span style="display:flex;"><span>    kubernetes.io/ingress.class: traefik
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  rules:
</span></span><span style="display:flex;"><span>  - host: traefik.od.com
</span></span><span style="display:flex;"><span>    http:
</span></span><span style="display:flex;"><span>      paths:
</span></span><span style="display:flex;"><span>      - path: /
</span></span><span style="display:flex;"><span>        backend:
</span></span><span style="display:flex;"><span>          serviceName: traefik-ingress-service
</span></span><span style="display:flex;"><span>          servicePort: <span style="color:#099">8080</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在任意一个运算节点应用以上 <code>yaml</code> 配置</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl apply -f http://k8s-yaml.od.com/traefik/rbac.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl apply -f http://k8s-yaml.od.com/traefik/ds.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl apply -f http://k8s-yaml.od.com/traefik/svc.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl apply -f http://k8s-yaml.od.com/traefik/ingress.yaml</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看 <code>pod</code> 的运行状态</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get pods -n kube-system -o wide</span>
</span></span><span style="display:flex;"><span>NAME                       READY   STATUS    RESTARTS   AGE   IP           NODE                      NOMINATED NODE   READINESS GATES
</span></span><span style="display:flex;"><span>coredns-6b6c4f9648-44xjn   1/1     Running   <span style="color:#099">0</span>          25h   172.7.13.3   192-168-199-13.host.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>traefik-ingress-2hctl      1/1     Running   <span style="color:#099">0</span>          22m   172.7.13.4   192-168-199-13.host.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>traefik-ingress-vfh4t      1/1     Running   <span style="color:#099">0</span>          22m   172.7.14.4   192-168-199-14.host.com   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>若 STATUS 一直处于 ContainerCreating 状态，可尝试重启容器</p>
</blockquote>
<h4 id="13-部署七层负载均衡">1.3 部署七层负载均衡</h4>
<p>在 <code>192.168.199.11</code> 和 <code>192.168.199.12</code> 上配置七层代理，无差别的将流量抛给后端的 <code>Ingress</code> 处理</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/nginx/conf.d/od.com.conf</span>
</span></span><span style="display:flex;"><span>upstream default_backend_traefik <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic"># Ingress的controller</span>
</span></span><span style="display:flex;"><span>    server 192.168.199.13:81    <span style="color:#008080">max_fails</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">3</span> <span style="color:#008080">fail_timeout</span><span style="color:#000;font-weight:bold">=</span>10s;
</span></span><span style="display:flex;"><span>    server 192.168.199.14:81    <span style="color:#008080">max_fails</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">3</span> <span style="color:#008080">fail_timeout</span><span style="color:#000;font-weight:bold">=</span>10s;
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>server <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    server_name *.od.com;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    location / <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        proxy_pass http://default_backend_traefik;
</span></span><span style="display:flex;"><span>        proxy_set_header Host       <span style="color:#008080">$http_host</span>;
</span></span><span style="display:flex;"><span>        proxy_set_header x-forwarded-for <span style="color:#008080">$proxy_add_x_forwarded_for</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>加载 <code>Nginx</code> 的配置文件</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># nginx -t</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># nginx -s reload</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 <code>192.168.199.11</code> 上配置域名解析</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /var/named/od.com.zone</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">$ORIGIN</span> od.com.
</span></span><span style="display:flex;"><span><span style="color:#008080">$TTL</span> <span style="color:#099">600</span>        ; <span style="color:#099">10</span> minutes
</span></span><span style="display:flex;"><span>@               IN SOA  dns.od.com. dnsadmin.od.com. <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#998;font-style:italic"># 前滚一个序列号</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">2020052704</span> ; serial
</span></span><span style="display:flex;"><span>                                <span style="color:#099">10800</span>      ; refresh <span style="color:#000;font-weight:bold">(</span><span style="color:#099">3</span> hours<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">900</span>        ; retry <span style="color:#000;font-weight:bold">(</span><span style="color:#099">15</span> minutes<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">604800</span>     ; expire <span style="color:#000;font-weight:bold">(</span><span style="color:#099">1</span> week<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">86400</span>      ; minimum <span style="color:#000;font-weight:bold">(</span><span style="color:#099">1</span> day<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                NS   dns.od.com.
</span></span><span style="display:flex;"><span><span style="color:#008080">$TTL</span> <span style="color:#099">60</span> ; <span style="color:#099">1</span> minute
</span></span><span style="display:flex;"><span>dns                A    192.168.199.11
</span></span><span style="display:flex;"><span>harbor             A    192.168.199.15
</span></span><span style="display:flex;"><span>k8s-yaml           A    192.168.199.15
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 添加一个 A 记录</span>
</span></span><span style="display:flex;"><span>traefik            A    192.168.199.10
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="2-验证">2. 验证</h3>
<p>重启 <code>named</code> 服务后，可通过域名访问 <code>traefik.od.com</code> 访问 <code>traefik</code> ，如下图所示：</p>
<p><img src="https://images.wuennan.cn/20200707233929414.png" alt="20200707233929414"></p>
<blockquote>
<p>traefik2 版本安装请参考 <a href="http://www.mydlq.club/article/107/">http://www.mydlq.club/article/107/</a></p>
</blockquote>
<h1 id="七dashboard">七、Dashboard</h1>
<h3 id="1-dashboard部署">1 Dashboard部署</h3>
<h4 id="11-安装dashboard服务">1.1 安装Dashboard服务</h4>
<p>准备镜像文件
获取官方 <code>dashboard</code> 镜像文件并上传至 <code>Harbor</code> 私有仓库</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker pull k8scn/kubernetes-dashboard-amd64:v1.8.3</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker tag fcac9aa03fd6 harbor.od.com/public/dashboard:v1.8.3</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker push harbor.od.com/public/dashboard:v1.8.3</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>准备资源配置清单</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 dashboard<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># pwd</span>
</span></span><span style="display:flex;"><span>/data/k8s-yaml/dashboard
</span></span></code></pre></td></tr></table>
</div>
</div><p>准备 <code>rbac.yaml</code> 文件</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 dashboard<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat rbac.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: ServiceAccount
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    k8s-app: kubernetes-dashboard
</span></span><span style="display:flex;"><span>    addonmanager.kubernetes.io/mode: Reconcile
</span></span><span style="display:flex;"><span>  name: kubernetes-dashboard-admin
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion: rbac.authorization.k8s.io/v1
</span></span><span style="display:flex;"><span>kind: ClusterRoleBinding
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: kubernetes-dashboard-admin
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    k8s-app: kubernetes-dashboard
</span></span><span style="display:flex;"><span>    addonmanager.kubernetes.io/mode: Reconcile
</span></span><span style="display:flex;"><span>roleRef:
</span></span><span style="display:flex;"><span>  apiGroup: rbac.authorization.k8s.io
</span></span><span style="display:flex;"><span>  kind: ClusterRole
</span></span><span style="display:flex;"><span>  name: cluster-admin
</span></span><span style="display:flex;"><span>subjects:
</span></span><span style="display:flex;"><span>- kind: ServiceAccount
</span></span><span style="display:flex;"><span>  name: kubernetes-dashboard-admin
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span></code></pre></td></tr></table>
</div>
</div><p>准备 <code>dp.yaml</code> 文件</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 dashboard<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat dp.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: apps/v1
</span></span><span style="display:flex;"><span>kind: Deployment
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: kubernetes-dashboard
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    k8s-app: kubernetes-dashboard
</span></span><span style="display:flex;"><span>    kubernetes.io/cluster-service: <span style="color:#d14">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>    addonmanager.kubernetes.io/mode: Reconcile
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    matchLabels:
</span></span><span style="display:flex;"><span>      k8s-app: kubernetes-dashboard
</span></span><span style="display:flex;"><span>  template:
</span></span><span style="display:flex;"><span>    metadata:
</span></span><span style="display:flex;"><span>      labels:
</span></span><span style="display:flex;"><span>        k8s-app: kubernetes-dashboard
</span></span><span style="display:flex;"><span>      annotations:
</span></span><span style="display:flex;"><span>        scheduler.alpha.kubernetes.io/critical-pod: <span style="color:#d14">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      priorityClassName: system-cluster-critical
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>      - name: kubernetes-dashboard
</span></span><span style="display:flex;"><span>        image: harbor.od.com/public/dashboard:v1.8.3
</span></span><span style="display:flex;"><span>        resources:
</span></span><span style="display:flex;"><span>          limits:
</span></span><span style="display:flex;"><span>            cpu: 100m
</span></span><span style="display:flex;"><span>            memory: 300Mi
</span></span><span style="display:flex;"><span>          requests:
</span></span><span style="display:flex;"><span>            cpu: 50m
</span></span><span style="display:flex;"><span>            memory: 100Mi
</span></span><span style="display:flex;"><span>        ports:
</span></span><span style="display:flex;"><span>        - containerPort: <span style="color:#099">8443</span>
</span></span><span style="display:flex;"><span>          protocol: TCP
</span></span><span style="display:flex;"><span>        args:
</span></span><span style="display:flex;"><span>          <span style="color:#998;font-style:italic"># PLATFORM-SPECIFIC ARGS HERE</span>
</span></span><span style="display:flex;"><span>          - --auto-generate-certificates
</span></span><span style="display:flex;"><span>        volumeMounts:
</span></span><span style="display:flex;"><span>        - name: tmp-volume
</span></span><span style="display:flex;"><span>          mountPath: /tmp
</span></span><span style="display:flex;"><span>        livenessProbe:
</span></span><span style="display:flex;"><span>          httpGet:
</span></span><span style="display:flex;"><span>            scheme: HTTPS
</span></span><span style="display:flex;"><span>            path: /
</span></span><span style="display:flex;"><span>            port: <span style="color:#099">8443</span>
</span></span><span style="display:flex;"><span>          initialDelaySeconds: <span style="color:#099">30</span>
</span></span><span style="display:flex;"><span>          timeoutSeconds: <span style="color:#099">30</span>
</span></span><span style="display:flex;"><span>      volumes:
</span></span><span style="display:flex;"><span>      - name: tmp-volume
</span></span><span style="display:flex;"><span>        emptyDir: <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>      serviceAccountName: kubernetes-dashboard-admin
</span></span><span style="display:flex;"><span>      tolerations:
</span></span><span style="display:flex;"><span>      - key: <span style="color:#d14">&#34;CriticalAddonsOnly&#34;</span>
</span></span><span style="display:flex;"><span>        operator: <span style="color:#d14">&#34;Exists&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>准备 <code>svc.yaml</code> 文件</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 dashboard<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat svc.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Service
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: kubernetes-dashboard
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    k8s-app: kubernetes-dashboard
</span></span><span style="display:flex;"><span>    kubernetes.io/cluster-service: <span style="color:#d14">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>    addonmanager.kubernetes.io/mode: Reconcile
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    k8s-app: kubernetes-dashboard
</span></span><span style="display:flex;"><span>  ports:
</span></span><span style="display:flex;"><span>  - port: <span style="color:#099">443</span>
</span></span><span style="display:flex;"><span>    targetPort: <span style="color:#099">8443</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>准备 <code>ingress</code> 配置文件</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 dashboard<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat ingress.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: extensions/v1beta1
</span></span><span style="display:flex;"><span>kind: Ingress
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: kubernetes-dashboard
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span><span style="display:flex;"><span>  annotations:
</span></span><span style="display:flex;"><span>    kubernetes.io/ingress.class: traefik
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  rules:
</span></span><span style="display:flex;"><span>  - host: dashboard.od.com
</span></span><span style="display:flex;"><span>    http:
</span></span><span style="display:flex;"><span>      paths:
</span></span><span style="display:flex;"><span>      - backend:
</span></span><span style="display:flex;"><span>          serviceName: kubernetes-dashboard
</span></span><span style="display:flex;"><span>          servicePort: <span style="color:#099">443</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>应用资源配置清单</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl apply -f http://k8s-yaml.od.com/dashboard/rbac.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl apply -f http://k8s-yaml.od.com/dashboard/dp.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl apply -f http://k8s-yaml.od.com/dashboard/svc.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl apply -f http://k8s-yaml.od.com/dashboard/ingress.yaml</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>验证以上资源配置清单是否生效</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get pods -n kube-system</span>
</span></span><span style="display:flex;"><span>NAME                                    READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>coredns-6b6c4f9648-t7727                1/1     Running   <span style="color:#099">0</span>          7d23h
</span></span><span style="display:flex;"><span>kubernetes-dashboard-76dcdb4677-7p8w9   1/1     Running   <span style="color:#099">0</span>          97s
</span></span><span style="display:flex;"><span>traefik-ingress-5jwhl                   1/1     Running   <span style="color:#099">0</span>          60m
</span></span><span style="display:flex;"><span>traefik-ingress-6pc5k                   1/1     Running   <span style="color:#099">0</span>          60m
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get svc -n kube-system</span>
</span></span><span style="display:flex;"><span>NAME                      TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span style="color:#000;font-weight:bold">(</span>S<span style="color:#000;font-weight:bold">)</span>                  AGE
</span></span><span style="display:flex;"><span>coredns                   ClusterIP   192.168.0.2     &lt;none&gt;        53/UDP,53/TCP,9153/TCP   7d23h
</span></span><span style="display:flex;"><span>kubernetes-dashboard      ClusterIP   192.168.1.136   &lt;none&gt;        443/TCP                  114s
</span></span><span style="display:flex;"><span>traefik-ingress-service   ClusterIP   192.168.191.8   &lt;none&gt;        80/TCP,8080/TCP          60m
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get ingress -n kube-system</span>
</span></span><span style="display:flex;"><span>NAME                   HOSTS              ADDRESS   PORTS   AGE
</span></span><span style="display:flex;"><span>kubernetes-dashboard   dashboard.od.com             <span style="color:#099">80</span>      2m19s
</span></span><span style="display:flex;"><span>traefik-web-ui         traefik.od.com               <span style="color:#099">80</span>      60m
</span></span></code></pre></td></tr></table>
</div>
</div><p>修改 <code>named</code> 配置文件，使 <code>dns</code> 客户端可以解析 <code>dashboard.od.com</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 conf.d<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /var/named/od.com.zone</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">$ORIGIN</span> od.com.
</span></span><span style="display:flex;"><span><span style="color:#008080">$TTL</span> <span style="color:#099">600</span>        ; <span style="color:#099">10</span> minutes
</span></span><span style="display:flex;"><span>@               IN SOA  dns.od.com. dnsadmin.od.com. <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>								<span style="color:#998;font-style:italic"># 前滚一个序列号</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">2020052705</span> ; serial
</span></span><span style="display:flex;"><span>                                <span style="color:#099">10800</span>      ; refresh <span style="color:#000;font-weight:bold">(</span><span style="color:#099">3</span> hours<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">900</span>        ; retry <span style="color:#000;font-weight:bold">(</span><span style="color:#099">15</span> minutes<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">604800</span>     ; expire <span style="color:#000;font-weight:bold">(</span><span style="color:#099">1</span> week<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">86400</span>      ; minimum <span style="color:#000;font-weight:bold">(</span><span style="color:#099">1</span> day<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                NS   dns.od.com.
</span></span><span style="display:flex;"><span><span style="color:#008080">$TTL</span> <span style="color:#099">60</span> ; <span style="color:#099">1</span> minute
</span></span><span style="display:flex;"><span>dns                A    192.168.199.11
</span></span><span style="display:flex;"><span>harbor             A    192.168.199.15
</span></span><span style="display:flex;"><span>k8s-yaml           A    192.168.199.15
</span></span><span style="display:flex;"><span>traefik            A    192.168.199.10
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 添加一个 A 记录</span>
</span></span><span style="display:flex;"><span>dashboard          A    192.168.199.10
</span></span></code></pre></td></tr></table>
</div>
</div><p>重启 <code>named</code> 服务</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 conf.d<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># systemctl restart named</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>验证解析是否成功</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 使用 192.168.199.11（named）解析域名</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># dig -t -A dashboard.od.com @192.168.199.11 +short</span>
</span></span><span style="display:flex;"><span>;; Warning, ignoring invalid <span style="color:#0086b3">type</span> -A
</span></span><span style="display:flex;"><span>192.168.199.10
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 使用 192.168.0.2 （coredns）解析域名</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># dig -t -A dashboard.od.com @192.168.0.2 +short</span>
</span></span><span style="display:flex;"><span>;; Warning, ignoring invalid <span style="color:#0086b3">type</span> -A
</span></span><span style="display:flex;"><span>192.168.199.10
</span></span></code></pre></td></tr></table>
</div>
</div><p>在浏览器中通过 <code>dashboard.od.com</code> 访问 <code>dashboard</code></p>
<p><img src="https://images.wuennan.cn/20200708003934133.png" alt="20200708003934133"></p>
<blockquote>
<p>授权这里可以先选择 “跳过”</p>
</blockquote>
<h4 id="12-为dashboard创建证书">1.2 为Dashboard创建证书</h4>
<p>若要使用令牌的方式登录到 <code>Dashboard</code> 的话，需要使用 <code>https</code> 协议。因此必要要创建一个证书供 <code>Dashboard</code> 使用</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># (umask 077; openssl genrsa -out dashboard.od.com.key 2048)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># openssl req -new -key dashboard.od.com.key -out dashboard.od.com.csr -subj &#34;/CN=dashboard.od.com/C=CN/ST=BJ/L=Beijing/O=OldboyEdu/OU=ops&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># openssl x509 -req -in dashboard.od.com.csr -CA ca.pem -CAkey ca-key.pem -CAcreateserial -out dashboard.od.com.crt -days 3650</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看证书详情</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cfssl-certinfo -cert dashboard.od.com.crt</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 <code>192.168.199.11</code> 和 <code>192.168.199.12</code> 上配置证书</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mkdir /etc/nginx/certs</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /etc/nginx/certs</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 拷贝证书</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp root@192.168.199.15:/opt/certs/dashboard.od.com.crt ./</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp root@192.168.199.15:/opt/certs/dashboard.od.com.key ./</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># nginx配置文件</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/nginx/conf.d/dashboard.od.com.conf</span>
</span></span><span style="display:flex;"><span>server <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    listen       80;
</span></span><span style="display:flex;"><span>    server_name  dashboard.od.com;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    rewrite ^<span style="color:#000;font-weight:bold">(</span>.*<span style="color:#000;font-weight:bold">)</span>$ https://<span style="color:#d14">${</span><span style="color:#008080">server_name</span><span style="color:#d14">}</span><span style="color:#008080">$1</span> permanent;
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>server <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    listen       <span style="color:#099">443</span> ssl;
</span></span><span style="display:flex;"><span>    server_name  dashboard.od.com;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ssl_certificate <span style="color:#d14">&#34;certs/dashboard.od.com.crt&#34;</span>;
</span></span><span style="display:flex;"><span>    ssl_certificate_key <span style="color:#d14">&#34;certs/dashboard.od.com.key&#34;</span>;
</span></span><span style="display:flex;"><span>    ssl_session_cache shared:SSL:1m;
</span></span><span style="display:flex;"><span>    ssl_session_timeout  10m;
</span></span><span style="display:flex;"><span>    ssl_ciphers HIGH:!aNULL:!MD5;
</span></span><span style="display:flex;"><span>    ssl_prefer_server_ciphers on;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    location / <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        proxy_pass http://default_backend_traefik;
</span></span><span style="display:flex;"><span>        proxy_set_header Host       <span style="color:#008080">$http_host</span>;
</span></span><span style="display:flex;"><span>        proxy_set_header x-forwarded-for <span style="color:#008080">$proxy_add_x_forwarded_for</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>配置完成后，点击 “不安全” 即可查看证书信息</p>
<p><img src="https://images.wuennan.cn/20200708223854583.png" alt="20200708223854583"></p>
<p>查看 <code>admin</code> 的 <code>token</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get secret -n kube-system</span>
</span></span><span style="display:flex;"><span>NAME                                     TYPE                                  DATA   AGE
</span></span><span style="display:flex;"><span>coredns-token-k6mvh                      kubernetes.io/service-account-token   <span style="color:#099">3</span>      8d
</span></span><span style="display:flex;"><span>default-token-zbds4                      kubernetes.io/service-account-token   <span style="color:#099">3</span>      9d
</span></span><span style="display:flex;"><span>kubernetes-dashboard-admin-token-jb27r   kubernetes.io/service-account-token   <span style="color:#099">3</span>      22h
</span></span><span style="display:flex;"><span>kubernetes-dashboard-key-holder          Opaque                                <span style="color:#099">2</span>      22h
</span></span><span style="display:flex;"><span>traefik-ingress-controller-token-pzl2h   kubernetes.io/service-account-token   <span style="color:#099">3</span>      23h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 执行此命令后，将返回一个token的值，复制此值到Dashboard即可登录</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl describe secret kubernetes-dashboard-admin-token-jb27r -n kube-system</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="13-kubeconfig登陆">1.3 Kubeconfig登陆</h4>
<p>设置变量</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># DASH_TOCKEN=$(kubectl get secret -n kube-system kubernetes-dashboard-admin-token-jb27r -o jsonpath={.data.token}|base64 -d)</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># admin-token-wrqbp可以通过 kubectl get secrets -n kube-system | grep admin 查看</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># echo $DASH_TOCKEN</span>
</span></span><span style="display:flex;"><span>eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZC1hZG1pbi10b2tlbi1ud3Y1dCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZC1hZG1pbiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImRlZGI0YmJjLWQ5ZTMtNDkyZC1hYjA0LTdlMTJlZjcwNjY5OSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTprdWJlcm5ldGVzLWRhc2hib2FyZC1hZG1pbiJ9.fdHw84wY7SvBY2yE5LK-8bSkR4f4Wniw78ohLdJ-saV1m3cRoWoBNYKYN4xTolBcgH21Wczma-4AjsEGXhCvtSzlWjd32uIxPk1x06_9LYBUKWs0tPdAhHLXRenxDXxi5RuQTRKw9DKg8droMri7V2RlPeBlQrEaestXBSrw1kE_LEQ1k67Nuh9clSTRIKE-OGM6MRtY-f1LMjzSWkg-v3tbI51SU2x-SldDqbgCgCNizRpLnY3KnpxUU1tjYMSTIi8lVsTuI5pFb7xOUwiZd_QncckXI0SWAS-4-3MyL-AHer6QDT-0pUM87gIraCJtjxLuqh4e02x3r4FvCFjVaA
</span></span></code></pre></td></tr></table>
</div>
</div><p>添加<code>cluster</code>条目</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl config set-cluster kubernetes --server=dashborad.od.com:80 --kubeconfig=/root/dashbord-admin.conf</span>
</span></span><span style="display:flex;"><span>Cluster <span style="color:#d14">&#34;kubernetes&#34;</span> set.
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># dashborad.od.com:80 为dashboard访问地址</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>定义用于向<code>kubernetes</code>集群进行身份验证的客户端凭据</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic">#  kubectl config set-credentials admin --token=$DASH_TOCKEN --kubeconfig=/root/dashbord-admin.conf</span>
</span></span><span style="display:flex;"><span>User <span style="color:#d14">&#34;admin&#34;</span> set.
</span></span></code></pre></td></tr></table>
</div>
</div><p>用于使用提供的认证信息和命名空间将请求发送到指定的集群</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl config set-context admin --cluster=kubernetes --user=admin --kubeconfig=/root/dashbord-admin.conf</span>
</span></span><span style="display:flex;"><span>Context <span style="color:#d14">&#34;admin&#34;</span> created.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl config use-context admin  --kubeconfig=/root/dashbord-admin.conf</span>
</span></span><span style="display:flex;"><span>Switched to context <span style="color:#d14">&#34;admin&#34;</span>.
</span></span></code></pre></td></tr></table>
</div>
</div><p>保存凭证</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># sz /root/dashbord-admin.conf </span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>参考链接： <a href="https://www.jianshu.com/p/99853cac56b8">https://www.jianshu.com/p/99853cac56b8</a></p>
</blockquote>
<h4 id="14-升级dashboard">1.4 升级Dashboard</h4>
<p>准备镜像文件</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker pull hexun/kubernetes-dashboard-amd64:v1.10.1</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker images | grep dashbo</span>
</span></span><span style="display:flex;"><span>hexun/kubernetes-dashboard-amd64   v1.10.1                    f9aed6605b81        <span style="color:#099">18</span> months ago       122MB
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker tag f9aed6605b81 harbor.od.com/public/dashboard:v1.10.1</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker push harbor.od.com/public/dashboard:v1.10.1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>修改 <code>dp.yaml</code> 资源配置清单，并重新应用</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 修改 image 部分，使用新的镜像文件</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /data/k8s-yaml/dashboard/dp.yaml</span>
</span></span><span style="display:flex;"><span>        image: harbor.od.com/public/dashboard:v1.10.1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 重新应用此配置清单</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl apply -f http://k8s-yaml.od.com/dashboard/dp.yaml</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="15-部署heapster">1.5 部署heapster</h4>
<p>可从 <code>Github</code> 上下载<a href="https://github.com/kubernetes-retired/heapster">Heapster</a>
准备镜像文件</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker pull quay.io/bitnami/heapster:1.5.4</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker tag c359b95ad38b harbor.od.com/public/heapster:v1.5.4</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker push harbor.od.com/public/heapster:v1.5.4</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>准备资源配置清单 <code>rbac.yaml</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /data/k8s-yaml/dashboard/heapster/rbac.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: ServiceAccount
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: heapster
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>kind: ClusterRoleBinding
</span></span><span style="display:flex;"><span>apiVersion: rbac.authorization.k8s.io/v1beta1
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: heapster
</span></span><span style="display:flex;"><span>roleRef:
</span></span><span style="display:flex;"><span>  apiGroup: rbac.authorization.k8s.io
</span></span><span style="display:flex;"><span>  kind: ClusterRole
</span></span><span style="display:flex;"><span>  name: system:heapster
</span></span><span style="display:flex;"><span>subjects:
</span></span><span style="display:flex;"><span>- kind: ServiceAccount
</span></span><span style="display:flex;"><span>  name: heapster
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span></code></pre></td></tr></table>
</div>
</div><p>准备资源配置清单 <code>dp.yaml</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /data/k8s-yaml/dashboard/heapster/dp.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: extensions/v1beta1
</span></span><span style="display:flex;"><span>kind: Deployment
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: heapster
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  replicas: <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>  template:
</span></span><span style="display:flex;"><span>    metadata:
</span></span><span style="display:flex;"><span>      labels:
</span></span><span style="display:flex;"><span>        task: monitoring
</span></span><span style="display:flex;"><span>        k8s-app: heapster
</span></span><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      serviceAccountName: heapster
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>      - name: heapster
</span></span><span style="display:flex;"><span>        image: harbor.od.com/public/heapster:v1.5.4
</span></span><span style="display:flex;"><span>        imagePullPolicy: IfNotPresent
</span></span><span style="display:flex;"><span>        command:
</span></span><span style="display:flex;"><span>        - /opt/bitnami/heapster/bin/heapster
</span></span><span style="display:flex;"><span>        - --source<span style="color:#000;font-weight:bold">=</span>kubernetes:https://kubernetes.default
</span></span></code></pre></td></tr></table>
</div>
</div><p>准备资源配置清单 <code>svc.yaml</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /data/k8s-yaml/dashboard/heapster/svc.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Service
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    task: monitoring
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># For use as a Cluster add-on (https://github.com/kubernetes/kubernetes/tree/master/cluster/addons)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># If you are NOT using this as an addon, you should comment out this line.</span>
</span></span><span style="display:flex;"><span>    kubernetes.io/cluster-service: <span style="color:#d14">&#39;true&#39;</span>
</span></span><span style="display:flex;"><span>    kubernetes.io/name: Heapster
</span></span><span style="display:flex;"><span>  name: heapster
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  ports:
</span></span><span style="display:flex;"><span>  - port: <span style="color:#099">80</span>
</span></span><span style="display:flex;"><span>    targetPort: <span style="color:#099">8082</span>
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    k8s-app: heapster
</span></span></code></pre></td></tr></table>
</div>
</div><p>应用资源配置清单</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl apply -f http://k8s-yaml.od.com/dashboard/heapster/rbac.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl apply -f http://k8s-yaml.od.com/dashboard/heapster/dp.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl apply -f http://k8s-yaml.od.com/dashboard/heapster/svc.yaml</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>等待几分钟后，重启登录 <code>Dashboard</code> ，可以看到服务器的资源使用情况</p>
<p><img src="https://images.wuennan.cn/20200709005716583.png" alt="20200709005716583"></p>
<blockquote>
<p>资源使用情况仅供参考，推荐使用Prometheus</p>
</blockquote>
<h1 id="八kubenetes升级">八、Kubenetes升级</h1>
<h3 id="1-环境准备">1. 环境准备</h3>
<p>生产环境应先摘除负载均衡，提前准备好安装包</p>
<p>查看当前的版本，两个 <code>node</code> 节点，版本为 <code>1.15.2</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get node -o wide</span>
</span></span><span style="display:flex;"><span>NAME                      STATUS   ROLES         AGE   VERSION   INTERNAL-IP      EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION               CONTAINER-RUNTIME
</span></span><span style="display:flex;"><span>192-168-199-13.host.com   Ready    master,node   13d   v1.15.2   192.168.199.13   &lt;none&gt;        CentOS Linux <span style="color:#099">7</span> <span style="color:#000;font-weight:bold">(</span>Core<span style="color:#000;font-weight:bold">)</span>   3.10.0-1127.8.2.el7.x86_64   docker://19.3.12
</span></span><span style="display:flex;"><span>192-168-199-14.host.com   Ready    master,node   13d   v1.15.2   192.168.199.14   &lt;none&gt;        CentOS Linux <span style="color:#099">7</span> <span style="color:#000;font-weight:bold">(</span>Core<span style="color:#000;font-weight:bold">)</span>   3.10.0-1127.8.2.el7.x86_64   docker://19.3.12
</span></span></code></pre></td></tr></table>
</div>
</div><p>删除其中一个节点</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl delete node 192-168-199-13.host.com</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>等待一小会，所有 <code>pod</code> 会全部转移至其他节点</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get nodes -o wide</span>
</span></span><span style="display:flex;"><span>NAME                      STATUS   ROLES         AGE   VERSION   INTERNAL-IP      EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION               CONTAINER-RUNTIME
</span></span><span style="display:flex;"><span>192-168-199-14.host.com   Ready    master,node   13d   v1.15.2   192.168.199.14   &lt;none&gt;        CentOS Linux <span style="color:#099">7</span> <span style="color:#000;font-weight:bold">(</span>Core<span style="color:#000;font-weight:bold">)</span>   3.10.0-1127.8.2.el7.x86_64   docker://19.3.12
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get pods -n kube-system -o wide</span>
</span></span><span style="display:flex;"><span>NAME                                   READY   STATUS    RESTARTS   AGE     IP           NODE                      NOMINATED NODE   READINESS GATES
</span></span><span style="display:flex;"><span>coredns-6b6c4f9648-8rcmq               1/1     Running   <span style="color:#099">0</span>          105s    172.7.14.7   192-168-199-14.host.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>heapster-b5b9f794-2qnkl                1/1     Running   <span style="color:#099">0</span>          3d17h   172.7.14.5   192-168-199-14.host.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>kubernetes-dashboard-67989c548-t4tcg   1/1     Running   <span style="color:#099">0</span>          113s    172.7.14.6   192-168-199-14.host.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>traefik-ingress-6pc5k                  1/1     Running   <span style="color:#099">0</span>          4d18h   172.7.14.4   192-168-199-14.host.com   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>准备安装包</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># tar xf kubernetes-server-linux-amd64-v1.15.4.tar.gz</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mv kubernetes kubernetes-v1.15.4</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd kubernetes-v1.15.4/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 kubernetes-v1.15.4<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># rm -rf kubernetes-src.tar.gz</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 kubernetes-v1.15.4<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># /root/kubernetes-v1.15.4/server/bin</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 bin<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># rm -rf *.tar</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 bin<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># rm -rf *_tag</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mv kubernetes-v1.15.4/ /opt/</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>准备证书及配置文件</p>
<pre tabindex="0"><code>[root@192-168-199-13 bin]# mkdir conf cert
[root@192-168-199-13 bin]# cp /opt/kubernetes-v1.15.2/server/bin/cert/* cert/
[root@192-168-199-13 bin]# cp /opt/kubernetes-v1.15.2/server/bin/conf/* conf/
[root@192-168-199-13 bin]# cp /opt/kubernetes-v1.15.2/server/bin/*.sh ./
</code></pre><h3 id="2-集群升级">2. 集群升级</h3>
<p>生效配置，并重启服务</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 bin<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /opt/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 opt<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ll | grep kube</span>
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#099">1</span> root root   <span style="color:#099">24</span> Jun <span style="color:#099">28</span> 22:20 kubernetes -&gt; /opt/kubernetes-v1.15.2/
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#099">4</span> root root <span style="color:#099">4096</span> Jun <span style="color:#099">28</span> 22:21 kubernetes-v1.15.2
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#099">4</span> root root <span style="color:#099">4096</span> Jul <span style="color:#099">12</span> 19:05 kubernetes-v1.15.4
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 删除原来的软连接，并新家软连接到 kubernetes-v1.15.4</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 opt<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># rm kubernetes -rf</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 opt<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ln -s /opt/kubernetes-v1.15.4/ /opt/kubernetes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 opt<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ll | grep kube</span>
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#099">1</span> root root   <span style="color:#099">24</span> Jul <span style="color:#099">12</span> 19:23 kubernetes -&gt; /opt/kubernetes-v1.15.4/
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#099">4</span> root root <span style="color:#099">4096</span> Jun <span style="color:#099">28</span> 22:21 kubernetes-v1.15.2
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#099">4</span> root root <span style="color:#099">4096</span> Jul <span style="color:#099">12</span> 19:05 kubernetes-v1.15.4
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 通过supervisorctl 重启所有服务，生产环境建议一个一个重启</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 opt<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># supervisorctl restart all</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看服务状态</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 kubernetes<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># supervisorctl status</span>
</span></span><span style="display:flex;"><span>etcd-server-199-13               RUNNING   pid 42096, uptime 0:09:18
</span></span><span style="display:flex;"><span>flanneld-199-13                  RUNNING   pid 43635, uptime 0:05:27
</span></span><span style="display:flex;"><span>kube-apiserver-199-13            RUNNING   pid 42460, uptime 0:08:28
</span></span><span style="display:flex;"><span>kube-controller-manager-199-13   RUNNING   pid 43836, uptime 0:04:56
</span></span><span style="display:flex;"><span>kube-kubelet-199-13              RUNNING   pid 45378, uptime 0:01:53
</span></span><span style="display:flex;"><span>kube-proxy-199-13                RUNNING   pid 36883, uptime 0:20:59
</span></span><span style="display:flex;"><span>kube-scheduler-199-13            RUNNING   pid 41827, uptime 0:10:02
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>若重启失败，可查看 <code>/data/logs/</code> 日志，若因 <code>ipv6</code> 端口冲突导致，可通过 <code>netstat -lnap</code> 找到进程对应的 <code>pid</code> , <code>kill</code> 后重启即可</p>
</blockquote>
<p>所有服务正常后，节点会被自动加回集群</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 kubernetes<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get nodes -o wide</span>
</span></span><span style="display:flex;"><span>NAME                      STATUS   ROLES         AGE   VERSION   INTERNAL-IP      EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION               CONTAINER-RUNTIME
</span></span><span style="display:flex;"><span>192-168-199-13.host.com   Ready    &lt;none&gt;        34m   v1.15.4   192.168.199.13   &lt;none&gt;        CentOS Linux <span style="color:#099">7</span> <span style="color:#000;font-weight:bold">(</span>Core<span style="color:#000;font-weight:bold">)</span>   3.10.0-1127.8.2.el7.x86_64   docker://19.3.12
</span></span><span style="display:flex;"><span>192-168-199-14.host.com   Ready    master,node   13d   v1.15.2   192.168.199.14   &lt;none&gt;        CentOS Linux <span style="color:#099">7</span> <span style="color:#000;font-weight:bold">(</span>Core<span style="color:#000;font-weight:bold">)</span>   3.10.0-1127.8.2.el7.x86_64   docker://19.3.12
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>升级，回退，添加节点等操作与上述类似</p>
</blockquote>

    </div>
    
    

    
</div>

            </div>
            <div id="footer"><div class="container-footer">
    
    

    <div class="beian">
        
        <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=">
            

        </a>

        <a href="" target="_blank">
            
            <span class="some">icp...<span>
            
        </a>
    </div>

    <div class="info">
        <a href="https://github.com/loveminimal/hugo-theme-virgo">Copyright</a> © 2016 - <span id="info-date"></span>
    </div>

</div></div>
        </div>
        <div class="cool-after" style="background-color: rgba(255, 255, 255, 0.81);"></div>
    </body>
</html>
<link href="https://qiniu.techgrow.cn/readmore/dist/readmore.css" type="text/css" rel="stylesheet">
<script src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script>
<script>
    var regex = /(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i
    var isMobile = navigator.userAgent.match(regex);
    if (!isMobile) {
        try {
            var plugin = new ReadmorePlugin();
            plugin.init({
                id: "readmore-container",
                blogId: "25525-2853989927488-092",
                name: "史努比会点运维",
                keyword: "验证码",
                qrcode: "https://images.snoopyops.top/wechat/wechat_snoopyops.jpg",
                type: "hugo",
                height: "auto",
                expires: "7",
                interval: "60",
                random: "1"
            })
        } catch (e) {
            console.warn("readmore plugin occurred error: " + e.name + " | " + e.message);
        }
    }
</script>
