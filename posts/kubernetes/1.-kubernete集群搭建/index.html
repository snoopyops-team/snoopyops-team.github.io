<!DOCTYPE html>
<html lang="zh-CN"><head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <meta name="description" content="1. Kubernetesé›†ç¾¤æ­å»º - https://www.snoopyops.top/posts/kubernetes/1.-kubernete%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/">
    <meta name="author" content="snoopy - https://www.snoopyops.top/">
    
    <meta name="msvalidate.01" content="B46311949B856F2A7015F366FB3CE878" />
    <title>1. Kubernetesé›†ç¾¤æ­å»º</title>
    <link rel="icon" type="image/png" href="/favicon.ico">
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/lxgw-wenkai-webfont/1.7.0/style.min.css" />
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/lxgw-wenkai-screen-webfont/1.7.0/style.min.css" />
    
    <link rel="stylesheet" href="https://www.snoopyops.top/style.min.6bbccf0916939df698171c34d30f896276712c30bd56be0d7fd8023e1b00c3d9.css">
    
    <script type="text/javascript" src="/main.js" defer></script>
    
    
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?080713f769977324f1fbafc95c5fa4c6";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
</head>
<body class="active-animate cool">
        <div class="cool-before" style="background: url('/imgs/bg/foxgirl.jpg') center center/cover no-repeat fixed;"></div>
        <div id="readmore-container">
            <div id="header" class=""><div class="container-header">
    
    
    <div class="right">
        
        <h1 class="title">1. Kubernetesé›†ç¾¤æ­å»º</h1>
    
        
            
            <div id="toc">ğŸ“œ</div>
        
    </div>
</div>
</div>
            <div id="content">










<div class="container-main container-page ">

    <div class="desc">
        
        <span>
            
            <svg t="1656736000388" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7409" width="12" height="12"><path d="M524.885333 338.986667L200.362667 663.466667c-17.28 15.274667-27.989333 36.693333-29.696 56.234666v133.76l130.730666 0.085334c22.784-1.621333 43.989333-12.245333 61.013334-31.701334l322.688-322.645333-160.213334-160.213333z m60.373334-60.330667l160.170666 160.213333 102.144-102.144a19.712 19.712 0 0 0 0-27.861333L715.093333 176.426667a19.456 19.456 0 0 0-27.605333 0L585.258667 278.613333zM701.312 85.333333c27.946667 0 54.741333 11.136 74.282667 30.848l132.309333 132.309334a105.045333 105.045333 0 0 1 0 148.565333L424.874667 879.957333c-29.824 34.346667-72.106667 55.466667-120.448 58.794667H85.333333v-42.666667l0.128-179.84c3.626667-44.970667 24.576-86.826667 56.448-114.944l485.12-485.034666A104.789333 104.789333 0 0 1 701.269333 85.333333z" p-id="7410" fill="#adb5bd"></path></svg>
            2023-05-11&nbsp;&nbsp;&nbsp;
            <svg t="1656737270708" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="23838" width="11" height="11"><path d="M824.264 95.36c0-23.859 25.043-44.16 48.902-44.16s49.714 20.301 49.714 44.16v190.08c0 23.859-19.054 52.868-42.913 52.868h-190.08c-23.859 0-46.696-25.96-46.696-49.819s22.55-46.249 46.409-46.249h82.025C702.344 175.534 610.22 155.853 512 155.853c-206.775 0-360.398 149.372-360.398 356.147 0 206.775 153.623 358.23 360.398 358.23 206.775 0 357.467-151.455 357.467-358.23 0-23.859 23.634-50.706 53.413-50.706 29.78 0 49.92 26.847 49.92 50.706 0 254.493-206.307 460.8-460.8 460.8-254.493 0-460.8-206.307-460.8-460.8C51.2 257.507 257.507 51.2 512 51.2c122.4 0 226.684 33.296 312.264 117.369 0.358 0.351 0.358-24.052 0-73.209z" p-id="23839" fill="#adb5bd"></path></svg>
            2023-12-06&nbsp;&nbsp;&nbsp;
        </span>
        <span>
            
            <svg t="1656737548689" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="33866" width="12" height="12"><path d="M832.038608 64.662657H192.030028C121.255125 64.662657 63.940169 121.98845 63.940169 192.694717v446.793671C63.940169 710.205493 121.255125 767.643272 192.030028 767.643272h133.353183a63.940169 63.940169 0 0 1 55.219742 31.576328l76.099638 129.83828c12.358154 21.093031 33.790754 31.626903 55.216129 31.626903s42.832688-10.544709 55.198067-31.619678l76.222461-129.870792a63.940169 63.940169 0 0 1 55.212517-31.551041h133.54103c70.576219 0 127.732228-57.289669 127.732227-127.800865V192.391272C959.825022 121.85479 902.643727 64.662657 832.038608 64.662657zM895.884854 639.842407A63.85347 63.85347 0 0 1 832.092795 703.703103h-133.54103a127.753903 127.753903 0 0 0-110.349172 63.09847l-76.222461 129.856342a0.274545 0.274545 0 0 1 0-0.050574h-0.032512s-0.021675 0.061411-0.032512 0.061412l-76.1466-129.85273A127.804477 127.804477 0 0 0 325.383211 703.703103H192.030028A64.207489 64.207489 0 0 1 127.880338 639.488388V192.694717A64.102729 64.102729 0 0 1 192.030028 128.602826h640.00858A63.799284 63.799284 0 0 1 895.884854 192.391272v447.451135z" fill="#adb5bd" p-id="33867"></path><path d="M608.154093 288.092004A31.970084 31.970084 0 0 0 576.184009 320.062089v160.078006l-134.650049-179.278119A31.970084 31.970084 0 0 0 384.002258 320.062089v255.760676a31.970084 31.970084 0 0 0 63.940169 0v-159.958796l134.650048 179.274507a31.970084 31.970084 0 0 0 57.531703-19.200113V320.062089a31.970084 31.970084 0 0 0-31.970085-31.970085z" fill="#adb5bd" p-id="33868"></path></svg>
            17637 å­—</span>&nbsp;
        <span>
            
            <svg t="1656737462334" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="32892" width="12" height="12"><path d="M512 74.666667C270.933333 74.666667 74.666667 270.933333 74.666667 512S270.933333 949.333333 512 949.333333 949.333333 753.066667 949.333333 512 753.066667 74.666667 512 74.666667z m0 810.666666c-204.8 0-373.333333-168.533333-373.333333-373.333333S307.2 138.666667 512 138.666667 885.333333 307.2 885.333333 512 716.8 885.333333 512 885.333333z" p-id="32893" fill="#adb5bd"></path><path d="M695.466667 567.466667l-151.466667-70.4V277.333333c0-17.066667-14.933333-32-32-32s-32 14.933333-32 32v238.933334c0 12.8 6.4 23.466667 19.2 29.866666l170.666667 81.066667c4.266667 2.133333 8.533333 2.133333 12.8 2.133333 12.8 0 23.466667-6.4 29.866666-19.2 6.4-14.933333 0-34.133333-17.066666-42.666666z" p-id="32894" fill="#adb5bd"></path></svg>
            36 åˆ†é’Ÿ</span>
            <div class="container-ctgtag">
	<div class="taxonomy">
		<div class="tag">
			
			
		</div>
	</div>
</div>
        
    </div>
    
    <div class="toc">
        <div class="container-page-operation">
	<div class="page-operation">
		<div><a href="/"><img src="/imgs/icons/home-2.svg" alt=""></a></div>
		<div><a href="/nav"><img src="/imgs/icons/iov-navigate-1.svg" alt=""></a></div>
		<div><a href="/tags"><img src="/imgs/icons/treetags.svg" alt=""></a></div>
		<div id="light-dark"><a><img src="/imgs/icons/moon2.svg" alt=""></a></div>
		<div><a href="#"><img src="/imgs/icons/up2.svg" alt=""></a></div>
	</div>
</div>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#ä¸€ç¯å¢ƒå‡†å¤‡">ä¸€ã€ç¯å¢ƒå‡†å¤‡</a>
      <ul>
        <li><a href="#1-k8sæ ¸å¿ƒç»„ä»¶">1. K8Sæ ¸å¿ƒç»„ä»¶</a></li>
        <li><a href="#2-k8sä¸­çš„ä¸‰ç§ç½‘ç»œ">2. K8Sä¸­çš„ä¸‰ç§ç½‘ç»œ</a></li>
        <li><a href="#3-ipè§„åˆ’åŠå®éªŒæ‹“æ‰‘">3. IPè§„åˆ’åŠå®éªŒæ‹“æ‰‘</a></li>
      </ul>
    </li>
    <li><a href="#äºŒåŸºç¡€æœåŠ¡å‡†å¤‡">äºŒã€åŸºç¡€æœåŠ¡å‡†å¤‡</a>
      <ul>
        <li><a href="#1-dnsæœåŠ¡åˆå§‹åŒ–">1. DNSæœåŠ¡åˆå§‹åŒ–</a></li>
        <li><a href="#2-å‡†å¤‡ç­¾å‘è¯ä¹¦ç¯å¢ƒ">2. å‡†å¤‡ç­¾å‘è¯ä¹¦ç¯å¢ƒ</a></li>
        <li><a href="#3-éƒ¨ç½²dockerç¯å¢ƒ">3. éƒ¨ç½²Dockerç¯å¢ƒ</a></li>
        <li><a href="#4-éƒ¨ç½²harborä»“åº“">4. éƒ¨ç½²Harborä»“åº“</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#1-éƒ¨ç½²etcdé›†ç¾¤">1. éƒ¨ç½²etcdé›†ç¾¤</a></li>
        <li><a href="#2-éƒ¨ç½²api-server">2. éƒ¨ç½²api-server</a></li>
        <li><a href="#3-å››å±‚è´Ÿè½½å‡è¡¡">3. å››å±‚è´Ÿè½½å‡è¡¡</a></li>
        <li><a href="#4-å®‰è£…kube-controller-manager">4. å®‰è£…kube-controller-manager</a></li>
        <li><a href="#5-å®‰è£…kube-scheduler">5. å®‰è£…kube-scheduler</a></li>
        <li><a href="#6-éƒ¨ç½²kubelet">6. éƒ¨ç½²Kubelet</a></li>
        <li><a href="#7-éƒ¨ç½²kube-proxy">7. éƒ¨ç½²kube-proxy</a></li>
        <li><a href="#8-é›†ç¾¤éªŒè¯">8. é›†ç¾¤éªŒè¯</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#1-é™ˆè¿°å¼èµ„æºç®¡ç†">1. é™ˆè¿°å¼èµ„æºç®¡ç†</a></li>
        <li><a href="#2-å£°æ˜å¼èµ„æºç®¡ç†">2. å£°æ˜å¼èµ„æºç®¡ç†</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#1-ingresséƒ¨ç½²">1. Ingresséƒ¨ç½²</a></li>
        <li><a href="#2-éªŒè¯">2. éªŒè¯</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#1-dashboardéƒ¨ç½²">1 Dashboardéƒ¨ç½²</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#1-ç¯å¢ƒå‡†å¤‡">1. ç¯å¢ƒå‡†å¤‡</a></li>
        <li><a href="#2-é›†ç¾¤å‡çº§">2. é›†ç¾¤å‡çº§</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>

    <div class='content  '>
        <h1 id="kuberneteé›†ç¾¤æ­å»º">Kuberneteé›†ç¾¤æ­å»º</h1>
<h2 id="ä¸€ç¯å¢ƒå‡†å¤‡">ä¸€ã€ç¯å¢ƒå‡†å¤‡</h2>
<h3 id="1-k8sæ ¸å¿ƒç»„ä»¶">1. K8Sæ ¸å¿ƒç»„ä»¶</h3>
<p>K8Sçš„é€»è¾‘æ¶æ„å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="https://images.wuennan.cn/image-20200818224330086.png" alt="image-20200818224330086"></p>
<p><strong>etcd</strong>ï¼šä¿å­˜äº†æ•´ä¸ªé›†ç¾¤çš„çŠ¶æ€ï¼Œå°±æ˜¯ä¸€ä¸ªæ•°æ®åº“ã€‚</p>
<h4 id="11-ä¸»æ§masterèŠ‚ç‚¹">1.1 ä¸»æ§ï¼ˆmasterï¼‰èŠ‚ç‚¹</h4>
<p><strong>apiserver</strong></p>
<ul>
<li>æä¾› äº†é›†ç¾¤çš„REST APIæ¥å£ï¼ˆåŒ…æ‹¬é‰´æƒã€æ•°æ®æ ¡éªŒåŠé›†ç¾¤çŠ¶æ€å˜æ›´ï¼‰</li>
<li>è´Ÿè´£å…¶ä»–æ¨¡å—è´¨æ£€çš„æ•°æ®äº¤äº’ï¼Œæ‰¿æ‹…é€šä¿¡æ¢çº½åŠŸèƒ½ã€‚</li>
<li>æ˜¯èµ„æºé…é¢æ§åˆ¶çš„å…¥å£ã€‚</li>
<li>æä¾›å®Œå¤‡çš„é›†ç¾¤å®‰å…¨æœºåˆ¶ã€‚</li>
</ul>
<p><strong>controller-manager</strong></p>
<ul>
<li>ç”±ä¸€ç³»åˆ—æ§åˆ¶å™¨ç»„æˆï¼Œé€šè¿‡ <code>apiserver</code> ç›‘æ§æ•´ä¸ªæ•´ä¸ªé›†ç¾¤çš„çŠ¶æ€ï¼Œå¹¶ç¡®ä¿é›†ç¾¤å¤„äºé¢„æœŸçš„å·¥ä½œçŠ¶æ€</li>
<li>Node Controller</li>
<li>Deployment Controller</li>
<li>Service  Controller</li>
<li>Volume Controller</li>
<li>&hellip;</li>
</ul>
<p><strong>scheduler</strong></p>
<ul>
<li>æ¥æ”¶è°ƒåº¦ pod åˆ°åˆé€‚çš„è¿ç®—èŠ‚ç‚¹ä¸Šã€‚</li>
<li>é¢„ç®—ç­–ç•¥ï¼ˆpredictï¼‰</li>
<li>ä¼˜é€‰ç­–ç•¥ï¼ˆprioritiesï¼‰</li>
</ul>
<h4 id="12-è¿ç®—nodeèŠ‚ç‚¹">1.2 è¿ç®—ï¼ˆnodeï¼‰èŠ‚ç‚¹</h4>
<p><strong>kube-kubelet</strong></p>
<ul>
<li>å®šæ—¶ä»æŸä¸ªåœ°æ–¹è·å–èŠ‚ç‚¹ä¸Š <code>pod</code> çš„æœŸæœ›çŠ¶æ€ï¼ˆè¿è¡Œä»€ä¹ˆå®¹å™¨ã€è¿è¡Œçš„å‰¯æœ¬æ•°é‡ã€ç½‘ç»œæˆ–è€…å­˜å‚¨å¦‚ä½•é…ç½®ç­‰ç­‰ï¼‰ï¼Œå¹¶è°ƒç”¨å¯¹åº”çš„å®¹å™¨å¹³å°æ¥å£è¾¾åˆ°è¿™ä¸ªçŠ¶æ€ã€‚</li>
<li>å®šæ—¶æ±‡æŠ¥å½“å‰èŠ‚ç‚¹çš„çŠ¶æ€ç»™ <code>apiserver</code> ï¼Œä»¥ä¾›è°ƒåº¦çš„æ—¶å€™ ä½¿ç”¨</li>
<li>é•œåƒå’Œå®¹å™¨çš„æ¸…ç†å·¥ä½œï¼Œä¿è¯èŠ‚ç‚¹ä¸Šé•œåƒä¸ä¼šå æ»¡ç£ç›˜ç©ºé—´ï¼Œé€€å‡ºçš„å®¹å™¨ä¸ä¼šå ç”¨å¤ªå¤šçš„èµ„æº</li>
</ul>
<p><strong>kube-proxy</strong></p>
<ul>
<li>K8Såœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œç½‘ç»œä»£ç†ï¼Œserviceèµ„æºçš„è½½ä½“(serveræ˜¯kube-proxyé€šè¿‡åˆ›å»ºiptablesæˆ–è€…lvsçš„è§„åˆ™å®ç°çš„)ã€‚</li>
<li>å»ºç«‹ <code>pod</code> ç½‘ç»œå’Œé›†ç¾¤ç½‘ç»œçš„çš„å…³ç³»ï¼ˆClusterIP -&gt; podIPï¼‰</li>
<li>å¸¸è§çš„ä¸‰ç§æµé‡è°ƒåº¦æ¨¡å¼
<ul>
<li>Userspaceï¼ˆåºŸå¼ƒï¼‰</li>
<li>Iptablesï¼ˆæ¿’ä¸´åºŸå¼ƒï¼‰</li>
<li>Ipvsï¼ˆæ¨èï¼‰</li>
</ul>
</li>
<li>è´Ÿè´£å»ºç«‹å’Œåˆ é™¤åŒ…æ‹¬æ›´æ–°è°ƒåº¦è§„åˆ™ã€é€šçŸ¥ <code>apiserver</code> è‡ªå·±æ›´æ–°ï¼Œæˆ–ä» <code>apiserver</code> é‚£é‡Œè·å–å…¶ä»– <code>kube-proxy</code>  çš„è°ƒåº¦è§„åˆ™å˜åŒ–æ¥æ›´æ–°è‡ªå·±çš„ã€‚</li>
</ul>
<h3 id="2-k8sä¸­çš„ä¸‰ç§ç½‘ç»œ">2. K8Sä¸­çš„ä¸‰ç§ç½‘ç»œ</h3>
<p>K8Sä¸­é»˜è®¤æœ‰å¦‚ä¸‹ä¸‰ç§ç½‘ç»œ</p>
<ul>
<li>
<p>Node ç½‘ç»œ</p>
</li>
<li>
<p>Service ç½‘ç»œ</p>
</li>
<li>
<p>Pod ç½‘ç»œ</p>
</li>
</ul>
<p><img src="https://images.wuennan.cn/image-20200818082131316.png" alt="image-20200818082131316"></p>
<h3 id="3-ipè§„åˆ’åŠå®éªŒæ‹“æ‰‘">3. IPè§„åˆ’åŠå®éªŒæ‹“æ‰‘</h3>
<p>æ¨è <code>2C4G</code> åŠä»¥ä¸Šé…ç½®</p>
<table>
<thead>
<tr>
<th>IP</th>
<th>ä¸»æœºå</th>
<th>è§’è‰²</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.199.11</td>
<td>192-168-199-11</td>
<td>ä»£ç†èŠ‚ç‚¹1</td>
</tr>
<tr>
<td>192.168.199.12</td>
<td>192-168-199-12</td>
<td>ä»£ç†èŠ‚ç‚¹2</td>
</tr>
<tr>
<td>192.168.199.13</td>
<td>192-168-199-13</td>
<td>è¿ç®—èŠ‚ç‚¹1</td>
</tr>
<tr>
<td>192.168.199.14</td>
<td>192-168-199-14</td>
<td>è¿ç®—èŠ‚ç‚¹2</td>
</tr>
<tr>
<td>192.168.199.15</td>
<td>192-168-199-15</td>
<td>è¿ç»´èŠ‚ç‚¹</td>
</tr>
</tbody>
</table>
<p>å®éªŒæ‹“æ‰‘å›¾</p>
<p><img src="https://images.wuennan.cn/image-20200821075109370.png" alt="image-20200821075109370"></p>
<h2 id="äºŒåŸºç¡€æœåŠ¡å‡†å¤‡">äºŒã€åŸºç¡€æœåŠ¡å‡†å¤‡</h2>
<h3 id="1-dnsæœåŠ¡åˆå§‹åŒ–">1. DNSæœåŠ¡åˆå§‹åŒ–</h3>
<p>é€šè¿‡ <code>Bind9</code> æä¾›åŸŸåè§£ææœåŠ¡ï¼Œ<code>Ingress</code> å¯æ ¹æ®åŸŸåçš„è®¿é—®å®ç°ä¸ƒå±‚è°ƒåº¦ã€‚</p>
<h4 id="11-å®‰è£…bind9">1.1 å®‰è£…Bind9</h4>
<p>ä¸»è¦åœ¨ <code>192.168.199.11</code> ä¸Šæ“ä½œï¼Œå®‰è£…æ—¶è¯·æ³¨æ„ä¸»æœºå</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># yum install bind -y</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># rpm -qa bind</span>
</span></span><span style="display:flex;"><span>bind-9.11.4-16.P2.el7_8.6.x86_64
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="12-é…ç½®bind9">1.2 é…ç½®Bind9</h4>
<p>ä¿®æ”¹ä¸»é…ç½®æ–‡ä»¶</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># vim /etc/named.conf</span>
</span></span><span style="display:flex;"><span>listen-on port <span style="color:#099">53</span> <span style="color:#000;font-weight:bold">{</span> 192.168.199.11; <span style="color:#000;font-weight:bold">}</span>;
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ipv6å¯åˆ é™¤ï¼Œallow-queryæŒ‡å®šå“ªäº›ä¸»æœºå¯ä»¥ä½¿ç”¨æ­¤æœåŠ¡æŸ¥è¯¢åŸŸå</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># allow-queryæŒ‡å®šå¯ä»¥ä½¿ç”¨æ­¤DNSçš„ä¸»æœº</span>
</span></span><span style="display:flex;"><span>allow-query     <span style="color:#000;font-weight:bold">{</span> any; <span style="color:#000;font-weight:bold">}</span>;
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># forwardersæŒ‡å‘ä¸Šå±‚DNSï¼Œéœ€è¦å•ç‹¬æ·»åŠ ï¼Œæˆ‘åœ¨æ­¤æ¬¡å¡«å†™çš„ç½‘å…³</span>
</span></span><span style="display:flex;"><span>forwarders      <span style="color:#000;font-weight:bold">{</span> 192.168.199.1; <span style="color:#000;font-weight:bold">}</span>;
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># é€’å½’æŸ¥è¯¢</span>
</span></span><span style="display:flex;"><span>recursion yes;
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># DNSå®‰å…¨æ‰©å±•ï¼Œå¯¹åŸŸåè¿›è¡Œç­¾åè®¤è¯ï¼Œä¿è¯åŸŸåçš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§ï¼Œä¸ä¼šè¢«ä¿®æ”¹ï¼Œä¸ºèŠ‚çœèµ„æºå¯å…³é—­</span>
</span></span><span style="display:flex;"><span>dnssec-enable no;
</span></span><span style="display:flex;"><span>dnssec-validation no;
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>DNSé»˜è®¤æœ‰é€’å½’æŸ¥è¯¢å’Œè¿­ä»£æŸ¥è¯¢ä¸¤ç§æ–¹å¼</p>
<p>é€’å½’æŸ¥è¯¢ï¼šåªè¦å‘å‡ºé€’å½’æŸ¥è¯¢ï¼ŒæœåŠ¡å™¨å¿…é¡»å›ç­”ç›®æ ‡IPä¸åŸŸåçš„æ˜ å°„å…³ç³»ã€‚</p>
<p>è¿­ä»£æŸ¥è¯¢ï¼šæœåŠ¡å™¨æ”¶åˆ°ä¸€æ¬¡è¿­ä»£æŸ¥è¯¢ï¼Œå›å¤ä¸€æ¬¡ç»“æœï¼Œè¿™ä¸ªç»“æœå¯èƒ½æ˜¯ç›®æ ‡IPä¸åŸŸåçš„æ˜ å°„å…³ç³»ï¼Œä¹Ÿå¯èƒ½æ˜¯å…¶ä»–DNSæœåŠ¡å™¨çš„åœ°å€ã€‚</p>
<p><img src="https://images.wuennan.cn/image-20200818233400890.png" alt="image-20200818233400890"></p>
</blockquote>
<p>æ£€æŸ¥é…ç½®æ–‡ä»¶ï¼Œæ­£å¸¸æƒ…å†µæ— è¾“å‡º</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># named-checkconf</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>é…ç½®ä¸»æœºåŸŸå’Œä¸šåŠ¡åŸŸ</strong>
ä¿®æ”¹åŸŸé…ç½®æ–‡ä»¶ï¼Œåœ¨ <code>/etc/named.rfc1912.zones</code> æœ€ä¸‹æ–¹æ·»åŠ å¦‚ä¸‹å†…å®¹</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>zone <span style="color:#d14">&#34;host.com&#34;</span> IN <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0086b3">type</span>  master;
</span></span><span style="display:flex;"><span>        file  <span style="color:#d14">&#34;host.com.zone&#34;</span>;
</span></span><span style="display:flex;"><span>        allow-update <span style="color:#000;font-weight:bold">{</span> 192.168.199.11; <span style="color:#000;font-weight:bold">}</span>;
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>zone <span style="color:#d14">&#34;od.com&#34;</span> IN <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0086b3">type</span>  master;
</span></span><span style="display:flex;"><span>        file  <span style="color:#d14">&#34;od.com.zone&#34;</span>;
</span></span><span style="display:flex;"><span>        allow-update <span style="color:#000;font-weight:bold">{</span> 192.168.199.11; <span style="color:#000;font-weight:bold">}</span>;
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>é…ç½®ä¸»æœºåŸŸæ•°æ®æ–‡ä»¶</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /var/named/host.com.zone</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">$ORIGIN</span> host.com.
</span></span><span style="display:flex;"><span><span style="color:#008080">$TTL</span> <span style="color:#099">600</span>        ; <span style="color:#099">10</span> minutes
</span></span><span style="display:flex;"><span>@       IN SOA  dns.host.com. dnsadmin.host.com. <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">2020052701</span> ; serial
</span></span><span style="display:flex;"><span>                                <span style="color:#099">10800</span>      ; refresh <span style="color:#000;font-weight:bold">(</span><span style="color:#099">3</span> hours<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">900</span>        ; retry <span style="color:#000;font-weight:bold">(</span><span style="color:#099">15</span> minutes<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">604800</span>     ; expire <span style="color:#000;font-weight:bold">(</span><span style="color:#099">1</span> week<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">86400</span>      ; minimum <span style="color:#000;font-weight:bold">(</span><span style="color:#099">1</span> day<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                        NS   dns.host.com.
</span></span><span style="display:flex;"><span><span style="color:#008080">$TTL</span> <span style="color:#099">60</span> ; <span style="color:#099">1</span> minute
</span></span><span style="display:flex;"><span>dns                     A    192.168.199.11
</span></span><span style="display:flex;"><span>192-168-199-11          A    192.168.199.11
</span></span><span style="display:flex;"><span>192-168-199-12          A    192.168.199.12
</span></span><span style="display:flex;"><span>192-168-199-13          A    192.168.199.13
</span></span><span style="display:flex;"><span>192-168-199-14          A    192.168.199.14
</span></span><span style="display:flex;"><span>192-168-199-15          A    192.168.199.15
</span></span></code></pre></td></tr></table>
</div>
</div><p>é…ç½®ä¸šåŠ¡åŸŸæ•°æ®æ–‡ä»¶</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /var/named/od.com.zone</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">$ORIGIN</span> od.com.
</span></span><span style="display:flex;"><span><span style="color:#008080">$TTL</span> <span style="color:#099">600</span>        ; <span style="color:#099">10</span> minutes
</span></span><span style="display:flex;"><span>@               IN SOA  dns.od.com. dnsadmin.od.com. <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">2020052701</span> ; serial
</span></span><span style="display:flex;"><span>                                <span style="color:#099">10800</span>      ; refresh <span style="color:#000;font-weight:bold">(</span><span style="color:#099">3</span> hours<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">900</span>        ; retry <span style="color:#000;font-weight:bold">(</span><span style="color:#099">15</span> minutes<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">604800</span>     ; expire <span style="color:#000;font-weight:bold">(</span><span style="color:#099">1</span> week<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">86400</span>      ; minimum <span style="color:#000;font-weight:bold">(</span><span style="color:#099">1</span> day<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                NS   dns.od.com.
</span></span><span style="display:flex;"><span><span style="color:#008080">$TTL</span> <span style="color:#099">60</span> ; <span style="color:#099">1</span> minute
</span></span><span style="display:flex;"><span>dns                A    192.168.199.11
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ£€æŸ¥é…ç½®æ–‡ä»¶</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># named-checkconf</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯åŠ¨æœåŠ¡</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># systemctl start named</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># systemctl enable named</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="13-éªŒè¯">1.3 éªŒè¯</h4>
<p>éªŒè¯æœåŠ¡æ˜¯å¦æ­£å¸¸å¯åŠ¨</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># netstat -lnutp | grep 53</span>
</span></span><span style="display:flex;"><span>tcp        <span style="color:#099">0</span>      <span style="color:#099">0</span> 127.0.0.1:953           0.0.0.0:*               LISTEN      1804/named
</span></span><span style="display:flex;"><span>tcp        <span style="color:#099">0</span>      <span style="color:#099">0</span> 192.168.199.11:53       0.0.0.0:*               LISTEN      1804/named
</span></span><span style="display:flex;"><span>tcp6       <span style="color:#099">0</span>      <span style="color:#099">0</span> ::1:953                 :::*                    LISTEN      1804/named
</span></span><span style="display:flex;"><span>udp        <span style="color:#099">0</span>      <span style="color:#099">0</span> 192.168.199.11:53       0.0.0.0:*                           1804/named
</span></span></code></pre></td></tr></table>
</div>
</div><p>æµ‹è¯•é€šè¿‡ <code>192.168.199.11</code> æ˜¯å¦èƒ½å¤Ÿè§£æ <code>192-168-199-14.host.com</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># dig -t A 192-168-199-14.host.com @192.168.199.11 +short</span>
</span></span><span style="display:flex;"><span>192.168.199.14
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¿®æ”¹æ‰€æœ‰ä¸»æœºçš„<strong>ç½‘å¡é…ç½®æ–‡ä»¶</strong>ï¼ŒæŒ‡å®š<code>DNS1=192.168.199.11</code> ï¼Œå¹¶é‡å¯ç½‘å¡
ä¿®æ”¹ <code>/etc/resolv.conf</code> æ–‡ä»¶ï¼Œå†ç¬¬ä¸€è¡Œæ·»åŠ  <code>search host.com </code> ä½¿å…¶æ”¯æŒçŸ­åŸŸåã€‚ä¸šåŠ¡åŸŸä¸æ¨èä½¿ç”¨çŸ­åŸŸåã€‚</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/resolv.conf</span>
</span></span><span style="display:flex;"><span>search host.com
</span></span><span style="display:flex;"><span>nameserver 192.168.199.11
</span></span><span style="display:flex;"><span>nameserver 223.5.5.5
</span></span></code></pre></td></tr></table>
</div>
</div><p>æµ‹è¯•</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ping 192-168-199-12</span>
</span></span><span style="display:flex;"><span>PING 192-168-199-12.host.com <span style="color:#000;font-weight:bold">(</span>192.168.199.12<span style="color:#000;font-weight:bold">)</span> 56<span style="color:#000;font-weight:bold">(</span>84<span style="color:#000;font-weight:bold">)</span> bytes of data.
</span></span><span style="display:flex;"><span><span style="color:#099">64</span> bytes from 192.168.199.12 <span style="color:#000;font-weight:bold">(</span>192.168.199.12<span style="color:#000;font-weight:bold">)</span>: <span style="color:#008080">icmp_seq</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">1</span> <span style="color:#008080">ttl</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">64</span> <span style="color:#008080">time</span><span style="color:#000;font-weight:bold">=</span>0.370 ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ping baidu.com</span>
</span></span><span style="display:flex;"><span>PING baidu.com <span style="color:#000;font-weight:bold">(</span>220.181.38.148<span style="color:#000;font-weight:bold">)</span> 56<span style="color:#000;font-weight:bold">(</span>84<span style="color:#000;font-weight:bold">)</span> bytes of data.
</span></span><span style="display:flex;"><span><span style="color:#099">64</span> bytes from 220.181.38.148 <span style="color:#000;font-weight:bold">(</span>220.181.38.148<span style="color:#000;font-weight:bold">)</span>: <span style="color:#008080">icmp_seq</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">1</span> <span style="color:#008080">ttl</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">49</span> <span style="color:#008080">time</span><span style="color:#000;font-weight:bold">=</span>12.3 ms
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="2-å‡†å¤‡ç­¾å‘è¯ä¹¦ç¯å¢ƒ">2. å‡†å¤‡ç­¾å‘è¯ä¹¦ç¯å¢ƒ</h3>
<h4 id="21-å‡†å¤‡æ‰€éœ€è½¯ä»¶">2.1 å‡†å¤‡æ‰€éœ€è½¯ä»¶</h4>
<p>K8S ä¸­æ‰€æœ‰é€šä¿¡éœ€è¦ä¾èµ–è¯ä¹¦ï¼Œå¸¸ç”¨çš„ç­¾å‘è¯ä¹¦å·¥å…·æœ‰ <code>openssl</code> å’Œ <code>cfssl</code></p>
<p>ä¸»è¦åœ¨ <code>192.168,199.15</code> ä¸Šæ“ä½œï¼Œä¸‹è½½æ‰€éœ€è½¯ä»¶åŒ…ï¼Œä¿®æ”¹æƒé™åå¹¶éªŒè¯</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ä¸‹è½½æ‰€éœ€è½¯ä»¶åŒ…</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -O /usr/bin/cfssl</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -O /usr/bin/cfssl-json</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 -O /usr/bin/cfssl-certinfo</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#ä¿®æ”¹æƒé™</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># chmod +x /usr/bin/cfssl*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#éªŒè¯</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># which cfssl</span>
</span></span><span style="display:flex;"><span>/usr/bin/cfssl
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># which cfssl-json</span>
</span></span><span style="display:flex;"><span>/usr/bin/cfssl-json
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># which cfssl-certinfo</span>
</span></span><span style="display:flex;"><span>/usr/bin/cfssl-certinfo
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="22-ç­¾å‘è¯ä¹¦">2.2 ç­¾å‘è¯ä¹¦</h4>
<p>éœ€è¦åˆ›å»ºæ ¹è¯ä¹¦</p>
<p>åˆ›å»ºç”Ÿæˆ <code>CA</code> è¯ä¹¦ç­¾åè¯·æ±‚ï¼ˆ<code>csr</code>ï¼‰çš„ <code>JSON</code> é…ç½®æ–‡ä»¶</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># vim /opt/certs/ca-csr.json</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;CN&#34;</span>: <span style="color:#d14">&#34;OldboyEdu&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;hosts&#34;</span>: <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">]</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;key&#34;</span>: <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;algo&#34;</span>: <span style="color:#d14">&#34;rsa&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;size&#34;</span>: <span style="color:#099">2048</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;names&#34;</span>: <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;C&#34;</span>: <span style="color:#d14">&#34;CN&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;ST&#34;</span>: <span style="color:#d14">&#34;beijing&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;L&#34;</span>: <span style="color:#d14">&#34;beijing&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;O&#34;</span>: <span style="color:#d14">&#34;od&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;OU&#34;</span>: <span style="color:#d14">&#34;ops&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">]</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;ca&#34;</span>: <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;expiry&#34;</span>: <span style="color:#d14">&#34;175200h&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>CNï¼šä¸€èˆ¬å†™çš„æ˜¯åŸŸåï¼Œéå¸¸é‡è¦ï¼Œæµè§ˆå™¨ä½¿ç”¨è¯¥å­—æ®µéªŒè¯ç½‘ç«™æ˜¯å¦åˆæ³•
Cï¼šå›½å®¶
STï¼šå·ï¼Œçœ
Lï¼šåœ°åŒºï¼ŒåŸå¸‚
Oï¼šç»„ç»‡åç§°ï¼Œå…¬å¸åç§°
OUï¼šç»„ç»‡å•ä½åç§°ï¼Œå…¬å¸éƒ¨é—¨
expiryï¼šè¯ä¹¦è¿‡æœŸæ—¶é—´ï¼Œkubeadminè‡ªç­¾è¯ä¹¦é»˜è®¤æœ‰æ•ˆæœŸä¸º1å¹´</p>
</blockquote>
<p>ç”Ÿæˆ <code>CA</code> è¯ä¹¦å’Œç§é’¥</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /opt/certs/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cfssl gencert -initca ca-csr.json | cfssl-json -bare ca</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># cfssl gencert -initca ca-csr.json å¯ç”Ÿæˆå¯†é’¥æ–‡ä»¶ï¼Œé€šè¿‡ç®¡é“çš„æ–¹å¼å°†ç”Ÿæˆçš„è¯ä¹¦ä¼ è¾“åˆ°æ–‡ä»¶ä¸­</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ä¸»è¦ä½¿ç”¨çš„æ˜¯ca.pem å’Œ ca-key.pem</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ll</span>
</span></span><span style="display:flex;"><span>total <span style="color:#099">16</span>
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root  <span style="color:#099">993</span> May <span style="color:#099">27</span> 23:06 ca.csr
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root  <span style="color:#099">328</span> May <span style="color:#099">27</span> 22:59 ca-csr.json
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ ¹è¯ä¹¦çš„ç§é’¥</span>
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#099">1</span> root root <span style="color:#099">1679</span> May <span style="color:#099">27</span> 23:06 ca-key.pem
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ ¹è¯ä¹¦</span>
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root <span style="color:#099">1346</span> May <span style="color:#099">27</span> 23:06 ca.pem
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>å¯é€šè¿‡ <code>cfssl-certinfo -cert ca.pem</code> å‘½ä»¤æŸ¥çœ‹ç­¾å‘è¯ä¹¦çš„è¯¦ç»†ä¿¡æ¯</p>
</blockquote>
<h3 id="3-éƒ¨ç½²dockerç¯å¢ƒ">3. éƒ¨ç½²Dockerç¯å¢ƒ</h3>
<p>K8Séœ€è¦ä¾èµ–äº <code>Docker</code> çš„ç¯å¢ƒï¼Œä¸»è¦åœ¨ <code>192.168.199.13</code>  ã€ <code>192.168.199.14</code> ã€ <code>192.168.199.15</code> ä¸‰å°ä¸»æœºä¸Šå®‰è£… <code>Docker</code> ç¯å¢ƒ</p>
<h4 id="31-å®‰è£…å¹¶é…ç½®docker">3.1 å®‰è£…å¹¶é…ç½®docker</h4>
<p>å®‰è£… <code>docker</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-14 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è‹¥ä¸»æœºä½¿ç”¨çš„æ˜¯é˜¿é‡Œäº‘æ“ä½œç³»ç»Ÿï¼Œ<code>Docker</code> å®‰è£…æ–¹å¼å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>wget -O /etc/yum.repos.d/docker-ce.repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
yum install yum-plugin-releasever-adapter --disablerepo=* --enablerepo=plus
yum install docker-ce
</code></pre><p>è‹¥æ˜¯å›½å¤–ä¸»æœºï¼Œ<code>Docker</code> å®‰è£…æ–¹å¼å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>curl -s https://get.docker.com | sudo sh
</code></pre><p>åœ¨å·²å®‰è£… <code>docker</code> çš„ä¸»æœºä¸Šé…ç½® <code>docker</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mkdir -p /data/docker</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mkdir /etc/docker</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/docker/daemon.json</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#d14">&#34;graph&#34;</span>: <span style="color:#d14">&#34;/data/docker&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#d14">&#34;storage-driver&#34;</span>: <span style="color:#d14">&#34;overlay2&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#d14">&#34;insecure-registries&#34;</span>: <span style="color:#000;font-weight:bold">[</span><span style="color:#d14">&#34;registry.access.redhat.com&#34;</span>,<span style="color:#d14">&#34;quay.io&#34;</span>,<span style="color:#d14">&#34;harbor.od.com&#34;</span><span style="color:#000;font-weight:bold">]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#d14">&#34;registry-mirrors&#34;</span>: <span style="color:#000;font-weight:bold">[</span><span style="color:#d14">&#34;https://q2gr04ke.mirror.aliyuncs.com&#34;</span><span style="color:#000;font-weight:bold">]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#d14">&#34;bip&#34;</span>: <span style="color:#d14">&#34;172.7.13.1/24&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#d14">&#34;exec-opts&#34;</span>: <span style="color:#000;font-weight:bold">[</span><span style="color:#d14">&#34;native.cgroupdriver=systemd&#34;</span><span style="color:#000;font-weight:bold">]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#d14">&#34;live-restore&#34;</span>: <span style="color:#0086b3">true</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>bipæœ€å¥½ä¸ä¸»æœºç›¸å¯¹åº”ï¼Œå½“å¯åŠ¨å®¹å™¨æ—¶ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åˆ¤æ–­å‡ºå®¹å™¨æ‰€åœ¨çš„ä¸»å¥ã€‚
192.168.199.13 &mdash;&ndash; 172.7.13.1/24
192.168.199.14 &mdash;&ndash; 172.7.14.1/24
192.168.199.15 &mdash;&ndash; 172.7.15.1/24</p>
</blockquote>
<h4 id="32-éªŒè¯">3.2 éªŒè¯</h4>
<p>å¯åŠ¨å¹¶éªŒè¯å®¹å™¨</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># systemctl start docker</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># systemctl enable docker</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker info</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker ps -a</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="4-éƒ¨ç½²harborä»“åº“">4. éƒ¨ç½²Harborä»“åº“</h3>
<p><code>Harbor</code> ä¸ºç›®å‰ä¸»æµçš„é•œåƒä»“åº“ï¼Œä¸»è¦åœ¨ <code>192.168.199.15</code> ä¸Šæ“ä½œ</p>
<h4 id="41-å®‰è£…harbor">4.1 å®‰è£…Harbor</h4>
<p>ä¸‹è½½å¹¶è§£å‹ <code>harbor</code> ç¦»çº¿å®‰è£…åŒ…</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># tar xf harbor-offline-installer-v1.8.3.tgz -C /opt/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 opt<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mv harbor/ harbor-v1.8.3</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 opt<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ln -s /opt/harbor-v1.8.3/ /opt/harbor</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>harborçš„ç¦»çº¿å®‰è£…åŒ…å¯ä»githubä¸Šä¸‹è½½
å¼ºçƒˆå»ºè®®ä½¿ç”¨1.7.6åŠå…¶ä»¥ä¸Šçš„ç‰ˆæœ¬ï¼Œ1.7.5åŠå…¶ä»¥ä¸‹ç‰ˆæœ¬æœ‰è¶Šæƒçš„bugï¼Œæ™®é€šç”¨æˆ·å¯èƒ½ä¼šè·å–åˆ°ç®¡ç†å‘˜çš„æƒé™</p>
</blockquote>
<p>ä¿®æ”¹é…ç½®æ–‡ä»¶ <code>/opt/harbor/harbor.yml</code> ï¼Œä¸»è¦ä¿®æ”¹ä»¥ä¸‹å†…å®¹</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 opt<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># vim /opt/harbor/harbor.yml</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ä¸€å®šè¦é…ç½®ï¼Œå¦åˆ™ install çš„æ—¶å€™ä¼šæŠ¥é”™ </span>
</span></span><span style="display:flex;"><span>hostname: harbor.od.com
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># harborçš„ç™»å½•å¯†ç </span>
</span></span><span style="display:flex;"><span>harbor_admin_password: Harbor12345
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># é€šè¿‡Nginxçš„80ç«¯å£åå‘ä»£ç†Harborçš„180ç«¯å£</span>
</span></span><span style="display:flex;"><span>  port: <span style="color:#099">180</span>
</span></span><span style="display:flex;"><span>data_volume: /data/harbor
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ—¥å¿—çš„ä½ç½®</span>
</span></span><span style="display:flex;"><span>  location: /data/harbor/logs
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ä½¿ç”¨åå‘ä»£ç†éœ€è¦é…ç½®æ­¤è¡Œï¼Œå¦å’Œå¯èƒ½ä¼šå¯¼è‡´nodeèŠ‚ç‚¹æ— æ³•pullé•œåƒ</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ³¨æ„ï¼Œèµ°çš„æ˜¯httpåè®®</span>
</span></span><span style="display:flex;"><span>  external_url: http://harbor.od.com:80
</span></span></code></pre></td></tr></table>
</div>
</div><p>åˆ›å»ºé…ç½®æ–‡ä»¶ä¸­æ‰€éœ€çš„ç›®å½•å¹¶å®‰è£… <code>docker-compose</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 opt<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mkdir -p /data/harbor/logs</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 opt<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># yum install docker-compose -y</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é€šè¿‡è„šæœ¬å®‰è£… <code>harbor</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 opt<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /opt/harbor</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 harbor<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ./install.sh</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æŸ¥çœ‹å¯åŠ¨çš„å®¹å™¨çŠ¶æ€</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 harbor<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker-compose ps</span>
</span></span><span style="display:flex;"><span>      Name                     Command               State             Ports
</span></span><span style="display:flex;"><span>--------------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>harbor-core         /harbor/start.sh                 Up
</span></span><span style="display:flex;"><span>harbor-db           /entrypoint.sh postgres          Up      5432/tcp
</span></span><span style="display:flex;"><span>harbor-jobservice   /harbor/start.sh                 Up
</span></span><span style="display:flex;"><span>harbor-log          /bin/sh -c /usr/local/bin/ ...   Up      127.0.0.1:1514-&gt;10514/tcp
</span></span><span style="display:flex;"><span>harbor-portal       nginx -g daemon off;             Up      80/tcp
</span></span><span style="display:flex;"><span>nginx               nginx -g daemon off;             Up      0.0.0.0:180-&gt;80/tcp
</span></span><span style="display:flex;"><span>redis               docker-entrypoint.sh redis ...   Up      6379/tcp
</span></span><span style="display:flex;"><span>registry            /entrypoint.sh /etc/regist ...   Up      5000/tcp
</span></span><span style="display:flex;"><span>registryctl         /harbor/start.sh                 Up
</span></span></code></pre></td></tr></table>
</div>
</div><p>è‹¥éœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œéœ€è¦æ‰§è¡Œä»¥ä¸‹æ­¥éª¤</p>
<pre tabindex="0"><code>[root@192-168-199-15 harbor]# cd /opt/harbor
[root@192-168-199-15 harbor]# docker-compose down 
# æ›´æ–°é…ç½®æ–‡ä»¶
[root@192-168-199-15 harbor]# ./prepare 
[root@192-168-199-15 harbor]# docker-compose up -d
</code></pre><h4 id="42-åå‘ä»£ç†åŠåŸŸåè§£æ">4.2 åå‘ä»£ç†åŠåŸŸåè§£æ</h4>
<p>å®‰è£…å¹¶é…ç½® <code>Nginx</code> ï¼Œä½¿ç”¨ <code>Nginx</code> åå‘ä»£ç† <code>harbor</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 harbor<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># yum install nginx -y</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 harbor<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/nginx/conf.d/harbor.od.com.conf</span>
</span></span><span style="display:flex;"><span>server <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    listen       80;
</span></span><span style="display:flex;"><span>    server_name  harbor.od.com;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    client_max_body_size 1000m;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    location / <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        proxy_pass http://127.0.0.1:180;
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>éªŒè¯æ— æŠ¥é”™åï¼Œå¯åŠ¨ <code>Nginx</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 harbor<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># nginx -t</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 harbor<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># systemctl start nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 harbor<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># systemctl enable nginx</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨ <code>192.168.199.11</code> ä¸Šé…ç½® <code>bind</code> ä½¿ä¸»æœºå¯ä»¥æ­£å¸¸è§£æ <code>harbor.od.com</code> ï¼Œä¸»è¦ä¿®æ”¹å¦‚ä¸‹</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /var/named/od.com.zone</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">$ORIGIN</span> od.com.
</span></span><span style="display:flex;"><span><span style="color:#008080">$TTL</span> <span style="color:#099">600</span>        ; <span style="color:#099">10</span> minutes
</span></span><span style="display:flex;"><span>@               IN SOA  dns.od.com. dnsadmin.od.com. <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>								<span style="color:#998;font-style:italic"># å‰æ»šä¸€ä¸ªåºå·</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">2020052702</span> ; serial
</span></span><span style="display:flex;"><span>                                <span style="color:#099">10800</span>      ; refresh <span style="color:#000;font-weight:bold">(</span><span style="color:#099">3</span> hours<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">900</span>        ; retry <span style="color:#000;font-weight:bold">(</span><span style="color:#099">15</span> minutes<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">604800</span>     ; expire <span style="color:#000;font-weight:bold">(</span><span style="color:#099">1</span> week<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">86400</span>      ; minimum <span style="color:#000;font-weight:bold">(</span><span style="color:#099">1</span> day<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                NS   dns.od.com.
</span></span><span style="display:flex;"><span><span style="color:#008080">$TTL</span> <span style="color:#099">60</span> ; <span style="color:#099">1</span> minute
</span></span><span style="display:flex;"><span>dns                A    192.168.199.11
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ·»åŠ  A è®°å½•</span>
</span></span><span style="display:flex;"><span>harbor             A    192.168.199.15
</span></span></code></pre></td></tr></table>
</div>
</div><p>éªŒè¯æ˜¯å¦å¯ä»¥è§£æ <code>harbor.od.com</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># dig -t A harbor.od.com +short</span>
</span></span><span style="display:flex;"><span>192.168.199.15
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="43-webé¡µé¢é…ç½®">4.3 WEBé¡µé¢é…ç½®</h4>
<p>ç™»å½• <code>harbor</code> é»˜è®¤ç”¨æˆ·åä¸º <code>admin</code> å¯†ç ä¸º <code>Harbor</code> ï¼Œæ–°å»ºåç§°ä¸º <code>public</code> çš„å…¬å¼€é¡¹ç›®</p>
<p><img src="https://images.wuennan.cn/20200528003144683-1594546377446.png" alt="20200528003144683"></p>
<p>åœ¨ <code>192.168.199.15</code> ä¸Šï¼Œä»å®˜æ–¹ <code>pull</code> ä¸€ä¸ªé•œåƒä¸‹æ¥ï¼Œå¹¶ä¸Šä¼ åˆ°ç§æœ‰ä»“åº“</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker pull nginx:1.7.9</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker tag 84581e99d807 harbor.od.com/public/nginx:v1.7.9</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ç™»å½•åˆ°ç§æœ‰ä»“åº“ï¼Œå¦åˆ™æ— æ³•ä¸Šä¼ æˆåŠŸ</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker login harbor.od.com</span>
</span></span><span style="display:flex;"><span>â€¦â€¦
</span></span><span style="display:flex;"><span>Login Succeeded
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ä¸Šä¼ é•œåƒåˆ°ç§æœ‰ä»“åº“</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker push harbor.od.com/public/nginx:v1.7.9</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç§æœ‰ä»“åº“å·²å­˜åœ¨åˆšåˆšä¸Šä¼ çš„é•œåƒ</p>
<p><img src="https://images.wuennan.cn/20200528004751926-1594546395609.png" alt="20200528004751926"></p>
<h1 id="äºŒkuberneteséƒ¨ç½²">äºŒã€Kuberneteséƒ¨ç½²</h1>
<h3 id="1-éƒ¨ç½²etcdé›†ç¾¤">1. éƒ¨ç½²etcdé›†ç¾¤</h3>
<p><code>etcd</code> é›†ç¾¤éœ€è¦å®‰è£…åœ¨å¥‡æ•°ä¸ªæœåŠ¡å™¨ä¸Šã€‚è¿™é‡Œä¸»è¦éƒ¨ç½²åœ¨ <code>192.168.199.12</code> ã€ <code>192.168.199.13</code> å’Œ <code>192.168.199.14</code> ä¸‰ä¸ªä¸»æœºä¸Šã€‚</p>
<h4 id="11-ä¸ºetcdç­¾å‘è¯ä¹¦">1.1 ä¸ºetcdç­¾å‘è¯ä¹¦</h4>
<p><code>etcd</code> é›†ç¾¤ä¸­å„ä¸ªèŠ‚ç‚¹ä¹‹é—´ç›¸äº’é€šä¿¡ä½¿ç”¨çš„è¯ä¹¦ã€‚ç”±äºä¸€ä¸ª <code>etcd</code> èŠ‚ç‚¹æ—¢ä¸ºå…¶ä»–èŠ‚ç‚¹æä¾›æœåŠ¡ï¼Œåˆéœ€è¦ä½œä¸ºå®¢æˆ·ç«¯è®¿é—®å…¶ä»–èŠ‚ç‚¹ï¼Œå› æ­¤è¯¥è¯ä¹¦åŒæ—¶ç”¨ä½œæœåŠ¡å™¨è¯ä¹¦å’Œå®¢æˆ·ç«¯è¯ä¹¦ã€‚</p>
<p><code>etcd</code> é›†ç¾¤å‘å¤–æä¾›æœåŠ¡ä½¿ç”¨çš„è¯ä¹¦ã€‚è¯¥è¯ä¹¦æ˜¯æœåŠ¡å™¨è¯ä¹¦ã€‚</p>
<p><code>etcd</code> ä¹‹é—´çš„é€šä¿¡éœ€è¦è¯ä¹¦ï¼Œç­¾å‘è¯ä¹¦æ“ä½œä¸»è¦åœ¨è¿ç»´ä¸»æœº <code>192.168.199.15</code> ä¸Šè¿›è¡Œ
åˆ›å»ºåŸºäºæ ¹è¯ä¹¦çš„ <code>config</code> é…ç½®æ–‡ä»¶</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /opt/certs/ca-config.json</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;signing&#34;</span>: <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;default&#34;</span>: <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;expiry&#34;</span>: <span style="color:#d14">&#34;175200h&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;profiles&#34;</span>: <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;server&#34;</span>: <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;expiry&#34;</span>: <span style="color:#d14">&#34;175200h&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;usages&#34;</span>: <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#d14">&#34;signing&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#d14">&#34;key encipherment&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#d14">&#34;server auth&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;client&#34;</span>: <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;expiry&#34;</span>: <span style="color:#d14">&#34;175200h&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;usages&#34;</span>: <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#d14">&#34;signing&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#d14">&#34;key encipherment&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#d14">&#34;client auth&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;peer&#34;</span>: <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;expiry&#34;</span>: <span style="color:#d14">&#34;175200h&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#d14">&#34;usages&#34;</span>: <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#d14">&#34;signing&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#d14">&#34;key encipherment&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#d14">&#34;server auth&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#d14">&#34;client auth&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åˆ›å»ºç”Ÿæˆè‡ªç­¾è¯ä¹¦ç­¾åè¯·æ±‚ï¼ˆscrï¼‰çš„ JSON é…ç½®æ–‡ä»¶</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /opt/certs/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /opt/certs/etcd-peer-csr.json</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;CN&#34;</span>: <span style="color:#d14">&#34;k8s-etcd&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;hosts&#34;</span>: <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;192.168.199.11&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;192.168.199.12&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;192.168.199.13&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;192.168.199.14&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">]</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;key&#34;</span>: <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;algo&#34;</span>: <span style="color:#d14">&#34;rsa&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;size&#34;</span>: <span style="color:#099">2048</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;names&#34;</span>: <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;C&#34;</span>: <span style="color:#d14">&#34;CN&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;ST&#34;</span>: <span style="color:#d14">&#34;beijing&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;L&#34;</span>: <span style="color:#d14">&#34;beijing&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;O&#34;</span>: <span style="color:#d14">&#34;od&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;OU&#34;</span>: <span style="color:#d14">&#34;ops&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>hostsä¸­è¡¨ç¤ºè¦éƒ¨ç½²etcdæœåŠ¡çš„è®¾å¤‡ã€‚192.168.199.11ä½œä¸ºå¤‡ç”¨ï¼Œå½“ä¸€ä¸ªèŠ‚ç‚¹åäº†ä¹‹åï¼Œå¯ä»¥åœ¨192.168.199.11ä¸Šéƒ¨ç½²ä¸€ä¸ªetcdèŠ‚ç‚¹ã€‚ä¸æ”¯æŒé…ç½®ç½‘æ®µã€‚
ç”Ÿäº§ç¯å¢ƒä¸­åº”å¤šé…ç½®ä¸€äº›hosts</p>
</blockquote>
<p>ç”Ÿæˆ etcd è¯ä¹¦å’Œç§é’¥</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=peer etcd-peer-csr.json |cfssl-json -bare etcd-peer</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="12-å®‰è£…etcd">1.2 å®‰è£…etcd</h4>
<p>ä»¥ä¸‹éƒ¨åˆ†ï¼Œéœ€è¦åœ¨ <code>192.168.199.12</code> ã€<code>192.168.199.13</code> ã€<code>192.168.199.14</code>  ä¸‰ä¸ªä¸»æœºä¸»æœºä¸Šæ“ä½œï¼Œæ“ä½œç›¸åŒ</p>
<p>åˆ›å»º <code>etcd</code> ç”¨æˆ·</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># useradd -s /sbin/nologin -M etcd</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># id etcd</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">uid</span><span style="color:#000;font-weight:bold">=</span>1000<span style="color:#000;font-weight:bold">(</span>etcd<span style="color:#000;font-weight:bold">)</span> <span style="color:#008080">gid</span><span style="color:#000;font-weight:bold">=</span>1000<span style="color:#000;font-weight:bold">(</span>etcd<span style="color:#000;font-weight:bold">)</span> <span style="color:#008080">groups</span><span style="color:#000;font-weight:bold">=</span>1000<span style="color:#000;font-weight:bold">(</span>etcd<span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä» <code>github</code> ä¸Šä¸‹è½½ <code>etcd</code>
<a href="https://github.com/etcd-io/etcd/tags">etcdä¸‹è½½åœ°å€</a></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># tar xf etcd-v3.1.20-linux-amd64.tar.gz -C /opt/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /opt/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 opt<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mv etcd-v3.1.20-linux-amd64/ etcd-v3.1.20</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 opt<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ln -s /opt/etcd-v3.1.20/ /opt/etcd</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åˆ›å»ºç›®å½•ï¼Œæ‹·è´è¯ä¹¦ã€ç§é’¥</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 opt<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mkdir -p /opt/etcd/certs /data/etcd /data/logs/etcd-server</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 opt<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /opt/etcd/certs/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp 192-168-199-15:/opt/certs/ca.pem ./</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp 192-168-199-15:/opt/certs/etcd-peer.pem ./</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp 192-168-199-15:/opt/certs/etcd-peer-key.pem ./</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åˆ›å»º <code>etcd</code> çš„å¯åŠ¨æ–‡ä»¶ï¼Œéœ€è¦æ³¨æ„ <code>--name</code> éƒ¨åˆ†å’Œ <code>--initial-cluster</code> éƒ¨åˆ†</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /opt/etcd/etcd-server-startup.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#!/bin/sh</span>
</span></span><span style="display:flex;"><span>./etcd --name etcd-server-199-12 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       --data-dir /data/etcd/etcd-server <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       --listen-peer-urls https://192.168.199.12:2380 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       --listen-client-urls https://192.168.199.12:2379,http://127.0.0.1:2379 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       --quota-backend-bytes <span style="color:#099">8000000000</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       --initial-advertise-peer-urls https://192.168.199.12:2380 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       --advertise-client-urls https://192.168.199.12:2379,http://127.0.0.1:2379 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       --initial-cluster  etcd-server-199-12<span style="color:#000;font-weight:bold">=</span>https://192.168.199.12:2380,etcd-server-199-13<span style="color:#000;font-weight:bold">=</span>https://192.168.199.13:2380,etcd-server-199-14<span style="color:#000;font-weight:bold">=</span>https://192.168.199.14:2380 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       <span style="color:#998;font-style:italic"># æ ¹è¯ä¹¦</span>
</span></span><span style="display:flex;"><span>       --ca-file ./certs/ca.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       <span style="color:#998;font-style:italic"># å¯¹å¤–æä¾›æœåŠ¡çš„æœåŠ¡å™¨è¯ä¹¦</span>
</span></span><span style="display:flex;"><span>       --cert-file ./certs/etcd-peer.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       <span style="color:#998;font-style:italic"># æœåŠ¡å™¨è¯ä¹¦å¯¹åº”çš„ç§é’¥</span>
</span></span><span style="display:flex;"><span>       --key-file ./certs/etcd-peer-key.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       --client-cert-auth  <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>        <span style="color:#998;font-style:italic"># ç”¨äºéªŒè¯è®¿é—® etcd æœåŠ¡å™¨çš„å®¢æˆ·ç«¯è¯ä¹¦çš„ CA æ ¹è¯ä¹¦</span>
</span></span><span style="display:flex;"><span>       --trusted-ca-file ./certs/ca.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       --peer-ca-file ./certs/ca.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       <span style="color:#998;font-style:italic"># peer è¯ä¹¦ï¼Œç”¨äº etcd èŠ‚ç‚¹ä¹‹é—´çš„ç›¸äº’è®¿é—®</span>
</span></span><span style="display:flex;"><span>       --peer-cert-file ./certs/etcd-peer.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       <span style="color:#998;font-style:italic"># peer è¯ä¹¦å¯¹åº”çš„ç§é’¥</span>
</span></span><span style="display:flex;"><span>       --peer-key-file ./certs/etcd-peer-key.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       --peer-client-cert-auth <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       <span style="color:#998;font-style:italic"># ç”¨äºéªŒè¯ peer è¯ä¹¦çš„ CA æ ¹è¯ä¹¦</span>
</span></span><span style="display:flex;"><span>       --peer-trusted-ca-file ./certs/ca.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       --log-output stdout
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>ä¸‰å°ä¸»æœºçš„é…ç½®æ–‡ä»¶ä¸­ï¼Œ&ndash;nameå‚æ•°å’Œæ‰€æ¶‰åŠåˆ°çš„ipåœ°å€ä¸åŒã€‚éœ€è¦æ³¨æ„</p>
</blockquote>
<p>å¯¹ä¸Šè¿°æ¶‰åŠåˆ°çš„ç›®å½•æˆæƒï¼Œä½¿ <code>etcd</code> ç”¨æˆ·å¯¹å…¶å…·æœ‰æƒé™</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># chmod a+x /opt/etcd/etcd-server-startup.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># chown -R etcd.etcd /opt/etcd-v3.1.20/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># chown -R etcd.etcd /data/etcd/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># chown -R etcd.etcd /data/logs/etcd-server/</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®‰è£… <code>supervisor</code> ï¼Œé€šè¿‡ <code>supervisor</code> ç®¡ç† <code>etcd</code> è¿›ç¨‹</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># yum install supervisor -y</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># systemctl start supervisord</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># systemctl enable supervisord</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¼–å†™ <code>supervisord</code> ç›¸å…³æ–‡ä»¶ï¼Œä½¿å…¶å¯ä»¥ç®¡ç† <code>etcd</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/supervisord.d/etcd-server.ini</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>program:etcd-server-199-12<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">command</span><span style="color:#000;font-weight:bold">=</span>/opt/etcd/etcd-server-startup.sh                        ; the program <span style="color:#000;font-weight:bold">(</span>relative uses PATH, can take args<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">numprocs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">1</span>                                                      ; number of processes copies to start <span style="color:#000;font-weight:bold">(</span>def 1<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">directory</span><span style="color:#000;font-weight:bold">=</span>/opt/etcd                                             ; directory to cwd to before <span style="color:#0086b3">exec</span> <span style="color:#000;font-weight:bold">(</span>def no cwd<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">autostart</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                                  ; start at supervisord start <span style="color:#000;font-weight:bold">(</span>default: <span style="color:#0086b3">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">autorestart</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                                ; retstart at unexpected quit <span style="color:#000;font-weight:bold">(</span>default: <span style="color:#0086b3">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">startsecs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">30</span>                                                    ; number of secs prog must stay running <span style="color:#000;font-weight:bold">(</span>def. 1<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">startretries</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">3</span>                                                  ; max <span style="color:#998;font-style:italic"># of serial start failures (default 3)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">exitcodes</span><span style="color:#000;font-weight:bold">=</span>0,2                                                   ; <span style="color:#d14">&#39;expected&#39;</span> <span style="color:#0086b3">exit</span> codes <span style="color:#000;font-weight:bold">for</span> process <span style="color:#000;font-weight:bold">(</span>default 0,2<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stopsignal</span><span style="color:#000;font-weight:bold">=</span>QUIT                                                 ; signal used to <span style="color:#0086b3">kill</span> process <span style="color:#000;font-weight:bold">(</span>default TERM<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stopwaitsecs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">10</span>                                                 ; max num secs to <span style="color:#0086b3">wait</span> b4 SIGKILL <span style="color:#000;font-weight:bold">(</span>default 10<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">user</span><span style="color:#000;font-weight:bold">=</span>etcd                                                       ; setuid to this UNIX account to run the program
</span></span><span style="display:flex;"><span><span style="color:#008080">redirect_stderr</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                            ; redirect proc stderr to stdout <span style="color:#000;font-weight:bold">(</span>default <span style="color:#0086b3">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile</span><span style="color:#000;font-weight:bold">=</span>/data/logs/etcd-server/etcd.stdout.log           ; stdout log path, NONE <span style="color:#000;font-weight:bold">for</span> none; default AUTO
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile_maxbytes</span><span style="color:#000;font-weight:bold">=</span>64MB                                    ; max <span style="color:#998;font-style:italic"># logfile bytes b4 rotation (default 50MB)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile_backups</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">4</span>                                        ; <span style="color:#998;font-style:italic"># of stdout logfile backups (default 10)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_capture_maxbytes</span><span style="color:#000;font-weight:bold">=</span>1MB                                     ; number of bytes in <span style="color:#d14">&#39;capturemode&#39;</span> <span style="color:#000;font-weight:bold">(</span>default 0<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_events_enabled</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">false</span>                                     ; emit events on stdout writes <span style="color:#000;font-weight:bold">(</span>default <span style="color:#0086b3">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>program:etcd-server-199-12 åº”ä¸è„šæœ¬ä¸­çš„åç§°ç›¸å¯¹åº”ï¼Œä¸‰ä¸ªä¸»æœºçš„é…ç½®æ–‡ä»¶æ­¤éƒ¨åˆ†ä¹Ÿä¸åŒ</p>
</blockquote>
<p>é€šè¿‡ <code>supervisord</code> å¯åŠ¨ <code>etcd</code> çš„è¿›ç¨‹ï¼Œå¹¶æŸ¥çœ‹å…¶çŠ¶æ€</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># supervisorctl update</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># supervisorctl status</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># å¼€å§‹çŠ¶æ€ä¸º STARTING ï¼Œç­‰å¾…çº¦30ç§’åï¼ŒçŠ¶æ€ä¼šå˜ä¸ºRUNNING</span>
</span></span><span style="display:flex;"><span>etcd-server-199-12               RUNNING   pid 12546, uptime 0:02:40
</span></span></code></pre></td></tr></table>
</div>
</div><p>éªŒè¯ <code>etcd</code> çš„ç«¯å£æ˜¯å¦æ­£å¸¸å¯åŠ¨</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># netstat -lntp | grep etcd</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#2379 å’Œ 2380 ç«¯å£éƒ½è¦èµ·æ¥</span>
</span></span><span style="display:flex;"><span>tcp        <span style="color:#099">0</span>      <span style="color:#099">0</span> 192.168.199.12:2379     0.0.0.0:*               LISTEN      12547/./etcd
</span></span><span style="display:flex;"><span>tcp        <span style="color:#099">0</span>      <span style="color:#099">0</span> 127.0.0.1:2379          0.0.0.0:*               LISTEN      12547/./etcd
</span></span><span style="display:flex;"><span>tcp        <span style="color:#099">0</span>      <span style="color:#099">0</span> 192.168.199.12:2380     0.0.0.0:*               LISTEN      12547/./etcd
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="13-éªŒè¯-1">1.3 éªŒè¯</h4>
<p><strong>é›†ç¾¤å¥åº·çŠ¶æ€æ£€æŸ¥</strong></p>
<p>ç­‰ä¸‰å°æœåŠ¡éƒ½å®‰è£…å®Œ <code>etcd</code> åï¼Œéœ€è¦æ£€æŸ¥é›†ç¾¤çš„çŠ¶æ€ï¼Œå¯é‡‡ç”¨ä»¥ä¸‹ä¸¤ç§æ–¹æ³•è¿›è¡Œæ£€æŸ¥
æ–¹æ³•ä¸€ï¼š</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-14 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ./etcdctl cluster-health</span>
</span></span><span style="display:flex;"><span>member 35d340010a02200a is healthy: got healthy result from http://127.0.0.1:2379
</span></span><span style="display:flex;"><span>member 4a554f90b80c73ac is healthy: got healthy result from http://127.0.0.1:2379
</span></span><span style="display:flex;"><span>member c899bc1f18888852 is healthy: got healthy result from http://127.0.0.1:2379
</span></span><span style="display:flex;"><span>cluster is healthy
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ–¹æ³•äºŒï¼š</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-14 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ./etcdctl member list</span>
</span></span><span style="display:flex;"><span>35d340010a02200a: <span style="color:#008080">name</span><span style="color:#000;font-weight:bold">=</span>etcd-server-199-14 <span style="color:#008080">peerURLs</span><span style="color:#000;font-weight:bold">=</span>https://192.168.199.14:2380 <span style="color:#008080">clientURLs</span><span style="color:#000;font-weight:bold">=</span>http://127.0.0.1:2379,https://192.168.199.14:2379 <span style="color:#008080">isLeader</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">false</span>
</span></span><span style="display:flex;"><span>4a554f90b80c73ac: <span style="color:#008080">name</span><span style="color:#000;font-weight:bold">=</span>etcd-server-199-13 <span style="color:#008080">peerURLs</span><span style="color:#000;font-weight:bold">=</span>https://192.168.199.13:2380 <span style="color:#008080">clientURLs</span><span style="color:#000;font-weight:bold">=</span>http://127.0.0.1:2379,https://192.168.199.13:2379 <span style="color:#008080">isLeader</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">false</span>
</span></span><span style="display:flex;"><span>c899bc1f18888852: <span style="color:#008080">name</span><span style="color:#000;font-weight:bold">=</span>etcd-server-199-12 <span style="color:#008080">peerURLs</span><span style="color:#000;font-weight:bold">=</span>https://192.168.199.12:2380 <span style="color:#008080">clientURLs</span><span style="color:#000;font-weight:bold">=</span>http://127.0.0.1:2379,https://192.168.199.12:2379 <span style="color:#008080">isLeader</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="2-éƒ¨ç½²api-server">2. éƒ¨ç½²api-server</h3>
<h4 id="21-å‡†å¤‡å®‰è£…åŒ…">2.1 å‡†å¤‡å®‰è£…åŒ…</h4>
<p>ä¸»è¦åœ¨ <code>192.168.199.13</code> å’Œ <code>192.168.199.14</code> ä¸Šè¿›è¡Œæ“ä½œ
<code>K8S</code> å®‰è£…åŒ…å¯åœ¨ <code>github</code> ä¸Šä¸‹è½½</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># tar xf kubernetes-server-linux-amd64-v1.15.2.tar.gz -C /opt/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /opt/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 opt<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mv kubernetes/ kubernetes-v1.15.2</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 opt<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ln -s /opt/kubernetes-v1.15.2/ /opt/kubernetes</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åˆ é™¤ä¸å¿…è¦çš„æ–‡ä»¶</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 opt<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd kubernetes</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># goè¯­è¨€å†™çš„æºç åŒ…</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 kubernetes<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># rm -rf kubernetes-src.tar.gz</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 kubernetes<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd server/bin/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># taråŒ…ä¸ºé•œåƒæ–‡ä»¶ï¼Œä½¿ç”¨kubeadmæ–¹å¼éƒ¨ç½²ä¼šä½¿ç”¨åˆ°</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 bin<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># rm -rf *.tar</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 bin<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># rm -rf *_tag</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ­¤æ—¶ /opt/kubernetes/server/bin ç›®å½•ä¸‹åªå‰©ä¸‹ä¸€å †å¯æ‰§è¡Œæ–‡ä»¶</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 bin<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ll</span>
</span></span><span style="display:flex;"><span>total <span style="color:#099">884636</span>
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#099">1</span> root root  <span style="color:#099">43534816</span> Aug  <span style="color:#099">5</span>  <span style="color:#099">2019</span> apiextensions-apiserver
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#099">1</span> root root <span style="color:#099">100548640</span> Aug  <span style="color:#099">5</span>  <span style="color:#099">2019</span> cloud-controller-manager
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#099">1</span> root root <span style="color:#099">200648416</span> Aug  <span style="color:#099">5</span>  <span style="color:#099">2019</span> hyperkube
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#099">1</span> root root  <span style="color:#099">40182208</span> Aug  <span style="color:#099">5</span>  <span style="color:#099">2019</span> kubeadm
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#099">1</span> root root <span style="color:#099">164501920</span> Aug  <span style="color:#099">5</span>  <span style="color:#099">2019</span> kube-apiserver
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#099">1</span> root root <span style="color:#099">116397088</span> Aug  <span style="color:#099">5</span>  <span style="color:#099">2019</span> kube-controller-manager
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#099">1</span> root root  <span style="color:#099">42985504</span> Aug  <span style="color:#099">5</span>  <span style="color:#099">2019</span> kubectl
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#099">1</span> root root <span style="color:#099">119616640</span> Aug  <span style="color:#099">5</span>  <span style="color:#099">2019</span> kubelet
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#099">1</span> root root  <span style="color:#099">36987488</span> Aug  <span style="color:#099">5</span>  <span style="color:#099">2019</span> kube-proxy
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#099">1</span> root root  <span style="color:#099">38786144</span> Aug  <span style="color:#099">5</span>  <span style="color:#099">2019</span> kube-scheduler
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#099">1</span> root root   <span style="color:#099">1648224</span> Aug  <span style="color:#099">5</span>  <span style="color:#099">2019</span> mounter
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>192.168.199.14ä¸Šçš„æ“ä½œä¸ä¸Šè¿°ç›¸åŒ</strong></p>
<h4 id="22-ç­¾å‘è¯ä¹¦-1">2.2 ç­¾å‘è¯ä¹¦</h4>
<ul>
<li>kube-apiserver å¯¹å¤–æä¾›æœåŠ¡çš„æœåŠ¡å™¨è¯ä¹¦åŠç§é’¥ã€‚</li>
<li>kube-apiserver è®¿é—® etcd æ‰€éœ€çš„å®¢æˆ·ç«¯è¯ä¹¦åŠç§é’¥ã€‚</li>
<li>kube-apiserver è®¿é—® kubelet æ‰€éœ€çš„å®¢æˆ·ç«¯è¯ä¹¦åŠç§é’¥ã€‚</li>
<li>éªŒè¯è®¿é—®å…¶æœåŠ¡çš„å®¢æˆ·ç«¯çš„ CAã€‚</li>
<li>éªŒè¯ etcd æœåŠ¡å™¨è¯ä¹¦çš„ CA æ ¹è¯ä¹¦ã€‚</li>
<li>éªŒè¯ service account token çš„å…¬é’¥ã€‚</li>
</ul>
<p><strong>ç­¾å‘ client è¯ä¹¦</strong></p>
<p>ä¸º <code>kube-apiserver</code> ç­¾å‘è¯ä¹¦ï¼Œæ­¤è¯ä¹¦åœ¨ <code>apiserver</code> å’Œ <code>etcd</code> é€šä¿¡æ—¶ä¼šä½¿ç”¨åˆ°ã€‚<code>etcd</code> ä¸ºæœåŠ¡ç«¯ï¼Œ<code>apiserver</code> ä¸ºå®¢æˆ·ç«¯ã€‚å› æ­¤éœ€è¦åœ¨ <code>192.168.199.15</code> ä¸Šåˆ¶ä½œ <code>client</code> è¯ä¹¦ç»™ <code>apiserver</code> ä½¿ç”¨ã€‚</p>
<p>åˆ›å»ºç”Ÿæˆè¯ä¹¦ç­¾åè¯·æ±‚ï¼ˆcsrï¼‰çš„ <code>JSON</code> çš„é…ç½®æ–‡ä»¶</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /opt/certs/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /opt/certs/client-csr.json</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;CN&#34;</span>: <span style="color:#d14">&#34;k8s-node&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;hosts&#34;</span>: <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">]</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;key&#34;</span>: <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;algo&#34;</span>: <span style="color:#d14">&#34;rsa&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;size&#34;</span>: <span style="color:#099">2048</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;names&#34;</span>: <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;C&#34;</span>: <span style="color:#d14">&#34;CN&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;ST&#34;</span>: <span style="color:#d14">&#34;beijing&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;L&#34;</span>: <span style="color:#d14">&#34;beijing&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;O&#34;</span>: <span style="color:#d14">&#34;od&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;OU&#34;</span>: <span style="color:#d14">&#34;ops&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç­¾å‘è¯ä¹¦</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client client-csr.json |cfssl-json -bare client</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ll client*</span>
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root  <span style="color:#099">993</span> May <span style="color:#099">30</span> 09:40 client.csr
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root  <span style="color:#099">280</span> May <span style="color:#099">30</span> 09:38 client-csr.json
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#099">1</span> root root <span style="color:#099">1675</span> May <span style="color:#099">30</span> 09:40 client-key.pem
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root <span style="color:#099">1363</span> May <span style="color:#099">30</span> 09:40 client.pem
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>ç­¾å‘kube-apiserverè¯ä¹¦</strong></p>
<p><code>kub-apiserver</code> å¯¹å¤–æä¾›æœåŠ¡æ—¶ï¼Œéœ€è¦ä¸€ä¸ªè¯ä¹¦ã€‚åŒæ ·åœ¨ <code>192.168.199.15</code> ä¸Šç­¾å‘è¯ä¹¦</p>
<p>åˆ›å»ºç”Ÿæˆè¯ä¹¦ç­¾åè¯·æ±‚ï¼ˆcsrï¼‰çš„ <code>JSON</code> é…ç½®æ–‡ä»¶</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /opt/certs/apiserver-csr.json</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;CN&#34;</span>: <span style="color:#d14">&#34;k8s-apiserver&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;hosts&#34;</span>: <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;127.0.0.1&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;192.168.0.1&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;kubernetes.default&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;kubernetes.default.svc&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;kubernetes.default.svc.cluster&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;kubernetes.default.svc.cluster.local&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;192.168.199.10&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;192.168.199.13&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;192.168.199.14&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;192.168.199.16&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">]</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;key&#34;</span>: <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;algo&#34;</span>: <span style="color:#d14">&#34;rsa&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;size&#34;</span>: <span style="color:#099">2048</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;names&#34;</span>: <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;C&#34;</span>: <span style="color:#d14">&#34;CN&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;ST&#34;</span>: <span style="color:#d14">&#34;beijing&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;L&#34;</span>: <span style="color:#d14">&#34;beijing&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;O&#34;</span>: <span style="color:#d14">&#34;od&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;OU&#34;</span>: <span style="color:#d14">&#34;ops&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>åœ¨hostsä¸­æŠŠå¯èƒ½ä¼šå®‰è£… apiserver çš„ IP å…¨éƒ½åˆ—å‡ºæ¥ï¼ŒåŒæ ·ä¸æ”¯æŒç½‘æ®µ</p>
<p>kube-ipvs0 ç½‘å¡çš„ipä¼šå˜ä¸º192.168.0.1 ï¼Œå› æ­¤è¦åŠ ä¸Šæ­¤ip</p>
</blockquote>
<p>ç­¾å‘è¯ä¹¦</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server apiserver-csr.json |cfssl-json -bare apiserver</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="23-å®‰è£…apiserver">2.3 å®‰è£…apiserver</h4>
<p>ä¸»è¦åœ¨ <code>192.168.199.13</code> å’Œ <code>192.168.199.14</code> ä¸Šè¿›è¡Œæ“ä½œ
<strong>åœ¨ <code>192.168.199.13</code> ä¸Šå®‰è£…apiserver</strong>
æ‹·è´è¯ä¹¦åˆ° <code>192.168.199.13</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 bin<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># pwd</span>
</span></span><span style="display:flex;"><span>/opt/kubernetes/server/bin
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 bin<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mkdir cert</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 bin<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd cert/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp root@192.168.199.15:/opt/certs/apiserver.pem ./</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp root@192.168.199.15:/opt/certs/apiserver-key.pem ./</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp root@192.168.199.15:/opt/certs/ca.pem ./</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp root@192.168.199.15:/opt/certs/ca-key.pem ./</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp root@192.168.199.15:/opt/certs/client.pem ./</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp root@192.168.199.15:/opt/certs/client-key.pem ./</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># éªŒè¯æ‰€éœ€6å¥—è¯ä¹¦</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ll</span>
</span></span><span style="display:flex;"><span>total <span style="color:#099">24</span>
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#099">1</span> root root <span style="color:#099">1679</span> May <span style="color:#099">31</span> 16:18 apiserver-key.pem
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root <span style="color:#099">1598</span> May <span style="color:#099">31</span> 16:17 apiserver.pem
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#099">1</span> root root <span style="color:#099">1679</span> May <span style="color:#099">31</span> 16:18 ca-key.pem
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root <span style="color:#099">1346</span> May <span style="color:#099">31</span> 16:18 ca.pem
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#099">1</span> root root <span style="color:#099">1675</span> May <span style="color:#099">31</span> 16:19 client-key.pem
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root <span style="color:#099">1363</span> May <span style="color:#099">31</span> 16:19 client.pem
</span></span></code></pre></td></tr></table>
</div>
</div><p>åˆ›å»ºé…ç½®æ–‡ä»¶ç›®å½•</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 bin<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mkdir /opt/kubernetes/server/bin/conf</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 bin<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /opt/kubernetes/server/bin/conf</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åˆ›å»º <code>apiserver</code> æ—¥å¿—å®¡è®¡è§„åˆ™ï¼Œå†ä¸‹é¢çš„å¯åŠ¨è„šæœ¬ä¸­ä¼šç”¨åˆ°</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat audit.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: audit.k8s.io/v1beta1 <span style="color:#998;font-style:italic"># This is required.</span>
</span></span><span style="display:flex;"><span>kind: Policy
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Don&#39;t generate audit events for all requests in RequestReceived stage.</span>
</span></span><span style="display:flex;"><span>omitStages:
</span></span><span style="display:flex;"><span>  - <span style="color:#d14">&#34;RequestReceived&#34;</span>
</span></span><span style="display:flex;"><span>rules:
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Log pod changes at RequestResponse level</span>
</span></span><span style="display:flex;"><span>  - level: RequestResponse
</span></span><span style="display:flex;"><span>    resources:
</span></span><span style="display:flex;"><span>    - group: <span style="color:#d14">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#998;font-style:italic"># Resource &#34;pods&#34; doesn&#39;t match requests to any subresource of pods,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#998;font-style:italic"># which is consistent with the RBAC policy.</span>
</span></span><span style="display:flex;"><span>      resources: <span style="color:#000;font-weight:bold">[</span><span style="color:#d14">&#34;pods&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Log &#34;pods/log&#34;, &#34;pods/status&#34; at Metadata level</span>
</span></span><span style="display:flex;"><span>  - level: Metadata
</span></span><span style="display:flex;"><span>    resources:
</span></span><span style="display:flex;"><span>    - group: <span style="color:#d14">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>      resources: <span style="color:#000;font-weight:bold">[</span><span style="color:#d14">&#34;pods/log&#34;</span>, <span style="color:#d14">&#34;pods/status&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Don&#39;t log requests to a configmap called &#34;controller-leader&#34;</span>
</span></span><span style="display:flex;"><span>  - level: None
</span></span><span style="display:flex;"><span>    resources:
</span></span><span style="display:flex;"><span>    - group: <span style="color:#d14">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>      resources: <span style="color:#000;font-weight:bold">[</span><span style="color:#d14">&#34;configmaps&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>      resourceNames: <span style="color:#000;font-weight:bold">[</span><span style="color:#d14">&#34;controller-leader&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Don&#39;t log watch requests by the &#34;system:kube-proxy&#34; on endpoints or services</span>
</span></span><span style="display:flex;"><span>  - level: None
</span></span><span style="display:flex;"><span>    users: <span style="color:#000;font-weight:bold">[</span><span style="color:#d14">&#34;system:kube-proxy&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>    verbs: <span style="color:#000;font-weight:bold">[</span><span style="color:#d14">&#34;watch&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>    resources:
</span></span><span style="display:flex;"><span>    - group: <span style="color:#d14">&#34;&#34;</span> <span style="color:#998;font-style:italic"># core API group</span>
</span></span><span style="display:flex;"><span>      resources: <span style="color:#000;font-weight:bold">[</span><span style="color:#d14">&#34;endpoints&#34;</span>, <span style="color:#d14">&#34;services&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Don&#39;t log authenticated requests to certain non-resource URL paths.</span>
</span></span><span style="display:flex;"><span>  - level: None
</span></span><span style="display:flex;"><span>    userGroups: <span style="color:#000;font-weight:bold">[</span><span style="color:#d14">&#34;system:authenticated&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>    nonResourceURLs:
</span></span><span style="display:flex;"><span>    - <span style="color:#d14">&#34;/api*&#34;</span> <span style="color:#998;font-style:italic"># Wildcard matching.</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#d14">&#34;/version&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Log the request body of configmap changes in kube-system.</span>
</span></span><span style="display:flex;"><span>  - level: Request
</span></span><span style="display:flex;"><span>    resources:
</span></span><span style="display:flex;"><span>    - group: <span style="color:#d14">&#34;&#34;</span> <span style="color:#998;font-style:italic"># core API group</span>
</span></span><span style="display:flex;"><span>      resources: <span style="color:#000;font-weight:bold">[</span><span style="color:#d14">&#34;configmaps&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># This rule only applies to resources in the &#34;kube-system&#34; namespace.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># The empty string &#34;&#34; can be used to select non-namespaced resources.</span>
</span></span><span style="display:flex;"><span>    namespaces: <span style="color:#000;font-weight:bold">[</span><span style="color:#d14">&#34;kube-system&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Log configmap and secret changes in all other namespaces at the Metadata level.</span>
</span></span><span style="display:flex;"><span>  - level: Metadata
</span></span><span style="display:flex;"><span>    resources:
</span></span><span style="display:flex;"><span>    - group: <span style="color:#d14">&#34;&#34;</span> <span style="color:#998;font-style:italic"># core API group</span>
</span></span><span style="display:flex;"><span>      resources: <span style="color:#000;font-weight:bold">[</span><span style="color:#d14">&#34;secrets&#34;</span>, <span style="color:#d14">&#34;configmaps&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># Log all other resources in core and extensions at the Request level.</span>
</span></span><span style="display:flex;"><span>  - level: Request
</span></span><span style="display:flex;"><span>    resources:
</span></span><span style="display:flex;"><span>    - group: <span style="color:#d14">&#34;&#34;</span> <span style="color:#998;font-style:italic"># core API group</span>
</span></span><span style="display:flex;"><span>    - group: <span style="color:#d14">&#34;extensions&#34;</span> <span style="color:#998;font-style:italic"># Version of group should NOT be included.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># A catch-all rule to log all other requests at the Metadata level.</span>
</span></span><span style="display:flex;"><span>  - level: Metadata
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># Long-running requests like watches that fall under this rule will not</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># generate an audit event in RequestReceived.</span>
</span></span><span style="display:flex;"><span>    omitStages:
</span></span><span style="display:flex;"><span>      - <span style="color:#d14">&#34;RequestReceived&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>æ²¡æœ‰éœ€è¦æ”¹åŠ¨çš„åœ°æ–¹</p>
</blockquote>
<p>åˆ›å»º <code>apiserver</code> å¯åŠ¨è„šæœ¬</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 bin<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /opt/kubernetes/server/bin/kube-apiserver.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#!/bin/bash</span>
</span></span><span style="display:flex;"><span>./kube-apiserver <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --apiserver-count <span style="color:#099">2</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --audit-log-path /data/logs/kubernetes/kube-apiserver/audit-log <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --audit-policy-file ./conf/audit.yaml <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --authorization-mode RBAC <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  <span style="color:#998;font-style:italic"># ç”¨äºéªŒè¯è®¿é—® kube-apiserver çš„å®¢æˆ·ç«¯çš„è¯ä¹¦çš„ CA æ ¹è¯ä¹¦</span>
</span></span><span style="display:flex;"><span>  --client-ca-file ./cert/ca.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --requestheader-client-ca-file ./cert/ca.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --enable-admission-plugins NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  <span style="color:#998;font-style:italic"># ç”¨äºéªŒè¯ etcd æœåŠ¡å™¨è¯ä¹¦çš„ CA æ ¹è¯ä¹¦</span>
</span></span><span style="display:flex;"><span>  --etcd-cafile ./cert/ca.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  <span style="color:#998;font-style:italic"># ç”¨äºè®¿é—® etcd çš„å®¢æˆ·ç«¯è¯ä¹¦</span>
</span></span><span style="display:flex;"><span>  --etcd-certfile ./cert/client.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  <span style="color:#998;font-style:italic"># ç”¨äºè®¿é—® etcd çš„å®¢æˆ·ç«¯è¯ä¹¦çš„ç§é’¥</span>
</span></span><span style="display:flex;"><span>  --etcd-keyfile ./cert/client-key.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --etcd-servers https://192.168.199.12:2379,https://192.168.199.13:2379,https://192.168.199.14:2379 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  <span style="color:#998;font-style:italic"># ç”¨äºéªŒè¯ service account token çš„å…¬é’¥</span>
</span></span><span style="display:flex;"><span>  --service-account-key-file ./cert/ca-key.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --service-cluster-ip-range 192.168.0.0/16 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --service-node-port-range 3000-29999 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --target-ram-mb<span style="color:#000;font-weight:bold">=</span><span style="color:#099">1024</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  <span style="color:#998;font-style:italic"># ç”¨äºè®¿é—® kubelet çš„å®¢æˆ·ç«¯è¯ä¹¦</span>
</span></span><span style="display:flex;"><span>  --kubelet-client-certificate ./cert/client.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  <span style="color:#998;font-style:italic"># ç”¨äºè®¿é—® kubelet çš„å®¢æˆ·ç«¯è¯ä¹¦çš„ç§é’¥</span>
</span></span><span style="display:flex;"><span>  --kubelet-client-key ./cert/client-key.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --log-dir  /data/logs/kubernetes/kube-apiserver <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  <span style="color:#998;font-style:italic"># ç”¨äºå¯¹å¤–æä¾›æœåŠ¡çš„æœåŠ¡å™¨è¯ä¹¦</span>
</span></span><span style="display:flex;"><span>  --tls-cert-file ./cert/apiserver.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  <span style="color:#998;font-style:italic"># æœåŠ¡å™¨è¯ä¹¦å¯¹åº”çš„ç§é’¥</span>
</span></span><span style="display:flex;"><span>  --tls-private-key-file ./cert/apiserver-key.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --v <span style="color:#099">2</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>éœ€è¦æ³¨æ„è„šæœ¬ä¸­æ¶‰åŠåˆ°çš„æ–‡ä»¶è·¯å¾„åŠ IP åœ°å€</p>
</blockquote>
<p>å¯¹è„šæœ¬è¿›è¡Œæˆæƒ</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 bin<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># chmod +x kube-apiserver.sh</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åˆ›å»º <code>supervisord</code> é…ç½®æ–‡ä»¶</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 bin<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/supervisord.d/kube-apiserver.ini</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>program:kube-apiserver-199-13<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">command</span><span style="color:#000;font-weight:bold">=</span>/opt/kubernetes/server/bin/kube-apiserver.sh            ; the program <span style="color:#000;font-weight:bold">(</span>relative uses PATH, can take args<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">numprocs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">1</span>                                                      ; number of processes copies to start <span style="color:#000;font-weight:bold">(</span>def 1<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">directory</span><span style="color:#000;font-weight:bold">=</span>/opt/kubernetes/server/bin                            ; directory to cwd to before <span style="color:#0086b3">exec</span> <span style="color:#000;font-weight:bold">(</span>def no cwd<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">autostart</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                                  ; start at supervisord start <span style="color:#000;font-weight:bold">(</span>default: <span style="color:#0086b3">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">autorestart</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                                ; retstart at unexpected quit <span style="color:#000;font-weight:bold">(</span>default: <span style="color:#0086b3">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">startsecs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">30</span>                                                    ; number of secs prog must stay running <span style="color:#000;font-weight:bold">(</span>def. 1<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">startretries</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">3</span>                                                  ; max <span style="color:#998;font-style:italic"># of serial start failures (default 3)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">exitcodes</span><span style="color:#000;font-weight:bold">=</span>0,2                                                   ; <span style="color:#d14">&#39;expected&#39;</span> <span style="color:#0086b3">exit</span> codes <span style="color:#000;font-weight:bold">for</span> process <span style="color:#000;font-weight:bold">(</span>default 0,2<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stopsignal</span><span style="color:#000;font-weight:bold">=</span>QUIT                                                 ; signal used to <span style="color:#0086b3">kill</span> process <span style="color:#000;font-weight:bold">(</span>default TERM<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stopwaitsecs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">10</span>                                                 ; max num secs to <span style="color:#0086b3">wait</span> b4 SIGKILL <span style="color:#000;font-weight:bold">(</span>default 10<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">user</span><span style="color:#000;font-weight:bold">=</span>root                                                       ; setuid to this UNIX account to run the program
</span></span><span style="display:flex;"><span><span style="color:#008080">redirect_stderr</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                            ; redirect proc stderr to stdout <span style="color:#000;font-weight:bold">(</span>default <span style="color:#0086b3">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile</span><span style="color:#000;font-weight:bold">=</span>/data/logs/kubernetes/kube-apiserver/apiserver.stdout.log        ; stderr log path, NONE <span style="color:#000;font-weight:bold">for</span> none; default AUTO
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile_maxbytes</span><span style="color:#000;font-weight:bold">=</span>64MB                                    ; max <span style="color:#998;font-style:italic"># logfile bytes b4 rotation (default 50MB)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile_backups</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">4</span>                                        ; <span style="color:#998;font-style:italic"># of stdout logfile backups (default 10)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_capture_maxbytes</span><span style="color:#000;font-weight:bold">=</span>1MB                                     ; number of bytes in <span style="color:#d14">&#39;capturemode&#39;</span> <span style="color:#000;font-weight:bold">(</span>default 0<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_events_enabled</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">false</span>                                     ; emit events on stdout writes <span style="color:#000;font-weight:bold">(</span>default <span style="color:#0086b3">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>æ³¨æ„ä¸åŒçš„ä¸»æœºåœ¨ [ ] ä¸­çš„åç§°ä¸ä¸€æ ·</p>
</blockquote>
<p>åˆ›å»ºä¸Šè¿°æ–‡ä»¶ä¸­æ‰€æ¶‰åŠåˆ°çš„ç›®å½•</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 bin<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mkdir -p /data/logs/kubernetes/kube-apiserver</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è®© <code>supervisord</code> ç®¡ç†æœåŠ¡</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 bin<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># supervisorctl update</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># supervisorctl status</span>
</span></span><span style="display:flex;"><span>etcd-server-199-13               RUNNING   pid 846, uptime <span style="color:#099">1</span> day, 7:35:30
</span></span><span style="display:flex;"><span>kube-apiserver-199-13            RUNNING   pid 3514, uptime 0:10:13
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># netstat -lnpt | grep kube-api</span>
</span></span><span style="display:flex;"><span>tcp        <span style="color:#099">0</span>      <span style="color:#099">0</span> 127.0.0.1:8080          0.0.0.0:*               LISTEN      3515/./kube-apiserv
</span></span><span style="display:flex;"><span>tcp6       <span style="color:#099">0</span>      <span style="color:#099">0</span> :::6443                 :::*                    LISTEN      3515/./kube-apiserv
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>192.168.199.14 çš„æ“ä½œä¸ä¸Šè¿°ç›¸åŒ</strong></p>
<h3 id="3-å››å±‚è´Ÿè½½å‡è¡¡">3. å››å±‚è´Ÿè½½å‡è¡¡</h3>
<p>åŒæ—¶åœ¨ <code>192.168.199.11</code> å’Œ <code>192.168.199.12</code> ä¸Šéƒ¨ç½² <code>nginx</code> å®ç°å¯¹åç«¯çš„ <code>apiserver</code> è´Ÿè½½å‡è¡¡ï¼Œåœ¨ <code>192.168.199.11</code> å’Œ <code>192.168.199.12</code> ä¸Šéœ€è¦é€šè¿‡ <code>keepalive</code> å®ç°é«˜å¯ç”¨ã€‚</p>
<h4 id="31-å®‰è£…å¹¶é…ç½®nginx">3.1 å®‰è£…å¹¶é…ç½®Nginx</h4>
<p>å®‰è£…å¹¶é…ç½® <code>nginx</code> ï¼Œä¸¤ä¸ªä¸»æœºæ“ä½œç›¸åŒï¼Œå‡æ‰§è¡Œä»¥ä¸‹æ­¥éª¤</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># yum install nginx -y</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># åœ¨ /etc/nginx/nginx.conf æ–‡ä»¶çš„æœ€åæ·»åŠ åå‘ä»£ç†è®¾ç½®</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># tail -n 12 /etc/nginx/nginx.conf</span>
</span></span><span style="display:flex;"><span>stream <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    upstream kube-apiserver <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        server 192.168.199.13:6443     <span style="color:#008080">max_fails</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">3</span> <span style="color:#008080">fail_timeout</span><span style="color:#000;font-weight:bold">=</span>30s;
</span></span><span style="display:flex;"><span>        server 192.168.199.14:6443     <span style="color:#008080">max_fails</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">3</span> <span style="color:#008080">fail_timeout</span><span style="color:#000;font-weight:bold">=</span>30s;
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    server <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        listen 7443;
</span></span><span style="display:flex;"><span>        proxy_connect_timeout 2s;
</span></span><span style="display:flex;"><span>        proxy_timeout 900s;
</span></span><span style="display:flex;"><span>        proxy_pass kube-apiserver;
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ£€æŸ¥å¹¶å¯åŠ¨ <code>nginx</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># nginx -t</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># systemctl start nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># systemctl enable nginx</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="32-å®‰è£…keepalived">3.2 å®‰è£…keepalived</h4>
<p>ä¸»è¦åœ¨ <code>192.168.199.11</code> å’Œ <code>192.168.199.12</code> ä¸Šè¿›è¡Œæ“ä½œï¼Œä¸¤è¾¹é…ç½®ç›¸ä¼¼ã€‚ <code>192.168.199.11</code> ä¸ºä¸»èŠ‚ç‚¹ï¼Œ <code>192.168.199.12</code> ä¸ºä»èŠ‚ç‚¹ã€‚</p>
<p>å®‰è£…å¹¶é…ç½® <code>keepalived</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># yum install keepalived -y</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨ä¸¤ä¸ªæœåŠ¡å™¨ä¸Šéƒ½éœ€è¦æ·»åŠ ç›‘æ§ç«¯å£çš„è„šæœ¬</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/keepalived/check_port.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#!/bin/bash</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#keepalived ç›‘æ§ç«¯å£è„šæœ¬</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#ä½¿ç”¨æ–¹æ³•ï¼š</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#åœ¨keepalivedçš„é…ç½®æ–‡ä»¶ä¸­</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#vrrp_script check_port {#åˆ›å»ºä¸€ä¸ªvrrp_scriptè„šæœ¬,æ£€æŸ¥é…ç½®</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#    script &#34;/etc/keepalived/check_port.sh 6379&#34; #é…ç½®ç›‘å¬çš„ç«¯å£</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#    interval 2 #æ£€æŸ¥è„šæœ¬çš„é¢‘ç‡,å•ä½ï¼ˆç§’ï¼‰</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#}</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">CHK_PORT</span><span style="color:#000;font-weight:bold">=</span><span style="color:#008080">$1</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">[</span> -n <span style="color:#d14">&#34;</span><span style="color:#008080">$CHK_PORT</span><span style="color:#d14">&#34;</span> <span style="color:#000;font-weight:bold">]</span>;<span style="color:#000;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>        <span style="color:#008080">PORT_PROCESS</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">`</span>ss -lnt|grep <span style="color:#008080">$CHK_PORT</span>|wc -l<span style="color:#d14">`</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">[</span> <span style="color:#008080">$PORT_PROCESS</span> -eq <span style="color:#099">0</span> <span style="color:#000;font-weight:bold">]</span>;<span style="color:#000;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0086b3">echo</span> <span style="color:#d14">&#34;Port </span><span style="color:#008080">$CHK_PORT</span><span style="color:#d14"> Is Not Used,End.&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0086b3">exit</span> <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0086b3">echo</span> <span style="color:#d14">&#34;Check Port Cant Be Empty!&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">fi</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯¹ä¸Šè¿°è„šæœ¬è¿›è¡Œæˆæƒ</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># chmod +x /etc/keepalived/check_port.sh</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é…ç½® <code>keepalived</code>
<strong>ä¸»èŠ‚ç‚¹</strong>æ¸…ç©ºåŸæ¥çš„é…ç½®ï¼Œæ·»åŠ å¦‚ä¸‹é…ç½®ï¼Œ<code>192.168.199.10</code> ä¸º <code>VIP</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/keepalived/keepalived.conf</span>
</span></span><span style="display:flex;"><span>! Configuration File <span style="color:#000;font-weight:bold">for</span> keepalived
</span></span><span style="display:flex;"><span>global_defs <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   router_id 192.168.199.11
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vrrp_script chk_nginx <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    script <span style="color:#d14">&#34;/etc/keepalived/check_port.sh 7443&#34;</span>
</span></span><span style="display:flex;"><span>    interval <span style="color:#099">2</span>
</span></span><span style="display:flex;"><span>    weight -20
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vrrp_instance VI_1 <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    state MASTER
</span></span><span style="display:flex;"><span>    interface eth0
</span></span><span style="display:flex;"><span>    virtual_router_id <span style="color:#099">251</span>
</span></span><span style="display:flex;"><span>    priority <span style="color:#099">100</span>
</span></span><span style="display:flex;"><span>    advert_int <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>    mcast_src_ip 192.168.199.11
</span></span><span style="display:flex;"><span>    nopreempt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    authentication <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        auth_type PASS
</span></span><span style="display:flex;"><span>        auth_pass <span style="color:#099">11111111</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    track_script <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>         chk_nginx
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    virtual_ipaddress <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        192.168.199.10
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>ä»èŠ‚ç‚¹</strong>æ¸…ç©ºåŸæ¥çš„é…ç½®ï¼Œæ·»åŠ å¦‚ä¸‹é…ç½®ï¼Œ<code>192.168.199.10</code> ä¸º <code>VIP</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-12 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/keepalived/keepalived.conf</span>
</span></span><span style="display:flex;"><span>! Configuration File <span style="color:#000;font-weight:bold">for</span> keepalived
</span></span><span style="display:flex;"><span>global_defs <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        router_id 192.168.199.12
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>vrrp_script chk_nginx <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        script <span style="color:#d14">&#34;/etc/keepalived/check_port.sh 7443&#34;</span>
</span></span><span style="display:flex;"><span>        interval <span style="color:#099">2</span>
</span></span><span style="display:flex;"><span>        weight -20
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>vrrp_instance VI_1 <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        state BACKUP
</span></span><span style="display:flex;"><span>        interface eth0
</span></span><span style="display:flex;"><span>        virtual_router_id <span style="color:#099">251</span>
</span></span><span style="display:flex;"><span>        mcast_src_ip 192.168.199.12
</span></span><span style="display:flex;"><span>        priority <span style="color:#099">90</span>
</span></span><span style="display:flex;"><span>        advert_int <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>        authentication <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                auth_type PASS
</span></span><span style="display:flex;"><span>                auth_pass <span style="color:#099">11111111</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        track_script <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                chk_nginx
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        virtual_ipaddress <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                192.168.199.10
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯åŠ¨ <code>keepalived</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># systemctl start keepalived.service</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># systemctl enable keepalived.service</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>éªŒè¯
<code>VIP</code> åœ¨ <code>192.168.199.11</code> çš„èŠ‚ç‚¹ä¸Šï¼Œå½“æ­¤èŠ‚ç‚¹çš„ <code>Nginx</code> åœæ­¢ï¼Œ<code>7443</code> ç«¯å£ä¸å­˜æ´»ï¼Œ<code>VIP</code> ä¼šæ¼‚ç§»åˆ° <code>192.168.199.12</code> èŠ‚ç‚¹ä¸Š</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ip ad | grep 192.168.199.10</span>
</span></span><span style="display:flex;"><span>    inet 192.168.199.10/32 scope global eth0
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="4-å®‰è£…kube-controller-manager">4. å®‰è£…kube-controller-manager</h3>
<p>éœ€è¦åœ¨ <code>192.168.199.13</code> å’Œ <code>192.168.199.14</code> ä¸Šè¿›è¡Œæ“ä½œï¼Œä¸¤è¾¹æ“ä½œç›¸åŒã€‚
åˆ›å»ºå¯åŠ¨è„šæœ¬</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /opt/kubernetes/server/bin/kube-controller-manager.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#!/bin/sh</span>
</span></span><span style="display:flex;"><span>./kube-controller-manager <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --cluster-cidr 172.7.0.0/16 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --leader-elect <span style="color:#0086b3">true</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --log-dir /data/logs/kubernetes/kube-controller-manager <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --master http://127.0.0.1:8080 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --service-account-private-key-file ./cert/ca-key.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --service-cluster-ip-range 192.168.0.0/16 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --root-ca-file ./cert/ca.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --v <span style="color:#099">2</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>æ‰¾masterèŠ‚ç‚¹æ—¶ï¼Œä½¿ç”¨çš„æ˜¯ <code>127.0.0.1</code> å¹¶ä¸”æ˜¯ http åè®®ï¼Œå› æ­¤ä¸éœ€è¦ä½¿ç”¨è¯ä¹¦ã€‚è‹¥ç»„ä»¶å†ä¸åŒçš„æœºå™¨ä¸Šï¼Œåˆ™éœ€è¦è¯ä¹¦ã€‚</p>
</blockquote>
<p>å¯¹å¯åŠ¨è„šæœ¬è¿›è¡Œæˆæƒå¹¶åˆ›å»ºç›¸åº”çš„ç›®å½•</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># chmod +x /opt/kubernetes/server/bin/kube-controller-manager.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mkdir -p /data/logs/kubernetes/kube-controller-manager</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é…ç½® <code>supervisord</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/supervisord.d/kube-conntroller-manager.ini</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>program:kube-controller-manager-199-13<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">command</span><span style="color:#000;font-weight:bold">=</span>/opt/kubernetes/server/bin/kube-controller-manager.sh                     ; the program <span style="color:#000;font-weight:bold">(</span>relative uses PATH, can take args<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">numprocs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">1</span>                                                                        ; number of processes copies to start <span style="color:#000;font-weight:bold">(</span>def 1<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">directory</span><span style="color:#000;font-weight:bold">=</span>/opt/kubernetes/server/bin                                              ; directory to cwd to before <span style="color:#0086b3">exec</span> <span style="color:#000;font-weight:bold">(</span>def no cwd<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">autostart</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                                                    ; start at supervisord start <span style="color:#000;font-weight:bold">(</span>default: <span style="color:#0086b3">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">autorestart</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                                                  ; retstart at unexpected quit <span style="color:#000;font-weight:bold">(</span>default: <span style="color:#0086b3">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">startsecs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">30</span>                                                                      ; number of secs prog must stay running <span style="color:#000;font-weight:bold">(</span>def. 1<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">startretries</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">3</span>                                                                    ; max <span style="color:#998;font-style:italic"># of serial start failures (default 3)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">exitcodes</span><span style="color:#000;font-weight:bold">=</span>0,2                                                                     ; <span style="color:#d14">&#39;expected&#39;</span> <span style="color:#0086b3">exit</span> codes <span style="color:#000;font-weight:bold">for</span> process <span style="color:#000;font-weight:bold">(</span>default 0,2<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stopsignal</span><span style="color:#000;font-weight:bold">=</span>QUIT                                                                   ; signal used to <span style="color:#0086b3">kill</span> process <span style="color:#000;font-weight:bold">(</span>default TERM<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stopwaitsecs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">10</span>                                                                   ; max num secs to <span style="color:#0086b3">wait</span> b4 SIGKILL <span style="color:#000;font-weight:bold">(</span>default 10<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">user</span><span style="color:#000;font-weight:bold">=</span>root                                                                         ; setuid to this UNIX account to run the program
</span></span><span style="display:flex;"><span><span style="color:#008080">redirect_stderr</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                                              ; redirect proc stderr to stdout <span style="color:#000;font-weight:bold">(</span>default <span style="color:#0086b3">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile</span><span style="color:#000;font-weight:bold">=</span>/data/logs/kubernetes/kube-controller-manager/controller.stdout.log  ; stderr log path, NONE <span style="color:#000;font-weight:bold">for</span> none; default AUTO
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile_maxbytes</span><span style="color:#000;font-weight:bold">=</span>64MB                                                      ; max <span style="color:#998;font-style:italic"># logfile bytes b4 rotation (default 50MB)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile_backups</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">4</span>                                                          ; <span style="color:#998;font-style:italic"># of stdout logfile backups (default 10)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_capture_maxbytes</span><span style="color:#000;font-weight:bold">=</span>1MB                                                       ; number of bytes in <span style="color:#d14">&#39;capturemode&#39;</span> <span style="color:#000;font-weight:bold">(</span>default 0<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_events_enabled</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">false</span>                                                       ; emit events on stdout writes <span style="color:#000;font-weight:bold">(</span>default <span style="color:#0086b3">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>æ³¨æ„ä¸é€šçš„ä¸»æœº  [ ] ä¸­çš„åç§°ä¸ä¸€æ ·</p>
</blockquote>
<p>æŸ¥çœ‹ <code>supervisorctl</code> çš„çŠ¶æ€</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># supervisorctl update</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># supervisorctl status</span>
</span></span><span style="display:flex;"><span>etcd-server-199-13               RUNNING   pid 846, uptime <span style="color:#099">1</span> day, 13:51:56
</span></span><span style="display:flex;"><span>kube-apiserver-199-13            RUNNING   pid 3514, uptime 6:26:39
</span></span><span style="display:flex;"><span>kube-controller-manager-199-13   RUNNING   pid 4258, uptime 0:03:45
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="5-å®‰è£…kube-scheduler">5. å®‰è£…kube-scheduler</h3>
<h4 id="51-éƒ¨ç½²kube-scheduler">5.1 éƒ¨ç½²kube-scheduler</h4>
<p>éœ€è¦åœ¨ <code>192.168.199.13</code> å’Œ <code>192.168.199.14</code> ä¸Šè¿›è¡Œæ“ä½œï¼Œä¸¤è¾¹æ“ä½œç›¸åŒã€‚
ç¼–è¾‘ <code>kube-scheduler</code> çš„å¯åŠ¨æ–‡ä»¶</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /opt/kubernetes/server/bin/kube-scheduler.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#!/bin/sh</span>
</span></span><span style="display:flex;"><span>./kube-scheduler <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --leader-elect  <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --log-dir /data/logs/kubernetes/kube-scheduler <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --master http://127.0.0.1:8080 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --v <span style="color:#099">2</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>æ‰¾masterèŠ‚ç‚¹æ—¶ï¼Œä½¿ç”¨çš„æ˜¯ <code>127.0.0.1</code> å¹¶ä¸”æ˜¯ http åè®®ï¼Œå› æ­¤ä¸éœ€è¦ä½¿ç”¨è¯ä¹¦ã€‚è‹¥ç»„ä»¶å†ä¸åŒçš„æœºå™¨ä¸Šï¼Œåˆ™éœ€è¦è¯ä¹¦ã€‚</p>
</blockquote>
<p>å¯¹è„šæœ¬æˆæƒå¹¶åˆ›å»ºç›¸åº”çš„ç›®å½•</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># chmod +x /opt/kubernetes/server/bin/kube-scheduler.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mkdir -p /data/logs/kubernetes/kube-scheduler</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é…ç½® <code>supervisord</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/supervisord.d/kube-scheduler.ini</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>program:kube-scheduler-199-13<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">command</span><span style="color:#000;font-weight:bold">=</span>/opt/kubernetes/server/bin/kube-scheduler.sh                     ; the program <span style="color:#000;font-weight:bold">(</span>relative uses PATH, can take args<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">numprocs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">1</span>                                                               ; number of processes copies to start <span style="color:#000;font-weight:bold">(</span>def 1<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">directory</span><span style="color:#000;font-weight:bold">=</span>/opt/kubernetes/server/bin                                     ; directory to cwd to before <span style="color:#0086b3">exec</span> <span style="color:#000;font-weight:bold">(</span>def no cwd<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">autostart</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                                           ; start at supervisord start <span style="color:#000;font-weight:bold">(</span>default: <span style="color:#0086b3">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">autorestart</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                                         ; retstart at unexpected quit <span style="color:#000;font-weight:bold">(</span>default: <span style="color:#0086b3">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">startsecs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">30</span>                                                             ; number of secs prog must stay running <span style="color:#000;font-weight:bold">(</span>def. 1<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">startretries</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">3</span>                                                           ; max <span style="color:#998;font-style:italic"># of serial start failures (default 3)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">exitcodes</span><span style="color:#000;font-weight:bold">=</span>0,2                                                            ; <span style="color:#d14">&#39;expected&#39;</span> <span style="color:#0086b3">exit</span> codes <span style="color:#000;font-weight:bold">for</span> process <span style="color:#000;font-weight:bold">(</span>default 0,2<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stopsignal</span><span style="color:#000;font-weight:bold">=</span>QUIT                                                          ; signal used to <span style="color:#0086b3">kill</span> process <span style="color:#000;font-weight:bold">(</span>default TERM<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stopwaitsecs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">10</span>                                                          ; max num secs to <span style="color:#0086b3">wait</span> b4 SIGKILL <span style="color:#000;font-weight:bold">(</span>default 10<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">user</span><span style="color:#000;font-weight:bold">=</span>root                                                                ; setuid to this UNIX account to run the program
</span></span><span style="display:flex;"><span><span style="color:#008080">redirect_stderr</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                                     ; redirect proc stderr to stdout <span style="color:#000;font-weight:bold">(</span>default <span style="color:#0086b3">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile</span><span style="color:#000;font-weight:bold">=</span>/data/logs/kubernetes/kube-scheduler/scheduler.stdout.log ; stderr log path, NONE <span style="color:#000;font-weight:bold">for</span> none; default AUTO
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile_maxbytes</span><span style="color:#000;font-weight:bold">=</span>64MB                                             ; max <span style="color:#998;font-style:italic"># logfile bytes b4 rotation (default 50MB)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile_backups</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">4</span>                                                 ; <span style="color:#998;font-style:italic"># of stdout logfile backups (default 10)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_capture_maxbytes</span><span style="color:#000;font-weight:bold">=</span>1MB                                              ; number of bytes in <span style="color:#d14">&#39;capturemode&#39;</span> <span style="color:#000;font-weight:bold">(</span>default 0<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_events_enabled</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">false</span>                                              ; emit events on stdout writes <span style="color:#000;font-weight:bold">(</span>default <span style="color:#0086b3">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>æ³¨æ„ä¸é€šçš„ä¸»æœº  [ ] ä¸­çš„åç§°ä¸ä¸€æ ·</p>
</blockquote>
<p>æŸ¥çœ‹ <code>supervisorctl</code> çš„çŠ¶æ€</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># supervisorctl update</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># supervisorctl status</span>
</span></span><span style="display:flex;"><span>etcd-server-199-13               RUNNING   pid 4497, uptime 0:01:13
</span></span><span style="display:flex;"><span>kube-apiserver-199-13            RUNNING   pid 4500, uptime 0:01:13
</span></span><span style="display:flex;"><span>kube-controller-manager-199-13   RUNNING   pid 4499, uptime 0:01:13
</span></span><span style="display:flex;"><span>kube-scheduler-199-13            RUNNING   pid 4498, uptime 0:01:13
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="52-é›†ç¾¤çŠ¶æ€æ£€æŸ¥">5.2 é›†ç¾¤çŠ¶æ€æ£€æŸ¥</h4>
<p>åˆ›å»ºè½¯è¿æ¥ï¼Œä½¿ç”¨æˆ·å¯ä»¥ç›´æ¥ä½¿ç”¨ <code>kubectl</code> å‘½ä»¤</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ln -s /opt/kubernetes/server/bin/kubectl /usr/bin/kubectl</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># which kubectl</span>
</span></span><span style="display:flex;"><span>/usr/bin/kubectl
</span></span></code></pre></td></tr></table>
</div>
</div><p>æŸ¥çœ‹é›†ç¾¤çŠ¶æ€</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get cs</span>
</span></span><span style="display:flex;"><span>NAME                 STATUS    MESSAGE              ERROR
</span></span><span style="display:flex;"><span>scheduler            Healthy   ok
</span></span><span style="display:flex;"><span>controller-manager   Healthy   ok
</span></span><span style="display:flex;"><span>etcd-1               Healthy   <span style="color:#000;font-weight:bold">{</span><span style="color:#d14">&#34;health&#34;</span>: <span style="color:#d14">&#34;true&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>etcd-2               Healthy   <span style="color:#000;font-weight:bold">{</span><span style="color:#d14">&#34;health&#34;</span>: <span style="color:#d14">&#34;true&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>etcd-0               Healthy   <span style="color:#000;font-weight:bold">{</span><span style="color:#d14">&#34;health&#34;</span>: <span style="color:#d14">&#34;true&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="6-éƒ¨ç½²kubelet">6. éƒ¨ç½²Kubelet</h3>
<h4 id="61-ç­¾å‘è¯ä¹¦">6.1 ç­¾å‘è¯ä¹¦</h4>
<p>ä¸»è¦åœ¨ <code>192.168.199.15</code> ä¸Šè¿›è¡Œæ“ä½œ
åˆ›å»ºç”Ÿæˆè¯ä¹¦ç­¾åè¯·æ±‚ï¼ˆcsrï¼‰çš„ <code>JSON</code> é…ç½®æ–‡ä»¶</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /opt/certs/kubelet-csr.json</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;CN&#34;</span>: <span style="color:#d14">&#34;k8s-kubelet&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;hosts&#34;</span>: <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;127.0.0.1&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;192.168.199.10&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;192.168.199.13&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;192.168.199.14&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;192.168.199.16&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;192.168.199.17&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;192.168.199.18&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;192.168.199.19&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;192.168.199.20&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;192.168.199.21&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">]</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;key&#34;</span>: <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;algo&#34;</span>: <span style="color:#d14">&#34;rsa&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;size&#34;</span>: <span style="color:#099">2048</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;names&#34;</span>: <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;C&#34;</span>: <span style="color:#d14">&#34;CN&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;ST&#34;</span>: <span style="color:#d14">&#34;beijing&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;L&#34;</span>: <span style="color:#d14">&#34;beijing&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;O&#34;</span>: <span style="color:#d14">&#34;od&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;OU&#34;</span>: <span style="color:#d14">&#34;ops&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>hostsä¸­è¡¨ç¤ºå¯èƒ½ä¼šå®‰è£…kubeletçš„ä¸»æœºï¼Œä¸æ”¯æŒç½‘æ®µ</p>
</blockquote>
<p>ç”Ÿæˆè¯ä¹¦</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server kubelet-csr.json | cfssl-json -bare kubelet</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ll kubelet*</span>
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root <span style="color:#099">1115</span> Jun  <span style="color:#099">2</span> 00:10 kubelet.csr
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root  <span style="color:#099">497</span> Jun  <span style="color:#099">2</span> 00:04 kubelet-csr.json
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#099">1</span> root root <span style="color:#099">1675</span> Jun  <span style="color:#099">2</span> 00:10 kubelet-key.pem
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root <span style="color:#099">1468</span> Jun  <span style="color:#099">2</span> 00:10 kubelet.pem
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="62-éƒ¨ç½²kubelet">6.2 éƒ¨ç½²kubelet</h4>
<p>åœ¨ <code>192.168.199.13</code> ä¸Šæ‹·è´è¯ä¹¦</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /opt/kubernetes/server/bin/cert/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp 192.168.199.15:/opt/certs/kubelet.pem ./</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp 192.168.199.15:/opt/certs/kubelet-key.pem ./</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é€šè¿‡ä»¥ä¸‹å‘½ä»¤ç”Ÿæˆ <code>kubelet.kubeconfig</code> ï¼Œç”±äºä½¿ç”¨çš„æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œè¯·åœ¨ <strong>configç›®å½•</strong> ä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ã€‚</p>
<p><strong>è‹¥è¯ä¹¦è¿‡æœŸï¼Œé‡æ–°ç”Ÿæˆè¯ä¹¦åï¼Œéœ€è¦é‡æ–°ç”Ÿæˆ kubelet.kubeconfig</strong></p>
<p><strong>set-cluster</strong>: æŒ‡å®šä¸€ä¸ªæ™®é€šçš„ç”¨æˆ·ï¼Œä¸ <code>192.168.199.10</code> è¿›è¡Œé€šä¿¡ï¼Œæ­¤æ­¥éª¤ç›¸å½“äºæŠŠ <code>ca.pem</code> çš„è¯ä¹¦åŠ å…¥åˆ° <code>kubelet.kubeconfig</code> æ–‡ä»¶ä¸­ï¼Œé€šè¿‡ <code>echo &quot;xxx&quot; | base64 -d</code> å¯çœ‹åˆ°åŸæ¥çš„å¯†é’¥ã€‚</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl config set-cluster myk8s \</span>
</span></span><span style="display:flex;"><span>   --certificate-authority<span style="color:#000;font-weight:bold">=</span>/opt/kubernetes/server/bin/cert/ca.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>   --embed-certs<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>   --server<span style="color:#000;font-weight:bold">=</span>https://192.168.199.10:7443 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>   --kubeconfig<span style="color:#000;font-weight:bold">=</span>kubelet.kubeconfig
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>æ³¨æ„IPï¼Œè¿™é‡Œå†™çš„æ˜¯ api-server çš„VIPï¼Œä¸å†™è‡ªå·±ä¸»æœºçš„ api-server æ¥å£çš„åŸå› æ˜¯é˜²æ­¢å› è‡ªå·±ä¸»æœºçš„api-serverå®•æœºå½±å“ä¸šåŠ¡ã€‚</p>
</blockquote>
<p><strong>set-credentials</strong></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl config set-credentials k8s-node \</span>
</span></span><span style="display:flex;"><span>   --client-certificate<span style="color:#000;font-weight:bold">=</span>/opt/kubernetes/server/bin/cert/client.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>   --client-key<span style="color:#000;font-weight:bold">=</span>/opt/kubernetes/server/bin/cert/client-key.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>   --embed-certs<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>   --kubeconfig<span style="color:#000;font-weight:bold">=</span>kubelet.kubeconfig
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>set-context</strong></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl config set-context myk8s-context \</span>
</span></span><span style="display:flex;"><span>   --cluster<span style="color:#000;font-weight:bold">=</span>myk8s <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>   --user<span style="color:#000;font-weight:bold">=</span>k8s-node <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>   --kubeconfig<span style="color:#000;font-weight:bold">=</span>kubelet.kubeconfig
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>use-context</strong></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl config use-context myk8s-context --kubeconfig=kubelet.kubeconfig</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>è‹¥æœ‰ <code>kubelet.kubeconfig</code> æ–‡ä»¶ï¼Œå¯å…ˆé€šè¿‡ <code>echo &quot;xxx&quot; | base64 -d &gt; 123.pem</code> è·å–å¯†é’¥æ–‡ä»¶ï¼Œå†é€šè¿‡ <code>cfssl-certinfo -cert 123.pem</code> è§£æå‡ºè¯ä¹¦ç”Ÿæˆæ–‡ä»¶ã€‚</p>
</blockquote>
<h4 id="63-åˆ›å»ºè§’è‰²ç»‘å®š">6.3 åˆ›å»ºè§’è‰²ç»‘å®š</h4>
<p>è®© <code>k8s-node</code> è¿™ä¸ªç”¨æˆ·å…·æœ‰ <code>systemï¼šnode</code> çš„è§’è‰²</p>
<p>ä»¥ä¸‹æ­¥éª¤ä¼šå°†æ•°æ®è½å…¥åˆ° etcd ä¸­ï¼Œå› æ­¤å…¶ä»–èŠ‚ç‚¹ä¸éœ€è¦æ‰§è¡Œä»¥ä¸‹æ­¥éª¤</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /opt/kubernetes/server/bin/conf/k8s-node.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: rbac.authorization.k8s.io/v1
</span></span><span style="display:flex;"><span>kind: ClusterRoleBinding
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: k8s-node
</span></span><span style="display:flex;"><span>roleRef:
</span></span><span style="display:flex;"><span>  apiGroup: rbac.authorization.k8s.io
</span></span><span style="display:flex;"><span>  kind: ClusterRole
</span></span><span style="display:flex;"><span>  name: system:node
</span></span><span style="display:flex;"><span>subjects:
</span></span><span style="display:flex;"><span>- apiGroup: rbac.authorization.k8s.io
</span></span><span style="display:flex;"><span>  kind: User
</span></span><span style="display:flex;"><span>  name: k8s-node
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç”Ÿæ•ˆé…ç½®</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl create -f k8s-node.yaml</span>
</span></span><span style="display:flex;"><span>clusterrolebinding.rbac.authorization.k8s.io/k8s-node created
</span></span></code></pre></td></tr></table>
</div>
</div><p>éªŒè¯</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get clusterrolebinding k8s-node -o yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: rbac.authorization.k8s.io/v1
</span></span><span style="display:flex;"><span>kind: ClusterRoleBinding
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  creationTimestamp: <span style="color:#d14">&#34;2020-06-01T16:36:57Z&#34;</span>
</span></span><span style="display:flex;"><span>  name: k8s-node
</span></span><span style="display:flex;"><span>  resourceVersion: <span style="color:#d14">&#34;28654&#34;</span>
</span></span><span style="display:flex;"><span>  selfLink: /apis/rbac.authorization.k8s.io/v1/clusterrolebindings/k8s-node
</span></span><span style="display:flex;"><span>  uid: 8eb86a21-e85c-4289-bbe3-fe2671b6465c
</span></span><span style="display:flex;"><span>roleRef:
</span></span><span style="display:flex;"><span>  apiGroup: rbac.authorization.k8s.io
</span></span><span style="display:flex;"><span>  kind: ClusterRole
</span></span><span style="display:flex;"><span>  name: system:node
</span></span><span style="display:flex;"><span>subjects:
</span></span><span style="display:flex;"><span>- apiGroup: rbac.authorization.k8s.io
</span></span><span style="display:flex;"><span>  kind: User
</span></span><span style="display:flex;"><span>  name: k8s-node
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="64-å…¶ä»–èŠ‚ç‚¹">6.4 å…¶ä»–èŠ‚ç‚¹</h4>
<p><strong>192.168.199.14</strong>ä¸Š
æ‹·è´è¯ä¹¦</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-14 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /opt/kubernetes/server/bin/cert/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-14 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp 192.168.199.15:/opt/certs/kubelet.pem ./</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-14 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp 192.168.199.15:/opt/certs/kubelet-key.pem ./</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ‹·è´é…ç½®æ–‡ä»¶</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-14 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /opt/kubernetes/server/bin/conf/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-14 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp root@192.168.199.13:/opt/kubernetes/server/bin/conf/kubelet.kubeconfig ./</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="65-å‡†å¤‡paushåŸºç¡€é•œåƒ">6.5 å‡†å¤‡paushåŸºç¡€é•œåƒ</h4>
<p><code>kubelet</code> å¯åŠ¨çš„æ—¶å€™éœ€è¦ä¸€ä¸ªåŸºç¡€é•œåƒ</p>
<p>åœ¨ <code>192.168.199.15</code> ä¸Šï¼Œå‡†å¤‡ <code>paush</code> åŸºç¡€é•œåƒï¼Œå¹¶ä¸Šä¼ è‡³ç§æœ‰ä»“åº“</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker pull kubernetes/pause</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker images | grep pause</span>
</span></span><span style="display:flex;"><span>kubernetes/pause                latest                     f9d5de079539        <span style="color:#099">5</span> years ago         240kB
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker tag f9d5de079539 harbor.od.com/public/pause:latest</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker push harbor.od.com/public/pause:latest</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨ <code>192.168.199.13</code> ä¸Šï¼Œåˆ›å»º <code>kubelet</code> å¯åŠ¨è„šæœ¬</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /opt/kubernetes/server/bin/kubelet.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#!/bin/sh</span>
</span></span><span style="display:flex;"><span>./kubelet <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  <span style="color:#998;font-style:italic"># ç¦æ­¢åŒ¿åç”¨æˆ·ä½¿ç”¨kubectl</span>
</span></span><span style="display:flex;"><span>  --anonymous-auth<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">false</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  <span style="color:#998;font-style:italic"># ä¸dockeré…ç½®æ–‡ä»¶/etc/docker/daemon.jsonä¸­ä¿æŒä¸€è‡´</span>
</span></span><span style="display:flex;"><span>  --cgroup-driver systemd <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  <span style="color:#998;font-style:italic"># corednsä¼šä½¿ç”¨æ­¤IP</span>
</span></span><span style="display:flex;"><span>  --cluster-dns 192.168.0.2 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --cluster-domain cluster.local <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --runtime-cgroups<span style="color:#000;font-weight:bold">=</span>/systemd/system.slice <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --kubelet-cgroups<span style="color:#000;font-weight:bold">=</span>/systemd/system.slice <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  <span style="color:#998;font-style:italic"># ä¸å…³é—­swapä¹Ÿå¯ä»¥å¯åŠ¨kubelet</span>
</span></span><span style="display:flex;"><span>  --fail-swap-on<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;false&#34;</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --client-ca-file ./cert/ca.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --tls-cert-file ./cert/kubelet.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --tls-private-key-file ./cert/kubelet-key.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  <span style="color:#998;font-style:italic"># ä¸»æœºå</span>
</span></span><span style="display:flex;"><span>  --hostname-override 192-168-199-13.host.com <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --image-gc-high-threshold <span style="color:#099">20</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --image-gc-low-threshold <span style="color:#099">10</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --kubeconfig ./conf/kubelet.kubeconfig <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --log-dir /data/logs/kubernetes/kube-kubelet <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  <span style="color:#998;font-style:italic"># pauseçš„ä½ç½®</span>
</span></span><span style="display:flex;"><span>  --pod-infra-container-image harbor.od.com/public/pause:latest <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --root-dir /data/kubelet
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>æ³¨æ„hostname-override ä¸­çš„ä¸»æœºååŠé•œåƒä»“åº“çš„åœ°å€</p>
</blockquote>
<p>å¯¹è„šæœ¬æˆæƒå¹¶åˆ›å»ºç›¸åº”çš„ç›®å½•</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mkdir -p /data/logs/kubernetes/kube-kubelet /data/kubelet</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># chmod a+x /opt/kubernetes/server/bin/kubelet.sh</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é…ç½® <code>supervisord</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/supervisord.d/kube-kubelet.ini</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>program:kube-kubelet-199-13<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">command</span><span style="color:#000;font-weight:bold">=</span>/opt/kubernetes/server/bin/kubelet.sh     ; the program <span style="color:#000;font-weight:bold">(</span>relative uses PATH, can take args<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">numprocs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">1</span>                                        ; number of processes copies to start <span style="color:#000;font-weight:bold">(</span>def 1<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">directory</span><span style="color:#000;font-weight:bold">=</span>/opt/kubernetes/server/bin              ; directory to cwd to before <span style="color:#0086b3">exec</span> <span style="color:#000;font-weight:bold">(</span>def no cwd<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">autostart</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                    ; start at supervisord start <span style="color:#000;font-weight:bold">(</span>default: <span style="color:#0086b3">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">autorestart</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                  ; retstart at unexpected quit <span style="color:#000;font-weight:bold">(</span>default: <span style="color:#0086b3">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">startsecs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">30</span>                                      ; number of secs prog must stay running <span style="color:#000;font-weight:bold">(</span>def. 1<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">startretries</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">3</span>                                    ; max <span style="color:#998;font-style:italic"># of serial start failures (default 3)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">exitcodes</span><span style="color:#000;font-weight:bold">=</span>0,2                                     ; <span style="color:#d14">&#39;expected&#39;</span> <span style="color:#0086b3">exit</span> codes <span style="color:#000;font-weight:bold">for</span> process <span style="color:#000;font-weight:bold">(</span>default 0,2<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stopsignal</span><span style="color:#000;font-weight:bold">=</span>QUIT                                   ; signal used to <span style="color:#0086b3">kill</span> process <span style="color:#000;font-weight:bold">(</span>default TERM<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stopwaitsecs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">10</span>                                   ; max num secs to <span style="color:#0086b3">wait</span> b4 SIGKILL <span style="color:#000;font-weight:bold">(</span>default 10<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">user</span><span style="color:#000;font-weight:bold">=</span>root                                         ; setuid to this UNIX account to run the program
</span></span><span style="display:flex;"><span><span style="color:#008080">redirect_stderr</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                              ; redirect proc stderr to stdout <span style="color:#000;font-weight:bold">(</span>default <span style="color:#0086b3">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile</span><span style="color:#000;font-weight:bold">=</span>/data/logs/kubernetes/kube-kubelet/kubelet.stdout.log   ; stderr log path, NONE <span style="color:#000;font-weight:bold">for</span> none; default AUTO
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile_maxbytes</span><span style="color:#000;font-weight:bold">=</span>64MB                      ; max <span style="color:#998;font-style:italic"># logfile bytes b4 rotation (default 50MB)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile_backups</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">4</span>                          ; <span style="color:#998;font-style:italic"># of stdout logfile backups (default 10)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_capture_maxbytes</span><span style="color:#000;font-weight:bold">=</span>1MB                       ; number of bytes in <span style="color:#d14">&#39;capturemode&#39;</span> <span style="color:#000;font-weight:bold">(</span>default 0<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_events_enabled</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">false</span>                       ; emit events on stdout writes <span style="color:#000;font-weight:bold">(</span>default <span style="color:#0086b3">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ£€æŸ¥ <code>supervisorctl</code> çš„çŠ¶æ€</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># supervisorctl update</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># supervisorctl status</span>
</span></span><span style="display:flex;"><span>etcd-server-199-13               RUNNING   pid 4497, uptime <span style="color:#099">1</span> day, 1:40:00
</span></span><span style="display:flex;"><span>kube-apiserver-199-13            RUNNING   pid 4500, uptime <span style="color:#099">1</span> day, 1:40:00
</span></span><span style="display:flex;"><span>kube-controller-manager-199-13   RUNNING   pid 4817, uptime 4:12:46
</span></span><span style="display:flex;"><span>kube-kubelet-199-13              RUNNING   pid 5487, uptime 0:00:41
</span></span><span style="display:flex;"><span>kube-scheduler-199-13            RUNNING   pid 5144, uptime 1:22:14
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="67-éªŒè¯é›†ç¾¤">6.7 éªŒè¯é›†ç¾¤</h4>
<p>æŸ¥çœ‹é›†ç¾¤çŠ¶å†µ</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get nodes</span>
</span></span><span style="display:flex;"><span>NAME                      STATUS   ROLES    AGE   VERSION
</span></span><span style="display:flex;"><span>192-168-199-13.host.com   Ready    &lt;none&gt;   94s   v1.15.2
</span></span><span style="display:flex;"><span>192-168-199-14.host.com   Ready    &lt;none&gt;   92s   v1.15.2
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šè¿° <code>ROLES</code> æ ‡ç­¾ä¸ºç©ºï¼Œæ·»åŠ  <code>ROLES</code> æ ‡ç­¾ï¼Œéå¿…é¡»çš„æ“ä½œ</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl label node 192-168-199-13.host.com node-role.kubernetes.io/master=</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl label node 192-168-199-13.host.com node-role.kubernetes.io/node=</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl label node 192-168-199-14.host.com node-role.kubernetes.io/master=</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl label node 192-168-199-14.host.com node-role.kubernetes.io/node=</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># å†æ¬¡æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ï¼ŒROLESä¸­æœ‰è§’è‰²</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get nodes</span>
</span></span><span style="display:flex;"><span>NAME                      STATUS   ROLES         AGE     VERSION
</span></span><span style="display:flex;"><span>192-168-199-13.host.com   Ready    master,node   6m35s   v1.15.2
</span></span><span style="display:flex;"><span>192-168-199-14.host.com   Ready    master,node   6m33s   v1.15.2
</span></span></code></pre></td></tr></table>
</div>
</div><p>é»˜è®¤ <code>kubectl</code> æ— æ³•é€šè¿‡ <code>Tab</code> é”®è¡¥å…¨å‚æ•°ï¼Œå¯é€šè¿‡ä»¥ä¸‹å‘½ä»¤è®¾ç½®è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½</p>
<pre tabindex="0"><code>[root@192-168-199-13 ~]# source &lt;(kubectl completion bash)
</code></pre><h3 id="7-éƒ¨ç½²kube-proxy">7. éƒ¨ç½²kube-proxy</h3>
<p><code>kube-proxy</code> ä¸»è¦ç”¨äºè¿æ¥é›†ç¾¤ç½‘ç»œå’Œ <code>pod</code> ç½‘ç»œ</p>
<h4 id="71-ç­¾å‘è¯ä¹¦">7.1 ç­¾å‘è¯ä¹¦</h4>
<p>åœ¨ <code>192.168.199.15</code> ä¸­ç­¾å‘è¯ä¹¦</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /opt/certs/kube-proxy-csr.json</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;CN&#34;</span>: <span style="color:#d14">&#34;system:kube-proxy&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;key&#34;</span>: <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;algo&#34;</span>: <span style="color:#d14">&#34;rsa&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#d14">&#34;size&#34;</span>: <span style="color:#099">2048</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#d14">&#34;names&#34;</span>: <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;C&#34;</span>: <span style="color:#d14">&#34;CN&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;ST&#34;</span>: <span style="color:#d14">&#34;beijing&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;L&#34;</span>: <span style="color:#d14">&#34;beijing&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;O&#34;</span>: <span style="color:#d14">&#34;od&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;OU&#34;</span>: <span style="color:#d14">&#34;ops&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client kube-proxy-csr.json |cfssl-json -bare kube-proxy-client</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨ <code>192.168.199.13</code> ä¸Šæ‹·è´è¯ä¹¦</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /opt/kubernetes/server/bin/cert</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp root@192.168.199.15:/opt/certs/kube-proxy-client.pem ./</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp root@192.168.199.15:/opt/certs/kube-proxy-client-key.pem ./</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>set-cluster</strong></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /opt/kubernetes/server/bin/conf/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl config set-cluster myk8s \</span>
</span></span><span style="display:flex;"><span>   --certificate-authority<span style="color:#000;font-weight:bold">=</span>/opt/kubernetes/server/bin/cert/ca.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>   --embed-certs<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>   --server<span style="color:#000;font-weight:bold">=</span>https://192.168.199.10:7443 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>   --kubeconfig<span style="color:#000;font-weight:bold">=</span>kube-proxy.kubeconfig
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>set-credentials</strong></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl config set-credentials kube-proxy \</span>
</span></span><span style="display:flex;"><span>   --client-certificate<span style="color:#000;font-weight:bold">=</span>/opt/kubernetes/server/bin/cert/kube-proxy-client.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>   --client-key<span style="color:#000;font-weight:bold">=</span>/opt/kubernetes/server/bin/cert/kube-proxy-client-key.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>   --embed-certs<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>   --kubeconfig<span style="color:#000;font-weight:bold">=</span>kube-proxy.kubeconfig
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>set-contex</strong></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl config set-context myk8s-context \</span>
</span></span><span style="display:flex;"><span>   --cluster<span style="color:#000;font-weight:bold">=</span>myk8s <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>   --user<span style="color:#000;font-weight:bold">=</span>kube-proxy <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>   --kubeconfig<span style="color:#000;font-weight:bold">=</span>kube-proxy.kubeconfig
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>use-context</strong></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl config use-context myk8s-context --kubeconfig=kube-proxy.kubeconfig</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨ <code>192.168.199.14</code> æ‹·è´  <code>192.168.199.13</code>  ä¸Šç”Ÿæˆçš„ <code>kube-proxy.kubeconfig</code> å³å¯</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-14 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /opt/kubernetes/server/bin/conf/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-14 conf<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp root@192.168.199.13:/opt/kubernetes/server/bin/conf/kube-proxy.kubeconfig ./</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="72-åŠ è½½lvsæ¨¡å—">7.2 åŠ è½½lvsæ¨¡å—</h4>
<p><code>192.168.199.13</code> å’Œ <code>192.168.199.14</code>
å¯åŠ¨å†…æ ¸ä¸­çš„ <code>lvs</code> æ¨¡å—</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat ip_vs.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#!/bin/bash</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">ipvs_mods_dir</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;/usr/lib/modules/</span><span style="color:#000;font-weight:bold">$(</span>uname -r<span style="color:#000;font-weight:bold">)</span><span style="color:#d14">/kernel/net/netfilter/ipvs&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">for</span> i in <span style="color:#000;font-weight:bold">$(</span>ls <span style="color:#008080">$ipvs_mods_dir</span>|grep -o <span style="color:#d14">&#34;^[^.]*&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span>  /sbin/modinfo -F filename <span style="color:#008080">$i</span> &amp;&gt;/dev/null
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">[</span> <span style="color:#008080">$?</span> -eq <span style="color:#099">0</span> <span style="color:#000;font-weight:bold">]</span>;<span style="color:#000;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>    /sbin/modprobe <span style="color:#008080">$i</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">done</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯¹è„šæœ¬è¿›è¡Œæˆæƒï¼Œå¹¶æ‰§è¡Œè„šæœ¬</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># chmod a+x ip_vs.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># sh ip_vs.sh</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>éªŒè¯æ¨¡å—æ˜¯å¦è¢«åŠ è½½</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># lsmod | grep ip_vs</span>
</span></span><span style="display:flex;"><span>ip_vs_wrr              <span style="color:#099">12697</span>  <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>ip_vs_wlc              <span style="color:#099">12519</span>  <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>ip_vs_sh               <span style="color:#099">12688</span>  <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>ip_vs_sed              <span style="color:#099">12519</span>  <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>ip_vs_rr               <span style="color:#099">12600</span>  <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>ip_vs_pe_sip           <span style="color:#099">12740</span>  <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>nf_conntrack_sip       <span style="color:#099">33780</span>  <span style="color:#099">1</span> ip_vs_pe_sip
</span></span><span style="display:flex;"><span>ip_vs_nq               <span style="color:#099">12516</span>  <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>ip_vs_lc               <span style="color:#099">12516</span>  <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>ip_vs_lblcr            <span style="color:#099">12922</span>  <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>ip_vs_lblc             <span style="color:#099">12819</span>  <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>ip_vs_ftp              <span style="color:#099">13079</span>  <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>ip_vs_dh               <span style="color:#099">12688</span>  <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>ip_vs                 <span style="color:#099">145497</span>  <span style="color:#099">24</span> ip_vs_dh,ip_vs_lc,ip_vs_nq,ip_vs_rr,ip_vs_sh,ip_vs_ftp,ip_vs_sed,ip_vs_wlc,ip_vs_wrr,ip_vs_pe_sip,ip_vs_lblcr,ip_vs_lblc
</span></span><span style="display:flex;"><span>nf_nat                 <span style="color:#099">26583</span>  <span style="color:#099">3</span> ip_vs_ftp,nf_nat_ipv4,nf_nat_masquerade_ipv4
</span></span><span style="display:flex;"><span>nf_conntrack          <span style="color:#099">139264</span>  <span style="color:#099">8</span> ip_vs,nf_nat,nf_nat_ipv4,xt_conntrack,nf_nat_masquerade_ipv4,nf_conntrack_netlink,nf_conntrack_sip,nf_conntrack_ipv4
</span></span><span style="display:flex;"><span>libcrc32c              <span style="color:#099">12644</span>  <span style="color:#099">3</span> ip_vs,nf_nat,nf_conntrack
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="73-å¯åŠ¨æœåŠ¡">7.3 å¯åŠ¨æœåŠ¡</h4>
<p>åˆ›å»ºå¯åŠ¨è„šæœ¬</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /opt/kubernetes/server/bin/kube-proxy.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#!/bin/sh</span>
</span></span><span style="display:flex;"><span>./kube-proxy <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --cluster-cidr 172.7.0.0/16 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --hostname-override 192-168-199-13.host.com <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --proxy-mode<span style="color:#000;font-weight:bold">=</span>ipvs <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --ipvs-scheduler<span style="color:#000;font-weight:bold">=</span>nq <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --kubeconfig ./conf/kube-proxy.kubeconfig
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>æ³¨æ„ä¸»æœºåï¼Œcluster-cidr æŒ‡ pod é›†ç¾¤IP</p>
</blockquote>
<p>æ ¹æ®ä¸Šè¿°è„šæœ¬åˆ›å»ºç›®å½•å¹¶å¯¹è„šæœ¬è¿›è¡Œæˆæƒ</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># chmod a+x /opt/kubernetes/server/bin/kube-proxy.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mkdir -p /data/logs/kubernetes/kube-proxy</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é…ç½® <code>supervisord</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/supervisord.d/kube-proxy.ini</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>program:kube-proxy-199-13<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">command</span><span style="color:#000;font-weight:bold">=</span>/opt/kubernetes/server/bin/kube-proxy.sh                     ; the program <span style="color:#000;font-weight:bold">(</span>relative uses PATH, can take args<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">numprocs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">1</span>                                                           ; number of processes copies to start <span style="color:#000;font-weight:bold">(</span>def 1<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">directory</span><span style="color:#000;font-weight:bold">=</span>/opt/kubernetes/server/bin                                 ; directory to cwd to before <span style="color:#0086b3">exec</span> <span style="color:#000;font-weight:bold">(</span>def no cwd<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">autostart</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                                       ; start at supervisord start <span style="color:#000;font-weight:bold">(</span>default: <span style="color:#0086b3">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">autorestart</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                                     ; retstart at unexpected quit <span style="color:#000;font-weight:bold">(</span>default: <span style="color:#0086b3">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">startsecs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">30</span>                                                         ; number of secs prog must stay running <span style="color:#000;font-weight:bold">(</span>def. 1<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">startretries</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">3</span>                                                       ; max <span style="color:#998;font-style:italic"># of serial start failures (default 3)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">exitcodes</span><span style="color:#000;font-weight:bold">=</span>0,2                                                        ; <span style="color:#d14">&#39;expected&#39;</span> <span style="color:#0086b3">exit</span> codes <span style="color:#000;font-weight:bold">for</span> process <span style="color:#000;font-weight:bold">(</span>default 0,2<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stopsignal</span><span style="color:#000;font-weight:bold">=</span>QUIT                                                      ; signal used to <span style="color:#0086b3">kill</span> process <span style="color:#000;font-weight:bold">(</span>default TERM<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stopwaitsecs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">10</span>                                                      ; max num secs to <span style="color:#0086b3">wait</span> b4 SIGKILL <span style="color:#000;font-weight:bold">(</span>default 10<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">user</span><span style="color:#000;font-weight:bold">=</span>root                                                            ; setuid to this UNIX account to run the program
</span></span><span style="display:flex;"><span><span style="color:#008080">redirect_stderr</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                                 ; redirect proc stderr to stdout <span style="color:#000;font-weight:bold">(</span>default <span style="color:#0086b3">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile</span><span style="color:#000;font-weight:bold">=</span>/data/logs/kubernetes/kube-proxy/proxy.stdout.log     ; stderr log path, NONE <span style="color:#000;font-weight:bold">for</span> none; default AUTO
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile_maxbytes</span><span style="color:#000;font-weight:bold">=</span>64MB                                         ; max <span style="color:#998;font-style:italic"># logfile bytes b4 rotation (default 50MB)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile_backups</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">4</span>                                             ; <span style="color:#998;font-style:italic"># of stdout logfile backups (default 10)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_capture_maxbytes</span><span style="color:#000;font-weight:bold">=</span>1MB                                          ; number of bytes in <span style="color:#d14">&#39;capturemode&#39;</span> <span style="color:#000;font-weight:bold">(</span>default 0<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_events_enabled</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">false</span>                                          ; emit events on stdout writes <span style="color:#000;font-weight:bold">(</span>default <span style="color:#0086b3">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ›´æ–° <code>supervisord</code> å¹¶æŸ¥çœ‹çŠ¶æ€</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># supervisorctl update</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># supervisorctl status</span>
</span></span><span style="display:flex;"><span>etcd-server-199-13               RUNNING   pid 688, uptime 0:47:58
</span></span><span style="display:flex;"><span>kube-apiserver-199-13            RUNNING   pid 695, uptime 0:47:58
</span></span><span style="display:flex;"><span>kube-controller-manager-199-13   RUNNING   pid 693, uptime 0:47:58
</span></span><span style="display:flex;"><span>kube-kubelet-199-13              RUNNING   pid 691, uptime 0:47:58
</span></span><span style="display:flex;"><span>kube-proxy-199-13                RUNNING   pid 10633, uptime 0:00:59
</span></span><span style="display:flex;"><span>kube-scheduler-199-13            RUNNING   pid 689, uptime 0:47:58
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®‰è£… <code>ipvsadm</code> å·¥å…·ï¼ŒæŸ¥çœ‹ <code>ipvs</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># yum install ipvsadm -y</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ipvsadm -Ln</span>
</span></span><span style="display:flex;"><span>IP Virtual Server version 1.2.1 <span style="color:#000;font-weight:bold">(</span><span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span>4096<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>Prot LocalAddress:Port Scheduler Flags
</span></span><span style="display:flex;"><span>  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
</span></span><span style="display:flex;"><span>TCP  192.168.0.1:443 nq
</span></span><span style="display:flex;"><span>  -&gt; 192.168.199.13:6443          Masq    <span style="color:#099">1</span>      <span style="color:#099">0</span>          <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>  -&gt; 192.168.199.14:6443          Masq    <span style="color:#099">1</span>      <span style="color:#099">0</span>          <span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get svc</span>
</span></span><span style="display:flex;"><span>NAME         TYPE        CLUSTER-IP    EXTERNAL-IP   PORT<span style="color:#000;font-weight:bold">(</span>S<span style="color:#000;font-weight:bold">)</span>   AGE
</span></span><span style="display:flex;"><span>kubernetes   ClusterIP   192.168.0.1   &lt;none&gt;        443/TCP   2d7h
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="8-é›†ç¾¤éªŒè¯">8. é›†ç¾¤éªŒè¯</h3>
<p>åˆ›å»ºä¸€ä¸ªåç§°ä¸º <code>my-nginx</code> çš„ <code>pod</code> ï¼Œé…ç½®æ–‡ä»¶å¦‚ä¸‹</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /root/nginx-ds.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: extensions/v1beta1
</span></span><span style="display:flex;"><span>kind: DaemonSet
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: nginx-ds
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  template:
</span></span><span style="display:flex;"><span>    metadata:
</span></span><span style="display:flex;"><span>      labels:
</span></span><span style="display:flex;"><span>        app: nginx-ds
</span></span><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>      - name: my-nginx
</span></span><span style="display:flex;"><span>        image: harbor.od.com/public/nginx:v1.7.9
</span></span><span style="display:flex;"><span>        ports:
</span></span><span style="display:flex;"><span>        - containerPort: <span style="color:#099">80</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ ¹æ® <code>yaml</code> æ–‡ä»¶å¯åŠ¨ <code>pod</code> ï¼Œå¹¶æŸ¥çœ‹å…¶çŠ¶æ€</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl create -f nginx-ds.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get pods -o wide</span>
</span></span><span style="display:flex;"><span>NAME             READY   STATUS    RESTARTS   AGE   IP           NODE                      NOMINATED NODE   READINESS GATES
</span></span><span style="display:flex;"><span>nginx-ds-6z2cl   1/1     Running   <span style="color:#099">0</span>          27s   172.7.14.2   192-168-199-14.host.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>nginx-ds-ln87w   1/1     Running   <span style="color:#099">0</span>          27s   172.7.13.2   192-168-199-13.host.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic">#  curl 172.7.13.2</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æŸ¥çœ‹é›†ç¾¤çŠ¶æ€</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get cs</span>
</span></span><span style="display:flex;"><span>NAME                 STATUS    MESSAGE              ERROR
</span></span><span style="display:flex;"><span>scheduler            Healthy   ok
</span></span><span style="display:flex;"><span>controller-manager   Healthy   ok
</span></span><span style="display:flex;"><span>etcd-1               Healthy   <span style="color:#000;font-weight:bold">{</span><span style="color:#d14">&#34;health&#34;</span>: <span style="color:#d14">&#34;true&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>etcd-2               Healthy   <span style="color:#000;font-weight:bold">{</span><span style="color:#d14">&#34;health&#34;</span>: <span style="color:#d14">&#34;true&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>etcd-0               Healthy   <span style="color:#000;font-weight:bold">{</span><span style="color:#d14">&#34;health&#34;</span>: <span style="color:#d14">&#34;true&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get node</span>
</span></span><span style="display:flex;"><span>NAME                      STATUS   ROLES         AGE   VERSION
</span></span><span style="display:flex;"><span>192-168-199-13.host.com   Ready    master,node   23h   v1.15.2
</span></span><span style="display:flex;"><span>192-168-199-14.host.com   Ready    master,node   23h   v1.15.2
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get pods</span>
</span></span><span style="display:flex;"><span>NAME             READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>nginx-ds-6z2cl   1/1     Running   <span style="color:#099">0</span>          3m1s
</span></span><span style="display:flex;"><span>nginx-ds-ln87w   1/1     Running   <span style="color:#099">0</span>          3m1s
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="ä¸‰å¸¸ç”¨å‘½ä»¤">ä¸‰ã€å¸¸ç”¨å‘½ä»¤</h1>
<h3 id="1-é™ˆè¿°å¼èµ„æºç®¡ç†">1. é™ˆè¿°å¼èµ„æºç®¡ç†</h3>
<h4 id="11-å‘½åç©ºé—´">1.1 å‘½åç©ºé—´</h4>
<p>æŸ¥çœ‹å‘½åç©ºé—´</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get namespace</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># å¯ä»¥ç®€å†™ä¸º</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get ns</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æŸ¥è¯¢ <code>default</code> ç©ºé—´ä¸‹æ‰€æœ‰çš„èµ„æº</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get all [ -n default ]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åˆ›å»ºä¸€ä¸ªåç§°ä¸º <code>app</code> çš„å‘½åç©ºé—´</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl create ns app</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åˆ é™¤åç§°ä¸º <code>app</code> çš„å‘½åç©ºé—´</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl delete ns app</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="12-deployment">1.2 deployment</h4>
<p>åˆ›å»ºä¸€ä¸ª <code>deployment</code> èµ„æº</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># deployment å¯ä»¥ç®€å†™ä¸º deploy</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl create deployment nginx-dp --image=harbor.od.com/public/nginx:v1.7.9 -n kube-public</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æŸ¥çœ‹ <code>deployment</code> èµ„æº</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ç®€å•æŸ¥çœ‹</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get deploy -n kube-public</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ‰©å±•æŸ¥çœ‹</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get deploy -n kube-public -o wide</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># è¯¦ç»†æŸ¥çœ‹</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl describe deployment nginx-dp -n kube-public</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="13-pods">1.3 pods</h4>
<p>æŸ¥çœ‹ <code>pod</code> èµ„æº</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get pod [ -o wide ]</span>
</span></span><span style="display:flex;"><span>NAME             READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>nginx-ds-6z2cl   1/1     Running   <span style="color:#099">1</span>          23h
</span></span><span style="display:flex;"><span>nginx-ds-ln87w   1/1     Running   <span style="color:#099">1</span>          23h
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿›å…¥ <code>pod</code> èµ„æºå†…éƒ¨</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl exec -it nginx-ds-6z2cl /bin/bash</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="14-services">1.4 services</h4>
<p>æš´éœ²æœåŠ¡ç«¯å£</p>
<pre tabindex="0"><code>[root@192-168-199-13 ~]# kubectl expose deployment nginx-dp --port=80 -n kube-public
</code></pre><p>æ›´æ”¹æœåŠ¡å‰¯æœ¬æ•°</p>
<pre tabindex="0"><code>[root@192-168-199-13 ~]# kubectl scale deployment nginx-dp --replicas=2 -n kube-public
</code></pre><h3 id="2-å£°æ˜å¼èµ„æºç®¡ç†">2. å£°æ˜å¼èµ„æºç®¡ç†</h3>
<h4 id="21-pods">2.1 pods</h4>
<p>æŸ¥çœ‹ <code>kube-public</code> å‘½åç©ºé—´å†…çš„ <code>pod</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get pods -n kube-public</span>
</span></span><span style="display:flex;"><span>NAME                        READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>nginx-dp-5dfc689474-2mlsq   1/1     Running   <span style="color:#099">1</span>          11d
</span></span></code></pre></td></tr></table>
</div>
</div><p>è·å–èµ„æºé…ç½®æ¸…å•</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get pods nginx-dp-5dfc689474-2mlsq -o yaml -n kube-public</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æŸ¥çœ‹<code>pods</code>çš„èµ„æºé…ç½®æ¸…å•å†™æ³•</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl explain pods</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æŸ¥çœ‹ <code>pods</code> ä¸­ <code>metadate</code> çš„ç”¨æ³•</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl explain pods.metadata</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>èµ„æºé…ç½®æ¸…å•ç¤ºä¾‹ï¼š</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat nginx-ds-svc.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Service
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    app: nginx-ds
</span></span><span style="display:flex;"><span>  name: nginx-ds
</span></span><span style="display:flex;"><span>  namespace: default
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  ports:
</span></span><span style="display:flex;"><span>  - port: <span style="color:#099">80</span>
</span></span><span style="display:flex;"><span>    protocol: TCP
</span></span><span style="display:flex;"><span>    targetPort: <span style="color:#099">80</span>
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    app: nginx-ds
</span></span><span style="display:flex;"><span>  sessionAffinity: None
</span></span><span style="display:flex;"><span>  type: ClusterIP
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ ¹æ®èµ„æºé…ç½®æ¸…å•åˆ›å»º <code>pod</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl create -f nginx-ds-svc.yaml</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="22-services">2.2 services</h4>
<p>è·å– <code>service</code> ä¿¡æ¯</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get svc</span>
</span></span><span style="display:flex;"><span>NAME         TYPE        CLUSTER-IP        EXTERNAL-IP   PORT<span style="color:#000;font-weight:bold">(</span>S<span style="color:#000;font-weight:bold">)</span>   AGE
</span></span><span style="display:flex;"><span>kubernetes   ClusterIP   192.168.0.1       &lt;none&gt;        443/TCP   14d
</span></span><span style="display:flex;"><span>nginx-ds     ClusterIP   192.168.164.154   &lt;none&gt;        80/TCP    9s
</span></span></code></pre></td></tr></table>
</div>
</div><p>å°† <code>nginx-ds</code> çš„é…ç½®ä¿¡æ¯ä»¥ <code>yaml</code> çš„æ–¹å¼è¾“å‡º</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get svc nginx-ds -o yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Service
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  creationTimestamp: <span style="color:#d14">&#34;2020-06-14T22:42:42Z&#34;</span>
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    app: nginx-ds
</span></span><span style="display:flex;"><span>  name: nginx-ds
</span></span><span style="display:flex;"><span>  namespace: default
</span></span><span style="display:flex;"><span>  resourceVersion: <span style="color:#d14">&#34;238777&#34;</span>
</span></span><span style="display:flex;"><span>  selfLink: /api/v1/namespaces/default/services/nginx-ds
</span></span><span style="display:flex;"><span>  uid: 0128d415-acc5-43df-a235-87e75a72d86e
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  clusterIP: 192.168.164.154
</span></span><span style="display:flex;"><span>  ports:
</span></span><span style="display:flex;"><span>  - port: <span style="color:#099">80</span>
</span></span><span style="display:flex;"><span>    protocol: TCP
</span></span><span style="display:flex;"><span>    targetPort: <span style="color:#099">80</span>
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    app: nginx-ds
</span></span><span style="display:flex;"><span>  sessionAffinity: None
</span></span><span style="display:flex;"><span>  type: ClusterIP
</span></span><span style="display:flex;"><span>status:
</span></span><span style="display:flex;"><span>  loadBalancer: <span style="color:#000;font-weight:bold">{}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯é€šè¿‡ <code>explain</code> æŸ¥çœ‹èµ„æºé…ç½®æ¸…å•çš„å†™æ³•</p>
<pre tabindex="0"><code>[root@k8s-node1 ~]# kubectl explain ds
</code></pre><h1 id="å››flannelç½‘ç»œ">å››ã€Flannelç½‘ç»œ</h1>
<p><strong>CINç½‘ç»œæ’ä»¶</strong>æœ€ä¸»è¦çš„åŠŸèƒ½æ˜¯å®ç°PODèµ„æºå¯ä»¥<strong>è·¨å®¿ä¸»æœº</strong>è¿›è¡Œé€šä¿¡</p>
<h4 id="1-å®‰è£…å¹¶é…ç½®flannel">1. å®‰è£…å¹¶é…ç½®Flannel</h4>
<p>éœ€è¦åœ¨æ‰€æœ‰ <code>node</code> èŠ‚ç‚¹å®‰è£… <code>Flannel</code> ï¼Œä½¿ <code>pod</code> å¯ä»¥è·¨ç•Œç‚¹é—´é€šä¿¡
ç›®å‰é›†ç¾¤ <code>pod</code> ä¹‹é—´ä¸èƒ½äº’ç›¸é€šä¿¡ï¼Œä»<code>pod 172.7.13.2</code> ä¸­æ— æ³• <code>ping</code> é€š <code>172.7.14.3</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get pod -o wide</span>
</span></span><span style="display:flex;"><span>NAME             READY   STATUS    RESTARTS   AGE   IP           NODE                      NOMINATED NODE   READINESS GATES
</span></span><span style="display:flex;"><span>nginx-ds-6z2cl   1/1     Running   <span style="color:#099">2</span>          12d   172.7.14.3   192-168-199-14.host.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>nginx-ds-ln87w   1/1     Running   <span style="color:#099">2</span>          12d   172.7.13.2   192-168-199-13.host.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl exec -it nginx-ds-ln87w /bin/bash</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@nginx-ds-ln87w:/# ping 172.7.14.3
</span></span><span style="display:flex;"><span>PING 172.7.14.3 <span style="color:#000;font-weight:bold">(</span>172.7.14.3<span style="color:#000;font-weight:bold">)</span>: <span style="color:#099">48</span> data bytes
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä» <code>172.7.14.3</code> ä¸­ä¹Ÿæ— æ³• <code>ping</code> é€š <code>172.7.13.2</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-14 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get pod -o wide</span>
</span></span><span style="display:flex;"><span>NAME             READY   STATUS    RESTARTS   AGE   IP           NODE                      NOMINATED NODE   READINESS GATES
</span></span><span style="display:flex;"><span>nginx-ds-6z2cl   1/1     Running   <span style="color:#099">2</span>          12d   172.7.14.3   192-168-199-14.host.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>nginx-ds-ln87w   1/1     Running   <span style="color:#099">2</span>          12d   172.7.13.2   192-168-199-13.host.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-14 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl exec -it nginx-ds-6z2cl /bin/bash</span>
</span></span><span style="display:flex;"><span>root@nginx-ds-6z2cl:/# ping 172.7.13.2
</span></span><span style="display:flex;"><span>PING 172.7.13.2 <span style="color:#000;font-weight:bold">(</span>172.7.13.2<span style="color:#000;font-weight:bold">)</span>: <span style="color:#099">48</span> data bytes
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä» <a href="https://github.com/coreos/flannel/releases">flannelå®˜ç½‘</a>ä¸‹è½½è½¯ä»¶</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># wget https://github.com/coreos/flannel/releases/download/v0.11.0/flannel-v0.11.0-linux-amd64.tar.gz</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è§£å‹è½¯ä»¶åŒ…ï¼Œå¹¶åˆ›å»ºè½¯è¿æ¥</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mkdir /opt/flannel-v0.11.0</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># tar xf flannel-v0.11.0-linux-amd64.tar.gz -C /opt/flannel-v0.11.0</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ln -s /opt/flannel-v0.11.0/ /opt/flannel</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ‹·è´è¯ä¹¦ï¼Œä½¿ <code>flannel</code> å¯ä»¥è¿æ¥ <code>etcd</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /opt/flannel</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 flannel<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mkdir cert</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 flannel<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd cert/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp root@192.168.199.15:/opt/certs/ca.pem ./</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp root@192.168.199.15:/opt/certs/client.pem ./</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp root@192.168.199.15:/opt/certs/client-key.pem ./</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 cert<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ll</span>
</span></span><span style="display:flex;"><span>total <span style="color:#099">12</span>
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root <span style="color:#099">1346</span> Jun <span style="color:#099">15</span> 19:49 ca.pem
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#099">1</span> root root <span style="color:#099">1675</span> Jun <span style="color:#099">15</span> 19:50 client-key.pem
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root <span style="color:#099">1363</span> Jun <span style="color:#099">15</span> 19:50 client.pem
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®šä¹‰ç½‘ç»œç›¸å…³å˜é‡ï¼Œå¯åŠ¨ <code>falnnel</code> æ—¶ä¼šå¼•ç”¨æ­¤æ–‡ä»¶</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 flannel<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat subnet.env</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ•´ä¸ª pod é›†ç¾¤ä½¿ç”¨çš„ç½‘æ®µ</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">FLANNEL_NETWORK</span><span style="color:#000;font-weight:bold">=</span>172.7.0.0/16
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æœ¬æœº pod ä½¿ç”¨çš„ç½‘æ®µ</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">FLANNEL_SUBNET</span><span style="color:#000;font-weight:bold">=</span>172.7.13.1/24
</span></span><span style="display:flex;"><span><span style="color:#008080">FLANNEL_MTU</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">1500</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">FLANNEL_IPMASQ</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">false</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åˆ›å»º <code>flanneld</code> çš„å¯åŠ¨è„šæœ¬</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 flannel<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat flanneld.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#!/bin/sh</span>
</span></span><span style="display:flex;"><span>./flanneld <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  <span style="color:#998;font-style:italic"># è‡ªå·±æœ¬èº«çš„ node ip</span>
</span></span><span style="display:flex;"><span>  --public-ip<span style="color:#000;font-weight:bold">=</span>192.168.199.13 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  <span style="color:#998;font-style:italic"># etcdé›†ç¾¤çš„åœ°å€</span>
</span></span><span style="display:flex;"><span>  --etcd-endpoints<span style="color:#000;font-weight:bold">=</span>https://192.168.199.12:2379,https://192.168.199.13:2379,https://192.168.199.14:2379 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --etcd-keyfile<span style="color:#000;font-weight:bold">=</span>./cert/client-key.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --etcd-certfile<span style="color:#000;font-weight:bold">=</span>./cert/client.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --etcd-cafile<span style="color:#000;font-weight:bold">=</span>./cert/ca.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  <span style="color:#998;font-style:italic"># ç½‘å¡åç§°</span>
</span></span><span style="display:flex;"><span>  --iface<span style="color:#000;font-weight:bold">=</span>eth0 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --subnet-file<span style="color:#000;font-weight:bold">=</span>./subnet.env <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --healthz-port<span style="color:#000;font-weight:bold">=</span><span style="color:#099">2401</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯¹è„šæœ¬è¿›è¡Œæˆæƒ</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 flannel<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># chmod a+x flanneld.sh</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨ <code>etcd</code> é›†ç¾¤ä¸­<strong>ä»»æ„ä¸€å°ä¸»æœº</strong>ä¸Šé…ç½® <code>flannel</code> ä½¿ç”¨ <code>host-gw</code> çš„ç½‘ç»œæ¨¡å‹ï¼Œæ­¤æ¨¡å‹ä¸­æ‰€æœ‰çš„ <code>Node</code> èŠ‚ç‚¹åº”å¤„äºåŒä¸€ä¸ªäºŒå±‚ç½‘ç»œï¼Œæ‹¥æœ‰åŒä¸€ä¸ªç‰©ç†ç½‘å…³ã€‚å¯ä»¥é€šè¿‡ <code>./etcdctl member list</code> å‘½ä»¤æŸ¥çœ‹é›†ç¾¤çŠ¶æ€</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /opt/etcd</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># é…ç½®ä¸º host-gw æ¨¡å¼</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ./etcdctl set /coreos.com/network/config &#39;{&#34;Network&#34;: &#34;172.7.0.0/16&#34;, &#34;Backend&#34;: {&#34;Type&#34;: &#34;host-gw&#34;}}&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># éªŒè¯é…ç½®</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ./etcdctl get /coreos.com/network/config</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span><span style="color:#d14">&#34;Network&#34;</span>: <span style="color:#d14">&#34;172.7.0.0/16&#34;</span>, <span style="color:#d14">&#34;Backend&#34;</span>: <span style="color:#000;font-weight:bold">{</span><span style="color:#d14">&#34;Type&#34;</span>: <span style="color:#d14">&#34;host-gw&#34;</span><span style="color:#000;font-weight:bold">}}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ Vxlan ç½‘ç»œæ¨¡å‹ å’Œ ç›´æ¥è·¯ç”±æ¨¡å‹</p>
</blockquote>
<p>é…ç½® <code>supervisord</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/supervisord.d/flannel.ini</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>program:flanneld-199-13<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">command</span><span style="color:#000;font-weight:bold">=</span>/opt/flannel/flanneld.sh                             ; the program <span style="color:#000;font-weight:bold">(</span>relative uses PATH, can take args<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">numprocs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">1</span>                                                   ; number of processes copies to start <span style="color:#000;font-weight:bold">(</span>def 1<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">directory</span><span style="color:#000;font-weight:bold">=</span>/opt/flannel                                       ; directory to cwd to before <span style="color:#0086b3">exec</span> <span style="color:#000;font-weight:bold">(</span>def no cwd<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">autostart</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                               ; start at supervisord start <span style="color:#000;font-weight:bold">(</span>default: <span style="color:#0086b3">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">autorestart</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                             ; retstart at unexpected quit <span style="color:#000;font-weight:bold">(</span>default: <span style="color:#0086b3">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">startsecs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">30</span>                                                 ; number of secs prog must stay running <span style="color:#000;font-weight:bold">(</span>def. 1<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">startretries</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">3</span>                                               ; max <span style="color:#998;font-style:italic"># of serial start failures (default 3)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">exitcodes</span><span style="color:#000;font-weight:bold">=</span>0,2                                                ; <span style="color:#d14">&#39;expected&#39;</span> <span style="color:#0086b3">exit</span> codes <span style="color:#000;font-weight:bold">for</span> process <span style="color:#000;font-weight:bold">(</span>default 0,2<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stopsignal</span><span style="color:#000;font-weight:bold">=</span>QUIT                                              ; signal used to <span style="color:#0086b3">kill</span> process <span style="color:#000;font-weight:bold">(</span>default TERM<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stopwaitsecs</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">10</span>                                              ; max num secs to <span style="color:#0086b3">wait</span> b4 SIGKILL <span style="color:#000;font-weight:bold">(</span>default 10<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">user</span><span style="color:#000;font-weight:bold">=</span>root                                                    ; setuid to this UNIX account to run the program
</span></span><span style="display:flex;"><span><span style="color:#008080">redirect_stderr</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>                                         ; redirect proc stderr to stdout <span style="color:#000;font-weight:bold">(</span>default <span style="color:#0086b3">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile</span><span style="color:#000;font-weight:bold">=</span>/data/logs/flanneld/flanneld.stdout.log       ; stderr log path, NONE <span style="color:#000;font-weight:bold">for</span> none; default AUTO
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile_maxbytes</span><span style="color:#000;font-weight:bold">=</span>64MB                                 ; max <span style="color:#998;font-style:italic"># logfile bytes b4 rotation (default 50MB)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_logfile_backups</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">4</span>                                     ; <span style="color:#998;font-style:italic"># of stdout logfile backups (default 10)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_capture_maxbytes</span><span style="color:#000;font-weight:bold">=</span>1MB                                  ; number of bytes in <span style="color:#d14">&#39;capturemode&#39;</span> <span style="color:#000;font-weight:bold">(</span>default 0<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stdout_events_enabled</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">false</span>                                  ; emit events on stdout writes <span style="color:#000;font-weight:bold">(</span>default <span style="color:#0086b3">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">killasgroup</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stopasgroup</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>æ³¨æ„ [ ] ä¸­çš„åå­—</p>
</blockquote>
<p>åˆ›å»ºä¸Šè¿°å¯åŠ¨è„šæœ¬ä¸­ç”¨åˆ°çš„ç›®å½•</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mkdir /data/logs/flanneld/</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æŸ¥çœ‹ <code>supervisord</code> çš„çŠ¶æ€</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># supervisorctl update</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># supervisorctl status</span>
</span></span><span style="display:flex;"><span>etcd-server-199-13               RUNNING   pid 721, uptime 16:23:15
</span></span><span style="display:flex;"><span>flanneld-199-13                  RUNNING   pid 57257, uptime 0:00:46
</span></span><span style="display:flex;"><span>kube-apiserver-199-13            RUNNING   pid 717, uptime 16:23:15
</span></span><span style="display:flex;"><span>kube-controller-manager-199-13   RUNNING   pid 722, uptime 16:23:15
</span></span><span style="display:flex;"><span>kube-kubelet-199-13              RUNNING   pid 714, uptime 16:23:15
</span></span><span style="display:flex;"><span>kube-proxy-199-13                RUNNING   pid 713, uptime 16:23:15
</span></span><span style="display:flex;"><span>kube-scheduler-199-13            RUNNING   pid 716, uptime 16:23:15
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>192.168.199.14 èŠ‚ç‚¹é…ç½®å†…å®¹ï¼ŒåŒä¸Š</strong></p>
<h4 id="2-éªŒè¯flannel">2. éªŒè¯Flannel</h4>
<h5 id="21-éªŒè¯ç½‘ç»œçŠ¶æ€">2.1 éªŒè¯ç½‘ç»œçŠ¶æ€</h5>
<p>é…ç½®å®Œæˆåï¼Œä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„ <code>pod</code> å¯ä»¥è¿›è¡Œæ­£å¸¸çš„é€šä¿¡</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@nginx-ds-ln87w:/# ping 172.7.14.3
</span></span><span style="display:flex;"><span>PING 172.7.14.3 <span style="color:#000;font-weight:bold">(</span>172.7.14.3<span style="color:#000;font-weight:bold">)</span>: <span style="color:#099">48</span> data bytes
</span></span><span style="display:flex;"><span><span style="color:#099">56</span> bytes from 172.7.14.3: <span style="color:#008080">icmp_seq</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">498</span> <span style="color:#008080">ttl</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">62</span> <span style="color:#008080">time</span><span style="color:#000;font-weight:bold">=</span>0.561 ms
</span></span><span style="display:flex;"><span><span style="color:#099">56</span> bytes from 172.7.14.3: <span style="color:#008080">icmp_seq</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">499</span> <span style="color:#008080">ttl</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">62</span> <span style="color:#008080">time</span><span style="color:#000;font-weight:bold">=</span>0.428 ms
</span></span><span style="display:flex;"><span><span style="color:#099">56</span> bytes from 172.7.14.3: <span style="color:#008080">icmp_seq</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">500</span> <span style="color:#008080">ttl</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">62</span> <span style="color:#008080">time</span><span style="color:#000;font-weight:bold">=</span>0.499 ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@nginx-ds-6z2cl:/# ping 172.7.13.2
</span></span><span style="display:flex;"><span>PING 172.7.13.2 <span style="color:#000;font-weight:bold">(</span>172.7.13.2<span style="color:#000;font-weight:bold">)</span>: <span style="color:#099">48</span> data bytes
</span></span><span style="display:flex;"><span><span style="color:#099">56</span> bytes from 172.7.13.2: <span style="color:#008080">icmp_seq</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">470</span> <span style="color:#008080">ttl</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">62</span> <span style="color:#008080">time</span><span style="color:#000;font-weight:bold">=</span>0.498 ms
</span></span><span style="display:flex;"><span><span style="color:#099">56</span> bytes from 172.7.13.2: <span style="color:#008080">icmp_seq</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">471</span> <span style="color:#008080">ttl</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">62</span> <span style="color:#008080">time</span><span style="color:#000;font-weight:bold">=</span>0.503 ms
</span></span><span style="display:flex;"><span><span style="color:#099">56</span> bytes from 172.7.13.2: <span style="color:#008080">icmp_seq</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">472</span> <span style="color:#008080">ttl</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">62</span> <span style="color:#008080">time</span><span style="color:#000;font-weight:bold">=</span>0.566 ms
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="22-flannelåŸç†">2.2 FlannelåŸç†</h5>
<p>flannel çš„ host-gw æ¨¡å¼ï¼Œç›¸å½“äºå†æ¯å°ä¸»æœºä¸Šæ·»åŠ äº†é™æ€è·¯ç”±</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># route -n</span>
</span></span><span style="display:flex;"><span>....
</span></span><span style="display:flex;"><span>172.7.14.0      192.168.199.14  255.255.255.0   UG    <span style="color:#099">0</span>      <span style="color:#099">0</span>        <span style="color:#099">0</span> eth0
</span></span><span style="display:flex;"><span>....
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="3-ä¼˜åŒ–-iptables-è§„åˆ™">3. ä¼˜åŒ– iptables è§„åˆ™</h4>
<p>æŸ¥çœ‹ <code>iptables</code> çš„ç°æœ‰è§„åˆ™</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># iptables-save | grep -i postrouting</span>
</span></span><span style="display:flex;"><span>:POSTROUTING ACCEPT <span style="color:#000;font-weight:bold">[</span>53:3216<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>:KUBE-POSTROUTING - <span style="color:#000;font-weight:bold">[</span>0:0<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>-A POSTROUTING -m comment --comment <span style="color:#d14">&#34;kubernetes postrouting rules&#34;</span> -j KUBE-POSTROUTING
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ¥æºåœ°å€æ˜¯ 172.7.13.0/24 ä¸” ä¸æ˜¯docker0 ç½‘å¡å‡ºç½‘çš„ï¼ŒåšSNAT</span>
</span></span><span style="display:flex;"><span>-A POSTROUTING -s 172.7.13.0/24 ! -o docker0 -j MASQUERADE
</span></span><span style="display:flex;"><span>-A KUBE-POSTROUTING -m comment --comment <span style="color:#d14">&#34;kubernetes service traffic requiring SNAT&#34;</span> -m mark --mark 0x4000/0x4000 -j MASQUERADE
</span></span><span style="display:flex;"><span>-A KUBE-POSTROUTING -m comment --comment <span style="color:#d14">&#34;Kubernetes endpoints dst ip:port, source ip for solving hairpin purpose&#34;</span> -m <span style="color:#0086b3">set</span> --match-set KUBE-LOOP-BACK dst,dst,src -j MASQUERADE
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç°åœ¨çš„è§„åˆ™æ˜¯é€šè¿‡ <code>docker0</code> å‡ºç½‘çš„ï¼Œä¸åšSNATã€‚éœ€è¦åŠ ä¸Šå‡ºç½‘åœ°å€æ˜¯ <code>172.7.0.0/16</code> ç½‘æ®µä¹Ÿä¸åšSNAT
å®‰è£…å¹¶å¯åŠ¨ <code>iptables</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># yum install iptables-services -y</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># systemctl start iptables</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># systemctl enable iptables</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¿®æ”¹ <code>iptables</code> è§„åˆ™</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># åˆ é™¤ç°æœ‰è§„åˆ™</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># iptables -t nat -D POSTROUTING -s 172.7.13.0/24 ! -o docker0 -j MASQUERADE</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ä¼˜åŒ–è§„åˆ™</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># iptables -t nat -I POSTROUTING -s 172.7.13.0/24 ! -d 172.7.0.0/16 ! -o docker0 -j MASQUERADE</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ä¿å­˜</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># service iptables save</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è‹¥å‡ºç°podèŠ‚ç‚¹ä¸äº’é€šæƒ…å†µï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œ</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># iptables-save | grep -i reject</span>
</span></span><span style="display:flex;"><span>-A INPUT -j REJECT --reject-with icmp-host-prohibited
</span></span><span style="display:flex;"><span>-A FORWARD -j REJECT --reject-with icmp-host-prohibited
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># iptables -t filter -D INPUT -j REJECT --reject-with icmp-host-prohibited</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># iptables -t filter -D FORWARD -j REJECT --reject-with icmp-host-prohibited</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>å…¶ä»– node èŠ‚ç‚¹ä¹Ÿéœ€è¦æ“ä½œä»¥ä¸Šå†…å®¹</strong></p>
<h1 id="äº”coredns">äº”ã€Coredns</h1>
<h4 id="1-corednséƒ¨ç½²">1. Corednséƒ¨ç½²</h4>
<h5 id="11-å‡†å¤‡å·¥ä½œ">1.1 å‡†å¤‡å·¥ä½œ</h5>
<p>Coredns ä¸»è¦è´Ÿè´£è‡ªåŠ¨å…³è” <strong>Serviceèµ„æºåç§°</strong> å’Œ <strong>é›†ç¾¤ç½‘ç»œIP</strong>ï¼Œä»è€Œè¾¾åˆ°æœåŠ¡è¢«é›†ç¾¤è‡ªåŠ¨å‘ç°çš„ç›®çš„ã€‚
å¦‚ä¸‹æœ‰ <code>service</code> èµ„æºï¼ŒCoredns ä¼šå°† <code>nginx-ds</code> ä¸ <code>192.168.31.51</code> å»ºç«‹å…³è”</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-14 etcd<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get svc</span>
</span></span><span style="display:flex;"><span>NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span style="color:#000;font-weight:bold">(</span>S<span style="color:#000;font-weight:bold">)</span>   AGE
</span></span><span style="display:flex;"><span>kubernetes   ClusterIP   192.168.0.1     &lt;none&gt;        443/TCP   25h
</span></span><span style="display:flex;"><span>nginx-ds     ClusterIP   192.168.31.51   &lt;none&gt;        80/TCP    121m
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬éœ€è¦åœ¨è¿ç»´ä¸»æœºä¸Šåˆ›å»ºèµ„æºé…ç½®æ¸…å•ï¼Œé€šè¿‡ <code>nginx</code> çš„ç›®å½•æµè§ˆåŠŸèƒ½å®ç°å…±äº«ï¼Œä½¿ä¸é€šçš„ <code>node</code> èŠ‚ç‚¹ç›´æ¥è®¿é—® <code>url</code> å°±å¯ä»¥è·å–èµ„æºé…ç½®æ¸…å•
åœ¨ <code>192.168.199.11</code> ä¸Šæ·»åŠ Aè®°å½•</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /var/named/od.com.zone</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">$ORIGIN</span> od.com.
</span></span><span style="display:flex;"><span><span style="color:#008080">$TTL</span> <span style="color:#099">600</span>        ; <span style="color:#099">10</span> minutes
</span></span><span style="display:flex;"><span>@               IN SOA  dns.od.com. dnsadmin.od.com. <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>								<span style="color:#998;font-style:italic"># å‰æ»šåºå·</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">2020052703</span> ; serial
</span></span><span style="display:flex;"><span>                                <span style="color:#099">10800</span>      ; refresh <span style="color:#000;font-weight:bold">(</span><span style="color:#099">3</span> hours<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">900</span>        ; retry <span style="color:#000;font-weight:bold">(</span><span style="color:#099">15</span> minutes<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">604800</span>     ; expire <span style="color:#000;font-weight:bold">(</span><span style="color:#099">1</span> week<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">86400</span>      ; minimum <span style="color:#000;font-weight:bold">(</span><span style="color:#099">1</span> day<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                NS   dns.od.com.
</span></span><span style="display:flex;"><span><span style="color:#008080">$TTL</span> <span style="color:#099">60</span> ; <span style="color:#099">1</span> minute
</span></span><span style="display:flex;"><span>dns                A    192.168.199.11
</span></span><span style="display:flex;"><span>harbor             A    192.168.199.15
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ·»åŠ å¦‚ä¸‹åŸŸåè§£æ</span>
</span></span><span style="display:flex;"><span>k8s-yaml           A    192.168.199.15
</span></span></code></pre></td></tr></table>
</div>
</div><p>éªŒè¯è§£ææ˜¯å¦ç”Ÿæ•ˆ</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># systemctl restart named</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># dig -t A k8s-yaml.od.com @192.168.199.11 +short</span>
</span></span><span style="display:flex;"><span>192.168.199.15
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨ <code>192.168.199.15</code> ä¸Šé…ç½® <code>nginx</code> ï¼Œå®ç°ç›®å½•æµè§ˆåŠŸèƒ½</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/nginx/conf.d/k8s-yaml.od.com.conf</span>
</span></span><span style="display:flex;"><span>server <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    listen       80;
</span></span><span style="display:flex;"><span>    server_name  k8s-yaml.od.com;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    location / <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        autoindex on;
</span></span><span style="display:flex;"><span>        default_type text/plain;
</span></span><span style="display:flex;"><span>        root /data/k8s-yaml;
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># nginx -t</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># nginx -s reload</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åˆ›å»ºå¯¹åº”çš„ç›®å½•ç”¨äºå­˜æ”¾ <code>coredns</code> ç›¸å…³çš„èµ„æºé…ç½®æ¸…å•ï¼Œåœ¨æµè§ˆå™¨ä¸­å¯ä»¥ç›´æ¥è®¿é—®åˆ°æ­¤ç›®å½•</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mkdir /data/k8s-yaml/coredns -p</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /data/k8s-yaml/coredns/</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="12-éƒ¨ç½²coredns">1.2 éƒ¨ç½²Coredns</h5>
<p>ä¸‹è½½é•œåƒï¼Œæ‰“æ ‡ç­¾åæ¨é€åˆ°ç§æœ‰ä»“åº“ <code>Harbor</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker pull coredns/coredns:1.6.1</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker tag c0f6e815079e harbor.od.com/public/coredns:v1.6.1</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker push harbor.od.com/public/coredns:v1.6.1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¼–å†™èµ„æºé…ç½®æ¸…å•
<code>rbac</code> èµ„æºé…ç½®æ¸…å•ï¼Œä¸»è¦é…ç½®æƒé™ç›¸å…³å†…å®¹</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 coredns<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat rbac.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: ServiceAccount
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: coredns
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>      kubernetes.io/cluster-service: <span style="color:#d14">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>      addonmanager.kubernetes.io/mode: Reconcile
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion: rbac.authorization.k8s.io/v1
</span></span><span style="display:flex;"><span>kind: ClusterRole
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    kubernetes.io/bootstrapping: rbac-defaults
</span></span><span style="display:flex;"><span>    addonmanager.kubernetes.io/mode: Reconcile
</span></span><span style="display:flex;"><span>  name: system:coredns
</span></span><span style="display:flex;"><span>rules:
</span></span><span style="display:flex;"><span>- apiGroups:
</span></span><span style="display:flex;"><span>  - <span style="color:#d14">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  resources:
</span></span><span style="display:flex;"><span>  - endpoints
</span></span><span style="display:flex;"><span>  - services
</span></span><span style="display:flex;"><span>  - pods
</span></span><span style="display:flex;"><span>  - namespaces
</span></span><span style="display:flex;"><span>  verbs:
</span></span><span style="display:flex;"><span>  - list
</span></span><span style="display:flex;"><span>  - watch
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion: rbac.authorization.k8s.io/v1
</span></span><span style="display:flex;"><span>kind: ClusterRoleBinding
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  annotations:
</span></span><span style="display:flex;"><span>    rbac.authorization.kubernetes.io/autoupdate: <span style="color:#d14">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    kubernetes.io/bootstrapping: rbac-defaults
</span></span><span style="display:flex;"><span>    addonmanager.kubernetes.io/mode: EnsureExists
</span></span><span style="display:flex;"><span>  name: system:coredns
</span></span><span style="display:flex;"><span>roleRef:
</span></span><span style="display:flex;"><span>  apiGroup: rbac.authorization.k8s.io
</span></span><span style="display:flex;"><span>  kind: ClusterRole
</span></span><span style="display:flex;"><span>  name: system:coredns
</span></span><span style="display:flex;"><span>subjects:
</span></span><span style="display:flex;"><span>- kind: ServiceAccount
</span></span><span style="display:flex;"><span>  name: coredns
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>ConfigMap</code> èµ„æºé…ç½®æ¸…å•ï¼Œä¸»è¦é…ç½® <code>coredns</code> ç›¸å…³å†…å®¹ï¼Œå…¶ä¸­ <code>forward</code> æŒ‡å‘ä¸Šå±‚çš„ <code>DNS</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 coredns<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat cm.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: ConfigMap
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: coredns
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span><span style="display:flex;"><span>data:
</span></span><span style="display:flex;"><span>  Corefile: |
</span></span><span style="display:flex;"><span>    .:53 <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        errors
</span></span><span style="display:flex;"><span>        log
</span></span><span style="display:flex;"><span>        health
</span></span><span style="display:flex;"><span>        ready
</span></span><span style="display:flex;"><span>        kubernetes cluster.local 192.168.0.0/16
</span></span><span style="display:flex;"><span>        forward . 192.168.199.11
</span></span><span style="display:flex;"><span>        cache <span style="color:#099">30</span>
</span></span><span style="display:flex;"><span>        loop
</span></span><span style="display:flex;"><span>        reload
</span></span><span style="display:flex;"><span>        loadbalance
</span></span><span style="display:flex;"><span>       <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>Deployment</code> èµ„æºé…ç½®æ¸…å•ï¼Œä¸º <code>pod</code> èµ„æºæ§åˆ¶å™¨ï¼Œä¸»è¦é…ç½® <code>pod</code> ç›¸å…³å†…å®¹</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 coredns<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat dp.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: apps/v1
</span></span><span style="display:flex;"><span>kind: Deployment
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: coredns
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    k8s-app: coredns
</span></span><span style="display:flex;"><span>    kubernetes.io/name: <span style="color:#d14">&#34;CoreDNS&#34;</span>
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  replicas: <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    matchLabels:
</span></span><span style="display:flex;"><span>      k8s-app: coredns
</span></span><span style="display:flex;"><span>  template:
</span></span><span style="display:flex;"><span>    metadata:
</span></span><span style="display:flex;"><span>      labels:
</span></span><span style="display:flex;"><span>        k8s-app: coredns
</span></span><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      priorityClassName: system-cluster-critical
</span></span><span style="display:flex;"><span>      serviceAccountName: coredns
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>      - name: coredns
</span></span><span style="display:flex;"><span>        image: harbor.od.com/public/coredns:v1.6.1
</span></span><span style="display:flex;"><span>        args:
</span></span><span style="display:flex;"><span>        - -conf
</span></span><span style="display:flex;"><span>        - /etc/coredns/Corefile
</span></span><span style="display:flex;"><span>        volumeMounts:
</span></span><span style="display:flex;"><span>        - name: config-volume
</span></span><span style="display:flex;"><span>          mountPath: /etc/coredns
</span></span><span style="display:flex;"><span>        ports:
</span></span><span style="display:flex;"><span>        - containerPort: <span style="color:#099">53</span>
</span></span><span style="display:flex;"><span>          name: dns
</span></span><span style="display:flex;"><span>          protocol: UDP
</span></span><span style="display:flex;"><span>        - containerPort: <span style="color:#099">53</span>
</span></span><span style="display:flex;"><span>          name: dns-tcp
</span></span><span style="display:flex;"><span>          protocol: TCP
</span></span><span style="display:flex;"><span>        - containerPort: <span style="color:#099">9153</span>
</span></span><span style="display:flex;"><span>          name: metrics
</span></span><span style="display:flex;"><span>          protocol: TCP
</span></span><span style="display:flex;"><span>        livenessProbe:
</span></span><span style="display:flex;"><span>          httpGet:
</span></span><span style="display:flex;"><span>            path: /health
</span></span><span style="display:flex;"><span>            port: <span style="color:#099">8080</span>
</span></span><span style="display:flex;"><span>            scheme: HTTP
</span></span><span style="display:flex;"><span>          initialDelaySeconds: <span style="color:#099">60</span>
</span></span><span style="display:flex;"><span>          timeoutSeconds: <span style="color:#099">5</span>
</span></span><span style="display:flex;"><span>          successThreshold: <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>          failureThreshold: <span style="color:#099">5</span>
</span></span><span style="display:flex;"><span>      dnsPolicy: Default
</span></span><span style="display:flex;"><span>      volumes:
</span></span><span style="display:flex;"><span>        - name: config-volume
</span></span><span style="display:flex;"><span>          configMap:
</span></span><span style="display:flex;"><span>            name: coredns
</span></span><span style="display:flex;"><span>            items:
</span></span><span style="display:flex;"><span>            - key: Corefile
</span></span><span style="display:flex;"><span>              path: Corefile
</span></span></code></pre></td></tr></table>
</div>
</div><p>é€šè¿‡ <code>Service</code> èµ„æºé…ç½®æ¸…å•æš´éœ² <code>coredns</code> çš„ <code>53</code> ç«¯å£</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 coredns<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat svc.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Service
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: coredns
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    k8s-app: coredns
</span></span><span style="display:flex;"><span>    kubernetes.io/cluster-service: <span style="color:#d14">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>    kubernetes.io/name: <span style="color:#d14">&#34;CoreDNS&#34;</span>
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    k8s-app: coredns
</span></span><span style="display:flex;"><span>  clusterIP: 192.168.0.2
</span></span><span style="display:flex;"><span>  ports:
</span></span><span style="display:flex;"><span>  - name: dns
</span></span><span style="display:flex;"><span>    port: <span style="color:#099">53</span>
</span></span><span style="display:flex;"><span>    protocol: UDP
</span></span><span style="display:flex;"><span>  - name: dns-tcp
</span></span><span style="display:flex;"><span>    port: <span style="color:#099">53</span>
</span></span><span style="display:flex;"><span>  - name: metrics
</span></span><span style="display:flex;"><span>    port: <span style="color:#099">9153</span>
</span></span><span style="display:flex;"><span>    protocol: TCP
</span></span></code></pre></td></tr></table>
</div>
</div><p>è®¿é—®å¯¹åº”çš„ <code>URL</code> å¯ä»¥çœ‹åˆ°åˆšåˆ›å»ºçš„å†…å®¹</p>
<p><img src="https://images.wuennan.cn/20200616231737876.png" alt="20200616231737876"></p>
<p>æ ¹æ®èµ„æºé…ç½®æ¸…å•åˆ›å»ºèµ„æº</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl apply -f http://k8s-yaml.od.com/coredns/rbac.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl apply -f http://k8s-yaml.od.com/coredns/cm.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl apply -f http://k8s-yaml.od.com/coredns/dp.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl apply -f http://k8s-yaml.od.com/coredns/svc.yaml</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>éªŒè¯èµ„æºåˆ›å»ºæƒ…å†µ</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get all -n kube-system</span>
</span></span><span style="display:flex;"><span>NAME                           READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod/coredns-6b6c4f9648-44xjn   1/1     Running   <span style="color:#099">0</span>          3m49s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># corednsçš„cluster ipä¸º192.168.0.2</span>
</span></span><span style="display:flex;"><span>NAME              TYPE        CLUSTER-IP    EXTERNAL-IP   PORT<span style="color:#000;font-weight:bold">(</span>S<span style="color:#000;font-weight:bold">)</span>                  AGE
</span></span><span style="display:flex;"><span>service/coredns   ClusterIP   192.168.0.2   &lt;none&gt;        53/UDP,53/TCP,9153/TCP   3m36s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>deployment.apps/coredns   1/1     <span style="color:#099">1</span>            <span style="color:#099">1</span>           3m49s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                                 DESIRED   CURRENT   READY   AGE
</span></span><span style="display:flex;"><span>replicaset.apps/coredns-6b6c4f9648   <span style="color:#099">1</span>         <span style="color:#099">1</span>         <span style="color:#099">1</span>       3m49s
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2-éªŒè¯corednsè§£æ">2. éªŒè¯corednsè§£æ</h4>
<p>éªŒè¯ <code>coredns</code> æ˜¯å¦èƒ½å¤Ÿè§£æ <code>www.baidu.com</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># dig -t A www.baidu.com @192.168.0.2 +short</span>
</span></span><span style="display:flex;"><span>www.a.shifen.com.
</span></span><span style="display:flex;"><span>61.135.169.121
</span></span><span style="display:flex;"><span>61.135.169.125
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>coredns</code> ä¸»è¦ç”¨äºè§£æ <code>service</code> èµ„æºå’Œ <code>cluster ip</code>ï¼Œå¯é€šè¿‡ä¸€ä¸‹æ–¹å¼éªŒè¯</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># é€šè¿‡é™ˆè¿°å¼å‘½ä»¤åˆ›å»ºä¸€ä¸ªpod</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl create deployment nginx-dp --image=harbor.od.com/public/nginx:v1.7.9 -n kube-public</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æŸ¥çœ‹åˆ›å»ºçš„pod</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get pods -n kube-public -o wide</span>
</span></span><span style="display:flex;"><span>NAME                        READY   STATUS    RESTARTS   AGE   IP           NODE                      NOMINATED NODE   READINESS GATES
</span></span><span style="display:flex;"><span>nginx-dp-5dfc689474-jml9v   1/1     Running   <span style="color:#099">0</span>          34s   172.7.14.3   192-168-199-14.host.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># é€šè¿‡é™ˆè¿°å¼å‘½ä»¤åˆ›å»ºä¸€ä¸ªsvcèµ„æº</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl expose deployment nginx-dp --port 80 -n kube-public</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># éªŒè¯svcèµ„æºæ˜¯å¦åˆ›å»ºæˆåŠŸ</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get svc -n kube-public</span>
</span></span><span style="display:flex;"><span>NAME       TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span style="color:#000;font-weight:bold">(</span>S<span style="color:#000;font-weight:bold">)</span>   AGE
</span></span><span style="display:flex;"><span>nginx-dp   ClusterIP   192.168.41.222   &lt;none&gt;        80/TCP    24s
</span></span></code></pre></td></tr></table>
</div>
</div><p>é€šè¿‡ <code>coredns</code> å¯ä»¥å°† <code>svc</code> èµ„æºè§£ææˆ <code>cluster ip</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># dig -t A nginx-dp.kube-public.svc.cluster.local. @192.168.0.2 +short</span>
</span></span><span style="display:flex;"><span>192.168.41.222
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>æ³¨æ„ï¼š éœ€è¦ä½¿ç”¨FQDNå³å…¨é™å®šåŸŸå</p>
</blockquote>
<p>æ›´å¤š <code>coredns</code> ç›¸å…³å†…å®¹ï¼Œå¯å‚è€ƒ<a href="http://ccnuo.com/2019/08/25/CoreDNS%EF%BC%9AKubernetes%E5%86%85%E9%83%A8%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90%E5%8E%9F%E7%90%86%E3%80%81%E5%BC%8A%E7%AB%AF%E5%8F%8A%E4%BC%98%E5%8C%96%E6%96%B9%E5%BC%8F/">CoreDNSï¼šKuberneteså†…éƒ¨åŸŸåè§£æåŸç†ã€å¼Šç«¯åŠä¼˜åŒ–æ–¹å¼</a></p>
<h1 id="å…­ingress">å…­ã€Ingress</h1>
<h3 id="1-ingresséƒ¨ç½²">1. Ingresséƒ¨ç½²</h3>
<h4 id="11-ingressç®€ä»‹">1.1 Ingressç®€ä»‹</h4>
<p>Ingress åŠŸèƒ½æ˜¯å°†é›†ç¾¤å¤–éƒ¨çš„æµé‡è¯·æ±‚è½¬å‘è‡³é›†ç¾¤å†…éƒ¨ï¼Œä»è€Œä½¿å®ç°æœåŠ¡æš´éœ²</p>
<h4 id="12-traefikéƒ¨ç½²">1.2 Traefikéƒ¨ç½²</h4>
<p>å¯ä»¥åœ¨ <a href="https://github.com/containous/traefik">github</a> ä¸Šä¸‹è½½traefikã€‚
è·å–<code>traefik</code> çš„é•œåƒæ–‡ä»¶ï¼Œæ‰“æ ‡ç­¾åä¸Šä¼ è‡³ <code>Harbor</code> ç§æœ‰ä»“åº“</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker pull traefik:v1.7.2-alpine</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker images | grep traefik</span>
</span></span><span style="display:flex;"><span>traefik                         v1.7.2-alpine              add5fac61ae5        <span style="color:#099">20</span> months ago       72.4MB
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker tag add5fac61ae5 harbor.od.com/public/traefik:v1.7.2</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker push harbor.od.com/public/traefik:v1.7.2</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å‡†å¤‡èµ„æºé…ç½®æ¸…å•</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 traefik<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># pwd</span>
</span></span><span style="display:flex;"><span>/data/k8s-yaml/traefik
</span></span></code></pre></td></tr></table>
</div>
</div><p>åˆ›å»º <code>rbac.yaml</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 traefik<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat rbac.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: ServiceAccount
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: traefik-ingress-controller
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion: rbac.authorization.k8s.io/v1beta1
</span></span><span style="display:flex;"><span>kind: ClusterRole
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: traefik-ingress-controller
</span></span><span style="display:flex;"><span>rules:
</span></span><span style="display:flex;"><span>  - apiGroups:
</span></span><span style="display:flex;"><span>      - <span style="color:#d14">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    resources:
</span></span><span style="display:flex;"><span>      - services
</span></span><span style="display:flex;"><span>      - endpoints
</span></span><span style="display:flex;"><span>      - secrets
</span></span><span style="display:flex;"><span>    verbs:
</span></span><span style="display:flex;"><span>      - get
</span></span><span style="display:flex;"><span>      - list
</span></span><span style="display:flex;"><span>      - watch
</span></span><span style="display:flex;"><span>  - apiGroups:
</span></span><span style="display:flex;"><span>      - extensions
</span></span><span style="display:flex;"><span>    resources:
</span></span><span style="display:flex;"><span>      - ingresses
</span></span><span style="display:flex;"><span>    verbs:
</span></span><span style="display:flex;"><span>      - get
</span></span><span style="display:flex;"><span>      - list
</span></span><span style="display:flex;"><span>      - watch
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>kind: ClusterRoleBinding
</span></span><span style="display:flex;"><span>apiVersion: rbac.authorization.k8s.io/v1beta1
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: traefik-ingress-controller
</span></span><span style="display:flex;"><span>roleRef:
</span></span><span style="display:flex;"><span>  apiGroup: rbac.authorization.k8s.io
</span></span><span style="display:flex;"><span>  kind: ClusterRole
</span></span><span style="display:flex;"><span>  name: traefik-ingress-controller
</span></span><span style="display:flex;"><span>subjects:
</span></span><span style="display:flex;"><span>- kind: ServiceAccount
</span></span><span style="display:flex;"><span>  name: traefik-ingress-controller
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span></code></pre></td></tr></table>
</div>
</div><p>åˆ›å»º <code>DaemonSet</code> ç±»å‹èµ„æºï¼Œæ§åˆ¶ä¸€ä¸ªå®¿ä¸»æœºä¸Šè·‘ä¸€ä¸ªå‰¯æœ¬</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 traefik<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat ds.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: extensions/v1beta1
</span></span><span style="display:flex;"><span>kind: DaemonSet
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: traefik-ingress
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    k8s-app: traefik-ingress
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  template:
</span></span><span style="display:flex;"><span>    metadata:
</span></span><span style="display:flex;"><span>      labels:
</span></span><span style="display:flex;"><span>        k8s-app: traefik-ingress
</span></span><span style="display:flex;"><span>        name: traefik-ingress
</span></span><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      serviceAccountName: traefik-ingress-controller
</span></span><span style="display:flex;"><span>      terminationGracePeriodSeconds: <span style="color:#099">60</span>
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>      - image: harbor.od.com/public/traefik:v1.7.2
</span></span><span style="display:flex;"><span>        name: traefik-ingress
</span></span><span style="display:flex;"><span>        ports:
</span></span><span style="display:flex;"><span>        - name: controller
</span></span><span style="display:flex;"><span>          containerPort: <span style="color:#099">80</span>
</span></span><span style="display:flex;"><span>          hostPort: <span style="color:#099">81</span>
</span></span><span style="display:flex;"><span>        - name: admin-web
</span></span><span style="display:flex;"><span>          containerPort: <span style="color:#099">8080</span>
</span></span><span style="display:flex;"><span>        securityContext:
</span></span><span style="display:flex;"><span>          capabilities:
</span></span><span style="display:flex;"><span>            drop:
</span></span><span style="display:flex;"><span>            - ALL
</span></span><span style="display:flex;"><span>            add:
</span></span><span style="display:flex;"><span>            - NET_BIND_SERVICE
</span></span><span style="display:flex;"><span>        args: 
</span></span><span style="display:flex;"><span>        - --api
</span></span><span style="display:flex;"><span>        - --kubernetes
</span></span><span style="display:flex;"><span>        - --logLevel<span style="color:#000;font-weight:bold">=</span>INFO
</span></span><span style="display:flex;"><span>        - --insecureskipverify<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>
</span></span><span style="display:flex;"><span>        - --kubernetes.endpoint<span style="color:#000;font-weight:bold">=</span>https://192.168.199.10:7443
</span></span><span style="display:flex;"><span>        - --accesslog
</span></span><span style="display:flex;"><span>        - --accesslog.filepath<span style="color:#000;font-weight:bold">=</span>/var/log/traefik_access.log
</span></span><span style="display:flex;"><span>        - --traefiklog
</span></span><span style="display:flex;"><span>        - --traefiklog.filepath<span style="color:#000;font-weight:bold">=</span>/var/log/traefik.log
</span></span><span style="display:flex;"><span>        - --metrics.prometheus
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>æ³¨æ„ï¼šéœ€è¦ä¿®æ”¹èµ„æºæ¸…å•ä¸­æ‰€æ¶‰åŠåˆ°çš„IPåœ°å€</p>
</blockquote>
<p>åˆ›å»º <code>Service</code> ç±»å‹èµ„æº</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 traefik<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat svc.yaml</span>
</span></span><span style="display:flex;"><span>kind: Service
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: traefik-ingress-service
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    k8s-app: traefik-ingress
</span></span><span style="display:flex;"><span>  ports:
</span></span><span style="display:flex;"><span>    - protocol: TCP
</span></span><span style="display:flex;"><span>      port: <span style="color:#099">80</span>
</span></span><span style="display:flex;"><span>      name: controller
</span></span><span style="display:flex;"><span>    - protocol: TCP
</span></span><span style="display:flex;"><span>      port: <span style="color:#099">8080</span>
</span></span><span style="display:flex;"><span>      name: admin-web
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>Ingress</code> èµ„æºæ˜¯ä¸€ç»„åŸºäºåŸŸåå’Œ <code>URL</code> è·¯å¾„ï¼ŒæŠŠç”¨æˆ·çš„è¯·æ±‚è½¬å‘è‡³æŒ‡å®š <code>Service</code> èµ„æºçš„è§„åˆ™</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 traefik<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat ingress.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: extensions/v1beta1
</span></span><span style="display:flex;"><span>kind: Ingress
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: traefik-web-ui
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span><span style="display:flex;"><span>  annotations:
</span></span><span style="display:flex;"><span>    kubernetes.io/ingress.class: traefik
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  rules:
</span></span><span style="display:flex;"><span>  - host: traefik.od.com
</span></span><span style="display:flex;"><span>    http:
</span></span><span style="display:flex;"><span>      paths:
</span></span><span style="display:flex;"><span>      - path: /
</span></span><span style="display:flex;"><span>        backend:
</span></span><span style="display:flex;"><span>          serviceName: traefik-ingress-service
</span></span><span style="display:flex;"><span>          servicePort: <span style="color:#099">8080</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨ä»»æ„ä¸€ä¸ªè¿ç®—èŠ‚ç‚¹åº”ç”¨ä»¥ä¸Š <code>yaml</code> é…ç½®</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl apply -f http://k8s-yaml.od.com/traefik/rbac.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl apply -f http://k8s-yaml.od.com/traefik/ds.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl apply -f http://k8s-yaml.od.com/traefik/svc.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl apply -f http://k8s-yaml.od.com/traefik/ingress.yaml</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æŸ¥çœ‹ <code>pod</code> çš„è¿è¡ŒçŠ¶æ€</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get pods -n kube-system -o wide</span>
</span></span><span style="display:flex;"><span>NAME                       READY   STATUS    RESTARTS   AGE   IP           NODE                      NOMINATED NODE   READINESS GATES
</span></span><span style="display:flex;"><span>coredns-6b6c4f9648-44xjn   1/1     Running   <span style="color:#099">0</span>          25h   172.7.13.3   192-168-199-13.host.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>traefik-ingress-2hctl      1/1     Running   <span style="color:#099">0</span>          22m   172.7.13.4   192-168-199-13.host.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>traefik-ingress-vfh4t      1/1     Running   <span style="color:#099">0</span>          22m   172.7.14.4   192-168-199-14.host.com   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>è‹¥ STATUS ä¸€ç›´å¤„äº ContainerCreating çŠ¶æ€ï¼Œå¯å°è¯•é‡å¯å®¹å™¨</p>
</blockquote>
<h4 id="13-éƒ¨ç½²ä¸ƒå±‚è´Ÿè½½å‡è¡¡">1.3 éƒ¨ç½²ä¸ƒå±‚è´Ÿè½½å‡è¡¡</h4>
<p>åœ¨ <code>192.168.199.11</code> å’Œ <code>192.168.199.12</code> ä¸Šé…ç½®ä¸ƒå±‚ä»£ç†ï¼Œæ— å·®åˆ«çš„å°†æµé‡æŠ›ç»™åç«¯çš„ <code>Ingress</code> å¤„ç†</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/nginx/conf.d/od.com.conf</span>
</span></span><span style="display:flex;"><span>upstream default_backend_traefik <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic"># Ingressçš„controller</span>
</span></span><span style="display:flex;"><span>    server 192.168.199.13:81    <span style="color:#008080">max_fails</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">3</span> <span style="color:#008080">fail_timeout</span><span style="color:#000;font-weight:bold">=</span>10s;
</span></span><span style="display:flex;"><span>    server 192.168.199.14:81    <span style="color:#008080">max_fails</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">3</span> <span style="color:#008080">fail_timeout</span><span style="color:#000;font-weight:bold">=</span>10s;
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>server <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    server_name *.od.com;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    location / <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        proxy_pass http://default_backend_traefik;
</span></span><span style="display:flex;"><span>        proxy_set_header Host       <span style="color:#008080">$http_host</span>;
</span></span><span style="display:flex;"><span>        proxy_set_header x-forwarded-for <span style="color:#008080">$proxy_add_x_forwarded_for</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åŠ è½½ <code>Nginx</code> çš„é…ç½®æ–‡ä»¶</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># nginx -t</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># nginx -s reload</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨ <code>192.168.199.11</code> ä¸Šé…ç½®åŸŸåè§£æ</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /var/named/od.com.zone</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">$ORIGIN</span> od.com.
</span></span><span style="display:flex;"><span><span style="color:#008080">$TTL</span> <span style="color:#099">600</span>        ; <span style="color:#099">10</span> minutes
</span></span><span style="display:flex;"><span>@               IN SOA  dns.od.com. dnsadmin.od.com. <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#998;font-style:italic"># å‰æ»šä¸€ä¸ªåºåˆ—å·</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">2020052704</span> ; serial
</span></span><span style="display:flex;"><span>                                <span style="color:#099">10800</span>      ; refresh <span style="color:#000;font-weight:bold">(</span><span style="color:#099">3</span> hours<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">900</span>        ; retry <span style="color:#000;font-weight:bold">(</span><span style="color:#099">15</span> minutes<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">604800</span>     ; expire <span style="color:#000;font-weight:bold">(</span><span style="color:#099">1</span> week<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">86400</span>      ; minimum <span style="color:#000;font-weight:bold">(</span><span style="color:#099">1</span> day<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                NS   dns.od.com.
</span></span><span style="display:flex;"><span><span style="color:#008080">$TTL</span> <span style="color:#099">60</span> ; <span style="color:#099">1</span> minute
</span></span><span style="display:flex;"><span>dns                A    192.168.199.11
</span></span><span style="display:flex;"><span>harbor             A    192.168.199.15
</span></span><span style="display:flex;"><span>k8s-yaml           A    192.168.199.15
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ·»åŠ ä¸€ä¸ª A è®°å½•</span>
</span></span><span style="display:flex;"><span>traefik            A    192.168.199.10
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="2-éªŒè¯">2. éªŒè¯</h3>
<p>é‡å¯ <code>named</code> æœåŠ¡åï¼Œå¯é€šè¿‡åŸŸåè®¿é—® <code>traefik.od.com</code> è®¿é—® <code>traefik</code> ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://images.wuennan.cn/20200707233929414.png" alt="20200707233929414"></p>
<blockquote>
<p>traefik2 ç‰ˆæœ¬å®‰è£…è¯·å‚è€ƒ <a href="http://www.mydlq.club/article/107/">http://www.mydlq.club/article/107/</a></p>
</blockquote>
<h1 id="ä¸ƒdashboard">ä¸ƒã€Dashboard</h1>
<h3 id="1-dashboardéƒ¨ç½²">1 Dashboardéƒ¨ç½²</h3>
<h4 id="11-å®‰è£…dashboardæœåŠ¡">1.1 å®‰è£…DashboardæœåŠ¡</h4>
<p>å‡†å¤‡é•œåƒæ–‡ä»¶
è·å–å®˜æ–¹ <code>dashboard</code> é•œåƒæ–‡ä»¶å¹¶ä¸Šä¼ è‡³ <code>Harbor</code> ç§æœ‰ä»“åº“</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker pull k8scn/kubernetes-dashboard-amd64:v1.8.3</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker tag fcac9aa03fd6 harbor.od.com/public/dashboard:v1.8.3</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker push harbor.od.com/public/dashboard:v1.8.3</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å‡†å¤‡èµ„æºé…ç½®æ¸…å•</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 dashboard<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># pwd</span>
</span></span><span style="display:flex;"><span>/data/k8s-yaml/dashboard
</span></span></code></pre></td></tr></table>
</div>
</div><p>å‡†å¤‡ <code>rbac.yaml</code> æ–‡ä»¶</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 dashboard<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat rbac.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: ServiceAccount
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    k8s-app: kubernetes-dashboard
</span></span><span style="display:flex;"><span>    addonmanager.kubernetes.io/mode: Reconcile
</span></span><span style="display:flex;"><span>  name: kubernetes-dashboard-admin
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion: rbac.authorization.k8s.io/v1
</span></span><span style="display:flex;"><span>kind: ClusterRoleBinding
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: kubernetes-dashboard-admin
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    k8s-app: kubernetes-dashboard
</span></span><span style="display:flex;"><span>    addonmanager.kubernetes.io/mode: Reconcile
</span></span><span style="display:flex;"><span>roleRef:
</span></span><span style="display:flex;"><span>  apiGroup: rbac.authorization.k8s.io
</span></span><span style="display:flex;"><span>  kind: ClusterRole
</span></span><span style="display:flex;"><span>  name: cluster-admin
</span></span><span style="display:flex;"><span>subjects:
</span></span><span style="display:flex;"><span>- kind: ServiceAccount
</span></span><span style="display:flex;"><span>  name: kubernetes-dashboard-admin
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span></code></pre></td></tr></table>
</div>
</div><p>å‡†å¤‡ <code>dp.yaml</code> æ–‡ä»¶</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 dashboard<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat dp.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: apps/v1
</span></span><span style="display:flex;"><span>kind: Deployment
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: kubernetes-dashboard
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    k8s-app: kubernetes-dashboard
</span></span><span style="display:flex;"><span>    kubernetes.io/cluster-service: <span style="color:#d14">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>    addonmanager.kubernetes.io/mode: Reconcile
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    matchLabels:
</span></span><span style="display:flex;"><span>      k8s-app: kubernetes-dashboard
</span></span><span style="display:flex;"><span>  template:
</span></span><span style="display:flex;"><span>    metadata:
</span></span><span style="display:flex;"><span>      labels:
</span></span><span style="display:flex;"><span>        k8s-app: kubernetes-dashboard
</span></span><span style="display:flex;"><span>      annotations:
</span></span><span style="display:flex;"><span>        scheduler.alpha.kubernetes.io/critical-pod: <span style="color:#d14">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      priorityClassName: system-cluster-critical
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>      - name: kubernetes-dashboard
</span></span><span style="display:flex;"><span>        image: harbor.od.com/public/dashboard:v1.8.3
</span></span><span style="display:flex;"><span>        resources:
</span></span><span style="display:flex;"><span>          limits:
</span></span><span style="display:flex;"><span>            cpu: 100m
</span></span><span style="display:flex;"><span>            memory: 300Mi
</span></span><span style="display:flex;"><span>          requests:
</span></span><span style="display:flex;"><span>            cpu: 50m
</span></span><span style="display:flex;"><span>            memory: 100Mi
</span></span><span style="display:flex;"><span>        ports:
</span></span><span style="display:flex;"><span>        - containerPort: <span style="color:#099">8443</span>
</span></span><span style="display:flex;"><span>          protocol: TCP
</span></span><span style="display:flex;"><span>        args:
</span></span><span style="display:flex;"><span>          <span style="color:#998;font-style:italic"># PLATFORM-SPECIFIC ARGS HERE</span>
</span></span><span style="display:flex;"><span>          - --auto-generate-certificates
</span></span><span style="display:flex;"><span>        volumeMounts:
</span></span><span style="display:flex;"><span>        - name: tmp-volume
</span></span><span style="display:flex;"><span>          mountPath: /tmp
</span></span><span style="display:flex;"><span>        livenessProbe:
</span></span><span style="display:flex;"><span>          httpGet:
</span></span><span style="display:flex;"><span>            scheme: HTTPS
</span></span><span style="display:flex;"><span>            path: /
</span></span><span style="display:flex;"><span>            port: <span style="color:#099">8443</span>
</span></span><span style="display:flex;"><span>          initialDelaySeconds: <span style="color:#099">30</span>
</span></span><span style="display:flex;"><span>          timeoutSeconds: <span style="color:#099">30</span>
</span></span><span style="display:flex;"><span>      volumes:
</span></span><span style="display:flex;"><span>      - name: tmp-volume
</span></span><span style="display:flex;"><span>        emptyDir: <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>      serviceAccountName: kubernetes-dashboard-admin
</span></span><span style="display:flex;"><span>      tolerations:
</span></span><span style="display:flex;"><span>      - key: <span style="color:#d14">&#34;CriticalAddonsOnly&#34;</span>
</span></span><span style="display:flex;"><span>        operator: <span style="color:#d14">&#34;Exists&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å‡†å¤‡ <code>svc.yaml</code> æ–‡ä»¶</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 dashboard<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat svc.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Service
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: kubernetes-dashboard
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    k8s-app: kubernetes-dashboard
</span></span><span style="display:flex;"><span>    kubernetes.io/cluster-service: <span style="color:#d14">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>    addonmanager.kubernetes.io/mode: Reconcile
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    k8s-app: kubernetes-dashboard
</span></span><span style="display:flex;"><span>  ports:
</span></span><span style="display:flex;"><span>  - port: <span style="color:#099">443</span>
</span></span><span style="display:flex;"><span>    targetPort: <span style="color:#099">8443</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å‡†å¤‡ <code>ingress</code> é…ç½®æ–‡ä»¶</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 dashboard<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat ingress.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: extensions/v1beta1
</span></span><span style="display:flex;"><span>kind: Ingress
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: kubernetes-dashboard
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span><span style="display:flex;"><span>  annotations:
</span></span><span style="display:flex;"><span>    kubernetes.io/ingress.class: traefik
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  rules:
</span></span><span style="display:flex;"><span>  - host: dashboard.od.com
</span></span><span style="display:flex;"><span>    http:
</span></span><span style="display:flex;"><span>      paths:
</span></span><span style="display:flex;"><span>      - backend:
</span></span><span style="display:flex;"><span>          serviceName: kubernetes-dashboard
</span></span><span style="display:flex;"><span>          servicePort: <span style="color:#099">443</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åº”ç”¨èµ„æºé…ç½®æ¸…å•</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl apply -f http://k8s-yaml.od.com/dashboard/rbac.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl apply -f http://k8s-yaml.od.com/dashboard/dp.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl apply -f http://k8s-yaml.od.com/dashboard/svc.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl apply -f http://k8s-yaml.od.com/dashboard/ingress.yaml</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>éªŒè¯ä»¥ä¸Šèµ„æºé…ç½®æ¸…å•æ˜¯å¦ç”Ÿæ•ˆ</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get pods -n kube-system</span>
</span></span><span style="display:flex;"><span>NAME                                    READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>coredns-6b6c4f9648-t7727                1/1     Running   <span style="color:#099">0</span>          7d23h
</span></span><span style="display:flex;"><span>kubernetes-dashboard-76dcdb4677-7p8w9   1/1     Running   <span style="color:#099">0</span>          97s
</span></span><span style="display:flex;"><span>traefik-ingress-5jwhl                   1/1     Running   <span style="color:#099">0</span>          60m
</span></span><span style="display:flex;"><span>traefik-ingress-6pc5k                   1/1     Running   <span style="color:#099">0</span>          60m
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get svc -n kube-system</span>
</span></span><span style="display:flex;"><span>NAME                      TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span style="color:#000;font-weight:bold">(</span>S<span style="color:#000;font-weight:bold">)</span>                  AGE
</span></span><span style="display:flex;"><span>coredns                   ClusterIP   192.168.0.2     &lt;none&gt;        53/UDP,53/TCP,9153/TCP   7d23h
</span></span><span style="display:flex;"><span>kubernetes-dashboard      ClusterIP   192.168.1.136   &lt;none&gt;        443/TCP                  114s
</span></span><span style="display:flex;"><span>traefik-ingress-service   ClusterIP   192.168.191.8   &lt;none&gt;        80/TCP,8080/TCP          60m
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get ingress -n kube-system</span>
</span></span><span style="display:flex;"><span>NAME                   HOSTS              ADDRESS   PORTS   AGE
</span></span><span style="display:flex;"><span>kubernetes-dashboard   dashboard.od.com             <span style="color:#099">80</span>      2m19s
</span></span><span style="display:flex;"><span>traefik-web-ui         traefik.od.com               <span style="color:#099">80</span>      60m
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¿®æ”¹ <code>named</code> é…ç½®æ–‡ä»¶ï¼Œä½¿ <code>dns</code> å®¢æˆ·ç«¯å¯ä»¥è§£æ <code>dashboard.od.com</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 conf.d<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /var/named/od.com.zone</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">$ORIGIN</span> od.com.
</span></span><span style="display:flex;"><span><span style="color:#008080">$TTL</span> <span style="color:#099">600</span>        ; <span style="color:#099">10</span> minutes
</span></span><span style="display:flex;"><span>@               IN SOA  dns.od.com. dnsadmin.od.com. <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>								<span style="color:#998;font-style:italic"># å‰æ»šä¸€ä¸ªåºåˆ—å·</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">2020052705</span> ; serial
</span></span><span style="display:flex;"><span>                                <span style="color:#099">10800</span>      ; refresh <span style="color:#000;font-weight:bold">(</span><span style="color:#099">3</span> hours<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">900</span>        ; retry <span style="color:#000;font-weight:bold">(</span><span style="color:#099">15</span> minutes<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">604800</span>     ; expire <span style="color:#000;font-weight:bold">(</span><span style="color:#099">1</span> week<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#099">86400</span>      ; minimum <span style="color:#000;font-weight:bold">(</span><span style="color:#099">1</span> day<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                NS   dns.od.com.
</span></span><span style="display:flex;"><span><span style="color:#008080">$TTL</span> <span style="color:#099">60</span> ; <span style="color:#099">1</span> minute
</span></span><span style="display:flex;"><span>dns                A    192.168.199.11
</span></span><span style="display:flex;"><span>harbor             A    192.168.199.15
</span></span><span style="display:flex;"><span>k8s-yaml           A    192.168.199.15
</span></span><span style="display:flex;"><span>traefik            A    192.168.199.10
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ·»åŠ ä¸€ä¸ª A è®°å½•</span>
</span></span><span style="display:flex;"><span>dashboard          A    192.168.199.10
</span></span></code></pre></td></tr></table>
</div>
</div><p>é‡å¯ <code>named</code> æœåŠ¡</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 conf.d<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># systemctl restart named</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>éªŒè¯è§£ææ˜¯å¦æˆåŠŸ</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ä½¿ç”¨ 192.168.199.11ï¼ˆnamedï¼‰è§£æåŸŸå</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># dig -t -A dashboard.od.com @192.168.199.11 +short</span>
</span></span><span style="display:flex;"><span>;; Warning, ignoring invalid <span style="color:#0086b3">type</span> -A
</span></span><span style="display:flex;"><span>192.168.199.10
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ä½¿ç”¨ 192.168.0.2 ï¼ˆcorednsï¼‰è§£æåŸŸå</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># dig -t -A dashboard.od.com @192.168.0.2 +short</span>
</span></span><span style="display:flex;"><span>;; Warning, ignoring invalid <span style="color:#0086b3">type</span> -A
</span></span><span style="display:flex;"><span>192.168.199.10
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨æµè§ˆå™¨ä¸­é€šè¿‡ <code>dashboard.od.com</code> è®¿é—® <code>dashboard</code></p>
<p><img src="https://images.wuennan.cn/20200708003934133.png" alt="20200708003934133"></p>
<blockquote>
<p>æˆæƒè¿™é‡Œå¯ä»¥å…ˆé€‰æ‹© â€œè·³è¿‡â€</p>
</blockquote>
<h4 id="12-ä¸ºdashboardåˆ›å»ºè¯ä¹¦">1.2 ä¸ºDashboardåˆ›å»ºè¯ä¹¦</h4>
<p>è‹¥è¦ä½¿ç”¨ä»¤ç‰Œçš„æ–¹å¼ç™»å½•åˆ° <code>Dashboard</code> çš„è¯ï¼Œéœ€è¦ä½¿ç”¨ <code>https</code> åè®®ã€‚å› æ­¤å¿…è¦è¦åˆ›å»ºä¸€ä¸ªè¯ä¹¦ä¾› <code>Dashboard</code> ä½¿ç”¨</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># (umask 077; openssl genrsa -out dashboard.od.com.key 2048)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># openssl req -new -key dashboard.od.com.key -out dashboard.od.com.csr -subj &#34;/CN=dashboard.od.com/C=CN/ST=BJ/L=Beijing/O=OldboyEdu/OU=ops&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># openssl x509 -req -in dashboard.od.com.csr -CA ca.pem -CAkey ca-key.pem -CAcreateserial -out dashboard.od.com.crt -days 3650</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æŸ¥çœ‹è¯ä¹¦è¯¦æƒ…</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cfssl-certinfo -cert dashboard.od.com.crt</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨ <code>192.168.199.11</code> å’Œ <code>192.168.199.12</code> ä¸Šé…ç½®è¯ä¹¦</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mkdir /etc/nginx/certs</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /etc/nginx/certs</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ‹·è´è¯ä¹¦</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp root@192.168.199.15:/opt/certs/dashboard.od.com.crt ./</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 certs<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># scp root@192.168.199.15:/opt/certs/dashboard.od.com.key ./</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># nginxé…ç½®æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-11 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/nginx/conf.d/dashboard.od.com.conf</span>
</span></span><span style="display:flex;"><span>server <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    listen       80;
</span></span><span style="display:flex;"><span>    server_name  dashboard.od.com;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    rewrite ^<span style="color:#000;font-weight:bold">(</span>.*<span style="color:#000;font-weight:bold">)</span>$ https://<span style="color:#d14">${</span><span style="color:#008080">server_name</span><span style="color:#d14">}</span><span style="color:#008080">$1</span> permanent;
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>server <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    listen       <span style="color:#099">443</span> ssl;
</span></span><span style="display:flex;"><span>    server_name  dashboard.od.com;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ssl_certificate <span style="color:#d14">&#34;certs/dashboard.od.com.crt&#34;</span>;
</span></span><span style="display:flex;"><span>    ssl_certificate_key <span style="color:#d14">&#34;certs/dashboard.od.com.key&#34;</span>;
</span></span><span style="display:flex;"><span>    ssl_session_cache shared:SSL:1m;
</span></span><span style="display:flex;"><span>    ssl_session_timeout  10m;
</span></span><span style="display:flex;"><span>    ssl_ciphers HIGH:!aNULL:!MD5;
</span></span><span style="display:flex;"><span>    ssl_prefer_server_ciphers on;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    location / <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        proxy_pass http://default_backend_traefik;
</span></span><span style="display:flex;"><span>        proxy_set_header Host       <span style="color:#008080">$http_host</span>;
</span></span><span style="display:flex;"><span>        proxy_set_header x-forwarded-for <span style="color:#008080">$proxy_add_x_forwarded_for</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é…ç½®å®Œæˆåï¼Œç‚¹å‡» â€œä¸å®‰å…¨â€ å³å¯æŸ¥çœ‹è¯ä¹¦ä¿¡æ¯</p>
<p><img src="https://images.wuennan.cn/20200708223854583.png" alt="20200708223854583"></p>
<p>æŸ¥çœ‹ <code>admin</code> çš„ <code>token</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get secret -n kube-system</span>
</span></span><span style="display:flex;"><span>NAME                                     TYPE                                  DATA   AGE
</span></span><span style="display:flex;"><span>coredns-token-k6mvh                      kubernetes.io/service-account-token   <span style="color:#099">3</span>      8d
</span></span><span style="display:flex;"><span>default-token-zbds4                      kubernetes.io/service-account-token   <span style="color:#099">3</span>      9d
</span></span><span style="display:flex;"><span>kubernetes-dashboard-admin-token-jb27r   kubernetes.io/service-account-token   <span style="color:#099">3</span>      22h
</span></span><span style="display:flex;"><span>kubernetes-dashboard-key-holder          Opaque                                <span style="color:#099">2</span>      22h
</span></span><span style="display:flex;"><span>traefik-ingress-controller-token-pzl2h   kubernetes.io/service-account-token   <span style="color:#099">3</span>      23h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æ‰§è¡Œæ­¤å‘½ä»¤åï¼Œå°†è¿”å›ä¸€ä¸ªtokençš„å€¼ï¼Œå¤åˆ¶æ­¤å€¼åˆ°Dashboardå³å¯ç™»å½•</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl describe secret kubernetes-dashboard-admin-token-jb27r -n kube-system</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="13-kubeconfigç™»é™†">1.3 Kubeconfigç™»é™†</h4>
<p>è®¾ç½®å˜é‡</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># DASH_TOCKEN=$(kubectl get secret -n kube-system kubernetes-dashboard-admin-token-jb27r -o jsonpath={.data.token}|base64 -d)</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># admin-token-wrqbpå¯ä»¥é€šè¿‡ kubectl get secrets -n kube-system | grep admin æŸ¥çœ‹</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># echo $DASH_TOCKEN</span>
</span></span><span style="display:flex;"><span>eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZC1hZG1pbi10b2tlbi1ud3Y1dCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZC1hZG1pbiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImRlZGI0YmJjLWQ5ZTMtNDkyZC1hYjA0LTdlMTJlZjcwNjY5OSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTprdWJlcm5ldGVzLWRhc2hib2FyZC1hZG1pbiJ9.fdHw84wY7SvBY2yE5LK-8bSkR4f4Wniw78ohLdJ-saV1m3cRoWoBNYKYN4xTolBcgH21Wczma-4AjsEGXhCvtSzlWjd32uIxPk1x06_9LYBUKWs0tPdAhHLXRenxDXxi5RuQTRKw9DKg8droMri7V2RlPeBlQrEaestXBSrw1kE_LEQ1k67Nuh9clSTRIKE-OGM6MRtY-f1LMjzSWkg-v3tbI51SU2x-SldDqbgCgCNizRpLnY3KnpxUU1tjYMSTIi8lVsTuI5pFb7xOUwiZd_QncckXI0SWAS-4-3MyL-AHer6QDT-0pUM87gIraCJtjxLuqh4e02x3r4FvCFjVaA
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ·»åŠ <code>cluster</code>æ¡ç›®</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl config set-cluster kubernetes --server=dashborad.od.com:80 --kubeconfig=/root/dashbord-admin.conf</span>
</span></span><span style="display:flex;"><span>Cluster <span style="color:#d14">&#34;kubernetes&#34;</span> set.
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># dashborad.od.com:80 ä¸ºdashboardè®¿é—®åœ°å€</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®šä¹‰ç”¨äºå‘<code>kubernetes</code>é›†ç¾¤è¿›è¡Œèº«ä»½éªŒè¯çš„å®¢æˆ·ç«¯å‡­æ®</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic">#  kubectl config set-credentials admin --token=$DASH_TOCKEN --kubeconfig=/root/dashbord-admin.conf</span>
</span></span><span style="display:flex;"><span>User <span style="color:#d14">&#34;admin&#34;</span> set.
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç”¨äºä½¿ç”¨æä¾›çš„è®¤è¯ä¿¡æ¯å’Œå‘½åç©ºé—´å°†è¯·æ±‚å‘é€åˆ°æŒ‡å®šçš„é›†ç¾¤</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl config set-context admin --cluster=kubernetes --user=admin --kubeconfig=/root/dashbord-admin.conf</span>
</span></span><span style="display:flex;"><span>Context <span style="color:#d14">&#34;admin&#34;</span> created.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl config use-context admin  --kubeconfig=/root/dashbord-admin.conf</span>
</span></span><span style="display:flex;"><span>Switched to context <span style="color:#d14">&#34;admin&#34;</span>.
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¿å­˜å‡­è¯</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># sz /root/dashbord-admin.conf </span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>å‚è€ƒé“¾æ¥ï¼š <a href="https://www.jianshu.com/p/99853cac56b8">https://www.jianshu.com/p/99853cac56b8</a></p>
</blockquote>
<h4 id="14-å‡çº§dashboard">1.4 å‡çº§Dashboard</h4>
<p>å‡†å¤‡é•œåƒæ–‡ä»¶</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker pull hexun/kubernetes-dashboard-amd64:v1.10.1</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker images | grep dashbo</span>
</span></span><span style="display:flex;"><span>hexun/kubernetes-dashboard-amd64   v1.10.1                    f9aed6605b81        <span style="color:#099">18</span> months ago       122MB
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker tag f9aed6605b81 harbor.od.com/public/dashboard:v1.10.1</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker push harbor.od.com/public/dashboard:v1.10.1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¿®æ”¹ <code>dp.yaml</code> èµ„æºé…ç½®æ¸…å•ï¼Œå¹¶é‡æ–°åº”ç”¨</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ä¿®æ”¹ image éƒ¨åˆ†ï¼Œä½¿ç”¨æ–°çš„é•œåƒæ–‡ä»¶</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /data/k8s-yaml/dashboard/dp.yaml</span>
</span></span><span style="display:flex;"><span>        image: harbor.od.com/public/dashboard:v1.10.1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># é‡æ–°åº”ç”¨æ­¤é…ç½®æ¸…å•</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl apply -f http://k8s-yaml.od.com/dashboard/dp.yaml</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="15-éƒ¨ç½²heapster">1.5 éƒ¨ç½²heapster</h4>
<p>å¯ä» <code>Github</code> ä¸Šä¸‹è½½<a href="https://github.com/kubernetes-retired/heapster">Heapster</a>
å‡†å¤‡é•œåƒæ–‡ä»¶</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker pull quay.io/bitnami/heapster:1.5.4</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker tag c359b95ad38b harbor.od.com/public/heapster:v1.5.4</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># docker push harbor.od.com/public/heapster:v1.5.4</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å‡†å¤‡èµ„æºé…ç½®æ¸…å• <code>rbac.yaml</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /data/k8s-yaml/dashboard/heapster/rbac.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: ServiceAccount
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: heapster
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>kind: ClusterRoleBinding
</span></span><span style="display:flex;"><span>apiVersion: rbac.authorization.k8s.io/v1beta1
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: heapster
</span></span><span style="display:flex;"><span>roleRef:
</span></span><span style="display:flex;"><span>  apiGroup: rbac.authorization.k8s.io
</span></span><span style="display:flex;"><span>  kind: ClusterRole
</span></span><span style="display:flex;"><span>  name: system:heapster
</span></span><span style="display:flex;"><span>subjects:
</span></span><span style="display:flex;"><span>- kind: ServiceAccount
</span></span><span style="display:flex;"><span>  name: heapster
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span></code></pre></td></tr></table>
</div>
</div><p>å‡†å¤‡èµ„æºé…ç½®æ¸…å• <code>dp.yaml</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /data/k8s-yaml/dashboard/heapster/dp.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: extensions/v1beta1
</span></span><span style="display:flex;"><span>kind: Deployment
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: heapster
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  replicas: <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>  template:
</span></span><span style="display:flex;"><span>    metadata:
</span></span><span style="display:flex;"><span>      labels:
</span></span><span style="display:flex;"><span>        task: monitoring
</span></span><span style="display:flex;"><span>        k8s-app: heapster
</span></span><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      serviceAccountName: heapster
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>      - name: heapster
</span></span><span style="display:flex;"><span>        image: harbor.od.com/public/heapster:v1.5.4
</span></span><span style="display:flex;"><span>        imagePullPolicy: IfNotPresent
</span></span><span style="display:flex;"><span>        command:
</span></span><span style="display:flex;"><span>        - /opt/bitnami/heapster/bin/heapster
</span></span><span style="display:flex;"><span>        - --source<span style="color:#000;font-weight:bold">=</span>kubernetes:https://kubernetes.default
</span></span></code></pre></td></tr></table>
</div>
</div><p>å‡†å¤‡èµ„æºé…ç½®æ¸…å• <code>svc.yaml</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-15 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /data/k8s-yaml/dashboard/heapster/svc.yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Service
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    task: monitoring
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># For use as a Cluster add-on (https://github.com/kubernetes/kubernetes/tree/master/cluster/addons)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># If you are NOT using this as an addon, you should comment out this line.</span>
</span></span><span style="display:flex;"><span>    kubernetes.io/cluster-service: <span style="color:#d14">&#39;true&#39;</span>
</span></span><span style="display:flex;"><span>    kubernetes.io/name: Heapster
</span></span><span style="display:flex;"><span>  name: heapster
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  ports:
</span></span><span style="display:flex;"><span>  - port: <span style="color:#099">80</span>
</span></span><span style="display:flex;"><span>    targetPort: <span style="color:#099">8082</span>
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    k8s-app: heapster
</span></span></code></pre></td></tr></table>
</div>
</div><p>åº”ç”¨èµ„æºé…ç½®æ¸…å•</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl apply -f http://k8s-yaml.od.com/dashboard/heapster/rbac.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl apply -f http://k8s-yaml.od.com/dashboard/heapster/dp.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl apply -f http://k8s-yaml.od.com/dashboard/heapster/svc.yaml</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç­‰å¾…å‡ åˆ†é’Ÿåï¼Œé‡å¯ç™»å½• <code>Dashboard</code> ï¼Œå¯ä»¥çœ‹åˆ°æœåŠ¡å™¨çš„èµ„æºä½¿ç”¨æƒ…å†µ</p>
<p><img src="https://images.wuennan.cn/20200709005716583.png" alt="20200709005716583"></p>
<blockquote>
<p>èµ„æºä½¿ç”¨æƒ…å†µä»…ä¾›å‚è€ƒï¼Œæ¨èä½¿ç”¨Prometheus</p>
</blockquote>
<h1 id="å…«kubeneteså‡çº§">å…«ã€Kubeneteså‡çº§</h1>
<h3 id="1-ç¯å¢ƒå‡†å¤‡">1. ç¯å¢ƒå‡†å¤‡</h3>
<p>ç”Ÿäº§ç¯å¢ƒåº”å…ˆæ‘˜é™¤è´Ÿè½½å‡è¡¡ï¼Œæå‰å‡†å¤‡å¥½å®‰è£…åŒ…</p>
<p>æŸ¥çœ‹å½“å‰çš„ç‰ˆæœ¬ï¼Œä¸¤ä¸ª <code>node</code> èŠ‚ç‚¹ï¼Œç‰ˆæœ¬ä¸º <code>1.15.2</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get node -o wide</span>
</span></span><span style="display:flex;"><span>NAME                      STATUS   ROLES         AGE   VERSION   INTERNAL-IP      EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION               CONTAINER-RUNTIME
</span></span><span style="display:flex;"><span>192-168-199-13.host.com   Ready    master,node   13d   v1.15.2   192.168.199.13   &lt;none&gt;        CentOS Linux <span style="color:#099">7</span> <span style="color:#000;font-weight:bold">(</span>Core<span style="color:#000;font-weight:bold">)</span>   3.10.0-1127.8.2.el7.x86_64   docker://19.3.12
</span></span><span style="display:flex;"><span>192-168-199-14.host.com   Ready    master,node   13d   v1.15.2   192.168.199.14   &lt;none&gt;        CentOS Linux <span style="color:#099">7</span> <span style="color:#000;font-weight:bold">(</span>Core<span style="color:#000;font-weight:bold">)</span>   3.10.0-1127.8.2.el7.x86_64   docker://19.3.12
</span></span></code></pre></td></tr></table>
</div>
</div><p>åˆ é™¤å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl delete node 192-168-199-13.host.com</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç­‰å¾…ä¸€å°ä¼šï¼Œæ‰€æœ‰ <code>pod</code> ä¼šå…¨éƒ¨è½¬ç§»è‡³å…¶ä»–èŠ‚ç‚¹</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get nodes -o wide</span>
</span></span><span style="display:flex;"><span>NAME                      STATUS   ROLES         AGE   VERSION   INTERNAL-IP      EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION               CONTAINER-RUNTIME
</span></span><span style="display:flex;"><span>192-168-199-14.host.com   Ready    master,node   13d   v1.15.2   192.168.199.14   &lt;none&gt;        CentOS Linux <span style="color:#099">7</span> <span style="color:#000;font-weight:bold">(</span>Core<span style="color:#000;font-weight:bold">)</span>   3.10.0-1127.8.2.el7.x86_64   docker://19.3.12
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get pods -n kube-system -o wide</span>
</span></span><span style="display:flex;"><span>NAME                                   READY   STATUS    RESTARTS   AGE     IP           NODE                      NOMINATED NODE   READINESS GATES
</span></span><span style="display:flex;"><span>coredns-6b6c4f9648-8rcmq               1/1     Running   <span style="color:#099">0</span>          105s    172.7.14.7   192-168-199-14.host.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>heapster-b5b9f794-2qnkl                1/1     Running   <span style="color:#099">0</span>          3d17h   172.7.14.5   192-168-199-14.host.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>kubernetes-dashboard-67989c548-t4tcg   1/1     Running   <span style="color:#099">0</span>          113s    172.7.14.6   192-168-199-14.host.com   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>traefik-ingress-6pc5k                  1/1     Running   <span style="color:#099">0</span>          4d18h   172.7.14.4   192-168-199-14.host.com   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>å‡†å¤‡å®‰è£…åŒ…</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># tar xf kubernetes-server-linux-amd64-v1.15.4.tar.gz</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mv kubernetes kubernetes-v1.15.4</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd kubernetes-v1.15.4/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 kubernetes-v1.15.4<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># rm -rf kubernetes-src.tar.gz</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 kubernetes-v1.15.4<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># /root/kubernetes-v1.15.4/server/bin</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 bin<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># rm -rf *.tar</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 bin<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># rm -rf *_tag</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mv kubernetes-v1.15.4/ /opt/</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å‡†å¤‡è¯ä¹¦åŠé…ç½®æ–‡ä»¶</p>
<pre tabindex="0"><code>[root@192-168-199-13 bin]# mkdir conf cert
[root@192-168-199-13 bin]# cp /opt/kubernetes-v1.15.2/server/bin/cert/* cert/
[root@192-168-199-13 bin]# cp /opt/kubernetes-v1.15.2/server/bin/conf/* conf/
[root@192-168-199-13 bin]# cp /opt/kubernetes-v1.15.2/server/bin/*.sh ./
</code></pre><h3 id="2-é›†ç¾¤å‡çº§">2. é›†ç¾¤å‡çº§</h3>
<p>ç”Ÿæ•ˆé…ç½®ï¼Œå¹¶é‡å¯æœåŠ¡</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 bin<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /opt/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 opt<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ll | grep kube</span>
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#099">1</span> root root   <span style="color:#099">24</span> Jun <span style="color:#099">28</span> 22:20 kubernetes -&gt; /opt/kubernetes-v1.15.2/
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#099">4</span> root root <span style="color:#099">4096</span> Jun <span style="color:#099">28</span> 22:21 kubernetes-v1.15.2
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#099">4</span> root root <span style="color:#099">4096</span> Jul <span style="color:#099">12</span> 19:05 kubernetes-v1.15.4
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># åˆ é™¤åŸæ¥çš„è½¯è¿æ¥ï¼Œå¹¶æ–°å®¶è½¯è¿æ¥åˆ° kubernetes-v1.15.4</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 opt<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># rm kubernetes -rf</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 opt<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ln -s /opt/kubernetes-v1.15.4/ /opt/kubernetes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 opt<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ll | grep kube</span>
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#099">1</span> root root   <span style="color:#099">24</span> Jul <span style="color:#099">12</span> 19:23 kubernetes -&gt; /opt/kubernetes-v1.15.4/
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#099">4</span> root root <span style="color:#099">4096</span> Jun <span style="color:#099">28</span> 22:21 kubernetes-v1.15.2
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#099">4</span> root root <span style="color:#099">4096</span> Jul <span style="color:#099">12</span> 19:05 kubernetes-v1.15.4
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># é€šè¿‡supervisorctl é‡å¯æ‰€æœ‰æœåŠ¡ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®ä¸€ä¸ªä¸€ä¸ªé‡å¯</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 opt<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># supervisorctl restart all</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># æŸ¥çœ‹æœåŠ¡çŠ¶æ€</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 kubernetes<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># supervisorctl status</span>
</span></span><span style="display:flex;"><span>etcd-server-199-13               RUNNING   pid 42096, uptime 0:09:18
</span></span><span style="display:flex;"><span>flanneld-199-13                  RUNNING   pid 43635, uptime 0:05:27
</span></span><span style="display:flex;"><span>kube-apiserver-199-13            RUNNING   pid 42460, uptime 0:08:28
</span></span><span style="display:flex;"><span>kube-controller-manager-199-13   RUNNING   pid 43836, uptime 0:04:56
</span></span><span style="display:flex;"><span>kube-kubelet-199-13              RUNNING   pid 45378, uptime 0:01:53
</span></span><span style="display:flex;"><span>kube-proxy-199-13                RUNNING   pid 36883, uptime 0:20:59
</span></span><span style="display:flex;"><span>kube-scheduler-199-13            RUNNING   pid 41827, uptime 0:10:02
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>è‹¥é‡å¯å¤±è´¥ï¼Œå¯æŸ¥çœ‹ <code>/data/logs/</code> æ—¥å¿—ï¼Œè‹¥å›  <code>ipv6</code> ç«¯å£å†²çªå¯¼è‡´ï¼Œå¯é€šè¿‡ <code>netstat -lnap</code> æ‰¾åˆ°è¿›ç¨‹å¯¹åº”çš„ <code>pid</code> , <code>kill</code> åé‡å¯å³å¯</p>
</blockquote>
<p>æ‰€æœ‰æœåŠ¡æ­£å¸¸åï¼ŒèŠ‚ç‚¹ä¼šè¢«è‡ªåŠ¨åŠ å›é›†ç¾¤</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@192-168-199-13 kubernetes<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get nodes -o wide</span>
</span></span><span style="display:flex;"><span>NAME                      STATUS   ROLES         AGE   VERSION   INTERNAL-IP      EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION               CONTAINER-RUNTIME
</span></span><span style="display:flex;"><span>192-168-199-13.host.com   Ready    &lt;none&gt;        34m   v1.15.4   192.168.199.13   &lt;none&gt;        CentOS Linux <span style="color:#099">7</span> <span style="color:#000;font-weight:bold">(</span>Core<span style="color:#000;font-weight:bold">)</span>   3.10.0-1127.8.2.el7.x86_64   docker://19.3.12
</span></span><span style="display:flex;"><span>192-168-199-14.host.com   Ready    master,node   13d   v1.15.2   192.168.199.14   &lt;none&gt;        CentOS Linux <span style="color:#099">7</span> <span style="color:#000;font-weight:bold">(</span>Core<span style="color:#000;font-weight:bold">)</span>   3.10.0-1127.8.2.el7.x86_64   docker://19.3.12
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>å‡çº§ï¼Œå›é€€ï¼Œæ·»åŠ èŠ‚ç‚¹ç­‰æ“ä½œä¸ä¸Šè¿°ç±»ä¼¼</p>
</blockquote>

    </div>
    
    

    
</div>

            </div>
            <div id="footer"><div class="container-footer">
    
    

    <div class="beian">
        
        <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=">
            

        </a>

        <a href="" target="_blank">
            
            <span class="some">icp...<span>
            
        </a>
    </div>

    <div class="info">
        <a href="https://github.com/loveminimal/hugo-theme-virgo">Copyright</a> Â© 2016 - <span id="info-date"></span>
    </div>

</div></div>
        </div>
        <div class="cool-after" style="background-color: rgba(255, 255, 255, 0.81);"></div>
    </body>
</html>
<link href="https://qiniu.techgrow.cn/readmore/dist/readmore.css" type="text/css" rel="stylesheet">
<script src="https://qiniu.techgrow.cn/readmore/dist/readmore.js" type="text/javascript"></script>
<script>
    var regex = /(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i
    var isMobile = navigator.userAgent.match(regex);
    if (!isMobile) {
        try {
            var plugin = new ReadmorePlugin();
            plugin.init({
                id: "readmore-container",
                blogId: "25525-2853989927488-092",
                name: "å²åŠªæ¯”ä¼šç‚¹è¿ç»´",
                keyword: "éªŒè¯ç ",
                qrcode: "https://images.snoopyops.top/wechat/wechat_snoopyops.jpg",
                type: "hugo",
                height: "auto",
                expires: "7",
                interval: "60",
                random: "1"
            })
        } catch (e) {
            console.warn("readmore plugin occurred error: " + e.name + " | " + e.message);
        }
    }
</script>
